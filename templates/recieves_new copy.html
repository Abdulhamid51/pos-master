{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    <title>Qabul - Yangi</title>
{% endblock %}

{% block css %}
    <style>
        .no-results-message {
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        #product-search:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .product-item {
            transition: all 0.3s ease;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999; /* Modal z-index'idan yuqori qilish */
            width: 30rem;
        }

        .ajax-loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .quick-add-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .recieve-item {
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 3px solid transparent;
        }
        
        .recieve-item:hover {
            background-color: #f8f9fa;
        }
        
        .recieve-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .price-table th, .price-table td {
            padding: 8px;
            text-align: center;
        }
        
        .edit-form {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .auto-calc {
            background-color: #e8f5e8;
            font-weight: bold;
        }
    </style>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />

{% endblock %}

{% block content %}
<div id="content" class="main-content">
    <div class="layout-px-spacing">
        <div style="z-index: 100000000000;" id="alert-container"></div>
        
        <!-- Yuklanish indikatori -->
        <div id="loading" class="ajax-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Yuklanmoqda...</span>
            </div>
        </div>

        <div class="row">
            <!-- Chap panel - Qabullar ro'yxati -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-primary btn-sm mb-1" data-toggle="modal" data-target="#createRecieveModal">
                            <i class="fas fa-plus"></i> Yangi Qabul
                        </button>
                        <button class="btn btn-info btn-sm ml-1 mb-1" data-toggle="modal" data-target="#createDeliverModal">
                            <i class="fas fa-truck"></i> Yetkazib beruvchi
                        </button>
                        <button class="btn btn-warning btn-sm ml-1 mb-1" data-toggle="modal" data-target="#createExpenseTypeModal">
                            <i class="fas fa-tag"></i> Chiqim turi
                        </button>

                        <!-- <button class="btn btn-secondary btn-sm ml-1 mb-1" data-toggle="modal" data-target="#createExpenseTypeModal">
                            <i class="fas fa-plus"></i> Maxsulot
                        </button> -->

                    </div>
                    <!-- <div class="card-body">
                        <div id="recieve-list">
                            {% for recieve in recieves %}
                            <div class="recieve-item p-3 border-bottom {% if active_one and active_one.id == recieve.id %}active{% endif %}" 
                                 onclick="selectRecieve({{ recieve.id }})" 
                                 data-recieve-id="{{ recieve.id }}"
                                 id="recieve-{{ recieve.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 font-weight-bold">Partiya: {{ recieve.name }}</h6>
                                        <p class="mb-1 text-muted small">Yetkazib beruvchi: {{ recieve.deliver.name }}</p>
                                        <p class="mb-1 text-muted small">Sana: {{ recieve.date|date:'d-m-Y H:i' }}</p>
                                        <p class="mb-0 text-success font-weight-bold">
                                            Jami: {{ recieve.total_bring_price|intcomma }}
                                        </p>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteRecieve({{ recieve.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted p-3">
                                <p>Hozircha qabullar mavjud emas</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div> -->


                    <div class="card-body">
                        <!-- Tab Navigation - Bootstrap 4 -->
                        <ul class="nav nav-tabs mb-2" id="recieveTabs" role="tablist" style="font-size: 0.85rem;">
                            <li class="nav-item">
                                <a class="nav-link active py-1 px-2" id="recieve-tab" data-toggle="tab" href="#recieve-content" role="tab" aria-controls="recieve-content" aria-selected="true">
                                    <small><i class="fas fa-inbox mr-1"></i>Qabullar</small>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link py-1 px-2" id="products-tab" data-toggle="tab" href="#products-content" role="tab" aria-controls="products-content" aria-selected="false">
                                    <small><i class="fas fa-boxes mr-1"></i>Maxsulotlar</small>
                                </a>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="recieveTabContent">
                            <!-- Qabullar Tab -->
                            <div class="tab-pane fade show active" id="recieve-content" role="tabpanel" aria-labelledby="recieve-tab">
                                <div id="recieve-list">
                                    {% for recieve in recieves %}
                                    <div class="recieve-item p-3 border-bottom {% if active_one and active_one.id == recieve.id %}active{% endif %}" 
                                        onclick="selectRecieve({{ recieve.id }})" 
                                        data-recieve-id="{{ recieve.id }}"
                                        id="recieve-{{ recieve.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 font-weight-bold">Partiya: {{ recieve.name }}</h6>
                                                <p class="mb-1 text-muted small">Yetkazib beruvchi: {{ recieve.deliver.name }}</p>
                                                <p class="mb-1 text-muted small">Sana: {{ recieve.date|date:'d-m-Y H:i' }}</p>
                                                <p class="mb-0 text-success font-weight-bold">
                                                    Jami: {{ recieve.total_bring_price|intcomma }}
                                                </p>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteRecieve({{ recieve.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted p-3">
                                        <p>Hozircha qabullar mavjud emas</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>


                            <div class="tab-pane fade" id="products-content" role="tabpanel" aria-labelledby="products-tab">
                                <!-- Qidiruv qismi -->
                                <div class="mb-3">
                                    <input type="text" id="product-search" class="form-control form-control-sm" placeholder="Maxsulot nomini qidirish...">
                                </div>
                                
                                <!-- Maxsulotlar ro'yxati -->
                                <div id="products-list" style="max-height: 80vh; overflow-y: auto;">
                                    {% for product in products %}
                                    <div class="product-item p-3 border-bottom" data-product-name="{{ product.name|lower }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 font-weight-bold">{{ product.name }}</h6>
                                                <p class="mb-1 text-muted small">Guruh: {{ product.group.name }}</p>
                                                <p class="mb-1 text-muted small">Narx: {% for br_pr in product.bring_prices %}
                                                    {{ br_pr.price|intcomma }} {{ br_pr.valyuta }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}</p>
                                                <p class="mb-0 text-muted small">Qoldiq: {{ product.quantity|floatformat:'2'|intcomma }}</p>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="addRecieveItemQuick({{ product.id }}, 0)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted p-3">
                                        <p>Hozircha maxsulotlar mavjud emas</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Maxsulotlar Tab -->
                            <!-- <div class="tab-pane fade" id="products-content" role="tabpanel" aria-labelledby="products-tab">
                                <div id="products-list">
                                    {% for product in products %}
                                    <div class="product-item p-3 border-bottom">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 font-weight-bold">{{ product.name }}</h6>
                                                <p class="mb-1 text-muted small">Guruh: {{ product.group.name }}</p>
                                                <p class="mb-1 text-muted small">Narx: {% for br_pr in product.bring_prices %}
                                                    {{ br_pr.price|intcomma }} {{ br_pr.valyuta }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                                </p>
                                                <p class="mb-0 text-muted small">Qoldiq: {{ product.quantity|floatformat:'2'|intcomma }}</p>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="addRecieveItemQuick({{ product.id }}, 0)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted p-3">
                                        <p>Hozircha maxsulotlar mavjud emas</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- O'ng panel - Tanlangan qabul -->
            <div class="col-md-8">
                <div id="recieve-detail">
                    {% if active_one %}
                        <!-- Tez qo'shish formasi -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"></h5>
                            </div>
                            <div class="card-body">
                                <form id="quick-add-form" class="quick-add-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Mahsulot</label>
                                                <div class="input-group">
                                                    <select class="form-control searchable" id="product-select" required>
                                                        <option value="">Tanlang</option>
                                                        {% for product in products %}
                                                        <option value="{{ product.id }}">{{ product.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <div class="input-group-append">
                                                        <button style="border-radius: 15px;" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#new_product_add">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Miqdor</label>
                                                <input type="number" step="any" class="form-control" id="quantity-input" required>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <button type="submit" id="product-submit-btn" class="btn btn-success btn-block">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Narxlar formasi -->
                                    <div id="price-fields">
                                        <!-- Narxlar JavaScript orqali yuklanadi -->
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Mahsulotlar jadvali -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Mahsulotlar</h5>
                                <span class="badge badge-primary">
                                    Jami: {{ active_one.total_quantity|default:0|intcomma }} dona
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Mahsulot</th>
                                                <th>Kelish narxi</th>
                                                <th>Soni</th>
                                                <th>Jami</th>
                                                <th>Dollar narxi</th>
                                                <th>Ulushi</th>
                                                <th>Chiqim</th>
                                                <th>Tan narx</th>
                                                <th>Amallar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-table-body">
                                            {% for item in active_one.receiveitem.all %}
                                            <tr id="item-{{ item.id }}">
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ item.product.name }}</td>
                                                <td>{{ item.bring_price|intcomma }}</td>
                                                <td>{{ item.quantity|intcomma }}</td>
                                                <td>{{ item.total_bring_price|intcomma }}</td>
                                                <td>{{ item.dollar_price_for_count|intcomma }}</td>
                                                <td>{{ item.percent|intcomma }}%</td>
                                                <td>{{ item.expanse|intcomma }}</td>
                                                <td>{{ item.cost|intcomma }}</td>
                                                <td>
                                                    <button class="btn btn-warning btn-sm" onclick="editItem({{ item.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteItem({{ item.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="10" class="text-center text-muted">
                                                    Hozircha mahsulotlar mavjud emas
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="font-weight-bold">
                                            <tr>
                                                <td colspan="3">Jami</td>
                                                <td>{{ active_one.total_quantity|default:0|intcomma }}</td>
                                                <td>{{ active_one.total_bring_price|intcomma }}</td>
                                                <td colspan="5"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Chiqimlar qismi -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Qabul chiqimlari</h5>
                                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addExpenseModal">
                                    <i class="fas fa-plus"></i> Chiqim qo'shish
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Turi</th>
                                                <th>Summa</th>
                                                <th>Valyuta</th>
                                                <th>Turli shaxs</th>
                                                <th>Izoh</th>
                                                <th>Amallar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expenses-table-body">
                                            {% for expanse in active_one.expanses.all %}
                                            <tr id="expense-{{ expanse.id }}">
                                                <td>{{ expanse.type.name }}</td>
                                                <td>{{ expanse.summa|intcomma }}</td>
                                                <td>{{ expanse.valyuta.name }}</td>
                                                <td>{{ expanse.externaluser.full_name|default:"-" }}</td>
                                                <td>{{ expanse.comment|default:"-" }}</td>
                                                <td>
                                                    <button class="btn btn-warning btn-sm" onclick="editExpense({{ expanse.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteExpense({{ expanse.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Hozircha chiqimlar mavjud emas
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted p-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Qabulni tanlang</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal oynalar -->

<!-- Yangi qabul modal -->
<div class="modal fade" id="createRecieveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yangi Qabul</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createRecieveForm">
                    <div class="form-group">
                        <label>Partiya nomi</label>
                        <input type="text" class="form-control" name="name" value="{{ last_part }}" required>
                    </div>
                    <div class="form-group">
                        <label>Yetkazib beruvchi</label>
                        <select class="form-control" name="deliver" required>
                            {% for deliver in delivers %}
                            <option value="{{ deliver.id }}">{{ deliver.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filial</label>
                        <select class="form-control" name="filial" required>
                            {% for filial in filial %}
                            <option value="{{ filial.id }}">{{ filial.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valyuta</label>
                        <select class="form-control" name="valyuta" required>
                            {% for valyuta in valyutas %}
                            <option value="{{ valyuta.id }}">{{ valyuta.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kurs</label>
                        <input type="number" step="any" class="form-control" name="kurs" value="{{ dollar_kurs }}" id="dollar-kurs-base" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createRecieve()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Yetkazib beruvchi modal -->
<div class="modal fade" id="createDeliverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yetkazib beruvchi qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createDeliverForm">
                    <div class="form-group">
                        <label>Nomi</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon 1</label>
                        <input type="text" class="form-control" name="phone1" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon 2</label>
                        <input type="text" class="form-control" name="phone2">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createDeliver()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Chiqim turi qo'shish modal -->
<div class="modal fade" id="createExpenseTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chiqim turi qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createExpenseTypeForm">
                    <div class="form-group">
                        <label>Nomi</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createExpenseType()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Chiqim qo'shish modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chiqim qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm">
                    <div class="form-group">
                        <label>Chiqim turi</label>
                        <select class="form-control" name="type" required>
                            {% for expanse_type in expanse_types %}
                            <option value="{{ expanse_type.id }}">{{ expanse_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Summa</label>
                        <input type="number" step="0.01" class="form-control" name="summa" required>
                    </div>
                    <div class="form-group">
                        <label>Valyuta</label>
                        <select class="form-control" name="valyuta" required>
                            {% for valyuta in valyutas %}
                            <option value="{{ valyuta.id }}">{{ valyuta.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Turli shaxs</label>
                        <select class="form-control" name="externaluser">
                            <option value="">-</option>
                            {% for user in external_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Izoh</label>
                        <textarea class="form-control" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()">Qo'shish</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="new_product_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
<div class="modal-dialog " role="document">
    <form id="newProductForm" class="modal-content" method="post" style="width: 700px;">
    {% csrf_token %}
    <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle1">Yangi qoshish</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <div class="row">
                <div class="col-md-6">
                    <label for="">Nomi</label>
                    <input type="text" class="form-control" name="name" required>
                    <input type="hidden" class="form-control" name="filial_id" value="{{ active_one.filial.id }}">
                    <input type="hidden" class="form-control" name="deliver" value="{{ active_one.deliver.id }}">
                </div>  
                <!-- <div class="col-md-6">
                    <label for="">Ishlab chiqaruvchi</label>
                    <select class="form-control searchable" required name="deliver" id="">
                        <option value="">- - - - - - - - </option>
                        {% for a in delivers %}
                            <option value="{{a.id}}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div> -->
                <div class="col-md-6">
                    <label for="">Ulchov</label>
                    <select class="form-control searchable" required name="measurement_type">
                        {% for a in measurement_type %}
                            <option value="{{a.id}}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="">Turi</label>
                    <select class="form-control" required name="ready">
                            <option value="1">Xom ashyo</option>
                            <option value="2">Yarim tayyor</option>
                            <option value="3">Tayyor</option>
                    </select>
                </div>
                <!-- <div class="col-md-6">
                    <label for="">Valyuta</label>
                    <select class="form-control searchable" required name="valyuta">
                        {% for a in valyutas %}
                            <option value="{{a.id}}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div> -->
                <div class="col-md-6">
                    <label for="">Minimal miqdor</label>
                    <input type="number" class="form-control" name="min_count" required>
                </div>
                <div class="col-md-6">
                    <label for="">Guruh</label>
                    <select class="form-control searchable" required name="group" id="">
                        <option value="">- - - - - - - - </option>
                        {% for a in groups %}
                            <option value="{{a.id}}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="">Polka kodi</label>
                    <input type="text" class="form-control" name="shelf_code">
                </div>
                <div class="col-md-6">
                    <label for="">Paketdagi soni</label>
                    <input type="number" step="any" class="form-control" name="pack">
                </div>
                <div class="col-md-6">
                    <label for="">Miqdori</label>
                    <input type="number" step="any" class="form-control" name="quantity">
                </div>
                <div class="col-md-12">
                    <label for="">Barcode</label>
                    <div id="barcode_container">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control barcode-input" oninput="push(this)">
                            <div class="input-group-append">
                                <button type="button" class="btn btn-secondary" onclick="addInput()">+</button>
                            </div>
                    </div>
                </div>
            </div>
            <input type="hidden" id="data_list" name="list_barcode" />

            <script>
                let isBarcodeDuplicate = false;

                function addInput() {
                    const inputs = document.querySelectorAll(".barcode-input");
                    const lastInput = inputs[inputs.length - 1];

                    const inputValue = lastInput.value.trim();

                    if (inputValue === '') {
                        showAlert("Barcode kiritilmagan!", "warning");
                        return;
                    }

                    if (isBarcodeDuplicate) {
                        showAlert("Bu barcode allaqachon mavjud!", "warning");
                        return;
                    }

                    const container = document.getElementById("barcode_container");
                    const group = document.createElement("div");
                    group.className = "input-group mb-2";
                    group.innerHTML = `
                        <input type="text" class="form-control barcode-input" oninput="push(this)">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-secondary" onclick="addInput()">+</button>
                        </div>
                    `;
                    container.appendChild(group);
                }

                function push(item) {
                    const inputValue = item.value.trim();

                    if (inputValue === '') {
                        isBarcodeDuplicate = true;  
                        disableAddButtons(true);
                        return;
                    }

                    $.ajax({
                        url: "{% url 'filter_product_barcode' %}",
                        type: "POST",
                        data: JSON.stringify({ 'barcode': inputValue }),
                        contentType: "application/json",
                        success: function (response) {
                            if (response.data.message) {
                                showAlert(response.data.message, 'warning');
                                isBarcodeDuplicate = true;
                                disableAddButtons(true);
                            } else {
                                isBarcodeDuplicate = false;
                                disableAddButtons(false);
                            }
                        },
                        error: function () {
                            showAlert("Server bilan bog'lanishda xatolik", "danger");
                            isBarcodeDuplicate = true;
                            disableAddButtons(true);
                        }
                    });
                }

                function disableAddButtons(disable) {
                    const buttons = document.querySelectorAll("#barcode_container .btn.btn-secondary");
                    buttons.forEach(btn => {
                        btn.disabled = disable;
                    });
                }

                function Pushdata() {
                    const inputs = document.querySelectorAll(".barcode-input");
                    const data = [];
                    inputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            data.push(input.value.trim());
                        }
                    });
                    document.getElementById('data_list').value = JSON.stringify(data);
                }
            </script>
            </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary" onclick="Pushdata()">Saqlash</button>
        </div>
    </div>
    </form>
</div>
</div>
{% endblock %}

{% block js %}



<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>


<script>
    $('#newProductForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const quantity = parseFloat(form.find('[name="quantity"]').val()) || 1;
        
        $.ajax({
            url: "{% url 'new_product_add' %}?from_ajax=true",
            type: "POST",
            data: form.serialize(),
            success: function(response) {
                console.log(response)
                if (response.success) {
                    console.log('uuuuuuuu')
                    const selectize = $('#product-select')[0].selectize;
                    console.log('iiiiiii')
                    if (selectize) {
                        // Yangi variantni qo'shish
                        selectize.addOption({
                            value: response.id,
                            text: response.name
                        });
                        // Yangi variantni tanlash
                        selectize.setValue(response.id);
                        console.log('bbbbbbbb')
                    }
                    
                    // Modalni yopish
                    $('#new_product_add').modal('hide');
                    // Formani tozalash
                    form[0].reset();

                    console.log('ccccccc')
                    
                    showAlert("Mahsulot muvaffaqiyatli qo'shildi!", "success");
                } else {
                    showAlert(response.message, "danger");
                }
            },
            error: function() {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    });

</script>


<script>

    function selectize_input(item) {
        const debtorSelect = $(item).selectize({
        normalize: true,
        create: false,
        sortField: 'text',
        placeholder: 'Tanlang...',
        render: {
            option: function (item, escape) {
                const parts = escape(item.text).split('—');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="
                        display: flex; 
                        flex-direction: column; 
                        padding: 8px 10px; 
                        line-height: 1.3;
                    ">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span style="font-weight: 500; color:#333;">${name}</span>
                        </div>
                        <div style="
                            display: flex; 
                            align-items: center; 
                            gap: 6px; 
                            margin-top: 4px;
                            line-height: 1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            },
            item: function (item, escape) {
                const parts = escape(item.text).split('—');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="display:flex; flex-direction:column; line-height:1.2;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span>${name}</span>
                        </div>
                        <div style="
                            display:flex; 
                            align-items:center; 
                            gap:6px; 
                            margin-top:2px;
                            line-height:1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            }
        },
        onInitialize: function () {
            const input = this.$control;
            input.css({
                'border-radius': '10px',
                'border': '1px solid #ced4da',
                'padding': '10px 12px',
                'background': '#fff',
                'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
                'transition': 'all 0.2s ease',
            });

            this.$dropdown.css({
                'border-radius': '8px',
                'overflow': 'hidden',
                'box-shadow': '0 4px 8px rgba(0,0,0,0.12)',
            });

            this.$dropdown.on('mouseenter', '.option', function () {
                $(this).css({
                    'background': '#007bff',
                    'color': '#fff',
                    'cursor': 'pointer'
                });
                $(this).find('i').css('color', '#fff');
            }).on('mouseleave', '.option', function () {
                $(this).css({
                    'background': '',
                    'color': ''
                });
                $(this).find('.bi-person-circle').css('color', '#007bff');
                $(this).find('.bi-telephone-fill').css('color', '#28a745');
            });

            input.on('focus', function () {
                $(this).css({
                    'border-color': '#007bff',
                    'box-shadow': '0 0 0 3px rgba(0,123,255,0.15)'
                });
            }).on('blur', function () {
                $(this).css({
                    'border-color': '#ced4da',
                    'box-shadow': 'none'
                });
            });
        }
    });
    }
    
    $(document).ready(function () {

        selectize_input('#product-select');
    });
</script>



<script>
    function calculate(item) {
        const $this = $(item);
        const value = parseFloat($this.val()) || 0;
        
        // Agar So'm bo'lsa, Dollarni hisobla
        if ($this.data('is_som')) {
            const dollarValue = value / dollarKurs;
            // Tegishli Dollar inputini topish
            if ($this.hasClass('bring-price-input')) {
                console.log('bbbbbbbb')
                // Kelish narxi - faqat Dollar inputini yangilaymiz
                $('.bring-price-input[data-is_dollar="true"]').val(dollarValue.toFixed(2));
            } else if ($this.hasClass('sell-price-input')){
                // Sotish narxi - faqat Dollar inputini yangilaymiz
                const priceKey = $this.data('price-key');
                const parts = priceKey.split('_');
                const price_type_id = $this.data('price_type_id')
                $(`.sell-price-input[data-is_dollar="true"][data-price_type_id="${price_type_id}"]`).val(dollarValue.toFixed(2));
            }
        }
        // Agar Dollar bo'lsa, So'mni hisobla
        else if ($this.data('is_dollar')) {
            const somValue = value * dollarKurs;
            // Tegishli So'm inputini topish
            if ($this.hasClass('bring-price-input')) {
                // Kelish narxi - faqat So'm inputini yangilaymiz
                $('.bring-price-input[data-is_som="true"]').val(somValue.toFixed(0));
            } else {
                // Sotish narxi - faqat So'm inputini yangilaymiz
                const priceKey = $this.data('price-key');
                const parts = priceKey.split('_');
                const somPriceKey = `price_${parts[1]}_1`; // Dollardan So'mga (1 - som ID)
                $(`.sell-price-input[data-price-key="${somPriceKey}"]`).val(somValue.toFixed(0));
            }
        }
    }




    // Asosiy o'zgaruvchilar
    let currentRecieveId = {% if active_one %}{{ active_one.id }}{% else %}null{% endif %};
    let dollarKurs = parseFloat("{{ dollar_kurs }}") || 1;
    
    // Sahifa yuklanganda
    $(document).ready(function() {
        initializeEventListeners();
        // Dollar kursini yangilash
        updateDollarKurs();
    });
    
    // Dollar kursini yangilash
    function updateDollarKurs() {
        const baseKurs = parseFloat($('#dollar-kurs-base').val());
        if (baseKurs && baseKurs > 0) {
            dollarKurs = baseKurs;
        }
    }
    
    // Kurs o'zgarganda avtomatik hisoblash
    function addKurs(input) {
        dollarKurs = parseFloat(input.value) || 1;
        // Barcha narxlarni yangilash
        updateAllPrices();
    }
    
    // Barcha narxlarni yangilash
    function updateAllPrices() {
        // Kelish narxlarini yangilash
        $('.bring-price-input').each(function() {
            const valyutaId = $(this).data('valyuta');
            if (valyutaId === '1') { // Som
                const somPrice = parseFloat($(this).val()) || 0;
                const dollarPrice = somPrice / dollarKurs;
                // Dollar narxini yangilash
                $(`.bring-price-input[data-valyuta="2"]`).val(dollarPrice.toFixed(2));
            }
        });
        
        // Sotish narxlarini yangilash
        $('.sell-price-input').each(function() {
            const priceKey = $(this).data('price-key');
            if (priceKey.includes('_1_')) { // Som valyuta
                const somPrice = parseFloat($(this).val()) || 0;
                const dollarPrice = somPrice / dollarKurs;
                // Dollar narxini topish va yangilash
                const parts = priceKey.split('_');
                const dollarPriceKey = `price_${parts[1]}_2`; // Dollar valyuta
                $(`.sell-price-input[data-price-key="${dollarPriceKey}"]`).val(dollarPrice.toFixed(2));
            }
        });
    }
    
    // Hodisa listenerlarini ishga tushirish
    function initializeEventListeners() {
        // Tez qo'shish formasi
        $(document).on('submit', '#quick-add-form', function(e) {
            e.preventDefault();
            addRecieveItemQuick();
        });
        
        // Mahsulot tanlanganda
        $(document).on('change', '#product-select', function() {
            const productId = $(this).val();
            if (productId) {
                loadProductPrices(productId);
            } else {
                $('#price-fields').hide();
            }
        });
        
        // Narx inputlarida o'zgarish
        // $(document).on('input', '.bring-price-input, .sell-price-input', function() {
        //     updateAllPrices();
        // });

        
        // Dollar kursi o'zgarganda
        $(document).on('input', '#dollar-kurs-base', function() {
            addKurs(this);
        });
    }
    
    // Qabul tanlash
    function selectRecieve(recieveId) {
        window.location.href = `{% url 'recieve' %}?active=${recieveId}`;
    }
    
    // Qabul yaratish
    function createRecieve() {
        const formData = {
            name: $('#createRecieveForm input[name="name"]').val(),
            deliver: $('#createRecieveForm select[name="deliver"]').val(),
            filial: $('#createRecieveForm select[name="filial"]').val(),
            valyuta: $('#createRecieveForm select[name="valyuta"]').val(),
            kurs: $('#createRecieveForm input[name="kurs"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'recieve_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createRecieveModal').modal('hide');
                    setTimeout(() => {
                        window.location.href = `{% url 'recieve' %}?active=${response.recieve_id}`;
                    }, 1000);
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Qabulni o'chirish
    function deleteRecieve(recieveId) {
        if (!confirm('Haqiqatan ham bu qabulni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${recieveId}/delete/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'recieve' %}";
                    }, 1000);
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Yetkazib beruvchi yaratish
    function createDeliver() {
        const formData = {
            name: $('#createDeliverForm input[name="name"]').val(),
            phone1: $('#createDeliverForm input[name="phone1"]').val(),
            phone2: $('#createDeliverForm input[name="phone2"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'deliver_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createDeliverModal').modal('hide');
                    $('#createRecieveForm select[name="deliver"]').append(
                        `<option value="${response.deliver.id}">${response.deliver.name}</option>`
                    );
                    $('#createDeliverForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim turi yaratish
    function createExpenseType() {
        const formData = {
            name: $('#createExpenseTypeForm input[name="name"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'recieve_expense_type_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createExpenseTypeModal').modal('hide');
                    // Yangi chiqim turini select ga qo'shish
                    $('#addExpenseForm select[name="type"]').append(
                        `<option value="${response.expense_type.id}">${response.expense_type.name}</option>`
                    );
                    $('#createExpenseTypeForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Tez qo'shish funksiyasi
    function addRecieveItemQuick(product_id = null, quantity = null) {
        if (product_id) {
            $('#product-select')[0].selectize.setValue(product_id);
            $('#quantity-input').val(quantity);
            $('#product-submit-btn').trigger('click');
            // $('#quick-add-form').submit();
            return
        }

        if (!currentRecieveId) {
            showAlert('Iltimos, avval qabulni tanlang!', 'warning');
            return;
        }

        // Agar qiymatlar berilmagan bo'lsa inputlardan olinadi
        const finalProductId = product_id ?? $('#product-select').val();
        const finalQuantity   = quantity ?? $('#quantity-input').val();

        const formData = {
            product_id: finalProductId,
            quantity: finalQuantity,
            bring_prices: getBringPrices(),
            sell_prices: getSellPrices()
        };

        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${currentRecieveId}/items/add/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                    $('#price-fields').hide();

                    $('#quantity-input').val('');
                    const selectize = $('#product-select')[0].selectize;
                    if (selectize) {
                        selectize.setValue('');
                    }

                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulotni tahrirlash - YANGILANDI (narxlar bilan)
    function editItem(itemId) {
        const row = $(`#item-${itemId}`);
        const currentQuantity = row.find('td').eq(3).text().replace(/,/g, '');
        const currentBringPrice = row.find('td').eq(2).text().replace(/,/g, '');
        
        // Mahsulot ma'lumotlarini olish
        const productName = row.find('td').eq(1).text();
        const productId = getProductIdByName(productName);
        
        // Tahrirlash formasi
        const editForm = `
            <tr id="edit-item-${itemId}" class="edit-form">
                <td colspan="10">
                    <form id="edit-item-form-${itemId}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Yangi miqdor</label>
                                    <input type="number" step="0.001" class="form-control" 
                                           id="edit-quantity-${itemId}" value="${currentQuantity}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Kelish narxi (So'm)</label>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="edit-bring-price-${itemId}" value="${currentBringPrice}" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-success btn-block" 
                                            onclick="saveItemEdit(${itemId})">
                                        <i class="fas fa-save"></i> Saqlash
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary btn-block" 
                                            onclick="cancelItemEdit(${itemId})">
                                        <i class="fas fa-times"></i> Bekor
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">Mahsulot: ${productName}</small>
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
        `;
        
        row.after(editForm);
        row.hide();
    }
    
    // Mahsulot ID sini nomi orqali olish
    function getProductIdByName(productName) {
        let productId = null;
        $('#product-select option').each(function() {
            if ($(this).text() === productName) {
                productId = $(this).val();
                return false;
            }
        });
        return productId;
    }
    
    // Mahsulot tahririni saqlash - YANGILANDI
    function saveItemEdit(itemId) {
        const newQuantity = $(`#edit-quantity-${itemId}`).val();
        const newBringPrice = $(`#edit-bring-price-${itemId}`).val();
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/items/${itemId}/update/`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                quantity: newQuantity,
                bring_price: newBringPrice
            }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                    cancelItemEdit(itemId);
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                cancelItemEdit(itemId);
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulot tahririni bekor qilish
    function cancelItemEdit(itemId) {
        $(`#edit-item-${itemId}`).remove();
        $(`#item-${itemId}`).show();
    }
    
    // Chiqimni tahrirlash
    function editExpense(expenseId) {
        const row = $(`#expense-${expenseId}`);
        const currentSumma = row.find('td').eq(1).text().replace(/,/g, '');
        const currentComment = row.find('td').eq(4).text();
        
        const editForm = `
            <tr id="edit-expense-${expenseId}" class="edit-form">
                <td colspan="6">
                    <form id="edit-expense-form-${expenseId}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Yangi summa</label>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="edit-summa-${expenseId}" value="${currentSumma}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Yangi izoh</label>
                                    <input type="text" class="form-control" 
                                           id="edit-comment-${expenseId}" value="${currentComment}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-success btn-block" 
                                            onclick="saveExpenseEdit(${expenseId})">
                                        <i class="fas fa-save"></i> Saqlash
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary btn-block" 
                                            onclick="cancelExpenseEdit(${expenseId})">
                                        <i class="fas fa-times"></i> Bekor
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
        `;
        
        row.after(editForm);
        row.hide();
    }
    
    // Chiqim tahririni saqlash
    function saveExpenseEdit(expenseId) {
        const newSumma = $(`#edit-summa-${expenseId}`).val();
        const newComment = $(`#edit-comment-${expenseId}`).val();
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/expenses/${expenseId}/update/`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                summa: newSumma,
                comment: newComment
            }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                    cancelExpenseEdit(expenseId);
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                cancelExpenseEdit(expenseId);
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim tahririni bekor qilish
    function cancelExpenseEdit(expenseId) {
        $(`#edit-expense-${expenseId}`).remove();
        $(`#expense-${expenseId}`).show();
    }
    
    // Mahsulotni o'chirish
    function deleteItem(itemId) {
        if (!confirm('Haqiqatan ham bu mahsulotni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/items/${itemId}/remove/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqimni o'chirish
    function deleteExpense(expenseId) {
        if (!confirm('Haqiqatan ham bu chiqimni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/expenses/${expenseId}/delete/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim qo'shish
    function addExpense() {
        if (!currentRecieveId) {
            showAlert('Iltimos, avval qabulni tanlang!', 'warning');
            return;
        }
        
        const formData = {
            type: $('#addExpenseForm select[name="type"]').val(),
            summa: $('#addExpenseForm input[name="summa"]').val(),
            valyuta: $('#addExpenseForm select[name="valyuta"]').val(),
            externaluser: $('#addExpenseForm select[name="externaluser"]').val(),
            comment: $('#addExpenseForm textarea[name="comment"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${currentRecieveId}/expenses/add/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#addExpenseModal').modal('hide');
                    updateRecieveData();
                    $('#addExpenseForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Ma'lumotlarni yangilash
    function updateRecieveData() {
        if (!currentRecieveId) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `{% url 'recieve' %}?active=${currentRecieveId}`,
            type: 'GET',
            success: function(data) {
                const $newContent = $(data).find('#recieve-detail').html();
                $('#recieve-detail').html($newContent);

                setTimeout(() => {
                    const select = $('#product-select')[0];
                    if (select) {
                        // Avvalgi selectize instanceni o'chirish
                        if (select.selectize) {
                            select.selectize.destroy();
                        }
                        // Yangi selectize ishga tushirish
                        selectize_input('#product-select');
                    }
                }, 100);

                $('#loading').hide();
            },
            error: function() {
                showAlert('Ma\'lumotlarni yangilashda xatolik!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulot narxlarini yuklash
    function loadProductPrices(productId) {
        $('#loading').show();
        
        $.ajax({
            url: `/products/${productId}/prices/`,
            type: 'GET',
            success: function(response) {
                renderPriceFields(response);
                $('#loading').hide();
            },
            error: function() {
                showAlert('Narxlarni yuklashda xatolik!', 'error');
                $('#loading').hide();
            }
        });
    }
  

    function renderPriceFields(data) {
        let html = '<div class="row mt-3"><div class="col-12"><h6>Narxlar</h6></div>';
        
        // Kelish narxlari
        html += '<div class="col-md-6"><h6 class="text-primary">Kelish narxlari</h6>';
        data.bring_prices.forEach(function(price) {
            html += `
                <div class="form-group">
                    <label>${price.valyuta}</label>
                    <input oninput="calculate(this)" type="number" step="0.01" class="form-control bring-price-input" 
                        data-valyuta="${price.valyuta_id}" 
                        data-is_som="${price.is_som}" 
                        data-is_dollar="${price.is_dollar}" 
                        value="${price.price}">
                </div>
            `;
        });
        html += '</div>';
        
        // Sotish narxlari
        html += '<div class="col-md-6"><h6 class="text-success">Sotish narxlari</h6>';
        data.sell_prices.forEach(function(row, index) {
            html += `<div class="form-group">`;
            row.summas.forEach(function(summa, sumIndex) {
                html += `
                    <label>${summa.name} (${row.valuta})</label>
                    <input oninput="calculate(this)" type="number" step="0.01" class="form-control sell-price-input mb-2" 
                        data-price-key="price_${summa.id}_${row.valyuta_id}"  data-price_type_id="${summa.price_type_id}"
                        data-is_som="${row.is_som}" 
                        data-is_dollar="${row.is_dollar}"
                        value="${summa.summa}">
                `;
            });
            html += '</div>';
        });
        html += '</div></div>';
        
        $('#price-fields').html(html).show();
    }

    // Yoki event delegation bilan (afzal)
    $(document).on('input', '.bring-price-input, .sell-price-input', function() {
        calculate(this);
    });


    
    // Yordamchi funksiyalar
    function getBringPrices() {
        const prices = {};
        $('.bring-price-input').each(function() {
            const valyutaId = $(this).data('valyuta');
            prices[valyutaId] = $(this).val();
        });
        return prices;
    }
    
    function getSellPrices() {
        const prices = {};
        $('.sell-price-input').each(function() {
            const priceKey = $(this).data('price-key');
            prices[priceKey] = $(this).val();
        });
        return prices;
    }
    
    function showAlert(message, type) {
        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type} alert-dismissible fade show`;
        alertElement.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertElement.style.zIndex = '10000000';
        alertElement.style.position = 'relative';

        
        document.getElementById('alert-container').appendChild(alertElement);
        
        setTimeout(() => {
            alertElement.remove();
        }, 3000);
    }
</script>


<script>
    // Maxsulot qidiruv funksiyasi
function initProductSearch() {
    const searchInput = document.getElementById('product-search');
    const productItems = document.querySelectorAll('.product-item');
    
    if (searchInput && productItems.length > 0) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let foundItems = 0;
            
            productItems.forEach(item => {
                const productName = item.getAttribute('data-product-name');
                if (productName.includes(searchTerm)) {
                    item.style.display = 'block';
                    foundItems++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // "Topilmadi" xabarini ko'rsatish/yashirish
            handleNoResultsMessage(searchTerm, foundItems);
        });
        
        console.log('Maxsulot qidiruv tizimi ishga tushdi');
    }
}

// "Topilmadi" xabarini boshqarish
function handleNoResultsMessage(searchTerm, foundItems) {
    const productsList = document.getElementById('products-list');
    const existingMessage = productsList.querySelector('.no-results-message');
    
    if (searchTerm && foundItems === 0) {
        // Topilmagan xabarini ko'rsatish
        if (!existingMessage) {
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'no-results-message text-center text-muted p-4';
            noResultsDiv.innerHTML = `
                <div class="mb-2">
                    <i class="fas fa-search fa-2x text-muted"></i>
                </div>
                <p class="mb-1 font-weight-bold">"${searchTerm}" topilmadi</p>
                <small>Boshqa so'z yoki imloni tekshiring</small>
            `;
            productsList.appendChild(noResultsDiv);
        }
    } else {
        // Topilmagan xabarini olib tashlash
        if (existingMessage) {
            existingMessage.remove();
        }
    }
}

// Qidiruvni tozalash funksiyasi
function clearProductSearch() {
    const searchInput = document.getElementById('product-search');
    if (searchInput) {
        searchInput.value = '';
        
        // Barcha maxsulotlarni ko'rsatish
        const productItems = document.querySelectorAll('.product-item');
        productItems.forEach(item => {
            item.style.display = 'block';
        });
        
        // "Topilmadi" xabarini olib tashlash
        const existingMessage = document.querySelector('.no-results-message');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
}

// Sahifa yuklanganda qidiruvni ishga tushirish
document.addEventListener('DOMContentLoaded', function() {
    initProductSearch();
});

// Agar tab o'zgarsa, qidiruvni qayta ishga tushirish
$(document).ready(function() {
    // Products tab ochilganda qidiruvni faollashtirish
    $('#products-tab').on('shown.bs.tab', function() {
        setTimeout(function() {
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.focus();
            }
        }, 100);
    });
});
</script>
{% endblock %}