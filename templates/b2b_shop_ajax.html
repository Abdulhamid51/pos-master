{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load mathfilters %}
{% block title %}
{% load custom_filters %}

    <title>Product </title>
{% endblock title %}
{% block css %}
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link href="{% static 'bootstrap/css/bootstrap.min.css'%}" rel="stylesheet" type="text/css" />
    <link href="{% static 'assets/css/plugins.css'%}" rel="stylesheet" type="text/css" />
        
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/datatables.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/custom_dt_html5.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/dt-global_style.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .line {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #071af2;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            width: 30rem;
        }
    </style>
    <style>
        .tab {
            display: flex;
            gap: 10px;
            /* border-bottom: 2px solid #ddd; */
            margin-bottom: 10px;
        }
        .tab button {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
        }
        .tab button.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        .tab button:hover {
            color: #0056b3;
        }
        .document {
            display: none;
        }
    </style>
      <style>
        .delete-btn {
              color: red;
              cursor: pointer;
              font-weight: bold;
              transition: transform 0.2s ease;
          }
          .delete-btn:hover {
              transform: scale(1.2);
              color: darkred;
          }
  </style>
   <style>
    .document h2 {
        margin-bottom: 25px;
        color: #333;
        font-size: 24px;
        border-bottom: 2px solid #007bff;
        display: inline-block;
        padding-bottom: 5px;
    }
    .document label {
        color: black !important;
    }
    .document input {
        border: 1px solid black;
    }
    .document .total {
        font-size: 18px;
        font-weight: bold;
        background-color: #f0f0f0;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-bottom: 20px;
        }
</style>
{% endblock css %}
{% block content %}
        <meta name="csrf-token" content="{{ csrf_token }}">
        <div id="content" class="main-content">
            <div class="layout-px-spacing">
                <div class="row layout-top-spacing" id="cancel-row">
                    <div class="col-lg-12">
                        <div id="alert-container"></div>
                        <div class="statbox widget box box-shadow">
                            <div class="widget-content widget-content-area">
                                <div class="row">
                                        <div class="col-md-12">
                                            <form action="">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="row">
                                                            <div class="col-md-2">
                                                                <br>
                                                                <button class="btn btn-warning" style="border: 1px solid silver !important; width: 100%; margin-top: 10px;">
                                                                    <a href="{% url 'shop_nakladnoy' product_id %}" target="_blank" rel="noopener noreferrer" style="color:white !important;">Печать ▼</a> 
                                                                </button>
                                                            </div>
                                                            <!-- <div class="col-md-2">
                                                                <br>
                                                               
                                                                <button class="btn btn-primary" data-toggle="modal" data-target="#exampleModalTolov"  data-whatever="@mdo" type="button" style="border: 1px solid silver !important; width: 100%; margin-top: 10px;">
                                                                    Tolov
                                                                </button>
                                                            </div> -->
                                                            <div class="col-md-2">
                                                                <label for="">Отгрузка №</label>
                                                                <input type="text" style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; text-align: center;" value="{{ shop.id }}">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label for="">От</label>
                                                                <input type="datetime-local" value="{{today|date:'Y-m-d H:i'}}" style="border: 1px solid #ddd; border-radius: 5px; padding: 5px; width: 100%;" id="shop_input_date">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Колл-центр</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_select_call_center">
                                                                    <option value="" disabled selected>Колл-центр</option>
                                                                    {% for i in call_center %}
                                                                    <option value="{{i.id}}"   {% if i == shop.saler %} selected {% endif %}>{{ i.first_name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Склад</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" id="shop_select_filial">
                                                                    <option value="">Выберите склад</option>
                                                                    {% for i in filial %}
                                                                    <option value="{{i.id}}" {% if  i == shop.filial %} selected {% endif %}>{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                         
                                                            <div class="col-md-12"><br></div>
                                                            <div class="col-md-2">
                                                                <label>* Контрагент</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_customer">
                                                                    <option value="">Выберите контрагента</option>
                                                                    {% for i in customer %}
                                                                    <option value="{{i.id}}" {% if shop.debtor == i %} selected {% endif %}>{{ i.fio }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Договор</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_contract">
                                                                    <option value="">Выберите договор</option>
                                                                    {% for i in contract %}
                                                                    <option value="{{i.id}}" {% if shop.contract == i %} selected {% endif %}>{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Тип</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_select_is_savdo">
                                                                    <option value="True"> {% if shop.is_savdo %} Sotuv {% else%} Mijozdan Qaytuv {% endif %} </option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Валюта</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_valyuta">
                                                                    {% for i in valyuta %}
                                                                    <option value="{{i.id}}" {% if shop.valyuta == i %} selected {% endif %}>{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Тип цены</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_select_type_price">
                                                                    <option value="" selected disabled>Выберите Тип цены</option>
                                                                    {% for i in price_type %}
                                                                        <option value="{{i.id}}" {% if shop.type_price == i %} selected {% endif %}>{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>* Дата платежа</label>
                                                                <input type="date" value="{{today|date:'Y-m-d'}}" style="border: 1px solid #ddd; border-radius: 5px; padding: 5px; width: 100%;" id="shop_input_payment_date">

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-12"><br><br><br></div>
                                      
                                        
                                        <div class="col-md-12">
                                            <div class="tab">
                                                <button class="active" onclick="switchTab(event)">Главная</button>
                                                <button onclick="switchTab(event)">Оплата</button>
                                            </div>
                                            <div class="row home">
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        <div class="col-md-2">
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%;">
                                                                <option>Наименование</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1"></div>
                                                        <div class="col-md-2">
                                                            <h6>Пакет</h6>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <h6>Kол-ва</h6>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <h6>Остаток </h6>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%;">
                                                                <option>Цена</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2" style="display: flex; gap: 7px;">
                                                            <label for=""></label>
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%; height: 24px;">
                                                                <option>Скидка </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <select style="border: 1px solid #ffffff;border-radius: 4px; width: 100%;">
                                                                <option>Сумма</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-12"><div class="line" ></div></div>
                                              
                                                <div id="product_list" class="col-md-12">
                                                    
                                                    {% for i in carts %}
                                                    <div class="row">
                                                        <div class="col-md-2"><p class="product_name">{{ i.product.name }}</p></div>
                                                        <div class="col-md-1"><p style='display:none;' class="id_product" data-un="ok">{{i.product.id}}</p></div>
                                                        <div class="col-md-2"><input type="number" data-pack="{{ i.total_pack|comma_to_dot }}" onkeyup="calculate_pack(this)" step="any" value="{{ i.total_pack }}" name="pack" onchange="pushData(this)"></div>
                                                        <div class="col-md-2"><input type="number" value="{{ i.quantity|comma_to_dot }}" onkeyup="calculate_pack(this)" name="quantity"  onchange="pushData(this)"></div>
                                                        <div class="col-md-1"><h6 class="ostatok" data-original="{{i.product.quantity|comma_to_dot}}">{{i.product.quantity|comma_to_dot}}</h6></div>
                                                        <div class="col-md-1"><p class="price_product_list">{{i.price}}</p></div>
                                                        <div class="col-md-2" style="display: flex; gap: 7px;">
                                                            <label for=""></label>
                                                            <input type="text"  class="skidka_input" placeholder="Скидка" oninput="pushData(this)" value="{{i.skidka_total}}" style="height:22px">
                                                        </div>
                                                        <div class="col-md-1" style="display:flex; gap:15px;" >
                                                            <h6 class="summa_product_list">{{ i.total }}</h6>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-12">
                                                    <form action="">
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <div class="input-group">
                                                                    <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_product">
                                                                        <option value="">Добавить позицию — введите наименование, код, штрихкод или артикул</option>
                                                                        {% for i in product %}
                                                                            <option value="{{ i.id }}|{{ i.price_ty }}|{{ i.quantity }}|{{i.pack}}">{{ i.name }} - {{ i.get_season_display|default_if_none:'' }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    <div class="input-group-append">
                                                                        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#new_product_add">+</button>
                                                                    </div>
                                                                </div>
                                                                <br>
                                                                <h6 id="query_select_product_name"></h6>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <button type="button" class="btn btn-success exampleModal_modal" data-toggle="modal" data-target="#exampleModal"  data-whatever="@mdo" style="display: none;">+</button>
                                                            </div>
                                                            <div class="col-md-1">
                                                                <!-- <button class="btn-light" type="button">Остатки</button> -->
                                                            </div>
                                                            <div class="col-md-2"></div>
                                                            <div class="col-md-2">
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                              
                                                
                                                <div class="col-md-12">
                                                    <div class="line"></div>
                                                </div>
                                                <div class="col-md-12">
                                                    <br>
                                                    <div class="row">
                                                        <div class="col-md-7">
                                                            <textarea name="" style="width: 100%;" placeholder="Комментарий" rows="5" id="shop_textarea">{{ shop.comment }}</textarea>

                                                            <!-- <button class="btn btn-success" id="shop_save" type="button">Savdoni yakunlash</button> -->
                                                        </div>
                                                        <div class="col-md-5">
                                                            <div class="row">
                                                                <div class="col-md-8">
                                                                    <h3 style="font-weight: bold;">Итого:</h3>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <h4 style="font-weight: bold;" id="summa_itog"></h4>
                                                                    <p style="display: none;" id="shop_last_kurs">{{kurs}}</p>
                                                                    <p>0</p>
                                                                </div>
    
                                                                <div class="col-md-8">
                                                                    <label><input type="checkbox" id="nds_checkbox" onchange="addNDS()"> НДС:</label><br>
                                                                    <label><input type="checkbox" onchange="addItogNDS(this)"> Цена включает НДС</label>
                                                                </div>
                                                               
                                                                <div class="col-md-4">
                                                                    <p id="nds_p">0</p>
                                                                    <p id="nds_itog">0</p>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <br><br>
                                                                    <h6 id="summa_col">Koл-вo: </h6>
                                                                    <div class="line"></div>
                                                                </div>
    
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                              
                                            </div>
                                            <div class="row document">
                                                <div class="col-md-12">
                                                    <h2>To‘lovni amalga oshirish</h2>
                                                    <br>
                                                </div>
                                               
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        <script>
                                                            function formatNumber(num) {
                                                                const number = typeof num === 'string' ? parseFloat(num.replace(/\s/g, '').replace(',', '.')) : num;
                                                                return number.toLocaleString('fr-FR', {maximumFractionDigits: 0});
                                                            }
                                                            function updateReceiptProducts() {
                                                                const productList = document.getElementById('product_list');
                                                                const receiptContainer = document.getElementById('chek_products');
                                                                
                                                                receiptContainer.innerHTML = '';
                                                                let summaItog = 0;
                                                                let oraliq_jami = 0;
                                                                let chegirma = 0;
                                                                
                                                                const productRows = productList.querySelectorAll('.row');
                                                                
                                                                productRows.forEach(row => {
                                                                    const productName = row.querySelector('.product_name').textContent;
                                                                    const quantityInput = row.querySelector('input[name="quantity"]');
                                                                    const quantity = quantityInput ? quantityInput.value : row.querySelector('h6').textContent;
                                                                    
                                                                    const priceText = row.querySelector('.price_product_list').textContent;
                                                                    const skidkaInput = row.querySelector('.skidka_input');
                                                                    const skidka = skidkaInput ? skidkaInput.value : row.querySelector('div.col-md-2').textContent.trim();
                                                                    
                                                                    const price = parseFloat(priceText.replace(/\s/g, '').replace(',', '.')) || 0;
                                                                    const qty = parseFloat(quantity.replace(/\s/g, '').replace(',', '.')) || 0;
                                                                    const discount = parseFloat(skidka.replace(/\s/g, '').replace(',', '.')) || 0;
                                                                    console.log(priceText)
                                                                    const totalWithoutDiscount = price * qty;
                                                                    const totalWithDiscount = totalWithoutDiscount - discount;
                                                                    summaItog += totalWithDiscount;
                                                                    oraliq_jami += totalWithoutDiscount;
                                                                    chegirma += discount;
                                                                    
                                                                    const formattedPrice = formatNumber(price);
                                                                    console.log(formattedPrice, '1111')

                                                                    const formattedQuantity = formatNumber(qty);
                                                                    const formattedTotal = formatNumber(totalWithDiscount);
                                                                    const formattedDiscount = discount ? formatNumber(discount) : '';
                                                                    const formattedTotalWithoutDiscount = formatNumber(totalWithoutDiscount);
                                                                    
                                                                    const receiptItem = `
                                                                        <div class="section">
                                                                            <div class="item-title">${productName}</div>
                                                                            <div class="lines">
                                                                                <span>${formattedQuantity} × ${formattedPrice}</span>
                                                                                <span>${formattedTotalWithoutDiscount} UZS</span>
                                                                            </div>
                                                                            ${discount ? `
                                                                            <div class="subline">
                                                                                <span>⛓ Chegirma ${formattedDiscount}</span>
                                                                                <span>${formattedTotal} UZS</span>
                                                                            </div>` : ''}
                                                                        </div>
                                                                    `;
                                                                    
                                                                    receiptContainer.insertAdjacentHTML('beforeend', receiptItem);
                                                                });
                                                                
                                                                const formattedSumma = formatNumber(summaItog);
                                                                const formattedoraliq_jami = formatNumber(oraliq_jami);
                                                                const formattedchegirma = formatNumber(chegirma);
                                                                
                                                                const totalJami = document.getElementById('chek_total_jami');
                                                                const oraliqjami = document.getElementById('chek_oraliq_jami');
                                                                const totalchegirma = document.getElementById('chek_chegirma');
                                                                const total_jami = document.getElementById('total_jami');
                                                                
                                                                if (totalJami) {
                                                                    totalJami.textContent = `${formattedSumma} UZS`;
                                                                    total_jami.textContent = `${formattedSumma} UZS`;
                                                                }
                                                                if (oraliqjami) {
                                                                    oraliqjami.textContent = `${formattedoraliq_jami} UZS`;
                                                                }
                                                                if (totalchegirma) {
                                                                    totalchegirma.textContent = `${formattedchegirma} UZS`;
                                                                }
                                                                
                                                                const mainTotalElement = document.getElementById('summa_itog');
                                                                if (mainTotalElement) {
                                                                    mainTotalElement.textContent = formattedSumma;
                                                                }
                                                                
                                                                return summaItog;
                                                            }

                                                           

                                                            const paymentSystem = {
                                                                totalJami: 0,
                                                                totalToPay: 0,
                                                                paymentMethods: {},
                                                                modalInstance: null,
                                                                
                                                                init: function() {
                                                                    this.totalJami = updateReceiptProducts();
                                                                    this.totalToPay = this.totalJami;
                                                                    
                                                                    document.querySelectorAll('.payment-method').forEach(method => {
                                                                        const methodName = method.querySelector('p').textContent.trim();
                                                                        this.paymentMethods[methodName] = 0;
                                                                    });
                                                                    
                                                                    this.paymentMethods['Qarz'] = 0;
                                                                    
                                                                    this.setupEventListeners();
                                                                    this.initModal();
                                                                    this.updatePaymentDisplay();
                                                                    this.updateTolashText();
                                                                },
                                                                
                                                                initModal: function() {
                                                                    const qarzModal = document.getElementById('qarzModal');
                                                                    if (!qarzModal) return;
                                                                    
                                                                    this.modalInstance = new bootstrap.Modal(qarzModal);
                                                                    const summaInput = qarzModal.querySelector('input[type="number"]');
                                                                    const qarzButton = qarzModal.querySelector('.btn-primary');
                                                                    const cancelButton = qarzModal.querySelector('.btn-danger');
                                                                    
                                                                    qarzModal.addEventListener('show.bs.modal', () => {
                                                                        summaInput.value = this.paymentMethods['Qarz'] || this.totalToPay;
                                                                        summaInput.select();
                                                                    });

                                                                    qarzButton.addEventListener('click', () => {
                                                                        const summa = parseFloat(summaInput.value) || 0;
                                                                        
                                                                        if (summa > 0) {
                                                                            if (this.addCreditPayment(summa)) {
                                                                                this.modalInstance.hide();
                                                                                document.querySelector('[data-bs-dismiss="modal"]').click();
                                                                            }
                                                                        } else {
                                                                            showAlert("Iltimos, to'g'ri summa kiriting!", "success");
                                                                            summaInput.focus();
                                                                        }
                                                                    });
                                                                    
                                                                    cancelButton.addEventListener('click', () => {
                                                                        if (this.paymentMethods['Qarz'] > 0) {
                                                                            this.totalToPay += this.paymentMethods['Qarz'];
                                                                            this.paymentMethods['Qarz'] = 0;
                                                                            this.updatePaymentDisplay();
                                                                            this.updateTolashText();
                                                                        }
                                                                        this.modalInstance.hide();
                                                                    });
                                                                },
                                                                
                                                                showInputBox: function(button) {
                                                                    const methodBox = button.closest('.payment-method');
                                                                    const inputBox = methodBox.querySelector('.input-box');
                                                                    if (inputBox) {
                                                                        inputBox.style.display = 'block';
                                                                        inputBox.querySelector('input').focus();
                                                                    }
                                                                },
                                                                    
                                                                removeBox: function(button) {
                                                                    const inputBox = button.closest('.input-box');
                                                                    if (!inputBox) return;

                                                                    const input = inputBox.querySelector('input');
                                                                    const methodName = inputBox.querySelector('.box-header span').textContent.trim();
                                                                    const value = parseFloat(input.value) || 0;
                                                                    
                                                                    if (this.paymentMethods[methodName] !== undefined) {
                                                                        this.totalToPay += this.paymentMethods[methodName];
                                                                        this.paymentMethods[methodName] = 0;
                                                                    }

                                                                    input.value = '';
                                                                    inputBox.style.display = 'none';
                                                                    
                                                                    this.updatePaymentDisplay();
                                                                    this.updateTolashText();
                                                                },
                                                                
                                                                updateTolash: function(input) {
                                                                    const inputBox = input.closest('.input-box');
                                                                    const methodName = inputBox.querySelector('.box-header span').textContent.trim();
                                                                    const value = parseFloat(input.value) || 0;
                                                                    
                                                                    const previousValue = this.paymentMethods[methodName] || 0;
                                                                    const difference = value - previousValue;
                                                                    
                                                                    this.paymentMethods[methodName] = value;
                                                                    this.totalToPay -= difference;
                                                                    
                                                                    this.updatePaymentDisplay();
                                                                    this.updateTolashText();
                                                                },
                                                                
                                                                updateTolashText: function() {
                                                                    const tolashEl = document.getElementById('tolash_summasi');
                                                                    if (tolashEl) {
                                                                        tolashEl.textContent = formatNumber(this.totalToPay) + ' UZS';
                                                                    }
                                                                },
                                                                
                                                                updatePaymentDisplay: function() {
                                                                    const paymentContainer = document.getElementById('check_tolovlar');
                                                                    paymentContainer.innerHTML = '';
                                                                    
                                                                    let totalPaid = 0;
                                                                    
                                                                    for (const [methodName, amount] of Object.entries(this.paymentMethods)) {
                                                                        if (amount > 0) {
                                                                            const paymentLine = document.createElement('div');
                                                                            paymentLine.className = 'lines';
                                                                            
                                                                            if (methodName === 'Qarz') {
                                                                                paymentLine.classList.add('qarz-row');
                                                                            }
                                                                            
                                                                            paymentLine.innerHTML = `
                                                                                <span>${methodName}</span>
                                                                                <span>${formatNumber(amount)} UZS</span>
                                                                            `;
                                                                            paymentContainer.appendChild(paymentLine);
                                                                            totalPaid += amount;
                                                                        }
                                                                    }
                                                                },
                                                                
                                                                setupEventListeners: function() {
                                                                    document.querySelectorAll('.payment-input').forEach(input => {
                                                                        input.addEventListener('input', (e) => this.updateTolash(e.target));
                                                                    });
                                                                    
                                                                    document.querySelectorAll('.toggle-input').forEach(button => {
                                                                        button.addEventListener('click', (e) => this.showInputBox(e.target));
                                                                    });
                                                                    
                                                                    document.querySelectorAll('.remove-field').forEach(button => {
                                                                        button.addEventListener('click', (e) => this.removeBox(e.target));
                                                                    });
                                                                },
                                                                
                                                                addCreditPayment: function(amount) {
                                                                    if (amount > 0 && amount <= this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                                                        if (this.paymentMethods['Qarz'] > 0) {
                                                                            this.totalToPay += this.paymentMethods['Qarz'];
                                                                        }
                                                                        
                                                                        this.paymentMethods['Qarz'] = amount;
                                                                        this.totalToPay -= amount;
                                                                        this.updatePaymentDisplay();
                                                                        this.updateTolashText();
                                                                        return true;
                                                                    } else if (amount > this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                                                        showAlert("Qarz summasi qolgan summadan katta bo'lishi mumkin emas!", "warning");
                                                                        return false;
                                                                    }
                                                                    return false;
                                                                },
                                                                
                                                                submitPayments: function(shopId) {
                                                                    const paymentInputs = document.querySelectorAll('.input-box:not([style*="display: none"]) .payment-input');
                                                                    const qarzPayment = this.paymentMethods['Qarz'] || 0;
                                                                    const qarzComment = document.querySelector('#qarzModal textarea') ? document.querySelector('#qarzModal textarea').value : '';
                                                                    const qarzDueDate = document.querySelector('#qarzModal input[type="date"]') ? document.querySelector('#qarzModal input[type="date"]').value : '';
                                                                    let payments = [];
                                                                    
                                                                    paymentInputs.forEach(input => {
                                                                        const inputBox = input.closest('.input-box');
                                                                        const paymentMethod = inputBox.closest('.payment-method');
                                                                        const kassaId = paymentMethod.dataset.kassaId;
                                                                        const valyutaId = paymentMethod.dataset.valyutaId;
                                                                        const methodText = inputBox.querySelector('.box-header span').textContent.trim();
                                                                        const summa = parseFloat(input.value) || 0;
                                                                        
                                                                        if (summa > 0) {
                                                                            payments.push({
                                                                                kassa_id: kassaId,
                                                                                valyuta_id: valyutaId,
                                                                                summa: summa,
                                                                                comment: ''
                                                                            });
                                                                        }
                                                                    });
                                                                    
                                                                    if (qarzPayment > 0) {
                                                                        if (!qarzDueDate) {
                                                                            showAlert("Iltimos, qarz uchun to'lov muddatini kiriting!", "warning");
                                                                            return false;
                                                                        }
                                                                        
                                                                        payments.push({
                                                                            kassa: 'qarz',
                                                                            valyuta: '',
                                                                            summa: qarzPayment,
                                                                            comment: qarzComment,
                                                                            payment_date: qarzDueDate
                                                                        });
                                                                    }
                                                                    
                                                                    const totalPaid = payments.reduce((sum, payment) => sum + payment.summa, 0);
                                                                    if (Math.abs(totalPaid - this.totalJami) > 1) {
                                                                        showAlert("To'lov summasi umumiy summagacha to'liq emas!", "danger");
                                                                        return false;
                                                                    }
                                                                    
                                                                    let successCount = 0;
                                                                    payments.forEach(payment => {
                                                                        const formData = new URLSearchParams();
                                                                        
                                                                        if (payment.kassa === 'qarz') {
                                                                            formData.append('kassa_id', 'qarz');
                                                                            formData.append('summa', payment.summa);
                                                                            formData.append('comment', payment.comment);
                                                                            formData.append('payment_date', payment.payment_date);
                                                                        } else {
                                                                            formData.append('kassa_id', payment.kassa_id);
                                                                            formData.append('valyuta_id', payment.valyuta_id);
                                                                            formData.append('summa', payment.summa);
                                                                        }
                                                                        
                                                                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                                                                        
                                                                        fetch(`/payment_shop/${shopId}`, {
                                                                            method: 'POST',
                                                                            headers: {
                                                                                'Content-Type': 'application/x-www-form-urlencoded',
                                                                                'X-CSRFToken': '{{ csrf_token }}'
                                                                            },
                                                                            body: formData
                                                                        })
                                                                        .then(response => response.json())
                                                                        .then(data => {
                                                                            if (data.success) {
                                                                                successCount++;
                                                                                if (successCount === payments.length) {
                                                                                    window.location.replace('/b2b_shop');
                                                                                }
                                                                            } else {
                                                                                throw new Error(data.message || "To'lovda xatolik yuz berdi");
                                                                            }
                                                                        })
                                                                        .catch(error => {
                                                                            console.error('Payment error:', error);
                                                                            alert(error.message);
                                                                        });
                                                                    });
                                                                    
                                                                    return true;
                                                                }
                                                            };

                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                // Initialize payment system
                                                                paymentSystem.init();

                                                                // Delete button handler
                                                                document.getElementById('product_list').addEventListener('click', function(e) {
                                                                    if (e.target.classList.contains('delete-btn')) {
                                                                        const row = e.target.closest('.row');
                                                                        if (row) {
                                                                            const row_quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                                                                            const total_row = parseNumber(row.querySelector('.summa_product_list').textContent.trim());
                                                                            const product_id = row.querySelector('.id_product').textContent.trim();
                                                                            
                                                                            let summaItog = document.getElementById('summa_itog');
                                                                            let oldValue = parseNumber(summaItog.textContent);
                                                                            const summaCol = document.getElementById('summa_col');

                                                                            if (total_row) {
                                                                                summaItog.textContent = (oldValue - (total_row)).toLocaleString('fr-FR');
                                                                            }

                                                                            if (row_quantity) {
                                                                                summaCol.textContent = (parseFloat(summaCol.textContent) - row_quantity).toFixed(0);
                                                                            }

                                                                            if (product_id) {
                                                                                const index = data.findIndex(item => item.product_id == product_id);
                                                                                data = data.filter(item => item.product_id !== product_id);
                                                                            }
                                                                            row.remove();
                                                                            const select = document.getElementById('shop_select_product');
                                                                            select.selectedIndex = 0;

                                                                            $.ajax({
                                                                                url: "{% url 'b2b_shop_ajax_cart_delete' product_id %}",
                                                                                type: "POST",
                                                                                data:JSON.stringify({'product_id':product_id}),
                                                                                headers: {
                                                                                    "X-CSRFToken": csrfToken
                                                                                },
                                                                                success: function(response) {
                                                                                    showAlert("Cart ochirildi!", "success");
                                                                                    updateReceiptProducts();
                                                                                    paymentSystem.init();
                                                                                },
                                                                                error: function() {
                                                                                    showAlert("Server bilan bog'lanishda xatolik1", "danger");
                                                                                }
                                                                            });
                                                                        }
                                                                    }
                                                                });

                                                                // Submit payment button
                                                                document.getElementById('submit-payment').addEventListener('click', function() {
                                                                    paymentSystem.submitPayments({{ shop.id }});
                                                                });
                                                            });

                                                            // Helper function to parse numbers
                                                            function parseNumber(text) {
                                                                return parseFloat(text.replace(/\s/g, '').replace(',', '.')) || 0;
                                                            }

                                                            // Add CSS for qarz row
                                                            const style = document.createElement('style');
                                                            style.textContent = `
                                                                .qarz-row {
                                                                    font-weight: bold;
                                                                    color: #dc3545;
                                                                    border-top: 1px dashed #ccc;
                                                                    border-bottom: 1px dashed #ccc;
                                                                    padding: 5px 0;
                                                                    margin: 5px 0;
                                                                    background-color: #fff3f3;
                                                                }
                                                                .qarz-row span {
                                                                    font-size: 14px;
                                                                }
                                                            `;
                                                            document.head.appendChild(style);
                                                            </script>
                                                        <div class="col-md-3">
                                                            <style>
                                                                .receipt-wrapper {
                                                                    width: 100%;
                                                                    background: #fff;
                                                                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                                                                    border-left: 1.8px solid rgba(192, 192, 192, 0.758);
                                                                    border-right: 1.8px solid rgba(192, 192, 192, 0.758);
                                                                    overflow: hidden; 
                                                                }

                                                                .zigzag {
                                                                    width: calc(100% + 3.6px);
                                                                    height: 15px;
                                                                    margin-left: -1.8px; 
                                                                    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 10" xmlns="http://www.w3.org/2000/svg"><polyline points="0,10 5,0 10,10 15,0 20,10 25,0 30,10 35,0 40,10 45,0 50,10 55,0 60,10 65,0 70,10 75,0 80,10 85,0 90,10 95,0 100,10" fill="white" stroke="lightgray" /></svg>') repeat-x;
                                                                    background-size: contain;
                                                                }
                                                                .receipt {
                                                                    padding: 20px;
                                                                    font-size: 13px;
                                                                    color: #000 !important;
                                                                }
                                                                .bold {
                                                                    font-weight: bold;
                                                                }
                                                                .lines {
                                                                    display: flex;
                                                                    justify-content: space-between;
                                                                    margin: 3px 0;
                                                                }
                                                                hr {
                                                                    border: none;
                                                                    border-top: 1px solid #bbb;
                                                                    margin: 8px 0;
                                                                    }
                                                                .section {
                                                                    margin-bottom: 8px;
                                                                    }
                                                                .barcode {
                                                                    height: 50px;
                                                                    width: 100%;
                                                                    background: repeating-linear-gradient(
                                                                        to right,
                                                                        #000 0px,
                                                                        #000 2px,
                                                                        #fff 2px,
                                                                        #fff 4px
                                                                    );
                                                                    margin: 15px 0;
                                                                }
                                                                .center {
                                                                    text-align: center;
                                                                    font-weight: bold;
                                                                    font-size: 14px;
                                                                }
                                                                .item-title {
                                                                    font-weight: bold;
                                                                    margin-bottom: 3px;
                                                                }
                                                                .subline {
                                                                    display: flex;
                                                                    justify-content: space-between;
                                                                    font-size: 12px;
                                                                    margin-left: 10px;
                                                                }
                                                                .qarz-row {
                                                                    font-weight: bold;
                                                                    color: #dc3545;
                                                                    border-top: 1px dashed #ccc;
                                                                    border-bottom: 1px dashed #ccc;
                                                                    padding: 5px 0;
                                                                    margin: 5px 0;
                                                                }
                                                            </style>
                                                            <div class="receipt-wrapper">
                                                                    <div class="zigzag"></div>
                                                                    <div class="receipt">
                                                                            <div class="section">
                                                                                <div class="lines"><span class="bold">Tranzaksiya:</span> <span>#{{ shop.id }}</span></div>
                                                                                <div class="bold">Store ecomarf-tekstil</div>
                                                                                <div class="lines"><span class="bold">Sana:</span> <span>{{today|date:'Y-m-d H:i'}}</span></div>
                                                                                <div class="lines"><span class="bold">Sotuvchi:</span> <span>{{ shop.debtor}}</span></div>
                                                                                <div class="bold">Maxsulotlar:</div>
                                                                            </div>
                                                                            <hr>
                                                                            <div id="chek_products">
                                                                            </div>
                                                                            <hr>
                                                                            <div class="section">
                                                                                <div class="lines"><span>Oraliq jami</span><span id="chek_oraliq_jami">0 UZS</span></div>
                                                                                <div class="lines"><span>Chegirma</span><span id="chek_chegirma">0 UZS</span></div>
                                                                                <div class="lines bold"><span>JAMI</span><span  id="chek_total_jami">0 UZS</span></div>
                                                                            </div>
                                                                            <div class="section" id="check_tolovlar">
                                                                            </div>
                                                                            <div class="barcode"></div>
                                                                            <div class="center">Xaridingiz uchun rahmat</div>
                                                                    </div>
                                                                    <div class="zigzag"></div>
                                                            </div>
                                                        </div>
                                                        <style>
                                                            .method-box {
                                                                display: flex;
                                                                gap: 10px;
                                                                align-items: center;
                                                                padding: 10px;
                                                                background-color: white !important;
                                                                border-radius: 5px;
                                                                box-shadow: 2px 5px 5px rgba(0,0,0,0.1) !important;
                                                                transition: all 0.3s ease;
                                                                border: 1px solid rgba(0, 0, 0, 0.129) !important;
                                                            }
                                                            .method-box:hover {
                                                                box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                                                            }
                                                            .method-box i {
                                                                color: #007bff !important;
                                                                font-size: 1.2em;
                                                            }
                                                            .method-box p {
                                                                margin: 0;
                                                                flex-grow: 1;
                                                                font-weight: 500;
                                                            }
                                                            .toggle-input {
                                                                color: #007bff !important;
                                                                background-color: white !important;
                                                                border: 1px solid #ffffff !important;
                                                                width: 25px;
                                                                height: 25px;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                padding: 0;
                                                                cursor: pointer;
                                                                transition: all 0.2s ease;
                                                            }
                                                            .toggle-input i {
                                                                font-size: 1.2em;
                                                            }
                                                            .input-fields {
                                                                background-color: #f8f9fa;
                                                                padding: 15px;
                                                                border-radius: 5px;
                                                                margin-top: 10px;
                                                                box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
                                                            }
                                                            .remove-field {
                                                                cursor: pointer;
                                                                font-size: 1.8em;
                                                                color: #dc3545;
                                                                background: none;
                                                                border: none;
                                                            }
                                                            .payment-table {
                                                                width: 100%;
                                                                border-collapse: collapse;
                                                            }
                                                            .payment-table th, .payment-table td {
                                                                border: 1px solid #ddd;
                                                                padding: 8px;
                                                                text-align: left;
                                                            }
                                                            .payment-table th {
                                                                background-color: #f8f9fa;
                                                            }
                                                            .card-balance {
                                                                text-align: right;
                                                                margin-top: 10px;
                                                                font-style: italic;
                                                                color: #666;
                                                            }
                                                            .inputkassa {
                                                                margin-top: 20px;
                                                                border-top: 1px solid #eee;
                                                                padding-top: 20px;
                                                            }
                                                        </style>
                                                        <style>
                                                            .input-box {
                                                                border: 1px solid rgba(0, 0, 0, 0.401);
                                                                padding: 10px;
                                                                border-radius: 8px;
                                                                background-color: #fff;
                                                                margin-top: 10px;
                                                                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                                                                transition: border 0.3s ease;
                                                                position: relative;
                                                                z-index: 10;
                                                            }

                                                            .input-box:hover {
                                                                border: 1px solid #007bff !important;
                                                            }
                                                            .box-header {
                                                                display: flex;
                                                                justify-content: space-between;
                                                                align-items: center;
                                                                font-weight: bold;
                                                                padding-bottom: 8px;
                                                                border-bottom: 1px solid #ddd;
                                                            }

                                                            .box-body {
                                                                margin-top: 10px;
                                                            }

                                                            .payment-input {
                                                                width: 100%;
                                                                border: 1px solid rgba(0, 0, 0, 0.277) !important;
                                                            }
                                                        </style>
                                                        
                                                        <div class="col-md-9">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="row">
                                                                        <div class="col-md-3">
                                                                            <h6>Jami:</h6>
                                                                            <h5 id="total_jami" style="display: flex; font-weight: bold;">855 000 UZS</h5>
                                                                        </div>
                                                                        <div class="col-md-6"></div>
                                                                        <div class="col-md-3">
                                                                            <h6 style="color: green !important;">Tolash uchun:</h6>
                                                                            <h5 id="tolash_summasi" style="display: flex; font-weight: bold; color: green !important;">855 000 UZS</h5>
                                                                        </div>
                                                                    </div>
                                                                    <br>
                                                                    <br>
                                                                </div>
                                                                {% for mer in kassa %}
                                                                <div class="col-md-3 mb-3">
                                                                    <div class="payment-method" data-kassa-id="{{ mer.kassa.id }}" data-valyuta-id="{{ mer.valyuta.id }}">
                                                                        <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'">
                                                                            <i class="fa-solid fa-money-bill-wave"></i>
                                                                            <p>{{ mer.kassa.name }} ({{ mer.valyuta }})</p>
                                                                            <button class="toggle-input">
                                                                                <i class="fa-solid fa-plus"></i>
                                                                            </button>
                                                                        </div>
                                                                        <div class="input-box" style="display: none;">
                                                                            <div class="box-header">
                                                                                <span>{{ mer.kassa.name }} ({{ mer.valyuta }})</span>
                                                                                <button class="remove-field">&times;</button>
                                                                            </div>
                                                                            <div class="box-body">
                                                                                <input type="number" step="any" class="form-control payment-input" placeholder="Summani kiriting">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% endfor %}
                                                                <div class="col-md-3">
                                                                    <div class="method-box">
                                                                        <i class="fa-solid fa-money-bill-transfer"></i>
                                                                        <p>Qarzga</p>
                                                                        <button type="button" class="toggle-input" data-bs-toggle="modal" data-bs-target="#qarzModal">
                                                                            <i class="fa-solid fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="modal fade" id="qarzModal" tabindex="-1" aria-labelledby="qarzModalLabel" aria-hidden="true">
                                                                    <div class="modal-dialog modal-lg">
                                                                        <div class="modal-content p-4">
                                                                            <div class="modal-header">
                                                                                <h5 class="modal-title" id="qarzModalLabel">Yangi qarz</h5>
                                                                                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                                                                    <span aria-hidden="true">&times;</span>
                                                                                </button>
                                                                            </div>
                                                                            <div class="modal-body">
                                                                                <form>
                                                                                    <div class="row mb-3">
                                                                                        {% for i in customer_info.valyuta %}
                                                                                        <div class="col-4">
                                                                                            <label>Faol qarz ({{i.name}})</label>
                                                                                            <h6>{{ i.summa|intcomma }}</h6>
                                                                                        </div>
                                                                                        {% endfor %}
                                                                                        <div class="col-3">
                                                                                            <label>Oxirgi to'lov</label>
                                                                                            <h6>{{customer_info.last_pay|date:'Y-m-d'}}</h6>
                                                                                        </div>
                                                                                    </div>

                                                                                    <div class="mb-3">
                                                                                        <label>Mijoz</label>
                                                                                        <div class="input-group">
                                                                                        <span class="input-group-text"><i class="fa fa-user"></i></span>
                                                                                        <input type="text" class="form-control" value="{{shop.debtor}}" readonly 
                                                                                            style="border: 1px solid rgba(0, 0, 0, 0.214);font-weight: bold; background-color: #fff; opacity: 1; color: #000;">
                                                                                        </div>
                                                                                        <small class="text-muted">Balans: 0 UZS</small>
                                                                                    </div>

                                                                                    <div class="row mb-3">
                                                                                        <div class="col">
                                                                                            <label>Summa</label>
                                                                                            <input type="number" step="any" class="form-control" style="border: 1px solid rgba(0, 0, 0, 0.214);">
                                                                                        </div>
                                                                                        <div class="col">
                                                                                            <label>To'lov muddati</label>
                                                                                            <input type="date" class="form-control" style="border: 1px solid rgba(0, 0, 0, 0.214);">
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label>Izoh</label>
                                                                                        <textarea class="form-control" rows="3" placeholder="Izoh kiriting"></textarea>
                                                                                    </div>
                                                                                </form>
                                                                            </div>
                                                                            <div class="modal-footer">
                                                                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Bekor qilish</button>
                                                                                <button type="button" class="btn btn-primary" id="confirmQarzButton">Qarz berish</button>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                                                                <div class="col-md-12 mt-3">
                                                                    <button id="submit-payment" class="btn btn-success btn-lg w-100">
                                                                        <i class="fa fa-check-circle"></i> To'lovni tasdiqlash va Savdoni yakunlash
                                                                    </button>
                                                                </div>
                                                                <div class="col-md-12 inputkassa"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




<!-- Add New Product Modal -->
<div class="modal fade" id="new_product_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <form id="newProductForm" class="modal-content" method="post">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle1">Yangi qoshish</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
            <label for="">Nomi</label>
            <input type="text" class="form-control" name="name" required>
            <input type="hidden" name="from_ajax" value="True">

            <label for="">Ishlab chiqaruvchi</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="deliver" id="deliverSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in delivers %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#deliverModal">+</button>
                    </div>
                </div>

                <label for="">O‘lchov</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="measurement" id="measurementSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in measurements %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#measurementModal">+</button>
                    </div>
                </div>

                <label for="">Fasl</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="season" id="seasonSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in seasons %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div>

            <label for="">Min miqdor</label>
            <input type="text" class="form-control" name="min_count" required>

            <label for="">Paketdagi soni</label>
            <input type="text" class="form-control" name="pack" required>

            <label for="">Guruh</label>
            <div class="input-group mb-2">
                <select class="form-control searchable" required name="group" id="groupSelect">
                    <option value="">- - - - - - - - </option>
                    {% for a in groups %}
                        <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#groupModal">+</button>
                </div>
            </div>

            <label for="">Turi</label>
            <select name="ready" class="form-control" id="" required>
                <option value="">- - - - - - - </option>
                {% for i in ready_types %}
                    <option value="{{i.id}}">{{ i.name }}</option>
                {% endfor %}
            </select>

            <label for="">Shtrix kod</label>
            <input type="text" class="form-control" name="barcode" value="{{new_barcode}}" required>

            <label for="">Dona soni</label>
            <input type="text" class="form-control" name="quantity" value="1" min="1" required>

            </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
        </form>
    </div>
</div>

<!-- Deliver Modal -->
<div class="modal fade" id="deliverModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="deliverForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi Ishlab chiqaruvchi</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="Nomi" required>
          <input type="text" name="phone1" class="form-control mb-2" placeholder="Telefon 1" required>
          <input type="text" name="phone2" class="form-control mb-2" placeholder="Telefon 2">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Measurement Modal -->
<div class="modal fade" id="measurementModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="measurementForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi O‘lchov</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="O‘lchov nomi" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="groupForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi Guruh</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="Guruh nomi" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock content %}
{% block js %}
<!-- Barcha HTML tugaydi -->
<!-- Bu yerda JavaScript kelsin -->


    <script>
        function addNDS() {
            const checkbox = document.getElementById('nds_checkbox');
            const ndsSpan = document.getElementById('nds_p');
            $.ajax({
                url: "{% url 'nds_ajax' %}",
                type: "POST",
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": csrfToken
                },
                success: function(response) {
                    if (checkbox.checked) {
                        ndsSpan.textContent = response.count; 
                        $.ajax({
                                url: "{% url 'b2b_shop_ajax_edit' product_id  %}",
                                type: "POST",
                                data: {'nds_count':response.count},
                                headers: {
                                    "X-CSRFToken": csrfToken
                                },
                                success: function(response) {
                                    showAlert("Ma'lumot muvaffaqiyatli saqlandi!", "success");
                                },
                                error: function () {
                                    showAlert("Server bilan bog'lanishda xatolik4", "danger");
                                }
                        });
                    } else {
                        ndsSpan.textContent = 0;
                        $.ajax({
                                url: "{% url 'b2b_shop_ajax_edit' product_id  %}",
                                type: "POST",
                                data: {'nds_count':0},
                                headers: {
                                    "X-CSRFToken": csrfToken
                                },
                                success: function(response) {
                                    showAlert("Ma'lumot muvaffaqiyatli saqlandi!", "success");
                                },
                                error: function () {
                                    showAlert("Server bilan bog'lanishda xatolik4", "danger");
                                }
                        });
                    }
                },
                error: function() {
                    showAlert("Server bilan bog'lanishda xatolik6", "danger");
                }
            });
        }
        function addItogNDS(element) {
            let nds_itog = document.getElementById('nds_itog');
            let summa_itog = document.getElementById('summa_itog');
            $.ajax({
                url: "{% url 'nds_ajax' %}",
                type: "POST",
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": csrfToken
                },
                success: function(response) {
                    let summa = parseInt(summa_itog.textContent.replace(/\s/g, '')) || 0; 
                    let nds_summa = parseInt(response.count) || 0; 
                    let other_sum = ( summa / 100) * nds_summa
                    if (element.checked) {
                        nds_itog.textContent = (summa + other_sum).toLocaleString('fr-FR');
                       
                    } else {
                        nds_itog.textContent = 0;
                       
                    }
                },
                error: function() {
                    showAlert("Server bilan bog'lanishda xatolik7", "danger");
                }
            });
        }
    </script>
    <script>
        let data = []
        function parseNumber(text) {
                return parseFloat(text.replace(/\s/g, '').replace(',', '.')) || 0;
            }

        document.getElementById('product_list').addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-btn')) {
                const row = e.target.closest('.row');
                if (row) {
                    const row_quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                    const total_row = parseNumber(row.querySelector('.summa_product_list').textContent.trim());
                    const product_id = row.querySelector('.id_product').textContent.trim();
                    
                    let summaItog = document.getElementById('summa_itog');
                    let oldValue = parseNumber(summaItog.textContent);
                    const summaCol = document.getElementById('summa_col');

                    if (total_row) {
                        summaItog.textContent = (oldValue - (total_row)).toLocaleString('fr-FR');

                    }

                    if (row_quantity) {
                        summaCol.textContent = (parseFloat(summaCol.textContent) - row_quantity).toFixed(0);
                    }

                    if (product_id) {
                        const index = data.findIndex(item => item.product_id == product_id);
                        data = data.filter(item => item.product_id !== product_id);
                    }
                    row.remove();
                    const select = document.getElementById('shop_select_product');
                    select.selectedIndex = 0;

                    $.ajax({
                        url: "{% url 'b2b_shop_ajax_cart_delete' product_id %}",
                        type: "POST",
                        data:JSON.stringify({'product_id':product_id}),
                        headers: {
                            "X-CSRFToken": csrfToken
                        },
                        success: function(response) {
                            showAlert("Cart ochirildi!", "success");
                        },
                        error: function() {
                            showAlert("Server bilan bog'lanishda xatolik1", "danger");
                        }
                    });
                }
            }
        });


        function changeItog() {
            let summa_itog = 0; 
            let summa_col = 0;  
            const productList = document.getElementById('product_list');
            const pr_summa_product_list = productList.querySelectorAll('.summa_product_list');
            const pr_summa_product_input = productList.querySelectorAll('input[name="quantity"]');
            
            pr_summa_product_list.forEach(sim => {
                let rawText = sim.textContent.replace(/\s/g, '').replace(',', '.');
                summa_itog += parseInt(rawText) || 0;
            });
            pr_summa_product_input.forEach(simi => {
                summa_col += parseInt(simi.value) || 0;
            });
            
            document.getElementById('summa_itog').textContent = summa_itog.toLocaleString('fr-FR');
            document.getElementById('summa_col').textContent = summa_col;
        }



        function pushData(item) {
            const row = item.closest('.row');
            const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
            const pack = parseFloat(row.querySelector('input[name="pack"]').value) || 0;
            const priceElement = row.querySelector('.price_product_list');
            const totalElement = row.querySelector('.summa_product_list');
            const id_product = row.querySelector('.id_product').textContent;
            const ostatok_quantity = row.querySelector('.ostatok').textContent;
            const skidka_input = parseFloat(row.querySelector('.skidka_input').value) || 0;
            const ostatokElement = row.querySelector('.ostatok');
            const originalOstatok = parseInt(ostatokElement.getAttribute('data-original')) || 0;
            if (parseInt(ostatok_quantity) >= parseInt(quantity)) {
                if (parseInt(priceElement.textContent) > 0 && totalElement) {
                    const price = parseFloat(priceElement.textContent) || 0;
                    let total = price * quantity;

                    if (skidka_input) {
                        total -= skidka_input
                    }

                    totalElement.textContent = total.toLocaleString('fr-FR');

                    const existingItem = data.find(item => item.product_id === id_product);
                    
                    if (existingItem) {
                        existingItem.pack = pack;
                        existingItem.quantity = quantity;
                        existingItem.total = total;
                        existingItem.skidka = skidka_input;
                        existingItem.price = price;
                    } else {
                        data.push({
                            quantity: quantity,
                            total_pack: pack,
                            total: total,
                            product_id: id_product,
                            skidka: skidka_input,
                            price:price,
                        });
                    }
                    console.log(data)
                    const one_data = {
                        quantity: quantity,
                        total_pack: pack,
                        total: total,
                        product_id: id_product,
                        skidka: skidka_input,
                        price:price,
                    }
                    
                    $.ajax({
                            url: "{% url 'b2b_shop_ajax_add_one' product_id  %}",
                            type: "POST",
                            data: JSON.stringify(one_data),
                            headers: {
                                "X-CSRFToken": csrfToken
                            },
                            success: function(response) {
                                updateReceiptProducts()
                                paymentSystem.init(); // Payment system ni yangilash

                            },
                            error: function () {
                            }
                    });
                    changeItog();
                    ostatokElement.textContent = originalOstatok - parseInt(quantity);


                } else {
                    showAlert("Narx yoki umumiy qiymat elementi topilmadi!", "danger");
                }
            } else {
                showAlert("Maxsulot yetarli emas!", "danger");
                
            }
            
        }

        document.addEventListener("DOMContentLoaded", function () {
            const selectElement = $('#shop_select_product').selectize();
            const selectizeInstance = selectElement[0].selectize;
            const modalButton = document.querySelector('.exampleModal_modal'); 
            const queryText = document.getElementById('query_select_product_name');
            const recipient_name = document.getElementById('recipient-name');
            
            console.log(modalButton)
            let lastQuery = ""; 

            selectizeInstance.on('type', function (query) {
                lastQuery = query;
                console.log(lastQuery, 'eeeeeeee')
                if (query && selectizeInstance.currentResults.items.length === 0) {
                    console.log("🆕 Hech nima topilmadi, tugma ochildi!");
                    modalButton.style.display = 'block';
                    queryText.style.display = 'block';
                    queryText.textContent = `🛒 "${query}" maxsulotni qo'shmoqchimisiz? + tugmasini bosing`;
                    recipient_name.value = lastQuery

                } else {
                    console.log("✅ Natija topildi, tugma yashirildi!");
                    modalButton.style.display = 'none';
                    queryText.style.display = 'none';

                }
            });
            $('.exampleModal_modal').on('click', function () {
                setTimeout(() => {
                    selectizeInstance.setTextboxValue(lastQuery); 
                }, 10);
            });

            $('#exampleModal').on('hidden.bs.modal', function () {
                selectizeInstance.focus(); 
                selectizeInstance.setTextboxValue(lastQuery); 
            });
        });

     
        $(document).ready(function () {
            const $select = $('#shop_select_product').selectize();
            const selectizeControl = $select[0].selectize;
            selectizeControl.focus();

            const productList = document.getElementById('product_list');

            selectizeControl.on('change', function (value) {
                if (!value) {
                    return;
                }

                const selectizeControl = $('#shop_select_product')[0].selectize;

                const [id, price, select_quantity, pack] = value.split('|');
                const selectedProduct = selectizeControl.getItem(value).text().trim();
                const existingProducts = productList.querySelectorAll('.product_name');


                let productExists = Array.from(existingProducts).some(product => product.textContent === selectedProduct);

                if (productExists) {
                    showAlert("Maxsulot allaqachon qo‘shilgan!", "warning");
                    return;
                }

                const newRow = `
                    <div class="row">
                        <div class="col-md-2"><p class="product_name">${selectedProduct}</p></div>
                        <div class="col-md-1"><p style='display:none;' class="id_product">${id}</p></div>
                        <div class="col-md-2"><input type="number" data-pack="${pack}" onkeyup="calculate_pack(this)" name="pack" onchange="pushData(this)"></div>
                        <div class="col-md-2"><input type="number" onkeyup="calculate_pack(this)" name="quantity"  onchange="pushData(this)"></div>
                        <div class="col-md-1"><h6 class="ostatok" data-original="${select_quantity}">${select_quantity}</h6></div>
                        <div class="col-md-1"><p class="price_product_list">${price}</p></div>
                        <div class="col-md-2" style="display: flex; gap: 7px;">
                            <label for=""></label>
                            <input type="text"  class="skidka_input" placeholder="Скидка" oninput="pushData(this)" style="height:22px">
                        </div>
                        <div class="col-md-1" style="display:flex; gap:15px;" >
                            <h6 class="summa_product_list"></h6>
                            <h6 class="delete-btn" style="color:red;cursor:pointer;">x</h6>
                        </div>
                    </div>
                    <br>
                `;

                productList.insertAdjacentHTML('beforeend', newRow);

                selectizeControl.clear(); 
                selectizeControl.focus();
            });

            productList.addEventListener('click', function (e) {
                if (e.target.classList.contains('delete-btn')) {
                    e.target.closest('.row').remove();
                }
            });
        });

      
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        $(document).ready(function () {

            

            function addCart() {
                if (data.length !== 0) {
                    $.ajax({
                        url: "{% url 'product_remove_quantity' product_id %}",
                        type: "POST",
                        data: JSON.stringify(data),
                        headers: {
                            "X-CSRFToken": csrfToken
                        },
                        success: function(response) {
                            showAlert("Ma'lumot muvaffaqiyatli saqlandi!", "success");
                            window.location.replace('/b2b_shop');
                        },
                        error: function () {
                            showAlert("Server bilan bog'lanishda xatolik3", "danger");
                        }
                    });
                }
            }
            function addShop() {
                const shop_textarea = $('#shop_textarea').val();
                const shop_input_payment_date = $('#shop_input_payment_date').val();
                
                const fields_shop = {
                    'text':shop_textarea,
                    'debt_return':shop_input_payment_date,
                };
                $.ajax({
                            url: "{% url 'b2b_shop_ajax_edit' product_id  %}",
                            type: "POST",
                            data: fields_shop,
                            headers: {
                                "X-CSRFToken": csrfToken
                            },
                            success: function(response) {
                                window.location.replace('/b2b_shop');

                            },
                            error: function () {
                                showAlert("Server bilan bog'lanishda xatolik4", "danger");
                            }
                });
            }
            $("#submit-payment").click(addShop);
            $("#submit-payment").click(addCart);
        });

        
    </script>
    <script> 
            const kurs = parseFloat(document.getElementById('shop_last_kurs').textContent.trim()) || 1;
            console.log(kurs)
    </script>
    <script>
      
    </script>
    
    
    <script>
        const showAlert = (message, type) => {
            const alertElement = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                </div>
            `);

            $("#alert-container").append(alertElement);
            setTimeout(() => {
                alertElement.fadeOut(500, function () { $(this).remove(); });
            }, 3000);
        };
    </script>

    <script src="{% static 'plugins/table/datatable/datatables.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/dataTables.buttons.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/jszip.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/buttons.html5.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/buttons.print.min.js'%}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
    <script>
        $('select.searchable').selectize({ normalize: true });
    </script>
    <script>
        function switchTab(event) {
           document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
           event.target.classList.add('active');
           const isRelatedDocs = event.target.innerText === "Оплата";
           document.querySelector('.home').style.display = isRelatedDocs ? 'none' : 'block';
           document.querySelector('.document').style.display = isRelatedDocs ? 'block' : 'none';
       }
    </script>


<script>
function calculate_pack(input) {
    const parent = input.closest('.row') || document;

    const packInput = parent.querySelector('input[name="pack"]');
    const quantityInput = parent.querySelector('input[name="quantity"]');

    const unit = parseFloat(packInput.getAttribute('data-pack')) || 1;

    if (input.name === 'quantity') {
        const quantity = parseFloat(quantityInput.value) || 0;
        packInput.value = quantity / unit;
    } else if (input.name === 'pack') {
        const pack = parseFloat(packInput.value) || 0;
        quantityInput.value = pack * unit;
    }
}
</script>


<script>
    $('#newProductForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const quantity = parseFloat(form.find('[name="quantity"]').val()) || 1;
        
        $.ajax({
            url: "{% url 'new_product_add' %}",
            type: "POST",
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, "success");
                    $('#new_product_add').modal('hide');
                    form[0].reset();
                    
                    $.get("{% url 'check_price' %}", { 
                        product: response.product_id, 
                        type: $('input[name="type_price"]:checked').val() 
                    }, function(data) {
                        const price = parseFloat(data['price']) || 0;
                        const productList = document.getElementById('product_list');
                        const selectizeControl = $('#shop_select_product')[0].selectize;
                        const value = `${response.product_id}|${0}|${quantity}|${response.pack}`;
                        const label = `${response.product_name} - ${response.barcode}`;

                        if (!selectizeControl.options[value]) {
                            selectizeControl.addOption({ value: value, text: label });
                        }

                        selectizeControl.setValue(value);

                        productList.insertAdjacentHTML('beforeend', newRow);

                        selectizeControl.clear(); 
                        selectizeControl.focus();
                    });
                } else {
                    showAlert(response.message, "danger");
                }
            },
            error: function() {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    });
</script>




    <script>
        $(document).ready(function () {
            function handleFormSubmit(formId, url, selectId, modalId) {
                $(formId).submit(function (e) {
                    e.preventDefault();
                    const formData = $(this).serialize();
                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: formData + '&csrfmiddlewaretoken={{ csrf_token }}',
                        success: function (data) {
                            $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                            $(modalId).modal('hide');

                            $(formId)[0].reset();
                        },
                        error: function () {
                            showAlert("Xatolik yuz berdi!", "success");
                        }
                    });
                });
            }
            handleFormSubmit('#deliverForm', '{% url "create_deliver_new" %}', '#deliverSelect', '#deliverModal');
            handleFormSubmit('#measurementForm', '{% url "create_measurement" %}', '#measurementSelect', '#measurementModal');
            handleFormSubmit('#groupForm', '{% url "create_group" %}', '#groupSelect', '#groupModal');
        });
    </script>
{% endblock js %}
