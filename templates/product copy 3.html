{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div id="content" class="main-content">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <div class="layout-px-spacing">
        <div class="row layout-top-spacing" id="cancel-row">
            <div id="alert-container"></div>
            <div class="col-xl-12 col-lg-12 col-sm-12 layout-spacing">
                <div class="widget-content widget-content-area br-6">
                    <!-- Top Buttons -->
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#nullModal">
                                Nolga tushirish
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary ml-2" id="savePricesBtn">
                                Narxlarni saqlash
                            </button>
                            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#newProductModal">
                                Yangi qo'shish
                            </button>
                        </div>
                    </div>

                    <!-- Filter Form -->
                    <form class="mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <select name="deliver" class="form-control searchable">
                                    <option value="">Ishlab chiqaruvchi</option>
                                    {% for deliver in delivers %}
                                    <option value="{{ deliver.id }}" {% if filters.deliver == deliver.id %}selected{% endif %}>{{ deliver.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select name="season" class="form-control">
                                    <option value="">Fasl</option>
                                    {% for season in seasons %}
                                    <option value="{{ season.id }}" {% if filters.season == season.id %}selected{% endif %}>{{ season.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary">Filtr</button>
                            </div>
                        </div>
                    </form>

                    <!-- Products Table -->
                    <div class="table-responsive">
                        <table id="productsTable" class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>â„–</th>
                                    <th>Nomi</th>
                                    <th>Shtrix kod</th>
                                    <th>Ishlab chiqaruvchi</th>
                                    <th>Fasl</th>
                                    <th>Paket</th>
                                    <th>Soni</th>
                                    <th>Min. soni</th>
                                    <th>Filial</th>
                                    <th>Guruh</th>
                                    <th>Harakatlar</th>

                                    {% for valyuta in valyutas %}
                                        {% for price_type in price_types %}
                                            <th style="white-space: nowrap;">
                                                {{ valyuta.name }} / {{ price_type.name }}
                                            </th>
                                        {% endfor %}
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in productfilials %}
                                <tr data-id="{{ product.id }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ product.name }}</td>
                                    <td>
                                        {% for barcode in product.barcodes.all %}
                                            {{ barcode.barcode }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="badge badge-primary">{{ product.deliver.name }}</span>
                                    </td>
                                    <td>{{ product.get_season_display }}</td>
                                    <td>{{ product.pack }}</td>
                                    <td>{{ product.quantity|intcomma }}</td>
                                    <td>{{ product.min_count|intcomma }}</td>
                                    <td>{{ product.filial.name }}</td>
                                    <td>{{ product.group.name }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary edit-product-btn" 
                                                data-id="{{ product.id }}">
                                            <i class="fas fa-edit"></i> Tahrirlash
                                        </button>
                                    </td>

                                    {% for i in product.pricetypevaluta_prices %}
                                        {% for summa in i.summas %}
                                            <td>
                                                <input type="number" step="0.01" 
                                                    class="form-control price-input"
                                                    data-product="{{ product.id }}"
                                                    data-valyuta="{{ i.valyuta_id }}"
                                                    data-price-type="{{ summa.price_type }}"
                                                    value="{{ summa.summa }}">
                                            </td>
                                        {% endfor %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Edit Modal -->
<div class="modal fade" id="productEditModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Mahsulotni tahrirlash</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="productEditForm">
                {% csrf_token %}
                <input type="hidden" id="editProductId" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nomi</label>
                                <input type="text" class="form-control" name="name" id="editProductName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Ishlab chiqaruvchi</label>
                                <select class="form-control searchable" name="deliver" id="editProductDeliver">
                                    {% for deliver in delivers %}
                                    <option value="{{ deliver.id }}">{{ deliver.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Fasl</label>
                                <select class="form-control" name="season" id="editProductSeason">
                                    <option value="">Tanlang</option>
                                    {% for season in seasons %}
                                    <option value="{{ season.id }}">{{ season.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Paketdagi soni</label>
                                <input type="number" step="0.01" class="form-control" name="pack" id="editProductPack" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimal soni</label>
                                <input type="number" class="form-control" name="min_count" id="editProductMinCount" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Guruh</label>
                                <select class="form-control" name="group" id="editProductGroup">
                                    <option value="">Tanlang</option>
                                    {% for group in groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>O'lchov birligi</label>
                                <select class="form-control" name="measurement_type" id="editProductMeasurement">
                                    <option value="">Tanlang</option>
                                    {% for measurement in measurements %}
                                    <option value="{{ measurement.id }}">{{ measurement.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Polka kodi</label>
                                <input type="text" class="form-control" name="shelf_code" id="editProductShelfCode">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Shtrix kodlar</label>
                                <div id="barcodeContainer">
                                    <!-- Barcodes will be added here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary mt-2" id="addBarcodeBtn">
                                    <i class="fas fa-plus"></i> Shtrix kod qo'shish
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                    <button type="submit" class="btn btn-primary">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Null Products Modal -->
<div class="modal fade" id="nullModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Nolga tushirish</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Barcha mahsulotlarni nolga tushirmoqchimisiz?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <a href="{% url 'null_products' %}" class="btn btn-danger">Tasdiqlash</a>
            </div>
        </div>
    </div>
</div>

<!-- New Product Modal -->
<div class="modal fade" id="newProductModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Yangi mahsulot qo'shish</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="newProductForm" action="{% url 'new_product_add' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nomi</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Ishlab chiqaruvchi</label>
                                <select class="form-control searchable" name="deliver">
                                    {% for deliver in delivers %}
                                    <option value="{{ deliver.id }}">{{ deliver.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Fasl</label>
                                <select class="form-control" name="season">
                                    <option value="">Tanlang</option>
                                    {% for season in seasons %}
                                    <option value="{{ season.id }}">{{ season.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Paketdagi soni</label>
                                <input type="number" step="0.01" class="form-control" name="pack" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimal soni</label>
                                <input type="number" class="form-control" name="min_count" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Guruh</label>
                                <select class="form-control" name="group">
                                    <option value="">Tanlang</option>
                                    {% for group in groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>O'lchov birligi</label>
                                <select class="form-control" name="measurement_type">
                                    <option value="">Tanlang</option>
                                    {% for measurement in measurements %}
                                    <option value="{{ measurement.id }}">{{ measurement.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Polka kodi</label>
                                <input type="text" class="form-control" name="shelf_code">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Shtrix kodlar</label>
                                <div id="newBarcodeContainer">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" name="barcodes[]">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-danger remove-barcode" type="button">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary mt-2" id="addNewBarcodeBtn">
                                    <i class="fas fa-plus"></i> Shtrix kod qo'shish
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                    <button type="submit" class="btn btn-success">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script src="{% static 'plugins/table/datatable/datatables.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" />

<script>
$(document).ready(function() {
    // Initialize DataTable with scroll
    $('#productsTable').DataTable({
        dom: '<"top"f>rt<"bottom"lip><"clear">',
        pageLength: 50,
        scrollY: '600px',
        scrollX: true,
        scrollCollapse: true,
        fixedColumns: {
            leftColumns: 5
        }
    });

    // Initialize Selectize for searchable selects
    $('.searchable').selectize({
        plugins: ['remove_button'],
        create: false,
        sortField: 'text'
    });

    // Edit Product Button Click
    $(document).on('click', '.edit-product-btn', function() {
        var productId = $(this).data('id');
        loadProductData(productId);
    });

    // Load Product Data for Edit Modal
    function loadProductData(productId) {
        $.ajax({
            url: '/get-product-data/' + productId + '/',
            type: 'GET',
            success: function(response) {
                $('#editProductId').val(response.id);
                $('#editProductName').val(response.name);
                $('#editProductPack').val(response.pack);
                $('#editProductMinCount').val(response.min_count);
                $('#editProductShelfCode').val(response.shelf_code);
                $('#editProductSeason').val(response.season);
                $('#editProductGroup').val(response.group);
                $('#editProductMeasurement').val(response.measurement_type);
                
                // Set deliver values
                var deliverSelect = $('#editProductDeliver')[0].selectize;
                //deliverSelect.clear();
                deliverSelect.setValue(response.deliver);
                
                // Load barcodes
                $('#barcodeContainer').empty();
                if(response.barcodes && response.barcodes.length > 0) {
                    response.barcodes.forEach(function(barcode) {
                        addBarcodeField(barcode);
                    });
                } else {
                    addBarcodeField();
                }
                
                $('#productEditModal').modal('show');
            },
            error: function(xhr) {
                showAlert('Mahsulot ma\'lumotlarini yuklashda xatolik', 'danger');
            }
        });
    }

    // Add barcode field
    function addBarcodeField(value = '') {
        var fieldId = 'barcode_' + Date.now();
        var html = `
            <div class="input-group mb-2" id="${fieldId}">
                <input type="text" class="form-control" name="barcodes[]" value="${value}">
                <div class="input-group-append">
                    <button class="btn btn-outline-danger remove-barcode" type="button" data-target="${fieldId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        $('#barcodeContainer').append(html);
    }

    // Add new barcode field
    $('#addBarcodeBtn').click(function() {
        addBarcodeField();
    });

    // Remove barcode field
    $(document).on('click', '.remove-barcode', function() {
        var target = $(this).data('target');
        $('#' + target).remove();
    });

    // Save Product Form
    $('#productEditForm').submit(function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '/edit-product/',
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if(response.status === 'success') {
                    showAlert('Mahsulot muvaffaqiyatli saqlandi!', 'success');
                    $('#productEditModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            },
            error: function(xhr) {
                showAlert('Saqlashda xatolik yuz berdi', 'danger');
            }
        });
    });

    // Save All Prices Button
    $('#savePricesBtn').click(function() {
        var prices = [];
        
        $('.price-input').each(function() {
            var $input = $(this);
            var priceValue = $input.val();
            
            if(priceValue) {
                prices.push({
                    product: $input.data('product'),
                    valyuta: $input.data('valyuta'),
                    price_type: $input.data('price-type'),
                    price: parseFloat(priceValue)
                });
            }
        });

        if(prices.length === 0) {
            showAlert('Saqlash uchun narxlar kiritilmagan', 'warning');
            return;
        }

        $.ajax({
            url: '/save-prices/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({prices: prices}),
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(response) {
                if(response.status === 'success') {
                    showAlert('Barcha narxlar muvaffaqiyatli saqlandi!', 'success');
                }
            },
            error: function(xhr) {
                showAlert('Narxlarni saqlashda xatolik yuz berdi', 'danger');
            }
        });
    });

    // Add new barcode field for new product
    $('#addNewBarcodeBtn').click(function() {
        var html = `
            <div class="input-group mb-2">
                <input type="text" class="form-control" name="barcodes[]">
                <div class="input-group-append">
                    <button class="btn btn-outline-danger remove-barcode" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        $('#newBarcodeContainer').append(html);
    });

    // Show Alert Function
    function showAlert(message, type) {
        var alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>`;
        
        $('#alert-container').html(alertHtml);
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});
</script>
{% endblock %}