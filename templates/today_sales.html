{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    <title>Sotuvlar hisoboti</title>
{% endblock title %}

{% block css %}
    <link href="{% static 'assets/css/tables/table-basic.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'plugins/flatpickr/flatpickr.css' %}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />


    <style>

        #fullscreenPayment {
                z-index: 9999;
                overflow-y: auto;
                overflow-x: auto;
                height: 100vh;
            }

            /* #fullscreenPayment .modal-dialog.modal-fullscreen-custom {
                max-height: 100vh;
                overflow-y: auto;
            } */

            #fullscreenPayment .modal-content {
                max-height: 100vh;
                overflow-y: auto;
            }

            /* #fullscreenPayment .container-fluid {
                min-height: 100vh;
                overflow-y: auto;
            } */


        #debtorModal {
            z-index: 999999 !important;
        }

        #debtorModal .modal-backdrop {
            z-index: 999998 !important;
        }
        .method-box {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background-color: white !important;
            border-radius: 5px;
            box-shadow: 2px 5px 5px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.129) !important;
        }
        .method-box:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .method-box i {
            color: #007bff !important;
            font-size: 1.2em;
        }
        .method-box p {
            margin: 0;
            flex-grow: 1;
            font-weight: 500;
        }
        .toggle-input {
            color: #007bff !important;
            background-color: white !important;
            border: 1px solid #ffffff !important;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-input i {
            font-size: 1.2em;
        }
        .input-fields {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .remove-field {
            cursor: pointer;
            font-size: 1.8em;
            color: #dc3545;
            background: none;
            border: none;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }
        .payment-table th, .payment-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f8f9fa;
        }
        .card-balance {
            text-align: right;
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .inputkassa {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .input-box {
            display: none;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.401);
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            margin-top: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: border 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .input-box:hover {
            border: 1px solid #007bff !important;
        }
        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        .box-body {
            margin-top: 10px;
        }
        .payment-input {
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.277) !important;
        }
        .receipt-wrapper {
            width: 100%;
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-left: 1.8px solid rgba(192, 192, 192, 0.758);
            border-right: 1.8px solid rgba(192, 192, 192, 0.758);
            overflow: hidden; 
        }
        .zigzag {
            width: calc(100% + 3.6px);
            height: 15px;
            margin-left: -1.8px; 
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 10" xmlns="http://www.w3.org/2000/svg"><polyline points="0,10 5,0 10,10 15,0 20,10 25,0 30,10 35,0 40,10 45,0 50,10 55,0 60,10 65,0 70,10 75,0 80,10 85,0 90,10 95,0 100,10" fill="white" stroke="lightgray" /></svg>') repeat-x;
            background-size: contain;
        }
        .receipt {
            padding: 20px;
            font-size: 13px;
            color: #000 !important;
        }
        .bold {
            font-weight: bold;
        }
        .lines {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        hr {
            border: none;
            border-top: 1px solid #bbb;
            margin: 8px 0;
        }
        .section {
            margin-bottom: 8px;
        }
        .barcode {
            height: 50px;
            width: 100%;
            background: repeating-linear-gradient(
                to right,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px
            );
            margin: 15px 0;
        }
        .center {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        .item-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .subline {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-left: 10px;
        }
        .qarz-row {
            font-weight: bold;
            color: #dc3545;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
            margin: 5px 0;
            background-color: #fff3f3;
        }
        .qarz-row span {
            font-size: 14px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
        }
        .summary-value.total {
            color: green;
        }
        .input-box.has-value {
            border: 1px solid #28a745 !important;
            background-color: #f8fff8;
        }
    </style>
    
    <style>

        .btn-check:checked + .btn {
            background-color: #007bff;
            color: white;
        }

        .modal-fullscreen-custom {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0;
            padding: 0;
        }
        .modal-fullscreen-custom .modal-content {
            height: 100vh;
            width: 100vw;
            border-radius: 0;
        }
        body.modal-open {
            overflow: hidden; /* Modal ochilganda sahifa skrollanmasin */
        }

        .modal-body {
            overflow-y: auto;
            max-height: calc(100vh - 120px); /* Modal header va footer balandligini hisobga olgan holda */
        }

        .shop-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .shop-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .shop-header:hover {
            background: #e9ecef;
        }
        
        .shop-main-info {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .shop-details {
            padding: 0;
            background: #f8f9fa;
            display: none;
        }
        
        .shop-details.show {
            display: block;
        }
        
        .carts-section, .payments-section, .returns-section {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .carts-section:last-child, .payments-section:last-child, .returns-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .payment-totals {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .payment-total-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            min-width: 120px;
        }
        
        .payment-total-label {
            font-size: 12px;
            color: #6c757d;
        }
        
        .payment-total-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-1 { background: #e3f2fd; color: #1976d2; }
        .status-2 { background: #e8f5e8; color: #2e7d32; }
        .status-3 { background: #ffebee; color: #c62828; }
        
        .return-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1060;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        .return-modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .return-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1050;
            display: none;
        }
        
        .return-modal-overlay.show {
            display: block;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .debt-payment {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        .table-sm th, .table-sm td {
            padding: 8px 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .payment-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .payment-amount {
            flex: 1;
        }
        
        .remove-payment {
            color: #dc3545;
            cursor: pointer;
        }
        
        .total-return-amount {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .chegirma-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .cart-item-row {
            transition: background-color 0.3s ease;
        }
        
        .cart-item-row:hover {
            background-color: #f8f9fa;
        }
        
        .cart-input {
            width: 80px;
            text-align: center;
        }
        
        .delete-cart-btn {
            padding: 4px 8px;
        }

        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999; /* Modal z-index'idan yuqori qilish */
            width: 30rem;
        }

        /* Alert elementlari uchun */
        .alert {
            z-index: 100000; /* Eng yuqori daraja */
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* Ko'rinishini yaxshilash */
        }

        #products {
            z-index: 1 !important;
            position: relative;
        }

    </style>
{% endblock css %}

{% block content %}
<div id="content" class="main-content">
    <div style="margin:2rem;">
        <div class="row layout-top-spacing">
            <div style="z-index: 1000000000;" id="alert-container"></div>
            <div class="col-12 layout-spacing">
                <!-- Filter Form -->
                <div class="row d-flex justify-content-end">
                    <div class="col-md-3">
                        <select onchange="$('#filter_submit').trigger('click');" name="filial" class="form-control" id="select-filial" style="margin-top: -1rem;margin-bottom: 1rem;">
                            {% if user.userprofile.staff == 1 %}
                                {% for d in filials %}
                                    <option data-name="{{ d.name }}" value="{{ d.id }}" {% if d.id|stringformat:"i" == filters.filial %}selected{% endif %}>
                                        {{ d.name }}
                                    </option>
                                {% endfor %}
                            
                            {% else %}
                                <option data-name="{{ d.name }}" value="{{ user.userprofile.filial.id }}" selected>
                                    {{ user.userprofile.filial.name }}
                                </option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <form class="row" method="GET" id="filter-form">
                            <div class="col-md-4 mb-2">
                                <input type="text" id="mainsearch" name="search" class="form-control" placeholder="Qidiruv..." value="{{ filters.search }}">
                            </div>
                            <div class="col-md-2 mb-2">
                                <input onchange="$('#filter_submit').trigger('click');" type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
                            </div>
                            <div class="col-md-2 mb-2">
                                <input onchange="$('#filter_submit').trigger('click');" type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
                            </div>
                            <!-- <div class="col-md-2 mb-2">
                                
                            </div> -->
                            <div class="col-md-2 mb-2">
                                <select onchange="$('#filter_submit').trigger('click');" name="client" class="form-control mainSelectDebtor" multiple id="select-client">
                                    <option value="" disabled>Mijoz</option>
                                    {% for c in client %}
                                        <option value="{{ c.id }}" {% if c.id|stringformat:"i" in filters.client %}selected{% endif %}>
                                            {{ c.fio }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="submit" id="filter_submit" class="btn btn-primary w-100">Filterlash</button>
                                <a href="{% url 'today_sales' %}" class="btn btn-secondary w-100 mt-1">Tozalash</a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Totals Card -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <h5>Sotuvlar</h5>
                                <h3 class="text-primary" id="total-shops">{{ totals.total_shops|intcomma }}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>SKU</h5>
                                <h3 class="text-success" id="total-quantity">{{ totals.total_quantity|intcomma }}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>To'lov summa</h5>
                                <h3 class="text-info" id="total-price">{{ totals.total_price|intcomma }}</h3>
                            </div>
                            <div class="col-md-2">
                                <h5>Qarz</h5>
                                <h3 class="text-warning" id="total-debt">1</h3>
                            </div>

                            <div class="col-md-2">
                                
                                {% if open_smena %}
                                    <button class="btn btn-primary w-100" id="openPOSModalBtn">POS</button>
                                {% else %}
                                    <button class="btn btn-primary w-100" id="smenaopenbtn" data-bs-toggle="modal" data-bs-target="#smenaModal">
                                        Smena ochish
                                    </button>
                                {% endif %}
                                    
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- Shops Container -->
                <div id="shops-container" class="mt-3">
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Yuklanmoqda...</span>
                        </div>
                        <p class="mt-2">Ma'lumotlar yuklanmoqda...</p>
                    </div>
                    <!-- Shops will be loaded here via AJAX -->
                </div>
                
                <!-- Pagination -->
                <div id="pagination-container" class="pagination-container">
                    <!-- Pagination will be loaded here via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="smenaModal" tabindex="-1" aria-labelledby="smenaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" method="post" action="{% url 'open_smena' %}">
            <div class="modal-header">
                <h5 class="modal-title filial-name" id="smenaModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Yopish"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="filial_hidden" name="filial"></input>
                <!-- Kassalar jadvali -->
                <table class="table">
                    <thead>
                        <tr>
                            <th width="60%">Kassa</th>
                            <th width="40%">Boshlang'ich summa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kassa in kassalar %}
                        <tr class="kassa_merges1" data-filial="{{ kassa.kassa.filial.id }}">
                            <td>{{ kassa.valyuta.name }}</td>
                            <td>
                                <input type="number" value="0" disabled class="form-control" placeholder="Summani kiriting">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="submit" class="btn btn-success">Smenani ochish</button>
            </div>
        </form>
    </div>
</div>




<!-- Fullscreen Payment Modal -->
<div class="modal fade" id="fullscreenPayment" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content">
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <h3><i class="fa fa-payment"></i> To'lovni amalga oshirish</h3>
                        <button class="btn btn-danger" data-bs-dismiss="modal" onclick="clearInputBox()">
                            <i class="fas fa-times"></i> 
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="receipt-wrapper" id="check_div">
                            <div class="zigzag"></div>
                            <div class="receipt">
                                <div class="section">
                                    <div class="lines"><span class="bold">Tranzaksiya:</span> <span>#{{ shop.id }}</span></div>
                                    <div class="bold">Store ecomarf-tekstil</div>
                                    <div class="lines"><span class="bold">Sana:</span> <span>{{today|date:'Y-m-d'}}</span></div>
                                    <div class="lines"><span class="bold">Sotuvchi:</span> <span>{{ shop.debtor}}</span></div>
                                    <div class="bold">Maxsulotlar:</div>
                                </div>
                                <hr>
                                <div id="chek_products">
                                </div>
                                <hr>
                                <div class="section">
                                    <div class="lines"><span>Oraliq jami</span><span id="chek_oraliq_jami">0 {{shop_valyuta_name}}</span></div>
                                    <div class="lines"><span>Chegirma</span><span id="chek_chegirma">0 {{shop_valyuta_name}}</span></div>
                                    <div class="lines bold"><span>JAMI</span><span  id="chek_total_jami">0 {{shop_valyuta_name}}</span></div>
                                </div>
                                <div class="section" id="check_tolovlar">
                                </div>
                                <div class="barcode"></div>
                                <div class="center">Xaridingiz uchun rahmat</div>
                            </div>
                            <div class="zigzag"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-center mt-3">
                                <button class="btn btn-primary" id="saveAsPngBtn">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9" style="overflow-y: auto; overflow-x: auto; height: 100%;">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="summary-card">
                                    <div class="summary-title">Jami:</div>
                                    <div class="summary-value" id="total_jami">0 {{shop_valyuta_name}}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card">
                                    <div class="row" id="pays-div">
                                        <!-- <div class="col-md-6">
                                            <div class="summary-title">Qarzi:</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="summary-title">Haqqi:</div>
                                        </div> -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card">
                                    <div class="summary-title">To'lash uchun:</div>
                                    <div class="summary-value total" id="tolash_summasi">0 {{shop_valyuta_name}}</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>To'lov usullari</h4>
                                <hr>
                            </div>
                            {% for mer in kassalar %}
                            <div class="col-md-3 mb-3 plus_button kassa_merges" data-filial="{{ mer.kassa.filial.id }}">
                                <div class="payment-method" data-kassa-id="{{ mer.id }}" data-valyuta-id="{{ mer.valyuta.id }}" data-valyuta-name="{{ mer.valyuta.name }}">
                                    <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'" onclick="showInputBox(this)">
                                        <i class="fa-solid fa-money-bill-wave"></i>
                                        <p>{{ mer.kassa.name }} ({{ mer.valyuta }})</p>
                                        <button class="toggle-input"
                                            {% if mer.valyuta.is_dollar %}
                                                data-dollar="true"
                                            {% else %}
                                                data-dollar="false"
                                            {% endif %}
                                            >
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="input-box" style="display: none;">
                                        <div class="box-header">
                                            <span>{{ mer.kassa.name }} ({{ mer.valyuta }})</span>
                                            <p style="display: none;" class="box-header-valyuta-name">{{ mer.valyuta.name }}</p>
                                            <button class="remove-field">&times;</button>
                                        </div>
                                        <div class="box-body">
                                            <input onkeyup="formatInput(this)" min="0" type="text" step="any" class="form-control payment-input" oninput="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <div class="col-md-3 mb-3 plus_button" id="qarzModalButton">
                                <div class="payment-method" data-kassa-id="qarz" data-valyuta-id="">
                                    <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'" >
                                        <i class="fa-solid fa-money-bill-transfer"></i>
                                        <p>Qarzga</p>
                                        <button class="toggle-input">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="input-box" style="display: none;" id="qarzInputBox">
                                    <div class="box-header">
                                        <span>Qarz berish</span>
                                        <!-- <button class="remove-field" onclick="hideQarzInputBox()">&times;</button> -->
                                    </div>
                                    <div class="box-body">
                                        <div class="mb-2">
                                            <label class="small">Valyuta</label>
                                            <select class="form-control form-control-sm" id="qarzBoxValyuta">
                                                <!-- <option value="">Tanlang</option> -->
                                                {% for valyuta in valyutalar %}
                                                    
                                                    {% if valyuta.is_som_or_dollar %}
                                                        <option value="{{ valyuta.id }}" 
                                                                data-name="{{ valyuta.name }}"
                                                                data-is-dollar="{{ valyuta.is_dollar|yesno:'true,false' }}"
                                                                
                                                                {% if valyuta.name == 'Som' %}
                                                                    selected
                                                                {% endif %}
                                                                    >
                                                            {{ valyuta.name }}
                                                        </option>
                                                    {% endif %}
                                                        
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small">Summa</label>
                                            <input onkeyup="formatInput(this)" type="text" step="any" class="form-control form-control-sm" id="qarzBoxSumma" placeholder="0.00">
                                        </div>
                                        <div class="mb-2">
                                            <label class="small">To'lov muddati</label>
                                            <input type="date" class="form-control form-control-sm" id="qarzBoxDueDate">
                                        </div>
                                        <div>
                                            <label class="small">Izoh</label>
                                            <textarea class="form-control form-control-sm" id="qarzBoxComment" rows="2" placeholder="Izoh"></textarea>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100 mt-2" onclick="addQarzToPayment()">
                                            <i class="fa-solid fa-plus"></i> Qo'shish
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12 d-flex justify-content-end" style="gap: 10px;margin-bottom: 1rem;">
                                <button type="button" class="btn btn-danger me-2" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Bekor qilish
                                </button>
                                <button type="button" class="btn btn-success" id="submit-payment" onclick="Yakunlash()">
                                    <i class="fas fa-check"></i> To'lovni tasdiqlash va Yakunlash
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- POS Modal -->
<div class="modal fade" id="posModal" tabindex="-1" aria-labelledby="posModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content bg-light">
            <div class="modal-header bg-primary text-white">
                <button type="button" style="background-color: #fff !important;" class="btn" onclick="$('#filter_submit').trigger('click')" data-bs-dismiss="modal"><i class="fa fa-arrow-left"></i></button>

                <h5 class="modal-title" style="color: #fff">POS Tizimi</h5>
                <!-- <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Yopish"></button> -->
            </div>
            <div class="modal-body bg-light">
                <div class="row layout-top-spacing" id="cancel-row">
                    <div class="col-xl-9 col-lg-9 col-sm-12 layout-spacing">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        <select name="valyuta" id="valyuta_input" class="searchable form-control" required disabled oninput="saveValyutaShop(this)">
                                            {% for i in valyutalar %}
                                                <option value="{{i.id}}" {% if shop.valyuta == i %}selected{% endif %} >{{i.name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <select class="d-none" id="products" name="product" data-recieve="{{recieve.id}}">
                                                <option value="">Mahsulot tanlanmagan</option>
                                                {% for i in products %}
                                                    <option 
                                                        value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}">
                                                        {{ i.name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <div class="dropdown w-100 position-relative">
                                                <input type="text" class="form-control fs-5 py-3 border-primary" placeholder="Mahsulotni qidiring..." id="productSearchInput" data-bs-toggle="dropdown" aria-expanded="false">
                                                <ul class="dropdown-menu w-100 overflow-auto shadow" style="max-height: 300px;" id="productListDropdown">
                                                    {% for i in products %}
                                                        <li>
                                                            <a onclick="addCart('{{i.id}}')" href="#" class="dropdown-item py-2 fs-5 select-product-item"
                                                            data-value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}${{i.measurement_type.name}}">
                                                                üõí <strong>{{ i.name }}</strong><br>
                                                                üì¶ <span id="quantity{{i.id}}">{{ i.quantity|floatformat:'2' }}</span> | üè∑Ô∏è {{ i.get_barcodes }} | üí∞ <span data-prices='{{ i.pricetypevaluta_prices_json|safe }}' data-quantity="{{ i.quantity }}" id="productprice{{i.id}}">{{ i.price|floatformat:'2' }}</span>
                                                            </a>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn btn-danger h-100" onclick="clearInputProduct()">X</button>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-primary w-100 h-100" id="fullscreenDropdownBtn">
                                            Guruh bo'yicha
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="product_list" class="table table-hover" style="width:100%">
                                        <thead class="" style="background-color: #dfdfdf;">
                                            <tr>
                                                <td>Jami</td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-left fw-bold" id="pack_total">0</td>
                                                <td class="text-left fw-bold" id="quantity_total">0</td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-left fw-bold" id="total_sum">0</td>
                                                <td><button class="btn btn-outline-danger" onclick="delete_all()"><i class="fa fa-trash"></i></button></td>
                                            </tr>
                                        </thead>

                                        
                                        <thead class="">
                                            <tr>
                                                <th>#</th>
                                                <th>Maxsulot nomi</th>
                                                <th>Paket / O'lchov</th>
                                                <th>Paket</th>
                                                <th>Miqdori (dona)</th>
                                                <th>Narx</th>
                                                <th>Kelishilgan narx</th>
                                                <th>Jami</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="cart-tbody"> 
                                            <!-- Cart elementlari shu yerga qo'shiladi -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-3 col-sm-12 layout-spacing">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <form method="post" id="shopEditForm">
                                    {% csrf_token %}
                                    <h4 class="text-success text-center mb-4" style="font-size: 50px;" id="all_total">0</h4>
                                    
                                    <div class="btn-group w-100 mb-3" role="group" aria-label="Price Types">
                                        {% for i in price_types %}
                                            <input type="radio" class="btn-check price_type_input" style="display:none" name="type_price" id="{{i.name}}{{i.id}}" value="{{i.id}}" autocomplete="off" 
                                            {% if shop.debtor.price_type == i %}
                                                checked
                                            {% elif not shop.debtor.price_type and price_types.first == i %}
                                                checked
                                            {% endif %}
                                                >
                                            <label class="btn btn-outline-primary" for="{{i.name}}{{i.id}}">{{i.name}}</label>
                                        {% endfor %}
                                    </div>
                                    
                                    <input type="hidden" name="id" id="shop_id" value="">
                                    
                                    <div class="mb-3">
                                        <label for="mainSelectDebtor" class="form-label">Mijoz</label>
                                        <div class="input-group">
                                            <select class="form-control mainSelectDebtor" id="mainSelectDebtor" name="debtor" required onchange="updateShopDetails()">
                                                <option value=""></option>
                                                {% for i in debtors %}
                                                    <option value="{{i.id}}" {% if shop.debtor == i %}selected{% endif %}>{{ i.fio }} - {{ i.phone1|default_if_none:'Kiritilmagan' }}</option>
                                                {% endfor %}
                                            </select>
                                            <button onclick="openDebtorModal()" type="button" class="btn btn-outline-primary" style="height: ;">+</button>
                                        </div>
                                    </div>
                                 
                                    <div class="mb-3">
                                        <label for="selectFilial" class="form-label">Filial</label>
                                        <select class="form-control searchable" name="filial" id="selectFilial" required {% if user.userprofile.staff != 1 %}disabled{% endif %}>
                                            
                                            {% if user.userprofile.staff == 1 %}
                                                <option value=""></option>
                                                {% for i in filials %}
                                                    <option value="{{i.id}}" {% if user.userprofile.filial == i %}selected{% endif %}>{{ i.name }}</option>
                                                {% endfor %}
                                            
                                            {% else %}
                                                <option value="{{ user.userprofile.filial.id }}">{{ user.userprofile.filial.name }}</option>
                                            {% endif %}
                                                
                                        </select>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="mb-3">
                                        <label for="all_total_2" class="form-label">Jami summa</label>
                                        <input type="text" class="form-control bg-light" id="all_total_2" name="all_total" value="0" disabled>
                                    </div>
                                </form>
                                
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <input type="text" id="discountInput" onchange="updateShopDetails()" oninput="updateTotals()" class="form-control make_intcomma" placeholder="Chegirmani kiriting">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-danger h-100" onclick="clearPerecent()">X</button>
                                    </div>
                                    <!-- <div class="col-md-2 d-flex justify-content-end">
                                        <button class="btn btn-secondary" id="uzsBtn">{{shop_valyuta_name}}</button>
                                    </div> -->
                                </div>
                                
                                <div class="row quick-discount g-2 mb-4">
                                    <div class="col-auto">
                                        <button id="disc_button" style="display: none;" class="btn btn-sm btn-outline-secondary">0%</button>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <button class="btn btn-primary" style="width: 100%;" id="fullscreenPaymentBtn">
                                            To'lovni amalga oshirish
                                        </button>
                                    </div>
                                    <br>
                                    <br>

                                    <div class="col-md-6">
                                        <button type="button" style="width: 100%;" class="btn btn-success" onclick="fetchReceipt()">CHEK V1</button>
                                    </div>

                                    <div class="col-md-6">
                                        <button type="button" style="width: 100%;" class="btn btn-warning">
                                            <a href="" target="_blank" rel="noopener noreferrer" class="text-white text-decoration-none">CHEK V2</a>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" onclick="$('#filter_submit').trigger('click')" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="debtorModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="debtorForm">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="col-form-label">Narx Turi</label>
                        <div class="input-group">
                            <select name="price_type" class="form-control" id="recipient-price_type">
                                <option value="">---------</option>
                                {% for price_type in price_types %}
                                    <option value="{{ price_type.id }}">{{ price_type.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#priceTypeModal">+</button>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="form-group">
                        <label for="recipient-image" class="col-form-label">Rasm</label>
                        <input type="file" class="form-control" id="recipient-image" name="image" >
                    </div> -->
                    <div class="form-group">
                        <label for="recipient-fio" class="col-form-label">F.I.O</label>
                        <input type="text" class="form-control" id="recipient-fio" name="fio" required>
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Telegram ID</label>
                        <input type="text" class="form-control"  name="tg_id" >
                    </div>
                    <div class="form-group">
                        <label for="recipient-phone1" class="col-form-label">Telefon</label>
                        <input value="998" type="text" class="form-control" id="recipient-phone1" name="phone1" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-phone2" class="col-form-label">Telefon 2</label>
                        <input value="998" type="text" class="form-control" id="recipient-phone2"  name="phone2" >
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="debtor_add_close">Yopish</button>
                        <button type="submit" class="btn btn-primary">Saqlash</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="priceTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="priceTypeForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yangi Narx Turi Qo‚Äòshish</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="text" name="name" class="form-control" placeholder="Narx turi nomi" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Saqlash</button>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- Return Modal -->
<div class="return-modal-overlay" id="return-modal-overlay"></div>
<div class="return-modal" id="return-modal">
    <div class="modal-header bg-primary text-white p-3">
        <h5 class="modal-title">Maxsulotlarni Qaytarish</h5>
        <button type="button" class="btn-close btn-close-white" id="close-return-modal"></button>
    </div>
    <div class="modal-body p-3">
        <div id="return-shop-info" class="mb-3 p-3 bg-light rounded"></div>
        
        <!-- Qaytariladigan mahsulotlar -->
        <div class="mb-4">
            <h6>Qaytariladigan Mahsulotlar</h6>
            <div id="return-products-list"></div>
        </div>
        
        <!-- To'lov usuli -->
        <div class="mb-4">
            <h6>To'lov Usuli</h6>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="subtract-from-debt" checked>
                <label class="form-check-label" for="subtract-from-debt">
                    Qarzidan ayirish
                </label>
                <small class="form-text text-muted d-block">
                    Agar belgilansa, qaytarish summasi mijozning qarzidan ayiriladi. 
                    Agar belgilanmasa, kassadan chiqim qilinadi.
                </small>
            </div>
            
            <div id="payment-section" style="display: none;">
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-payment">
                        <i class="fas fa-plus"></i> To'lov qo'shish
                    </button>
                </div>
                <div id="payments-container"></div>
                <div id="total-return-display" class="total-return-amount"></div>
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-success w-100" id="confirm-return">
                <i class="fas fa-check"></i> Qaytarishni Tasdiqlash
            </button>
        </div>
    </div>
</div>





{% endblock content %}

{% block js %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js" integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script> -->


<script>
    document.querySelector('#smenaopenbtn').addEventListener('click', function () {
        const filialName = $('#select-filial option:selected').data('name');
        $('#smenaModalLabel').text(filialName);
        $('#filial_hidden').val($('#select-filial').val())

        let filialId = document.getElementById('select-filial').value;

        document.querySelectorAll('.kassa_merges1').forEach(element => {
            if (element.dataset.filial != filialId) {
                element.style.display = 'none';
                return;
            } else {
                element.style.display = '';
            }
        });
    });

</script>


<script>
    $(document).ready(function() {
        let searchTimeout;
        
        $('#mainsearch').on('input', function() {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(function() {
                console.log('eeeee')
                $('#filter_submit').trigger('click');
            }, 1500);
        });
});
</script>

<script>
    $(document).on('show.bs.modal', '.modal', function () {
        const zIndex = 1040 + (10 * $('.modal:visible').length);
        $(this).css('z-index', zIndex);
        setTimeout(() => {
            $('.modal-backdrop').not('.modal-stack')
                .css('z-index', zIndex - 1)
                .addClass('modal-stack');
        }, 0);
    });
</script>

<!-- <script>
function updateProductQuantity(id, quantity) {
    // Elementni topamiz
    const quantitySpan = document.getElementById(`quantity${id}`);
    
    // Agar element mavjud bo'lsa, yangilaymiz
    if (quantitySpan) {
        // Matnni yangilash
        quantitySpan.textContent = parseFloat(quantity).toFixed(2);

        // data-quantity atributini ham yangilash
        quantitySpan.setAttribute('data-quantity', quantity);
    } else {
        console.warn(`Element #quantity${id} topilmadi`);
    }
}
</script> -->

<script>
function updateProductQuantity(id, quantity) {
    const quantitySpan = document.getElementById(`quantity${id}`);
    
    if (quantitySpan) {
        // Matnni yangilash
        quantitySpan.textContent = parseFloat(quantity).toFixed(2);
        quantitySpan.setAttribute('data-quantity', quantity);

        // üîπ Tegishli itemni topamiz
        const item = quantitySpan.closest('.select-product-item');
        if (item) {
            // üîπ Hozirgi yangilangan HTML holatini olish
            const updatedHTML = item.innerHTML;
            // üîπ data-original-html ni ham yangilab qo'yamiz
            item.setAttribute('data-original-html', updatedHTML);
        }
    } else {
        console.warn(`Element #quantity${id} topilmadi`);
    }
}
</script>


<script>
    



$(document).ready(function () {
    $('select.searchable').selectize({ normalize: true });
    
    const debtorSelect = $('.mainSelectDebtor').selectize({
        normalize: true,
        create: false,
        sortField: 'text',
        placeholder: 'Mijozni tanlang...',
        
        // Qidiruv sozlamalari - barcha qismlardan qidirish
        searchField: ['text'],
        score: function(search) {
            const searchTerm = search.toLowerCase().trim();
            
            return function(item) {
                const fullText = item.text.toLowerCase();
                const parts = item.text.split('‚Äî');
                const name = parts[0]?.trim().toLowerCase() || '';
                const phone = parts[1]?.trim().toLowerCase() || '';
                const cleanPhone = phone.replace(/\D/g, '');
                
                let score = 0;
                
                // 1. TO'LIQ MOS KELISH
                if (fullText === searchTerm) score += 10000;
                
                // 2. ISM BO'YICHA QIDIRISH
                if (name.includes(searchTerm)) {
                    score += 1000;
                    if (name.startsWith(searchTerm)) score += 500;
                }
                
                // 3. TELEFON BO'YICHA QIDIRISH
                if (phone.includes(searchTerm)) score += 800;
                
                // 4. FAQAT RAQAMLARDAN QIDIRISH
                if (/^\d+$/.test(searchTerm)) {
                    if (cleanPhone === searchTerm) score += 2000;
                    if (cleanPhone.includes(searchTerm)) {
                        score += 600;
                        if (cleanPhone.endsWith(searchTerm)) score += 400;
                    }
                }
                
                // 5. HAR QANDAY QISMDAN QIDIRISH
                const allWords = fullText.split(/[‚Äî\s]+/);
                allWords.forEach(word => {
                    if (word.includes(searchTerm)) score += 200;
                });
                
                return score;
            };
        },
        
        // MARK QILISH UCHUN YANGI RENDER FUNKSIYA
        render: {
            option: function (item, escape) {
                // Joriy qidiruv so'zini olish
                const searchTerm = this.$control_input.val().toLowerCase().trim();
                const parts = escape(item.text).split('‚Äî');
                let name = parts[0]?.trim() || '';
                let phone = parts[1]?.trim() || '';
                
                // Regex special belgilarni escape qilish
                const escapeRegex = (string) => {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                };
                
                // Har qanday qismda topilgan so'zlarni mark qilish
                const highlightAnywhere = (text, search) => {
                    if (!search || !text || search.length < 2) return text;
                    
                    try {
                        const escapedSearch = escapeRegex(search);
                        const regex = new RegExp(`(${escapedSearch})`, 'gi');
                        return text.replace(regex, '<mark class="search-highlight">$1</mark>');
                    } catch (e) {
                        return text;
                    }
                };
                
                // Agar qidiruv so'zi bo'lsa, mark qilish
                if (searchTerm && searchTerm.length >= 2) {
                    name = highlightAnywhere(name, searchTerm);
                    phone = highlightAnywhere(phone, searchTerm);
                    
                    // Raqamli qidiruv uchun alohida
                    if (/^\d+$/.test(searchTerm)) {
                        const phoneRegex = new RegExp(`(${searchTerm})`, 'gi');
                        phone = phone.replace(phoneRegex, '<mark class="search-highlight">$1</mark>');
                    }
                }

                return `
                    <div class="selectize-option-item">
                        <div class="option-name">
                            <i class="bi bi-person-circle"></i>
                            <span>${name}</span>
                        </div>
                        <div class="option-phone">
                            <span>${phone}</span>
                        </div>
                    </div>`;
            },
            
            item: function (item, escape) {
                const searchTerm = this.$control_input.val().toLowerCase().trim();
                const parts = escape(item.text).split('‚Äî');
                let name = parts[0]?.trim() || '';
                let phone = parts[1]?.trim() || '';
                
                // Tanlangan elementda ham mark qilish
                const highlightAnywhere = (text, search) => {
                    if (!search || !text || search.length < 2) return text;
                    
                    try {
                        const escapedSearch = escapeRegex(search);
                        const regex = new RegExp(`(${escapedSearch})`, 'gi');
                        return text.replace(regex, '<mark class="search-highlight">$1</mark>');
                    } catch (e) {
                        return text;
                    }
                };
                
                if (searchTerm && searchTerm.length >= 2) {
                    name = highlightAnywhere(name, searchTerm);
                    phone = highlightAnywhere(phone, searchTerm);
                }

                return `
                    <div class="selectize-selected-item">
                        <div class="selected-name">
                            <i class="bi bi-person-circle"></i>
                            <span>${name}</span>
                        </div>
                        <div class="selected-phone">
                            <span>${phone}</span>
                        </div>
                    </div>`;
            }
        },

        // Qidiruv o'zgarganida yangilash
        onType: function(value) {
            // Qisqa vaqt o'tgach refresh qilish (performance uchun)
            clearTimeout(this._searchTimeout);
            this._searchTimeout = setTimeout(() => {
                this.refreshOptions();
            }, 50);
        },
        
        onInitialize: function () {
            const input = this.$control;
            input.css({
                'border-radius': '2px',
                'border': '1px solid #ced4da',
                'padding': '10px 12px',
                'background': '#fff',
                'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
                'transition': 'all 0.2s ease',
            });

            this.$dropdown.css({
                'border-radius': '2px',
                'overflow': 'hidden',
                'box-shadow': '0 4px 8px rgba(0,0,0,0.12)',
            });

            // CSS qo'shish
            const style = document.createElement('style');
            style.textContent = `
                .search-highlight {
                    background: #ffeb3b !important;
                    color: #000 !important;
                    padding: 1px 2px;
                    border-radius: 2px;
                    font-weight: bold;
                }
                .selectize-option-item {
                    display: flex;
                    flex-direction: column;
                    padding: 8px 10px;
                    line-height: 1.3;
                }
                .option-name {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .option-name i {
                    color: #007bff;
                    font-size: 17px;
                }
                .option-name span {
                    font-weight: 500;
                    color: #333;
                }
                .option-phone {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    margin-top: 4px;
                    line-height: 1;
                }
                .option-phone span {
                    font-size: 13px;
                    color: #666;
                }
                .selectize-dropdown .option:hover .search-highlight {
                    background: #fff !important;
                    color: #007bff !important;
                }
            `;
            document.head.appendChild(style);

            this.$dropdown.on('mouseenter', '.option', function () {
                $(this).css({
                    'background': '#007bff',
                    'color': '#fff',
                });
                $(this).find('i').css('color', '#fff');
                $(this).find('.search-highlight').css({
                    'background': '#fff !important',
                    'color': '#007bff !important'
                });
            }).on('mouseleave', '.option', function () {
                $(this).css({
                    'background': '',
                    'color': ''
                });
                $(this).find('i').css('color', '#007bff');
                $(this).find('.search-highlight').css({
                    'background': '#ffeb3b !important',
                    'color': '#000 !important'
                });
            });

            input.on('focus', function () {
                $(this).css({
                    'border-color': '#007bff',
                    'box-shadow': '0 0 0 3px rgba(0,123,255,0.15)'
                });
            }).on('blur', function () {
                $(this).css({
                    'border-color': '#ced4da',
                    'box-shadow': 'none'
                });
            });
        }
    });
});
</script>

<!-- <script>
$(document).on('click', '#qarzModalButton', function () {
    console.log('aaaaaaaaa')
    const qarzModal = new bootstrap.Modal(document.getElementById('qarzModal'));
    qarzModal.show();
});
</script> -->

<script>
// Cart operatsiyalari uchun global o'zgaruvchilar
let currentShopId = null;
let cartItems = [];
let currentKurs = document.querySelector('#dollar-kurs-base').value


let currentDatas = null

let existingPayments = [];



function delete_all() {
    if (confirm("Rostdan ham barcha mahsulotlarni o‚Äòchirmoqchimisiz?")) {
        fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&request_type=delete_all`, {
            method: 'GET',
        })
        .then(response => {
            if (response.status) {
                initializeShop(currentShopId)
            } else {
                console.error("So‚Äòrov muvaffaqiyatli emas:", response.status);
            }
        })
        .catch(error => {
            console.error("Xatolik yuz berdi:", error);
        });
    }

}


function updateShopDetails() {
    if (!currentShopId) {
        console.log('Shop ID mavjud emas');
        return;
    }

    // Selectize instansiyalaridan qiymatlarni olish
    const debtorSelectize = $('#mainSelectDebtor')[0]?.selectize;
    const filialSelectize = $('#selectFilial')[0]?.selectize;
    let chegirma = cleanNumber($('#discountInput').val()) || 0;

    const debtorId = debtorSelectize ? debtorSelectize.getValue() : '';
    const filialId = filialSelectize ? filialSelectize.getValue() : '';

    if (debtorId && filialId) {
        const formData = new FormData();
        formData.append('debtor', debtorId);
        formData.append('filial', filialId);
        formData.append('chegirma', chegirma);

        fetch(`{% url 'b2c_shop_edit_ajax' %}?id=${currentShopId}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json()) // JSONni kutish
        .then(data => {
            if (data.success) {
                // showAlert("Shop ma'lumotlari yangilandi", 'success');
                initializeShop(currentShopId);
            } else {
                showAlert(data.message || 'Yangilashda xatolik', 'danger');
            }
        })
        .catch(error => {
            console.error('Shop yangilashda xatolik:', error);
            showAlert("Server bilan bog'lanishda xatolik", 'danger');
        });
    }
}



// Sahifa yuklanganda shop yaratish yoki olish
document.addEventListener('DOMContentLoaded', function() {
    // initializeShop();
    
    // POS modalini ochish
    document.getElementById('openPOSModalBtn').addEventListener('click', function() {
        initializeShop();
        const modal = new bootstrap.Modal(document.getElementById('posModal'));
        modal.show();
    });
});


function editShopModal(id) {
    initializeShop(id);
    const modal = new bootstrap.Modal(document.getElementById('posModal'));
    modal.show();
}

// Shopni yaratish yoki olish
async function initializeShop(id) {
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${id || ''}`);
    
        const data = await response.json();
        
        if (data.id) {
            currentShopId = data.id;
            currentDatas = data
            filialId = data.filial.id;
            customerId = data.customer_info.id
            document.getElementById('shop_id').value = currentShopId;

            
            console.log(data.chegirma, 'oo')
            $('#discountInput').val(formatNumber(data.chegirma))
            $('#all_total').val(data.totals.total)


            var customerselect = $('#mainSelectDebtor')[0].selectize;
            customerselect.setValue(customerId, true); // silent:true

            var filialselect = $('#selectFilial')[0].selectize;
            filialselect.setValue(filialId, true); // silent:true

            loadCartItems();
            // await loadExistingPayments();
        }
    } catch (error) {
        console.error('Shop yaratishda xatolik:', error);
        showAlert('Shop yaratishda xatolik yuz berdi', 'danger');
    }
}

// Cart elementlarini yuklash
async function loadCartItems() {
    if (!currentShopId) return;
    
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}`);
        const data = await response.json();
        
        if (data.cart_items) {
            cartItems = data.cart_items;
            renderCartItems();
            updateTotals();
        }
    } catch (error) {
        console.error('Cart elementlarini yuklashda xatolik:', error);
    }
}

// Cart elementlarini ekranga chiqarish
function renderCartItems() {
    const tbody = document.getElementById('cart-tbody');
    tbody.innerHTML = '';
    
    cartItems.slice().reverse().forEach((item, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-cart-id', item.id);
        row.setAttribute('data-product-id', item.product_id);
        row.className = 'cart-item-row';
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td class="product_name">${item.product_name}</td>
            <td>${item.pack_size || 1} / ${item.product_measure || ''}</td>
            <td>
                <div class="input-group">
                    <input type="text" onkeyup="formatInput(this)" class="make_intcomma cart-input pack-input" 
                           value="${formatNumber(item.total_pack)}" min="0" step="any"
                           data-pack="${item.pack_size || 1}"
                           onchange="updateCartItem(${item.id}, 'total_pack', this.value)">
                </div>
            </td>
            <td>
                <div class="input-group">
                    <input type="text" onkeyup="formatInput(this)" class="make_intcomma cart-input quantity-input" 
                           value="${formatNumber(item.quantity)}" min="0" step="any"
                           onchange="updateCartItem(${item.id}, 'quantity', this.value)">
                </div>
            </td>
            <td>${formatNumber(item.price_without_skidka)}</td>
            <td>
                <div class="input-group">
                    <input type="text" onkeyup="formatInput(this)" class="make_intcomma cart-input price-input" 
                           value="${formatNumber(item.price)}" min="0" step="any"
                           onchange="updateCartItem(${item.id}, 'price', this.value)">
                </div>
            </td>
            <td class="total" data-value="${item.total}">${formatNumber(item.total)}</td>
            <td>
                <button onclick="deleteCartItem(${item.id})" type="button" class="btn btn-danger delete-cart-btn">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Cartga yangi mahsulot qo'shish
async function addCart(productId) {
    if (!currentShopId) {
        showAlert('Iltimos, avval shop yaratiling', 'warning');
        return;
    }
    
    try {
        const productElement = document.querySelector(`[data-value*="${productId}&"]`);
        if (!productElement) {
            showAlert('Mahsulot topilmadi', 'danger');
            return;
        }
        
        const productData = productElement.getAttribute('data-value').split('&');
        const productName = productData[1];
        const quantity = 1;
        const packSize = parseFloat(productData[4]) || 1;
        const productMeasure = parseFloat(productData[-1]) || '';
        const totalPack = quantity / packSize;

        console.log(productId)
        console.log(document.getElementById(`productprice${productId}`), 'oooooo')
        const price = parseFloat(document.getElementById(`productprice${productId}`).textContent);
        console.log('rrrr')
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', quantity);
        formData.append('total_pack', totalPack);
        formData.append('agreed_price', price);
        formData.append('product_price', price);
        
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&request_type=cart_add`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            //showAlert("Mahsulot savatga qo'shildi", "success");
            
            // Yangi cart elementini qo'shamiz
            const newItem = {
                id: data.cart_id,
                product_id: productId,
                product_name: productName,
                quantity: quantity,
                total_pack: totalPack,
                price: price,
                price_without_skidka: price,
                total: quantity * price,
                pack_size: packSize,
                product_measure: productMeasure,
            };
            
            cartItems.push(newItem);
            renderCartItems();
            updateTotals();
            
            // Inputni tozalash
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productListDropdown').classList.remove('show');

            updateProductQuantity(data.product_id, data.rest)
            
        } else {
            showAlert(data.message || "Xatolik yuz berdi", "danger");
        }
    } catch (error) {
        console.error('Cart qo\'shishda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Cart elementini yangilash
async function updateCartItem(cartId, field, value) {
    try {
        if (field === 'quantity' || field === 'price' || field === 'total_pack') {
            value = cleanNumber(value)
        }
        console.log(value)
        // Avvalgi qiymatni saqlab olamiz
        const itemIndex = cartItems.findIndex(item => item.id === cartId);
        if (itemIndex === -1) return;
        
        const oldItem = {...cartItems[itemIndex]}; // Avvalgi qiymatlarni nusxalaymiz
        const oldValue = cartItems[itemIndex][field];
        
        // Local cart items ni yangilaymiz (vaqtincha)
        cartItems[itemIndex][field] = parseFloat(value);
        
        
        // Agar quantity yoki price o'zgarsa, totalni qayta hisoblaymiz
        if (field === 'quantity' || field === 'price') {
            const quantity = cartItems[itemIndex].quantity;
            const price = cartItems[itemIndex].price;
            cartItems[itemIndex].total = quantity * price;
            
            // Agar quantity o'zgarsa, total_pack ni ham yangilaymiz
            if (field === 'quantity') {
                const packSize = cartItems[itemIndex].pack_size || 1;
                cartItems[itemIndex].total_pack = quantity / packSize;
            }
        }
        
        // Agar total_pack o'zgarsa, quantity ni yangilaymiz
        if (field === 'total_pack') {
            const packSize = cartItems[itemIndex].pack_size || 1;
            cartItems[itemIndex].quantity = value * packSize;
            cartItems[itemIndex].total = cartItems[itemIndex].quantity * cartItems[itemIndex].price;
        }
        
        // UI ni yangilaymiz (vaqtincha)
        renderCartItems();
        updateTotals();
        
        const formData = new FormData();
        formData.append(field, value);
        
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&cart_id=${cartId}&request_type=cart_edit`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // showAlert('Mahsulot yangilandi', 'success');
            updateProductQuantity(data.product_id, data.rest)
        } else {
            // Xatolik bo'lsa, avvalgi qiymatlarga qaytaramiz
            cartItems[itemIndex] = {...oldItem}; // Avvalgi holatiga qaytaramiz
            
            // UI ni qayta yangilaymiz
            renderCartItems();
            updateTotals();
            
            showAlert(data.message || 'Yangilashda xatolik', 'danger');
            
            // Xatolik bo'lsa, cartni qayta yuklaymiz
            loadCartItems();
        }
    } catch (error) {
        console.error('Cart yangilashda xatolik:', error);
        
        // Xatolik bo'lsa, avvalgi qiymatlarga qaytaramiz
        const itemIndex = cartItems.findIndex(item => item.id === cartId);
        if (itemIndex !== -1) {
            // Avvalgi qiymatni qayta o'rnatish
            const inputElement = document.querySelector(`[data-id="${cartId}"] .${field}-input`);
            if (inputElement) {
                inputElement.value = oldValue;
            }
        }
        
        // Cartni qayta yuklaymiz
        loadCartItems();
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Cart elementini o'chirish
async function deleteCartItem(cartId) {
    if (!confirm('Haqiqatan ham ushbu mahsulotni o\'chirmoqchimisiz?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&cart_id=${cartId}&request_type=cart_delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // showAlert("Mahsulot o'chirildi", "success");
            updateProductQuantity(data.product_id, data.rest)
            // Local cart items dan o'chiramiz
            cartItems = cartItems.filter(item => item.id !== cartId);
            renderCartItems();
            updateTotals();
            
        } else {
            showAlert(data.message || "O'chirishda xatolik", "danger");
        }
    } catch (error) {
        console.error('Cart o\'chirishda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Jami summalarni yangilash
function updateTotals() {
    let totalPack = 0;
    let totalQuantity = 0;
    let totalSum = 0;
    
    cartItems.forEach(item => {
        totalPack += item.total_pack;
        totalQuantity += item.quantity;
        totalSum += item.total;
    });

    chegirma = parseFloat(cleanNumber(document.getElementById('discountInput').value)) || 0;
    if (chegirma > 0) {
        totalSum = totalSum - chegirma;
    }
    
    document.getElementById('pack_total').textContent = formatNumber(totalPack);
    document.getElementById('quantity_total').textContent = formatNumber(totalQuantity);
    document.getElementById('total_sum').textContent = formatNumber(totalSum);
    document.getElementById('all_total').textContent = formatNumber(totalSum);
    document.getElementById('all_total_2').value = formatNumber(totalSum);
}

// Sonlarni formatlash
// function formatNumber(num) {
//     return new Intl.NumberFormat("ru-RU", {
//         minimumFractionDigits: 0,
//         maximumFractionDigits: 2
//     }).format(num).replace(',', '.');
// }

// function formatInput(input) {
//     let value = input.value.replace(/\s/g, '');
//     if (value && !isNaN(value)) {
//         input.value = formatNumber(parseFloat(value));
//     }
// }


// function cleanNumber(str) {
//     return str.replace(/\s/g, '');
// }


// Barcha .make_intcomma inputlariga event qo'shish
// document.addEventListener('DOMContentLoaded', function() {
//     document.querySelectorAll('.make_intcomma').forEach(input => {
//         input.addEventListener('keyup', function() {
//             setTimeout(() => formatInput(this), 50);
//         });
        
//         input.addEventListener('blur', function() {
//             formatInput(this);
//         });
//     });
// });


// Xabarlarni ko'rsatish
function showAlert(message, type) {
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show`;
    alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertElement.style.zIndex = '10000000';
    alertElement.style.position = 'relative';

    
    document.getElementById('alert-container').appendChild(alertElement);
    
    setTimeout(() => {
        alertElement.remove();
    }, 5000);
}
// Inputni tozalash
function clearInputProduct() {
    document.getElementById('productSearchInput').value = '';
    document.getElementById('productListDropdown').classList.remove('show');
}




// document.addEventListener('DOMContentLoaded', function() {
//     const searchInput = document.getElementById('productSearchInput');
//     const dropdown = document.getElementById('productListDropdown');
    
//     searchInput.addEventListener('input', function() {
//         const query = this.value.trim().toLowerCase();
//         const searchTerms = query.split(/\s+/).filter(term => term.length > 0);
//         const items = Array.from(dropdown.querySelectorAll('.select-product-item'));

//         let hasVisibleItems = false;

//         const scoredItems = items.map(item => {
//             const originalHTML = item.getAttribute('data-original-html') || item.innerHTML;
            
//             // üîπ Mahsulot nomi va ma'lumotlarini olish
//             const textContent = item.textContent.toLowerCase();
//             const dataValue = (item.getAttribute('data-value') || '').toLowerCase();
//             const combinedText = `${textContent} ${dataValue}`;

//             // üîπ Quantity ni tekshirish
//             const quantitySpan = item.querySelector('[data-quantity]');
//             const quantity = quantitySpan ? parseFloat(quantitySpan.getAttribute('data-quantity')) || 0 : 0;

//             let score = 0;
            
//             if (searchTerms.length > 0) {
//                 // üîπ 1. Aniq mos kelish (exact match) - eng yuqori ball
//                 const exactRegex = new RegExp('\\b' + searchTerms.map(escapeRegex).join('\\s+') + '\\b', 'i');
//                 if (exactRegex.test(combinedText)) {
//                     score += 10000;
//                 }
                
//                 // üîπ 2. Ketma-ketlik mos kelishi (sequence match)
//                 const sequenceRegex = new RegExp(searchTerms.map(escapeRegex).join('.*?'), 'i');
//                 if (sequenceRegex.test(combinedText)) {
//                     score += 5000;
                    
//                     // üîπ Qanchalik erta topilsa, shuncha ko'p ball
//                     const match = combinedText.match(sequenceRegex);
//                     if (match) {
//                         score += 1000 - match.index;
//                     }
                    
//                     // üîπ Qisqa matnlar uchun bonus
//                     score += (100 - combinedText.length);
//                 }
                
//                 // üîπ 3. Har bir term uchun alohida ball
//                 searchTerms.forEach(term => {
//                     const termRegex = new RegExp(escapeRegex(term), 'gi');
//                     let match;
//                     while ((match = termRegex.exec(combinedText)) !== null) {
//                         // üîπ So'z boshi (word boundary) bonus
//                         const isWordStart = match.index === 0 || 
//                                           /[\s\W]/.test(combinedText[match.index - 1]);
//                         if (isWordStart) {
//                             score += 100;
//                         }
                        
//                         // üîπ Pozitsiya bonus (boshiga yaqin bo'lsa ko'proq ball)
//                         score += 50 - (match.index / 10);
//                     }
//                 });

//                 // üîπ 4. Maxsus belgilarni (/, \, #) aqlli qayta ishlash
//                 const normalizedQuery = query.replace(/[\/\\#]/g, ' ');
//                 const normalizedText = combinedText.replace(/[\/\\#]/g, ' ');
                
//                 if (normalizedQuery.split(/\s+/).every(term => 
//                     normalizedText.includes(term))) {
//                     score += 200;
//                 }
//             }

//             return { item, score, originalHTML, quantity, textContent: combinedText };
//         });

//         // üîπ Ballar bo'yicha saralash
//         scoredItems.sort((a, b) => {
//             if (b.score !== a.score) {
//                 return b.score - a.score;
//             }
//             // üîπ Ballar teng bo'lsa, qisqa nomli mahsulotlar ustun
//             return a.textContent.length - b.textContent.length;
//         });

//         // üîπ Dropdownni tozalash
//         dropdown.innerHTML = '';

//         scoredItems.forEach(({ item, score, originalHTML, quantity }) => {
//             const shouldShow = (searchTerms.length === 0 || score > 0) && quantity > 0;

//             if (shouldShow) {
//                 item.style.display = '';
//                 hasVisibleItems = true;
//                 item.setAttribute('data-original-html', originalHTML);
                
//                 // üîπ Highlight qilish
//                 if (searchTerms.length > 0) {
//                     const highlightedHTML = highlightTextInHTML(originalHTML, searchTerms);
//                     item.innerHTML = highlightedHTML;
//                 } else {
//                     item.innerHTML = originalHTML;
//                 }
//                 dropdown.appendChild(item);
//             } else {
//                 item.style.display = 'none';
//             }
//         });

//         // üîπ Hech narsa topilmasa
//         if (!hasVisibleItems && searchTerms.length > 0) {
//             const noResults = document.createElement('div');
//             noResults.className = 'select-product-item no-results';
//             noResults.textContent = 'Hech narsa topilmadi';
//             dropdown.appendChild(noResults);
//         }
//     });

//     // üîπ HTML tuzilmasini saqlaydigan highlight funksiyasi
//     function highlightTextInHTML(html, terms) {
//         const tempDiv = document.createElement('div');
//         tempDiv.innerHTML = html;
//         const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);

//         let textNode;
//         while ((textNode = walker.nextNode())) {
//             let text = textNode.nodeValue;
//             let replaced = false;
            
//             terms.forEach(term => {
//                 const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
//                 if (regex.test(text)) {
//                     replaced = true;
//                     text = text.replace(regex, '<mark class="search-highlight">$1</mark>');
//                 }
//             });
            
//             if (replaced) {
//                 const span = document.createElement('span');
//                 span.innerHTML = text;
//                 textNode.parentNode.replaceChild(span, textNode);
//             }
//         }
//         return tempDiv.innerHTML;
//     }

//     // üîπ Regex uchun xavfsiz qochirish
//     function escapeRegex(str) {
//         return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
//     }
// });

document.getElementById('productSearchInput').addEventListener('focus', function() {
    setTimeout(() => {
        const dropdown = document.getElementById('productListDropdown');
        if (dropdown) {
            dropdown.scrollTop = 0; // Scrollni eng tepaga olib chiqadi
        }
    }, 100);
});


document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('productSearchInput');
    const dropdown = document.getElementById('productListDropdown');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        const searchTerms = query.split(/\s+/).filter(term => term.length > 0);
        const items = Array.from(dropdown.querySelectorAll('.select-product-item'));

        items.forEach(item => {
            item.style.display = ''
            // if (!item.hasAttribute('data-original-html')) {
            //     item.setAttribute('data-original-html', item.innerHTML);
            // }
        });

        let hasVisibleItems = false;

        const scoredItems = items.map(item => {
            const originalHTML = item.getAttribute('data-original-html') || item.innerHTML;
            
            // üîπ Mahsulot nomi va ma'lumotlarini olish
            const textContent = item.textContent.toLowerCase();
            const dataValue = (item.getAttribute('data-value') || '').toLowerCase();
            const combinedText = `${textContent} ${dataValue}`;

            // üîπ Quantity ni tekshirish
            const quantitySpan = item.querySelector('[data-quantity]');
            const quantity = quantitySpan ? parseFloat(quantitySpan.getAttribute('data-quantity')) || 0 : 0;

            let score = 0;
            
            if (searchTerms.length > 0) {
                // üîπ 1. ANIQ RAQAMLAR MOS KELISHI - ENG YUQORI BALL
                // Masalan: "75 1" -> "75/1", "75/1#", "75\1" lar birinchi chiqadi
                const allTermsMatchExactly = searchTerms.every(term => {
                    // Raqamni aniq topish (alohida so'z yoki /, \, # dan keyin)
                    const exactTermRegex = new RegExp('(^|[\\s\\/\\\\#])' + escapeRegex(term) + '($|[\\s\\/\\\\#])', 'i');
                    return exactTermRegex.test(combinedText);
                });
                
                if (allTermsMatchExactly) {
                    score += 10000; // Eng yuqori ball
                }
                
                // üîπ 2. ANIQ KETMA-KETLIK MOS KELISHI
                // Masalan: "75 1" -> "75/1", "75/1#", "75\1"
                const exactSequenceRegex = new RegExp(searchTerms.map(escapeRegex).join('[\\/\\\\\\s#]*'), 'i');
                if (exactSequenceRegex.test(combinedText)) {
                    score += 8000;
                    
                    // üîπ Qanchalik aniq va qisqa bo'lsa, shuncha ko'p ball
                    const match = combinedText.match(exactSequenceRegex);
                    if (match) {
                        score += 1000 - match.index; // Boshiga yaqin bo'lsa bonus
                    }
                }
                
                // üîπ 3. HAR BIR TERM UCHUN ANIQ MOS KELISH
                searchTerms.forEach(term => {
                    // Raqamni aniq topish
                    const exactTermRegex = new RegExp('(^|[\\s\\/\\\\#])' + escapeRegex(term) + '($|[\\s\\/\\\\#])', 'i');
                    if (exactTermRegex.test(combinedText)) {
                        score += 500; // Aniq mos kelish uchun yuqori ball
                    } else {
                        // Faqat qisman mos kelish
                        const partialRegex = new RegExp(escapeRegex(term), 'gi');
                        let match;
                        while ((match = partialRegex.exec(combinedText)) !== null) {
                            score += 100; // Past ball
                        }
                    }
                });

                // üîπ 4. MATN UZUNLIGI - qisqa nomlar ustun
                score += (200 - combinedText.length);
            }

            if (quantity <= 1) {
                score = -10000; // YOKI: score -= 1000000; agar boshqa ballarni ham saqlamoqchi bo'lsangiz
            }


            return { item, score, originalHTML, quantity, textContent: combinedText };
        });

        // üîπ Ballar bo'yicha saralash
        scoredItems.sort((a, b) => {
            if (b.score !== a.score) {
                return b.score - a.score;
            }
            // üîπ Ballar teng bo'lsa, qisqa nomli mahsulotlar ustun
            return a.textContent.length - b.textContent.length;
        });

        // üîπ Dropdownni tozalash va yangilash
        dropdown.innerHTML = '';

        scoredItems.forEach(({ item, score, originalHTML, quantity }) => {
            const shouldShow = (searchTerms.length === 0 || score > 0) && quantity > 0;

            item.style.display = '';
            hasVisibleItems = true;
            item.setAttribute('data-original-html', originalHTML);
            
            // üîπ Highlight qilish
            if (searchTerms.length > 0) {
                const highlightedHTML = highlightTextInHTML(originalHTML, searchTerms);
                item.innerHTML = highlightedHTML;
            } else {
                item.innerHTML = originalHTML;
            }
            dropdown.appendChild(item);
            // if (shouldShow) {
            // } else {
            //     //item.style.display = 'none';
            // }
        });

        // üîπ Hech narsa topilmasa
        if (!hasVisibleItems && searchTerms.length > 0) {
            const noResults = document.createElement('div');
            noResults.className = 'select-product-item no-results';
            noResults.textContent = 'Hech narsa topilmadi';
            dropdown.appendChild(noResults);
        }
    });

    // üîπ HTML tuzilmasini saqlaydigan highlight funksiyasi
    function highlightTextInHTML(html, terms) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);

        let textNode;
        while ((textNode = walker.nextNode())) {
            let text = textNode.nodeValue;
            let replaced = false;
            
            terms.forEach(term => {
                // üîπ Aniq mos kelishlarni highlight qilish
                const exactRegex = new RegExp(`(^|[\\s\\/\\\\#])(${escapeRegex(term)})($|[\\s\\/\\\\#])`, 'gi');
                if (exactRegex.test(text)) {
                    replaced = true;
                    text = text.replace(exactRegex, `$1<mark class="search-highlight">$2</mark>$3`);
                } else {
                    // üîπ Qisman mos kelishlarni highlight qilish
                    const partialRegex = new RegExp(`(${escapeRegex(term)})`, 'gi');
                    if (partialRegex.test(text)) {
                        replaced = true;
                        text = text.replace(partialRegex, '<mark class="search-highlight">$1</mark>');
                    }
                }
            });
            
            if (replaced) {
                const span = document.createElement('span');
                span.innerHTML = text;
                textNode.parentNode.replaceChild(span, textNode);
            }
        }
        return tempDiv.innerHTML;
    }

    // üîπ Regex uchun xavfsiz qochirish
    function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
});


// Narx turini o'zgartirganda narxlarni yangilash
document.addEventListener('DOMContentLoaded', function () {
    const priceTypeRadios = document.querySelectorAll('.price_type_input');
    const valyutaSelect = document.getElementById('valyuta_input');

    function updateAllPrices() {
        const selectedValyutaId = valyutaSelect.value;
        const selectedPriceTypeId = document.querySelector('.price_type_input:checked')?.value;

        document.querySelectorAll('#productListDropdown span[data-prices]').forEach(span => {
            const rawPrices = span.getAttribute('data-prices');
            if (!rawPrices) return;

            let pricesData;
            try {
                pricesData = JSON.parse(rawPrices);
            } catch (e) {
                console.error("JSON parse error:", e, rawPrices);
                span.textContent = '0';
                return;
            }

            const foundValyuta = pricesData.find(v => String(v.valyuta_id) === selectedValyutaId);
            if (!foundValyuta) {
                span.textContent = '0';
                return;
            }

            const foundPrice = foundValyuta.summas.find(
                s => String(s.price_type) === selectedPriceTypeId
            );

            if (foundPrice && foundPrice.summa) {
                span.textContent = foundPrice.summa;
            } else {
                span.textContent = '0';
            }
        });
    }

    updateAllPrices();

    priceTypeRadios.forEach(radio => radio.addEventListener('change', updateAllPrices));
    valyutaSelect.addEventListener('change', updateAllPrices);
});


</script>



<script>

function showInputBox(item) {
    const mainBox = $(item).closest('.plus_button');
    const isDollar = mainBox.find('.toggle-input').data('dollar') === true;
    const inputBox = mainBox.find('.input-box');


    if (inputBox.length) {
        inputBox.show();

        const input = inputBox.find('input');
        input.val('')
            let inputValue = 0
            if (isDollar) {
                inputValue = (parseFloat(input.val()) || 0) * currentKurs;
            } else {
                inputValue = parseFloat(input.val()) || 0;
            }

        input.trigger('focus');

        let tolashSummasi = parseFloat(calculatePaymentTotal().replace(/\s+/g, ''));

        console.log(calculatePaymentTotal().replace(/\s+/g, ''), inputValue)
        console.log(tolashSummasi)


        // Agar dollar bo‚Äòlsa, kursga ko‚Äòra hisoblash
        if (isDollar) {
            input.val(formatNumber((tolashSummasi / currentKurs).toFixed(2)));
        } else {
            input.val(formatNumber(tolashSummasi));
        }

        // Umumiy hisobni yangilash
        updatePaymentTotal();
    }
}




$(document).on('click', '.remove-field', function () {
    const parentBox = $(this).closest('.input-box');
    const input = parentBox.find('.payment-input');

    // Inputni tozalaymiz
    input.val('');

    updatePaymentTotal()
});

function calculatePaymentTotal() {
    $('#total_jami').text(formatNumber(currentDatas.total_price))
    let total = 0;

    $('.plus_button').each(function() {
        const inputBox = $(this).find('.input-box');
        
        // faqat display:none bo‚Äòlmaganlarini olish
        if (inputBox.is(':visible')) {
            const inputVal = parseFloat(cleanNumber($(this).find('.payment-input').val())) || 0;
            const isDollar = $(this).find('.toggle-input').data('dollar') === true;

            if (isDollar) {
                total += inputVal * currentKurs;
            } else {
                total += inputVal;
            }
        }
    });

    // $('#tolash_summasi').text(formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total)))
    // console.log(formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total)))
    return formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total));
}

function updatePaymentTotal() {
    let total = calculatePaymentTotal()
    console.log(total)
    $('#tolash_summasi').text(total)
}

// Masalan, har input o‚Äòzgarganda hisoblash uchun:
$(document).on('input', '.payment-input', function() {
    updatePaymentTotal();
    updateCheckPayments();

});

</script>



<script>
    



function fetchDebtInfo() {
    const debtorSelectize = $('#mainSelectDebtor')[0]?.selectize;
    const debtorId = debtorSelectize ? debtorSelectize.getValue() : '';
    
    fetch(`/get-debts/${debtorId}/`)
        .then(response => response.json())
        .then(data => {
            updatePaysDiv(data);
        })
        .catch(error => {
            console.error('Xatolik:', error);
        });
}

function updatePaysDiv(data) {
    const paysDiv = document.getElementById('pays-div');
    if (!paysDiv) return;

    let qarzHTML = `
        <div class="col-md-6">
            <strong>Qarz:</strong>
            <div class="mt-2">
    `;

    let haqHTML = `
        <div class="col-md-6">
            <strong>Haq:</strong>
            <div class="mt-2">
    `;

    // Valyuta + Wallet larni bog‚Äòlash
    data.valyutas_for_debt.forEach(valyuta => {
        const wallet = data.wallets.find(w => w.valyuta_id === valyuta.id);
        const summa = wallet ? wallet.summa : 0;

        if (summa <= 0) {
            qarzHTML += `
                <p class="text-danger mb-0">
                    ${valyuta.name}: ${formatNumber(summa)}
                </p>
            `;
        } else {
            haqHTML += `
                <p class="text-success mb-0">
                    ${valyuta.name}: ${formatNumber(summa)}
                </p>
            `;
        }
    });

    qarzHTML += `</div></div>`;
    haqHTML += `</div></div>`;

    // Yakuniy HTML ‚Äî ikki ustunli
    paysDiv.innerHTML = `
            ${qarzHTML}
            ${haqHTML}
    `;
}

$(document).ready(function() {
    // DOM elementni olish (jQuery elementning [0]-chi elementi)
    var fullscreenPaymentEl = $('#fullscreenPayment')[0]; 

    // Bootstrap modal obyekti yaratish
    var fullscreenPaymentModal = new bootstrap.Modal(fullscreenPaymentEl);

    // Modalni ochish
    $('#fullscreenPaymentBtn').on('click', function() {

        let filialId = document.getElementById('selectFilial').value;

        document.querySelectorAll('.kassa_merges').forEach(element => {
            if (element.dataset.filial != filialId) {
                element.style.display = 'none';
                return;
            } else {
                element.style.display = '';
            }
        });

        initializeShop(currentDatas.id);
        document.querySelectorAll('.input-box').forEach(element => {
            element.style.display = 'none';
        });
        fetchDebtInfo()
        fullscreenPaymentModal.show();
        calculatePaymentTotal();
        loadExistingPaymentsForModal();
    });

    // Modalni yopish va inputlarni tozalash
    function closeFullscreen() {
        fullscreenPaymentModal.hide();
        $('#fullscreenPayment').find('.payment-input').val('0');
    }

    // Tugmalarni bog‚Äòlash
    $('#closeFullscreenBtn, #cancelPaymentBtn').on('click', closeFullscreen);

    // ESC yoki backdrop bosilganda inputlarni tozalash
    $('#fullscreenPayment').on('hidden.bs.modal', function() {
        $(this).find('.payment-input').val('0');
    });
});


// </script>


<script>
    // Sotuvlar ro'yxatini boshqarish
document.addEventListener('DOMContentLoaded', function() {
    const shopsContainer = document.getElementById('shops-container');
    const paginationContainer = document.getElementById('pagination-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const filterForm = document.getElementById('filter-form');
    const returnModal = document.getElementById('return-modal');
    const returnOverlay = document.getElementById('return-modal-overlay');
    const closeReturnModal = document.getElementById('close-return-modal');
    const returnShopInfo = document.getElementById('return-shop-info');
    const subtractFromDebtCheckbox = document.getElementById('subtract-from-debt');
    const paymentSection = document.getElementById('payment-section');
    const addPaymentBtn = document.getElementById('add-payment');
    const paymentsContainer = document.getElementById('payments-container');
    const totalReturnDisplay = document.getElementById('total-return-display');
    const confirmReturnBtn = document.getElementById('confirm-return');
    // const filialId = document.getElementById('select-filial').value;

    
    let currentPage = 1;
    let currentShops = [];
    let currentShop = null;
    let totalReturnAmount = 0;
    let payments = [];
    
    // Sahifani yuklash
    function loadShops(page = 1) {
        currentPage = page;
        loadingSpinner.style.display = 'block';
        shopsContainer.style.opacity = '0.5';
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        // Form ma'lumotlarini qo'shamiz
        for (let [key, value] of formData.entries()) {
            if (key === 'deliver' || key === 'client') {
                const values = formData.getAll(key);
                values.forEach(val => params.append(key, val));
            } else if (value) {
                params.append(key, value);
            }
        }
        
        params.append('page', page);
        params.append('filial', document.getElementById('select-filial').value);
        
        fetch(`?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            currentShops = data.shops;
            renderShops(data.shops);
            renderPagination(data);
            updateTotals(data);
            loadingSpinner.style.display = 'none';
            shopsContainer.style.opacity = '1';
        })
        .catch(error => {
            console.error('Xatolik:', error);
            loadingSpinner.style.display = 'none';
            shopsContainer.style.opacity = '1';
            shopsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Xatolik yuz berdi: ${error.message}
                </div>
            `;
        });
    }
    
    // Sotuvlarni render qilish
    function renderShops(shops) {
        if (shops.length === 0) {
            shopsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h5>Hech qanday sotuv topilmadi</h5>
                        <p class="text-muted">Filterlarni o'zgartirib ko'ring</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        shops.forEach((shop, index) => {

                // To'lov jami larini formatlash
                let paymentTotalsHtml = '';
                for (const [valyuta, summa] of Object.entries(shop.payment_totals)) {
                    paymentTotalsHtml += `
                        <div class="payment-total-item">
                            <div class="payment-total-label">${valyuta}</div>
                            <div class="payment-total-value">${parseFloat(summa).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                if (!paymentTotalsHtml) {
                    paymentTotalsHtml = '<div class="text-muted">To\'lovlar mavjud emas</div>';
                }
    
                let chiqimTotalsHtml = '';
                for (const [valyuta, summa] of Object.entries(shop.chiqim_totals)) {
                    chiqimTotalsHtml += `
                        <div class="payment-total-item">
                            <div class="payment-total-label">${valyuta}</div>
                            <div class="payment-total-value">${parseFloat(summa).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                if (!chiqimTotalsHtml) {
                    chiqimTotalsHtml = '<div class="text-muted">To\'lovlar mavjud emas</div>';
                }
                
                // Chegirma ko'rsatish
                let chegirmaHtml = '';
                if (shop.chegirma > 0) {
                    chegirmaHtml = `<span class="chegirma-badge">Chegirma: ${parseFloat(shop.chegirma).toLocaleString()}</span>`;
                }
                
                html += `
                    <div class="shop-table">
                        <div class="shop-header" onclick="toggleShopDetails(${shop.id})">
                            <div class="shop-main-info">
                                <div>
                                    <strong>${shop.debtor_name}</strong>
                                    <br>
                                    <small class="text-muted">${shop.date}</small>
                                    ${chegirmaHtml}
                                </div>
                                <div>
                                    <div class="text-success"><strong>${parseFloat(shop.total_price).toLocaleString()} ${shop.valyuta_name}</strong></div>
                                    <small class="text-muted">Jami summa</small>
                                </div>
    
                                <div>
                                    <div class="text-success"><strong>${parseFloat(shop.total_returned_sum).toLocaleString()} ${shop.valyuta_name}</strong></div>
                                    <small class="text-muted">Qaytarilgan summa</small>
                                </div>
    
                                <div>
                                    <div><strong>${shop.total_quantity}</strong></div>
                                    <small class="text-muted">Mahsulotlar</small>
                                </div>
                                <div>
                                    ${paymentTotalsHtml ? Object.keys(shop.payment_totals).length + ' hil to\'lov' : 'To\'lov yo\'q'}
                                </div>
    
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editShopModal(${shop.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
    
                                    <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); openReturnModal(${shop.id})">
                                        <i class="fas fa-undo"></i> Qaytarish
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="shop-details" id="details-${shop.id}">
                            <!-- Mahsulotlar qismi -->
                            <div class="carts-section">
                                <div class="section-title">
                                    <span>Sotilgan Mahsulotlar</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Mahsulot</th>
                                                <th>Narx</th>
                                                <th>Soni</th>
                                                <th>Summa</th>
                                                <th>Qaytarilgan</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${shop.carts.map(cart => `
                                                <tr>
                                                    <td>${cart.product_name}</td>
                                                    <td>${parseFloat(cart.price).toLocaleString()}</td>
                                                    <td>${parseFloat(cart.quantity).toLocaleString()}</td>
                                                    <td>${parseFloat(cart.total).toLocaleString()}</td>
                                                    <td>${parseFloat(cart.total_returned).toLocaleString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- To'lovlar qismi -->
                            <div class="payments-section">
                                <div class="section-title">
                                    <span>To'lovlar</span>
                                </div>
                                <div class="payment-totals">
                                    ${paymentTotalsHtml}
                                </div>
                                ${shop.payment_details.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Summa</th>
                                                    <th>Valyuta</th>
                                                    <th>Kassa</th>
                                                    <th>Sana</th>
                                                    <th>Turi</th>
                                                    <th>Holat</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${shop.payment_details.map(payment => `
                                                <tr class="${payment.is_debt ? 'debt-payment' : ''}">
                                                    <td>${parseFloat(payment.summa).toLocaleString()}</td>
                                                    <td>${payment.valyuta}</td>
                                                    <td>${payment.kassa}</td>
                                                    <td>${payment.date}</td>
                                                    <td class="${payment.type_pay == 1 ? 'text-primary' : 'text-danger'}">
                                                        ${payment.type_pay == 1 ? 'Kirim' : 'Chiqim'}
                                                    </td>
                                                    <td>
                                                        ${payment.is_debt 
                                                            ? '<span class="badge bg-warning">Qarz</span>' 
                                                            : '<span class="badge bg-success">To\'lov</span>'
                                                        }
                                                    </td>
                                                </tr>
                                            `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">To\'lovlar mavjud emas</p>'}
                            </div>
    
                            <!-- Qaytarilgan summalar qismi -->
                            <div class="payments-section">
                                <div class="section-title">
                                    <span>Qaytarilgan summalar</span>
                                </div>
                                <div class="payment-totals">
                                    ${chiqimTotalsHtml}
                                </div>
                                ${shop.chiqim_details.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Summa</th>
                                                    <th>Valyuta</th>
                                                    <th>Kassa</th>
                                                    <th>Sana</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${shop.chiqim_details.map(chiqim => `
                                                <tr class="">
                                                    <td>${parseFloat(chiqim.summa).toLocaleString()}</td>
                                                    <td>${chiqim.valyuta}</td>
                                                    <td>${chiqim.kassa}</td>
                                                    <td>${chiqim.date}</td>
                                                </tr>
                                            `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">To\'lovlar mavjud emas</p>'}
                            </div>
                            
                            <!-- Qaytarilgan mahsulotlar qismi -->
                            ${shop.return_details.length > 0 ? `
                                <div class="returns-section">
                                    <div class="section-title">
                                        <span>Qaytarilgan Mahsulotlar</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Mahsulot</th>
                                                    <th>Qaytarilgan miqdor</th>
                                                    <th>Sana</th>
                                                    <th>Kim tomonidan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${shop.return_details.map(return_item => `
                                                    <tr>
                                                        <td>${return_item.product_name}</td>
                                                        <td>${parseFloat(return_item.return_quantity).toLocaleString()}</td>
                                                        <td>${return_item.date}</td>
                                                        <td>${return_item.returned_by}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
        });
        
        shopsContainer.innerHTML = html;
    }
    
    // Pagination render qilish
    function renderPagination(data) {
        let html = '';
        
        if (data.total_pages > 1) {
            html = '<nav><ul class="pagination justify-content-center">';
            
            if (data.has_previous) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadShops(${data.current_page - 1})">‚Üê Oldingi</a>
                </li>`;
            }
            
            // Birinchi sahifalar
            for (let i = 1; i <= Math.min(3, data.total_pages); i++) {
                html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                </li>`;
            }
            
            // O'rtada nuqtalar
            if (data.current_page > 4) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            
            // Joriy sahifa atrofi
            for (let i = Math.max(4, data.current_page - 1); i <= Math.min(data.total_pages - 1, data.current_page + 1); i++) {
                if (i > 3 && i < data.total_pages) {
                    html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                    </li>`;
                }
            }
            
            // Oxirgi nuqtalar
            if (data.current_page < data.total_pages - 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            
            // Oxirgi sahifalar
            if (data.total_pages > 3) {
                for (let i = Math.max(data.total_pages - 2, data.current_page + 2); i <= data.total_pages; i++) {
                    html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                    </li>`;
                }
            }
            
            if (data.has_next) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadShops(${data.current_page + 1})">Keyingi ‚Üí</a>
                </li>`;
            }
            
            html += '</ul></nav>';
        }
        
        paginationContainer.innerHTML = html;
    }
    
    // Jami qiymatlarni yangilash
    

    function updateTotals(data) {

        let paymentsHTML = '';
        if (data.payments_by_currency && Object.keys(data.payments_by_currency).length > 0) {
            paymentsHTML = Object.entries(data.payments_by_currency)
                .map(([currency, amount]) => `
                    <h6 class="text-primary"><small>${formatNumber(amount)} ${currency}</small></h6>
                `).join('');
        } else {
            paymentsHTML = '<h6 class="text-primary"><small>0</small></h6>';
        }


        let debtsHTML = '';
        if (data.debts_by_currency && Object.keys(data.debts_by_currency).length > 0) {
            debtsHTML = Object.entries(data.debts_by_currency)
                .map(([currency, amount]) => `
                    <h6 class="text-primary"><small>${formatNumber(amount)} ${currency}</small></h6>
                `).join('');
        } else {
            paymentsHTML = '<h6 class="text-primary"><small>0</small></h6>';
        }
        
        // document.getElementById('current-page').textContent = data.current_page;
        $('#total-price').html(paymentsHTML)
        $('#total-debt').html(debtsHTML)
        document.getElementById('total-quantity').textContent = parseFloat(data.total_quantity).toLocaleString();
        document.getElementById('total-shops').textContent = parseInt(data.total_shops).toLocaleString();
    }
    
    // Shop tafsilotlarini ochish/yopish
    window.toggleShopDetails = function(shopId) {
        const details = document.getElementById(`details-${shopId}`);
        details.classList.toggle('show');
    }
    
    // Qaytarish modalini ochish
    window.openReturnModal = function(shopId) {
        currentShop = currentShops.find(s => s.id === shopId);
        if (!currentShop) return;
        
        // Shop ma'lumotlarini ko'rsatish
        returnShopInfo.innerHTML = `
            <strong>${currentShop.debtor_name}</strong><br>
            <small>Sana: ${currentShop.date}</small><br>
            <small>Jami summa: ${parseFloat(currentShop.total_price).toLocaleString()} ${currentShop.valyuta_name}</small>
            ${currentShop.chegirma > 0 ? `<br><small>Chegirma: ${parseFloat(currentShop.chegirma).toLocaleString()}</small>` : ''}
        `;
        
        // Qaytariladigan mahsulotlar ro'yxati
        let productsHtml = '';
        totalReturnAmount = 0;
        
        currentShop.carts.forEach(cart => {
            const maxReturnable = cart.quantity - cart.total_returned;
            if (maxReturnable > 0) {
                productsHtml += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${cart.product_name}</h6>
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <small class="text-muted">Qaytarish mumkin: ${maxReturnable}</small>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Narx: ${parseFloat(cart.price).toLocaleString()}</small>
                                </div>
                                <div class="col-4">
                                    <input type="number" 
                                           class="form-control form-control-sm return-quantity" 
                                           data-cart-id="${cart.id}"
                                           data-price="${cart.price}"
                                           min="0" 
                                           max="${maxReturnable}" 
                                           step="0.01"
                                           placeholder="Miqdor"
                                           value="0"
                                           onchange="updateReturnTotal()">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        if (!productsHtml) {
            productsHtml = '<div class="alert alert-info">Qaytarish mumkin bo\'lgan mahsulotlar yo\'q</div>';
        }
        
        document.getElementById('return-products-list').innerHTML = productsHtml;
        
        // To'lovlarni tozalash
        payments = [];
        paymentsContainer.innerHTML = '';
        updatePaymentSection();
        
        returnModal.classList.add('show');
        returnOverlay.classList.add('show');
    }
    
    // Qaytarish jami summasini yangilash
    window.updateReturnTotal = function() {
        totalReturnAmount = 0;
        const inputs = document.querySelectorAll('.return-quantity');
        
        inputs.forEach(input => {
            const quantity = parseFloat(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            totalReturnAmount += quantity * price;
        });
        
        totalReturnDisplay.innerHTML = `
            Jami qaytarish summasi: <strong>${totalReturnAmount.toLocaleString()} ${currentShop.valyuta_name}</strong>
        `;
        
        updatePaymentSection();
    }
    
    // To'lov bo'limini yangilash
    function updatePaymentSection() {
        const isNaqdMijoz = currentShop.debtor_name.toLowerCase().includes('naqd');
        const shouldShowPayment = !subtractFromDebtCheckbox.checked || isNaqdMijoz;
        
        paymentSection.style.display = shouldShowPayment ? 'block' : 'none';
        
        if (shouldShowPayment) {
            totalReturnDisplay.style.display = totalReturnAmount > 0 ? 'block' : 'none';
        }
    }
    
    // To'lov qo'shish
    addPaymentBtn.addEventListener('click', function() {
        const paymentId = Date.now();
        const paymentHtml = `
            <div class="payment-row" id="payment-${paymentId}">
                <div class="payment-amount">
                    <label>Summa</label>
                    <input type="number" class="form-control payment-amount-input" 
                           step="0.01" min="0" placeholder="Summa"
                           onchange="updatePayments()">
                </div>
                <div class="payment-amount">
                    <label>Valyuta</label>
                    <select class="form-control valyuta-select" onchange="onValyutaChange(${paymentId})">
                        <option value="">Valyuta tanlang</option>
                        {% for valyuta in valyutalar %}
                            <option value="{{ valyuta.id }}" 
                                    data-is-dollar="{{ valyuta.is_dollar|yesno:'true,false' }}"
                                    data-is-som="{{ valyuta.is_som|yesno:'true,false' }}">
                                {{ valyuta.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="payment-amount">
                    <label>Kassa</label>
                    <select class="form-control kassa-select" id="kassa-${paymentId}" onchange="updatePayments()">
                        <option value="">Kassa tanlang</option>
                    </select>
                </div>
                <div class="remove-payment" onclick="removePayment(${paymentId})">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        `;
        
        paymentsContainer.insertAdjacentHTML('beforeend', paymentHtml);
        payments.push({
            id: paymentId,
            amount: 0,
            valyuta_id: null,
            kassa_id: null
        });
    });
    
    
    // Valyuta o'zgarganda kassalarni yuklash
    window.onValyutaChange = function(paymentId) {
        const valyutaSelect = document.querySelector(`#payment-${paymentId} .valyuta-select`);
        const kassaSelect = document.querySelector(`#kassa-${paymentId}`);
        const valyutaId = valyutaSelect.value;
        
        if (valyutaId) {
            fetch(`/get-kassalar-by-valyuta/?valyuta_id=${valyutaId}`)
                .then(response => response.json())
                .then(data => {
                    kassaSelect.innerHTML = '<option value="">Kassa tanlang</option>';
                    data.kassalar.forEach(kassa => {
                        kassaSelect.innerHTML += `<option value="${kassa.id}" data-balance="${kassa.balance}">${kassa.name}</option>`;
                    });
                    updatePayments();
                });
        } else {
            kassaSelect.innerHTML = '<option value="">Kassa tanlang</option>';
            updatePayments();
        }
    }
    
    // To'lovni o'chirish
    window.removePayment = function(paymentId) {
        const paymentElement = document.getElementById(`payment-${paymentId}`);
        if (paymentElement) {
            paymentElement.remove();
        }
        payments = payments.filter(p => p.id !== paymentId);
        updatePayments();
    }
    
    // To'lovlarni yangilash
    window.updatePayments = function() {
        let totalPaid = 0;
        
        payments.forEach(payment => {
            const paymentElement = document.getElementById(`payment-${payment.id}`);
            if (paymentElement) {
                const amountInput = paymentElement.querySelector('.payment-amount-input');
                const valyutaSelect = paymentElement.querySelector('.valyuta-select');
                const kassaSelect = paymentElement.querySelector('.kassa-select');
                
                payment.amount = parseFloat(amountInput.value) || 0;
                payment.valyuta_id = valyutaSelect.value;
                payment.kassa_id = kassaSelect.value;
                
                // Valyuta konvertatsiyasi
                if (payment.amount > 0 && payment.valyuta_id) {
                    const valyutaOption = valyutaSelect.options[valyutaSelect.selectedIndex];
                    const isDollar = valyutaOption.dataset.isDollar === 'true';
                    const isSom = valyutaOption.dataset.isSom === 'true';
                    
                    if (currentShop.valyuta_is_dollar && isSom) {
                        // Dollar -> So'm
                        totalPaid += payment.amount / currentShop.kurs;
                    } else if (!currentShop.valyuta_is_dollar && isDollar) {
                        // So'm -> Dollar
                        totalPaid += payment.amount * currentShop.kurs;
                    } else {
                        totalPaid += payment.amount;
                    }
                }
            }
        });
        
        // Jami to'langan summani ko'rsatish
        if (totalReturnAmount > 0) {
            totalReturnDisplay.innerHTML = `
                Jami qaytarish summasi: <strong>${totalReturnAmount.toLocaleString()} ${currentShop.valyuta_name}</strong><br>
                Jami to'langan: <strong>${totalPaid.toLocaleString()} ${currentShop.valyuta_name}</strong><br>
                Farq: <strong>${(totalReturnAmount - totalPaid).toLocaleString()} ${currentShop.valyuta_name}</strong>
            `;
        }
    }
    
    // Qarzdan ayirish checkbox'ini tinglash
    subtractFromDebtCheckbox.addEventListener('change', function() {
        updatePaymentSection();
    });
    
    // Qaytarishni tasdiqlash
    confirmReturnBtn.addEventListener('click', function() {
        const returnItems = [];
        const returnInputs = document.querySelectorAll('.return-quantity');
        
        returnInputs.forEach(input => {
            const quantity = parseFloat(input.value);
            if (quantity > 0) {
                returnItems.push({
                    cart_id: input.dataset.cartId,
                    return_quantity: quantity
                });
            }
        });
        
        if (returnItems.length === 0) {
            alert('Hech qanday miqdor kiritilmagan');
            return;
        }
        
        // To'lovlarni tekshirish
        const subtractFromDebt = subtractFromDebtCheckbox.checked;
        const isNaqdMijoz = currentShop.debtor_name.toLowerCase().includes('naqd');
        
        if ((!subtractFromDebt || isNaqdMijoz) && payments.length === 0) {
            alert('To\'lov usulini tanlang yoki to\'lov qo\'shing');
            return;
        }
        
        // To'lovlarni tekshirish
        let totalPaid = 0;
        const validPayments = [];
        
        payments.forEach(payment => {
            if (payment.amount > 0 && payment.valyuta_id && payment.kassa_id) {
                totalPaid += payment.amount;
                validPayments.push(payment);
            }
        });
        
        if ((!subtractFromDebt || isNaqdMijoz) && validPayments.length === 0) {
            alert('To\'g\'ri to\'lov ma\'lumotlarini kiriting');
            return;
        }
        
        confirmReturnBtn.disabled = true;
        confirmReturnBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Amalga oshirilmoqda...';
        
        fetch("{% url 'return_products' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                shop_id: currentShop.id,
                return_items: returnItems,
                payments: validPayments,
                subtract_from_debt: subtractFromDebt,
                filial: $('#select-filial').val()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                returnModal.classList.remove('show');
                returnOverlay.classList.remove('show');
                loadShops(currentPage); // Sahifani yangilash
            } else {
                alert('Xatolik: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Xatolik:', error);
            alert('Server xatosi yuz berdi');
        })
        .finally(() => {
            confirmReturnBtn.disabled = false;
            confirmReturnBtn.innerHTML = '<i class="fas fa-check"></i> Qaytarishni Tasdiqlash';
        });
    });
    
    // Qaytarish modalini yopish
    closeReturnModal.addEventListener('click', function() {
        returnModal.classList.remove('show');
        returnOverlay.classList.remove('show');
    });
    
    returnOverlay.addEventListener('click', function() {
        returnModal.classList.remove('show');
        returnOverlay.classList.remove('show');
    });
    
    // Filter formasi
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadShops(1);
    });
    
    // Sahifani boshlang'ich yuklash
    loadShops(1);
});
</script>



<script>
// QarzModal-ni boshqarish
$(document).on('click', '#qarzModalButton .method-box', function (e) {
    e.stopPropagation();
    
    const customerSelect = $('#mainSelectDebtor')[0].selectize;
    const selectedCustomerId = customerSelect.getValue();
    
    if (!selectedCustomerId) {
        showAlert('Iltimos, avval mijozni tanlang', 'warning');
        return;
    }
    
    // Qarz input boxini ko'rsatish
    showQarzInputBox(this);
});

// Qarz input boxini ko'rsatish
function showQarzInputBox(element) {
    let qarzInputBox = document.getElementById('qarzInputBox');
    const mainBox = $(element).closest('.plus_button');
    const isDollar = mainBox.find('.toggle-input').data('dollar') === true;
    
    // Boshqa input boxlarni yopish
    // $('.input-box').hide();
    
    // Qarz input boxini ko'rsatish
    qarzInputBox.style.display = 'block';
    // $('#qarzBoxValyuta').val();


    qarzInputBox = $(qarzInputBox)
    const input = qarzInputBox.find('#qarzBoxSumma');
    input.val('')

    let inputValue = 0
    if (isDollar) {
        inputValue = (parseFloat(cleanNumber(input.val())) || 0) * currentKurs;
    } else {
        inputValue = parseFloat(cleanNumber(input.val())) || 0;
    }
    input.trigger('focus');

    let tolashSummasi = parseFloat(calculatePaymentTotal().replace(/\s+/g, '')); 



    // Agar dollar bo‚Äòlsa, kursga ko‚Äòra hisoblash
    if (isDollar) {
        input.val(formatNumber((tolashSummasi / currentKurs).toFixed(2)));
    } else {
        input.val(formatNumber(tolashSummasi));
    }



    const dueDateInput = document.getElementById('qarzBoxDueDate');
    const today = new Date();
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    // Mahalliy vaqt formati bilan YYYY-MM-DD yaratamiz
    const year = lastDay.getFullYear();
    const month = String(lastDay.getMonth() + 1).padStart(2, '0');
    const day = String(lastDay.getDate()).padStart(2, '0');

    dueDateInput.value = `${year}-${month}-${day}`;

    
    // Formani tozalash
    // document.getElementById('qarzBoxValyuta').value = '';
    // document.getElementById('qarzBoxSumma').value = '';
    // document.getElementById('qarzBoxDueDate').value = '';
    // document.getElementById('qarzBoxComment').value = '';
    
    // Kursni yangilash
    updatePaymentTotal();
}

function clearInputBox() {
    let qarzInputBox = document.getElementById('qarzInputBox');
    qarzInputBox.style.display = 'none';
    // const input = qarzInputBox.find('#qarzBoxSumma');
    // input.value = ''


    // document.getElementById('qarzBoxValyuta').value = '';
    document.getElementById('qarzBoxSumma').value = '';
    document.getElementById('qarzBoxDueDate').value = '';
    document.getElementById('qarzBoxComment').value = '';


}

// Qarz input boxini yopish
function hideQarzInputBox() {
    const qarzInputBox = document.getElementById('qarzInputBox');
    qarzInputBox.style.display = 'none';
    updatePaymentTotal();
}

// Qarzni to'lovlar ro'yxatiga qo'shish
function addQarzToPayment() {
    const valyutaId = document.getElementById('qarzBoxValyuta').value;
    const summa = parseFloat(cleanNumber(document.getElementById('qarzBoxSumma').value));
    const dueDate = document.getElementById('qarzBoxDueDate').value;
    const comment = document.getElementById('qarzBoxComment').value;
    
    if (!valyutaId || !summa || summa <= 0 || !dueDate) {
        showAlert('Iltimos, valyuta, summani va sanani to\'g\'ri kiriting', 'warning');
        return;
    }
    
    const valyutaSelect = document.getElementById('qarzBoxValyuta');
    const selectedOption = valyutaSelect.options[valyutaSelect.selectedIndex];
    const valyutaName = selectedOption.getAttribute('data-name');
    const isDollar = selectedOption.getAttribute('data-is-dollar') === 'true';
    
    // Qarz ma'lumotlarini global o'zgaruvchiga saqlash (sessionStorage o'rniga)
    window.currentQarzData = {
        type: 'qarz',
        valyuta_id: valyutaId,
        valyuta_name: valyutaName,
        summa: summa,
        due_date: dueDate,
        comment: comment,
        is_dollar: isDollar
    };
    
    // Input boxni yopish
    hideQarzInputBox();
    
    // Chekda ko'rsatish
    updateCheckPayments();
    
    // To'lov jamiini yangilash
    updatePaymentTotal();

    updateCheckPayments();

    
    showAlert('Qarz ma\'lumotlari qo\'shildi', 'success');
}

// Qarzni to'lovlar ro'yxatiga qo'shish
function addQarzToPayment() {
    const valyutaId = document.getElementById('qarzBoxValyuta').value;
    const summa = parseFloat(cleanNumber(document.getElementById('qarzBoxSumma').value));
    const dueDate = document.getElementById('qarzBoxDueDate').value;
    const comment = document.getElementById('qarzBoxComment').value;
    
    if (!valyutaId || !summa || summa <= 0 || !dueDate) {
        showAlert('Iltimos, valyuta, summani va sanani to\'g\'ri kiriting', 'warning');
        return;
    }
    
    const valyutaSelect = document.getElementById('qarzBoxValyuta');
    const selectedOption = valyutaSelect.options[valyutaSelect.selectedIndex];
    const valyutaName = selectedOption.getAttribute('data-name');
    const isDollar = selectedOption.getAttribute('data-is-dollar') === 'true';
    
    // Input boxni yopish
    hideQarzInputBox();
    
    // Chekda ko'rsatish
    updateCheckPayments();
    
    // To'lov jamiini yangilash
    updatePaymentTotal();
    
    showAlert('Qarz ma\'lumotlari qo\'shildi', 'success');
}

$(document).on('input', '#qarzBoxSumma, #qarzBoxValyuta, #qarzBoxDueDate, #qarzBoxComment', function() {
    updateCheckPayments();
});

// Chekda qarzni ko'rsatish
// function updateQarzInCheck(valyutaId, summa, valyutaName, dueDate, comment, isDollar) {
//     const checkTolovlar = document.getElementById('check_tolovlar');
    
//     let dueDateInfo = '';
//     if (dueDate) {
//         dueDateInfo = `<br><small>To'lov muddati: ${dueDate}</small>`;
//     }
    
//     let commentInfo = '';
//     if (comment) {
//         commentInfo = `<br><small>Izoh: ${comment}</small>`;
//     }
    
//     // Avval mavjud to'lovlarni saqlab olamiz
//     let existingPayments = checkTolovlar.innerHTML;
    
//     // Qarz qismini qo'shamiz yoki yangilaymiz
//     const qarzSection = `
//         <div class="section">
//             <div class="lines"><span class="bold">Qarz</span><span>${formatNumber(summa)} ${valyutaName}</span></div>
//             ${dueDateInfo}
//             ${commentInfo}
//         </div>
//     `;
    
//     // Agar allaqachon qarz bo'lsa, uni yangilaymiz
//     if (existingPayments.includes('Qarz</span>')) {
//         checkTolovlar.innerHTML = existingPayments.replace(
//             /<div class="section">[\s\S]*?Qarz[\s\S]*?<\/div>/,
//             qarzSection
//         );
//     } else {
//         checkTolovlar.innerHTML += qarzSection;
//     }
// }


// To'lov ma'lumotlarini yig'ish
function collectPaymentData() {
    const payments = [];
    let totalPaid = 0;

    // Kassalar bo'yicha to'lovlar
    $('.plus_button').each(function() {
        if (!$(this).is('#qarzModalButton')) {
            const inputBox = $(this).find('.input-box');
            if (inputBox.is(':visible')) {
                const inputVal = parseFloat(cleanNumber($(this).find('.payment-input').val())) || 0;
                const kassaId = $(this).find('.payment-method').data('kassa-id');
                const valyutaId = $(this).find('.payment-method').data('valyuta-id');
                const valyutaName = $(this).find('.payment-method').data('valyuta-name');
                const isDollar = $(this).find('.toggle-input').data('dollar') === true;
                
                if (inputVal > 0) {
                    // Valyuta konvertatsiyasi
                    let convertedAmount = inputVal;
                    if (isDollar && !currentDatas.valyuta_is_dollar) {
                        convertedAmount = inputVal * currentKurs;
                    } else if (!isDollar && currentDatas.valyuta_is_dollar) {
                        convertedAmount = inputVal / currentKurs;
                    }
                    
                    totalPaid += convertedAmount;
                    
                    payments.push({
                        kassa_id: kassaId,
                        valyuta_id: valyutaId,
                        valyuta_name: valyutaName,
                        summa: inputVal,
                        converted_summa: convertedAmount,
                        type: 'payment',
                        is_dollar: isDollar
                    });
                }
            }
        }
    });

    // Qarzni hisobga olish (faqat inputlardan olish)
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(cleanNumber(document.getElementById('qarzBoxSumma').value)) || 0;
    const qarzDueDate = document.getElementById('qarzBoxDueDate').value;
    const qarzComment = document.getElementById('qarzBoxComment').value;
    
    if (qarzValyutaId && qarzSumma > 0) {
        const qarzValyutaSelect = document.getElementById('qarzBoxValyuta');
        const qarzSelectedOption = qarzValyutaSelect.options[qarzValyutaSelect.selectedIndex];
        const qarzIsDollar = qarzSelectedOption.getAttribute('data-is-dollar') === 'true';
        
        let convertedQarzAmount = qarzSumma;
        
        if (qarzIsDollar && !currentDatas.valyuta_is_dollar) {
            convertedQarzAmount = qarzSumma * currentKurs;
        } else if (!qarzIsDollar && currentDatas.valyuta_is_dollar) {
            convertedQarzAmount = qarzSumma / currentKurs;
        }
        
        totalPaid += convertedQarzAmount;
        
        payments.push({
            type: 'qarz',
            valyuta_id: qarzValyutaId,
            summa: qarzSumma,
            converted_summa: convertedQarzAmount,
            due_date: qarzDueDate,
            comment: qarzComment,
            is_dollar: qarzIsDollar
        });
    }

    return {
        payments: payments,
        total_paid: totalPaid
    };
}

// To'lovni tekshirish va yakunlash
async function Yakunlash() {
    try {
        const totalRequired = parseFloat(currentDatas.total_price);
        const paymentResult = collectPaymentData();
        const totalPaid = paymentResult.total_paid;
        
        // To'lov miqdorini tekshirish
        if (totalPaid < totalRequired) {
            const difference = totalRequired - totalPaid;
            showAlert(`To'lov yetarli emas! Yetishmayotgan summa: ${formatNumber(difference)} ${currentDatas.valyuta_name}`, 'danger');
            return;
        }
        
        // Agar ortiqcha to'langan bo'lsa, ogohlantirish
        if (totalPaid > totalRequired) {
            const difference = totalPaid - totalRequired;
            const confirmContinue = confirm(`To'lov keragidan ${formatNumber(difference)} ${currentDatas.valyuta_name} ko'p. Davom ettirilsinmi?`);
            if (!confirmContinue) {
                return;
            }
        }

        // To'lov ma'lumotlarini tayyorlash
        const paymentData = {
            shop_id: currentShopId,
            payments: paymentResult.payments,
            total_required: totalRequired,
            total_paid: totalPaid,
            chegirma: parseFloat(cleanNumber($('#discountInput').val())) || 0
        };

        console.log(paymentData, 'ooooooo')
        
        // Yuklash indikatorini ko'rsatish
        const submitBtn = document.getElementById('submit-payment');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Amalga oshirilmoqda...';
        
        // Serverga yuborish
        const response = await fetch("{% url 'complete_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(paymentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('To\'lov muvaffaqiyatli yakunlandi!', 'success');
            
            // Modalni yopish
            const paymentModal = bootstrap.Modal.getInstance(document.getElementById('fullscreenPayment'));
            paymentModal.hide();
            
            // POS modalini ham yopish
            const posModal = bootstrap.Modal.getInstance(document.getElementById('posModal'));
            if (posModal) {
                posModal.hide();
            }
            
            // Ma'lumotlarni tozalash
            $('.payment-input').val('');
            $('.input-box').hide();
            // document.getElementById('qarzBoxValyuta').value = '';
            document.getElementById('qarzBoxSumma').value = '';
            document.getElementById('qarzBoxDueDate').value = '';
            document.getElementById('qarzBoxComment').value = '';
            document.getElementById('check_tolovlar').innerHTML = '';

            $('#filter_submit').trigger('click')
            // Sahifani yangilash
            setTimeout(() => {
                // window.location.reload();
            }, 1500);
            
        } else {
            showAlert(result.message || 'To\'lovda xatolik yuz berdi', 'danger');
        }
    } catch (error) {
        console.error('Yakunlashda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    } finally {
        // Tugmani qayta faollashtirish
        const submitBtn = document.getElementById('submit-payment');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> To\'lovni tasdiqlash va Yakunlash';
        }
    }
}

// Real vaqtda to'lov miqdorini tekshirish va ko'rsatish
function updatePaymentTotal() {
    const totalRequired = parseFloat(currentDatas.total_price);
    const paymentResult = collectPaymentData();
    const totalPaid = paymentResult.total_paid;
    
    const remaining = totalRequired - totalPaid;
    $('#tolash_summasi').text(formatNumber(remaining > 0 ? remaining : 0));
    
    // To'lov holatini rang bilan ko'rsatish
    const tolashElement = $('#tolash_summasi');
    tolashElement.removeClass('text-success text-warning text-danger');
    
    if (remaining <= 0) {
        tolashElement.addClass('text-success');
    } else if (remaining <= totalRequired * 0.1) { // 10% dan kam qolgan
        tolashElement.addClass('text-warning');
    } else {
        tolashElement.addClass('text-danger');
    }
    
    // Submit tugmasini holatini yangilash
    const submitBtn = document.getElementById('submit-payment');
    if (submitBtn) {
        if (totalPaid >= totalRequired) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    return formatNumber(remaining > 0 ? remaining : 0);
}

// DOM yuklanganda submit tugmasini sozlash
document.addEventListener('DOMContentLoaded', function() {
    // Har bir input o'zgarganda to'lovni yangilash
    $(document).on('input', '.payment-input, #qarzBoxSumma, #qarzBoxValyuta, #qarzBoxDueDate, #qarzBoxComment', function() {
        updatePaymentTotal();
    });
    
    // Fullscreen payment modal ochilganda to'lovni yangilash
    $('#fullscreenPayment').on('shown.bs.modal', function() {
        updatePaymentTotal();
        loadExistingPaymentsForModal();
        updateCheckWithProducts();
    });
    
    // Modal yopilganda inputlarni tozalash
    $('#fullscreenPayment').on('hidden.bs.modal', function() {
    // Faqat qarz inputlarini tozalash, kassa inputlarini emas
        // document.getElementById('qarzBoxValyuta').value = '';
        document.getElementById('qarzBoxSumma').value = '';
        document.getElementById('qarzBoxDueDate').value = '';
        document.getElementById('qarzBoxComment').value = '';
        
        // Chekni tozalash
        document.getElementById('chek_products').innerHTML = '';
        document.getElementById('check_tolovlar').innerHTML = '';
        document.getElementById('chek_oraliq_jami').textContent = `0 ${currentDatas?.valyuta_name || ''}`;
        document.getElementById('chek_chegirma').textContent = `0 ${currentDatas?.valyuta_name || ''}`;
        document.getElementById('chek_total_jami').textContent = `0 ${currentDatas?.valyuta_name || ''}`;
    });
});



async function loadExistingPaymentsForModal() {
    if (!currentShopId) return;
    
    try {
        const response = await fetch(`{% url 'get_shop_payments' %}?shop_id=${currentShopId}`);
        const data = await response.json();
        if (data.success && data.payments) {
            // Mavjud to'lovlarni inputlarga joylash
            data.payments.forEach(payment => {
                if (payment.type === 'payment') {
                    // Kassalar bo'yicha to'lovlar
                    const paymentMethod = $(`.payment-method[data-kassa-id="${payment.kassa_id}"][data-valyuta-id="${payment.valyuta_id}"]`);
                    if (paymentMethod.length) {
                        const inputBox = paymentMethod.closest('.plus_button').find('.input-box');
                        const paymentInput = inputBox.find('.payment-input');
                        
                        inputBox.show();
                        paymentInput.val(formatNumber(payment.summa));
                    }
                } else if (payment.type === 'qarz') {
                    // Qarz to'lovlari
                    document.getElementById('qarzBoxValyuta').value = payment.valyuta_id;
                    document.getElementById('qarzBoxSumma').value = formatNumber(payment.summa);
                    document.getElementById('qarzBoxDueDate').value = payment.due_date || '';
                    document.getElementById('qarzBoxComment').value = payment.comment || '';
                    
                    // Qarzni chekda ko'rsatish
                    const valyutaSelect = document.getElementById('qarzBoxValyuta');
                    const selectedOption = valyutaSelect.options[valyutaSelect.selectedIndex];
                    const valyutaName = selectedOption ? selectedOption.getAttribute('data-name') : '';
                    
                    updateCheckPayments();;
                }
            });
        }
    } catch (error) {
        console.error('To\'lovlarni yuklashda xatolik:', error);
    }
}


function updateCheckWithProducts() {
    if (!currentDatas || !cartItems.length) return;
    
    const chekProducts = document.getElementById('chek_products');
    const chekOraliqJami = document.getElementById('chek_oraliq_jami');
    const chekChegirma = document.getElementById('chek_chegirma');
    const chekTotalJami = document.getElementById('chek_total_jami');
    
    let totalWithoutDiscount = 0;
    let productsHtml = '';
    
    // Mahsulotlarni chekga joylash
    cartItems.forEach(item => {
        const itemTotal = item.quantity * item.price;
        totalWithoutDiscount += itemTotal;
        
        productsHtml += `
            <div class="item-title">${item.product_name}</div>
            <div class="subline">
                <span>${formatNumber(item.quantity)} x ${formatNumber(item.price)}</span>
                <span>${formatNumber(itemTotal)}</span>
            </div>
        `;
    });
    
    chegirma = parseFloat(cleanNumber($('#discountInput').val())) || 0;
    const totalWithDiscount = totalWithoutDiscount - chegirma;
    
    // Chek qiymatlarini yangilash
    chekProducts.innerHTML = productsHtml;
    chekOraliqJami.textContent = `${formatNumber(totalWithoutDiscount)} ${currentDatas.valyuta_name}`;
    chekChegirma.textContent = `${formatNumber(chegirma)} ${currentDatas.valyuta_name}`;
    chekTotalJami.textContent = `${formatNumber(totalWithDiscount)} ${currentDatas.valyuta_name}`;
    
    // Jami summani yangilash
    $('#total_jami').text(`${formatNumber(currentDatas.total_price)}`);
}



function updateCheckPayments() {
    const checkTolovlar = document.getElementById('check_tolovlar');
    const paymentResult = collectPaymentData();
    
    let paymentsHtml = '';
    let qarzValyutaName = $('#qarzBoxValyuta option:selected').data('name') || '';
    
    // Kassalar bo'yicha to'lovlar
    paymentResult.payments.forEach(payment => {
        if (payment.type === 'payment') {
            const paymentMethod = $(`.payment-method[data-kassa-id="${payment.kassa_id}"][data-valyuta-id="${payment.valyuta_id}"]`);
            if (paymentMethod.length) {
                const kassaName = paymentMethod.find('p').text().split(' (')[0];
                const valyutaName = (paymentMethod.find('p').text().match(/\(([^)]+)\)/) || [])[1] || '';                
                paymentsHtml += `
                    <div class="lines">
                        <span>${valyutaName}</span>
                        <span>${formatNumber(payment.summa)}</span>
                    </div>
                `;
            }
        } else if (payment.type === 'qarz') {
            paymentsHtml += `
                <div class="lines">
                    <span class="bold">Qarz</span>
                    <span>${formatNumber(payment.summa)} ${qarzValyutaName}</span>
                </div>
            `;
        }
    });
    
    checkTolovlar.innerHTML = paymentsHtml;
}






// To'lov jamiini yangilash (qarzni hisobga olgan holda)
function calculatePaymentTotal() {
    $('#total_jami').text(formatNumber(currentDatas.total_price));
    let total = 0;

    // Kassalar bo'yicha to'lovlar
    $('.plus_button').each(function() {
        const inputBox = $(this).find('.input-box');
        
        if (inputBox.is(':visible') && !$(this).is('#qarzModalButton')) {
            const inputVal = parseFloat(cleanNumber($(this).find('.payment-input').val())) || 0;
            const isDollar = $(this).find('.toggle-input').data('dollar') === true;

            if (isDollar) {
                total += inputVal * currentKurs;
            } else {
                total += inputVal;
            }
        }
    });

    // Qarzni hisobga olish (faqat inputlardan)
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(cleanNumber(document.getElementById('qarzBoxSumma').value)) || 0;
    
    if (qarzValyutaId && qarzSumma > 0) {
        const qarzValyutaSelect = document.getElementById('qarzBoxValyuta');
        const qarzSelectedOption = qarzValyutaSelect.options[qarzValyutaSelect.selectedIndex];
        const qarzIsDollar = qarzSelectedOption.getAttribute('data-is-dollar') === 'true';
        
        if (qarzIsDollar && !currentDatas.valyuta_is_dollar) {
            // Dollar qarz, asosiy valyuta so'm
            total += qarzSumma * currentKurs;
        } else if (!qarzIsDollar && currentDatas.valyuta_is_dollar) {
            // So'm qarz, asosiy valyuta dollar
            total += qarzSumma / currentKurs;
        } else {
            // Bir xil valyuta
            total += qarzSumma;
        }
    }

    const remaining = parseFloat(currentDatas.total_price) - parseFloat(total);
    $('#tolash_summasi').text(formatNumber(remaining > 0 ? remaining : 0));
    return formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total));
}

// Qarz input boxini yopish
function hideQarzInputBox() {
    const qarzInputBox = document.getElementById('qarzInputBox');
    qarzInputBox.style.display = 'none';
    
    // Agar qarz ma'lumotlari to'liq kiritilmagan bo'lsa, chekni tozalash
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(cleanNumber(document.getElementById('qarzBoxSumma').value)) || 0;
    
    if (!qarzValyutaId || qarzSumma <= 0) {
        document.getElementById('check_tolovlar').innerHTML = '';
    }
    
    updatePaymentTotal();
}

// Modal yopilganda inputlarni tozalash
$('#fullscreenPayment').on('hidden.bs.modal', function() {
    // Qarz inputlarini tozalash
    // document.getElementById('qarzBoxValyuta').value = '';
    document.getElementById('qarzBoxSumma').value = '';
    document.getElementById('qarzBoxDueDate').value = '';
    document.getElementById('qarzBoxComment').value = '';
    document.getElementById('check_tolovlar').innerHTML = '';
});
</script>



<script>
// $(document).ready(function () {
//     let isSubmitting = false;

//     function handleFormSubmit(formId, url, selectId, modalId) {
//         $(formId).submit(function (e) {
//             e.preventDefault();

//             if (isSubmitting) {
//                 return false;
//             }
            
//             isSubmitting = true;


//             const formDatas = $(this).serialize();
//             $.ajax({
//                 url: url,
//                 type: 'POST',
//                 data: formDatas + '&csrfmiddlewaretoken={{ csrf_token }}',
//                 success: function (data) {
//                     // $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
//                     if ($(selectId)[0].selectize) {
//                         // Agar Selectize bo'lsa
//                         let selectize = $(selectId)[0].selectize;
//                         selectize.addOption({ value: data.id, text: data.name });
//                         selectize.addItem(data.id, true);
//                         $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
//                     } else {
//                         // Oddiy select bo'lsa
//                         $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
//                     }

//                     $(selectId).trigger("change");


//                     // $(modalId).modal('hide');
//                     if (modalId === "#debtorModal" && document.querySelector("#debtor_add_close")) {
//                         document.querySelector("#debtor_add_close").click();
//                     } else {
//                         $(modalId).modal('hide');
//                     }

//                     $(formId)[0].reset();
//                     if (data.fio) {
//                         // qarz_shop_debtor.options[qarz_shop_debtor.selectedIndex].text = data.fio;
//                         $('#modalSelectDebtor').append(`<option value="${data.id}" selected>${data.name}</option>`);
//                         changeInfo(data.id);

//                     }
//                 },
//                 error: function () {
//                     alert("Xatolik yuz berdi!");
//                 },

//                 complete: function () {
//                     isSubmitting = false;
//                     submitBtn.prop('disabled', false).text(originalText);
//                 }

//             });
//         });
//     }

//     // handleFormSubmit('#measurementForm', '{% url "create_measurement" %}', '#measurementSelect', '#measurementModal');
//     // handleFormSubmit('#groupForm', '{% url "create_group" %}', '#groupSelect', '#groupModal');
//     // handleFormSubmit('#debtorTypeForm', '{% url "create_debtor_type" %}', '#recipient-debtor_type', '#debtorTypeModal');
//     // handleFormSubmit('#teritoryForm', '{% url "create_teritory" %}', '#recipient-teritory', '#teritoryModal');
//     handleFormSubmit('#priceTypeForm', '{% url "create_price_type" %}', '#recipient-price_type', '#priceTypeModal');
//     // handleFormSubmit('#regionForm', '{% url "create_region" %}', '#regionSelect', '#regionModal');
//     handleFormSubmit('#debtorForm', '{% url "create_debtor" %}', '#mainSelectDebtor', '#debtorModal');

// });


$(document).ready(function () {
    let lastSubmitTime = 0;
    const SUBMIT_DELAY = 1000; // 1 soniya

    // Event listener'larni kuzatish
    let eventCount = {
        priceTypeForm: 0,
        debtorForm: 0
    };

    function handleFormSubmit(formId, url, selectId, modalId) {
        // Avvalgi event listener'larni olib tashlash
        $(formId).off('submit');
        
        $(formId).submit(function (e) {
            e.preventDefault();
            
            const currentTime = Date.now();
            const formKey = formId.replace('#', '');
            eventCount[formKey]++;
            
            console.log(`${formKey} submit bosildi:`, eventCount[formKey]);
            console.log('Vaqt farqi:', currentTime - lastSubmitTime);
            
            // Agar oxirgi so'rovdan 1 soniya o'tmagan bo'lsa
            if (currentTime - lastSubmitTime < SUBMIT_DELAY) {
                console.log('Bir soniya ichida so\'rov yuborish mumkin emas');
                return false;
            }
            
            lastSubmitTime = currentTime;
            
            // Tugmani disable qilish
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('Yuklanmoqda...');
            
            const formDatas = $(this).serialize();
            
            console.log('AJAX so\'rov yuborilmoqda...');
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formDatas + '&csrfmiddlewaretoken={{ csrf_token }}',
                success: function (data) {
                    console.log('AJAX muvaffaqiyatli:', data);
                    
                    if ($(selectId)[0].selectize) {
                        let selectize = $(selectId)[0].selectize;
                        selectize.addOption({ value: data.id, text: data.name });
                        selectize.addItem(data.id, true);
                        $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                    } else {
                        $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                    }

                    $(selectId).trigger("change");

                    if (modalId === "#debtorModal" && document.querySelector("#debtor_add_close")) {
                        document.querySelector("#debtor_add_close").click();
                    } else {
                        $(modalId).modal('hide');
                    }

                    $(formId)[0].reset();
                    if (data.fio) {
                        $('#modalSelectDebtor').append(`<option value="${data.id}" selected>${data.name}</option>`);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX xatosi:', error);
                    alert("Xatolik yuz berdi!");
                },
                complete: function () {
                    // Tugmani qayta faollashtirish
                    submitBtn.prop('disabled', false).text(originalText);
                }
            });
        });
    }

    handleFormSubmit('#priceTypeForm', '{% url "create_price_type" %}', '#recipient-price_type', '#priceTypeModal');
    handleFormSubmit('#debtorForm', '{% url "create_debtor" %}', '#mainSelectDebtor', '#debtorModal');
});
</script>


<script>
    // Debtor modal muammosini hal qilish
document.addEventListener('DOMContentLoaded', function() {
    const debtorModal = document.getElementById('debtorModal');
    
    if (debtorModal) {
        // 1. Modal ochilganda - barcha focus event'larini to'xtatish
        debtorModal.addEventListener('show.bs.modal', function() {
            // Focus event'ini butun modal uchun to'xtatish
            debtorModal.addEventListener('focusin', function(e) {
                e.stopPropagation();
                e.stopImmediatePropagation();
            }, true); // capture phase - eng avval ishlashi uchun
        });

        // 2. Modal yopilganda - event listener'larni tozalash
        debtorModal.addEventListener('hidden.bs.modal', function() {
            // Simple debounce - modal yopilganda biroz kutish
            setTimeout(() => {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.tagName === 'INPUT') {
                    activeElement.blur();
                }
            }, 50);
        });

        // 3. Modal ichidagi input'larda focus bo'lganda
        const debtorInputs = debtorModal.querySelectorAll('input, select, textarea');
        debtorInputs.forEach(input => {
            input.addEventListener('focus', function(e) {
                e.stopPropagation();
            });
        });

        // 4. Form submit handler - event bubbling to'xtatish
        const debtorForm = document.getElementById('debtorForm');
        if (debtorForm) {
            debtorForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const formData = new FormData(this);
                fetch('{% url "create_debtor" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        // Selectize yoki oddiy select uchun
                        const mainSelect = document.getElementById('mainSelectDebtor');
                        if (mainSelect.selectize) {
                            mainSelect.selectize.addOption({value: data.id, text: data.name});
                            mainSelect.selectize.setValue(data.id);
                        } else {
                            mainSelect.innerHTML += `<option value="${data.id}" selected>${data.name}</option>`;
                        }
                        
                        // Modalni yopish
                        bootstrap.Modal.getInstance(debtorModal).hide();
                        this.reset();
                    }
                })
                .catch(error => {
                    console.error('Xatolik:', error);
                    alert('Xatolik yuz berdi!');
                });
            });
        }
    }
});

// Debtor modalini ochish funksiyasi
function openDebtorModal() {
    const modal = new bootstrap.Modal(document.getElementById('debtorModal'));
    modal.show();
    
    // Focus muammosini oldini olish uchun biroz kutish
    setTimeout(() => {
        const firstInput = document.querySelector('#debtorModal input');
        if (firstInput) {
            firstInput.focus({preventScroll: true});
        }
    }, 200);
}
</script>

{% endblock js %}