{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load mathfilters %}
{% block title %}
    <title>Product </title>
{% endblock title %}
{% block css %}
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link href="{% static 'bootstrap/css/bootstrap.min.css'%}" rel="stylesheet" type="text/css" />
    <link href="{% static 'assets/css/plugins.css'%}" rel="stylesheet" type="text/css" />
        
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/datatables.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/custom_dt_html5.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/dt-global_style.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .line {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #071af2;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            width: 30rem;
        }
    </style>
    <style>
        .tab {
            display: flex;
            gap: 10px;
            /* border-bottom: 2px solid #ddd; */
            margin-bottom: 10px;
        }
        .tab button {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
        }
        .tab button.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        .tab button:hover {
            color: #0056b3;
        }
        .document {
            display: none;
        }
    </style>
      <style>
        .delete-btn {
              color: red;
              cursor: pointer;
              font-weight: bold;
              transition: transform 0.2s ease;
          }
          .delete-btn:hover {
              transform: scale(1.2);
              color: darkred;
          }
  </style>
{% endblock css %}
{% block content %}
        <meta name="csrf-token" content="{{ csrf_token }}">
        <div id="content" class="main-content">
            <div class="layout-px-spacing">
                <div class="row layout-top-spacing" id="cancel-row">
                    <div class="col-lg-12">
                        <div id="alert-container"></div>
                        <div class="statbox widget box box-shadow">
                            <div class="widget-content widget-content-area">
                                <div class="row">
                                        <div class="col-md-12">
                                            <form action="" id="form_id">
                                                <div class="row">
                                                    <div class="col-md-1">
                                                        <button class="btn btn-success" id="shop_save" type="button">Saqlash</button>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div style="display: flex; gap: 10px; align-items: center;">
                                                            <h5>Yuk jo‘natish №</h5>
                                                            <input type="text" style="width: 60px; border: 1px solid #ddd; border-radius: 5px; padding: 5px;">
                                                            <h5>dan</h5>
                                                            <input type="datetime-local" value="{{today|date:'Y-m-d H:i'}}" style="border: 1px solid #ddd; border-radius: 5px; padding: 5px;" id="shop_input_date">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <br>
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <label>* Qo'ng'iroqlar markazi</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_select_call_center" required>
                                                                    <option value="" disabled selected>Qo'ng'iroqlar markazi</option>
                                                                    {% for i in call_center %}
                                                                    <option value="{{i.id}}">{{ i.first_name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label>* Filial</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" id="shop_select_filial" required>
                                                                    <!-- <option value="" disabled selected>Выберите склад</option> -->
                                                                    {% for i in filial %}
                                                                    <option value="{{i.id}}">{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label>* Mijoz</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_customer" required>
                                                                    <option value="" disabled selected>Mijoz-ni tanlang</option>
                                                                    {% for i in customer %}
                                                                    <option value="{{i.id}}">{{ i.fio }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-12"><br></div>
                                                            <div class="col-md-3">
                                                                <label>* Shartnoma</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_contract" required>
                                                                    <option value="" disabled selected>Выберите договор</option>
                                                                    {% for i in contract %}
                                                                    <option value="{{i.id}}">{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <label>* Valyuta</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_valyuta" required>
                                                                    {% for i in valyuta %}
                                                                    <option value="{{i.id}}">{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <label>* Narx turi</label>
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px; height: 35px;" id="shop_select_type_price" required>
                                                                    <!-- <option value="" selected disabled>Выберите Тип цены</option> -->
                                                                    {% for i in price_type %}
                                                                    <option value="{{i.id}}">{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-12"><br><br><br></div>
                                      
                                        
                                        <div class="col-md-12">
                                            <div class="tab">
                                                <button class="active" onclick="switchTab(event)">Asosiy </button>
                                                <button onclick="switchTab(event)">Tegishli hujjatlar</button>
                                            </div>
                                            <div class="row home">
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        <div class="col-md-1">
                                                            <input type="checkbox">
                                                           
                                                        </div>
                                                        <div class="col-md-2">
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%;">
                                                                <option>Mahsulot nomi</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1"></div>
                                                        <div class="col-md-2">
                                                            <h6>Miqdor</h6>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <h6>Qoldiq </h6>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%;">
                                                                <option>Narxi</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2" style="display: flex; gap: 7px;">
                                                            <label for="">NDS</label>
                                                            <select style="border: 1px solid #ddd;border-radius: 4px; width: 100%; height: 24px;">
                                                                <option>Chegirma </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <select style="border: 1px solid #ffffff;border-radius: 4px; width: 100%;">
                                                                <option>Jami</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-12"><div class="line" ></div></div>
                                                <div id="product_list" class="col-md-12"></div>
                                                <div class="col-md-12">
                                                    <br>
                                                    <form action="">
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <select style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" class="searchable" id="shop_select_product">
                                                                    <option value="">Pozitsiya qo‘shish — nomi, kodi, shtrixkodi yoki artikulini kiriting</option>
                                                                    {% for i in product %}
                                                                        <option value="{{ i.id }}|{{ i.som }}">{{ i.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                
                                                            </div>
                                                            <div class="col-md-2">
                                                                <button class="btn-success" type="button" id="save_btn">Saqlash</button>
                                                            </div>
                                                            <div class="col-md-1">
                                                                <!-- <button class="btn-light" type="button">Остатки</button> -->
                                                            </div>
                                                            <div class="col-md-3"></div>
                                                            <div class="col-md-1">
                                                                <!-- <button class="btn-light " type="button">Импорт</button> -->
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="line"></div>
                                                </div>
                                                <div class="col-md-12">
                                                    <br>
                                                    <div class="row">
                                                        <div class="col-md-7">
                                                            <textarea name="" style="width: 100%;" placeholder="Izoh" rows="5" id="shop_textarea"></textarea>
                                                        </div>
                                                        <div class="col-md-5">
                                                            <div class="row">
                                                                <div class="col-md-8">
                                                                    <h3 style="font-weight: bold;">Jami:</h3>
                                                                    <p>Foyda </p>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <h4 style="font-weight: bold;" id="summa_itog">0</h4>
                                                                    <p>0</p>
                                                                </div>
    
                                                                <div class="col-md-8">
                                                                    <label><input type="checkbox" checked> NDS:</label><br>
                                                                    <label><input type="checkbox" checked> NDS bilan narx</label>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <p>0</p>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <br><br>
                                                                    <h6 id="summa_col">Miqdor: </h6>
                                                                    <div class="line"></div>
                                                                </div>
    
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

{% endblock content %}
{% block js %}
    <script>
        document.getElementById('save_btn').addEventListener('click', function() {
            showAlert("Shop yaratilmagan iltimos birinchi shop yarating!", "warning");
        })

        const showAlert = (message, type) => {
            const alertElement = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                </div>
            `);

            $("#alert-container").append(alertElement);
            setTimeout(() => {
                alertElement.fadeOut(500, function () { $(this).remove(); });
            }, 3000);
        };

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        $(document).ready(function () {
            function addShop() {
                const form = document.getElementById('form_id');
                console.log(form)
                if (!form.checkValidity()) {
                    form.reportValidity(); 
                    return;
                }
                const shop_input_date = $('#shop_input_date').val();
                const shop_select_customer = $('#shop_select_customer').val();
                const shop_select_filial = $('#shop_select_filial').val();
                const shop_select_contract = $('#shop_select_contract').val();
                const shop_select_call_center = $('#shop_select_call_center').val();
                const shop_textarea = $('#shop_textarea').val();
                const shop_select_is_savdo = $('#shop_select_is_savdo').val()
                const shop_valyuta = $('#shop_valyuta').val()
                const shop_select_type_price = $('#shop_select_type_price').val()
                
                
                const fields_shop = {
                    'date': shop_input_date,
                    'customer': shop_select_customer,
                    'filial': shop_select_filial,
                    'contract':shop_select_contract,
                    'call_center':shop_select_call_center,
                    'text':shop_textarea,
                    'is_savdo':shop_select_is_savdo,
                    'valyuta':shop_valyuta,
                    'type_price':shop_select_type_price,
                };

                const requiredFields = ['date', 'customer', 'filial', 'contract', 'call_center', 'valyuta', 'type_price'];
                const missingFields = requiredFields.filter(field => !fields_shop[field]);
                if (missingFields.length === 0) {
                    $.ajax({
                        url: "{% url 'b2b_shop_add' %}",
                        type: "POST",
                        data: fields_shop,
                        headers: {
                            "X-CSRFToken": csrfToken
                        },
                        success: function(response) {

                            showAlert("Ma'lumot muvaffaqiyatli saqlandi!", "success");
                            if (response.success) {
                                const newUrl = `/b2b_shop_ajax/${response.order_id}`;
                                window.location.href = newUrl;
                            }

                        },
                        error: function () {
                            showAlert("Server bilan bog'lanishda xatolik", "danger");
                        }
                    });
                }
                else {
                    const fieldNamesUz = {
                        'date': 'Sana',
                        'customer': 'Контрагент',
                        'filial': 'Склад',
                        'contract': 'Договор',
                        'call_center': 'Колл-центр',
                        'valyuta': 'Валюта',
                        'type_price': 'Тип цены',
                    };

                    const missingLabels = missingFields.map(f => fieldNamesUz[f]).join(', ');
                    showAlert(`Iltimos quyidagi maydonlarni to'ldiring: ${missingLabels}`, "danger")
                    }
            }

            $("#shop_save").click(addShop);
        });
    </script>

    <script src="{% static 'plugins/table/datatable/datatables.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/dataTables.buttons.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/jszip.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/buttons.html5.min.js'%}"></script>
    <script src="{% static 'plugins/table/datatable/button-ext/buttons.print.min.js'%}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
    <script>
        $('select.searchable').selectize({ normalize: true });
    </script>
    <script>
        function switchTab(event) {
           document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
           event.target.classList.add('active');
           const isRelatedDocs = event.target.innerText === "Связанные документы";
           document.querySelector('.home').style.display = isRelatedDocs ? 'none' : 'block';
           document.querySelector('.document').style.display = isRelatedDocs ? 'block' : 'none';
       }
    </script>
{% endblock js %}
