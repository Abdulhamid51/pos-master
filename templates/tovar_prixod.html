{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load custom_filters %}

{% block title %}
    <title>Qabul </title>
{% endblock title %}
{% block css %}
    <link href="{% static 'plugins/perfect-scrollbar/perfect-scrollbar.css'%}" rel="stylesheet" type="text/css" />
    <!-- END GLOBAL MANDATORY STYLES -->

    <!--  BEGIN CUSTOM STYLE FILE  -->
    <link href="{% static 'assets/css/apps/invoice.css'%}" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!--  END CUSTOM STYLE FILE  -->
    
{% endblock css %}
{% block content %}
        <!--  BEGIN CONTENT AREA  -->
        <div id="content" class="main-content">
            <div class="layout-px-spacing">
                <div class="row invoice layout-top-spacing">
                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="app-hamburger-container">
                            <div class="hamburger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu chat-menu d-xl-none"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div>
                        </div>
                        <div class="doc-container">
                            <div class="tab-title">
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-12">
                                        <div class="">
                                            <button style="width: 100%;" type="button" class="btn btn-primary" data-toggle="modal" data-target="#new_add">
                                                Yangi
                                            </button>
                                            
                                        



                                              <div class="modal fade" id="new_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered" role="document">
                                                  <form action="{% url 'add_recieve_perexoded' %}" class="modal-content" method="post">
                                                    {% csrf_token %}
                                                    <div class="modal-header">
                                                      <h5 class="modal-title" id="exampleModalLongTitle">Yangi qoshish</h5>
                                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                      </button>
                                                    </div>
                                                    <div class="modal-body">
                                                      <div class="form-group">
                                                        <label for="">Nomi</label>
                                                        <input type="text" class="form-control" name="name" required>
                                                      </div>
                                                      <div class="modal-footer d-flex justify-content-between">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                                                        <button type="submit" class="btn btn-primary">Saqlash</button>
                                                      </div>
                                                    </div>
                                                  </form>
                                                </div>
                                              </div>


                                              <div class="modal fade" id="add_taminotchi" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered" role="document">
                                                  <form action="{% url 'create_deliver' %}" class="modal-content" method="post">
                                                    {% csrf_token %}
                                                    <div class="modal-header">
                                                      <h5 class="modal-title" id="exampleModalLongTitle">Taminotchi qoshish</h5>
                                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                      </button>
                                                    </div>
                                                    <div class="modal-body">
                                                      <div class="form-group">
                                                        <label for="">Nomi</label>
                                                        <input type="text" class="form-control" name="name" required>

                                                        <label for="">Telefon 1</label>
                                                        <input type="text" class="form-control" name="phone1" required>

                                                        <label for="">Telefon 2</label>
                                                        <input type="text" class="form-control" name="phone2" required>

                                                        
                                                        
                                                      </div>
                                                      <div class="modal-footer d-flex justify-content-between">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                                                        <button type="submit" class="btn btn-primary">Saqlash</button>
                                                      </div>
                                                    </div>
                                                  </form>
                                                </div>
                                              </div>
                                        </div>
                                        <div class="search">
                                            <input type="text" class="form-control" placeholder="Izlash">
                                        </div>
                                        <ul class="nav nav-pills inv-list-container d-block" id="pills-tab" role="tablist">
                                            {% for recieve in recieves %}
                                                <li data-id="{{recieve.id}}" class="nav-item nav_items
                                                {% if forloop.first %}
                                                    active
                                                {% endif %}
                                                    ">
                                                    <div class="nav-link list-actions" id="invoice-{{ recieve.id }}" data-invoice-id="{{ recieve.id }}">
                                                        <div class="f-m-body">
                                                            <div class="f-body">
                                                                <p class="invoice-customer-name">Nomi: {{ recieve.name }} <button type="button" class="btn" data-toggle="modal" data-target="#delete_modal{{recieve.id}}" style="color: red; float: right;"><i class="fa fa-trash"></i></button> </p>
                                                                <p class="invoice-customer-name"><span>So'm:</span> {{ recieve.som }}</p>
                                                                <p class="invoice-generated-date">Sana: {{ recieve.date }}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>



                                                <div class="modal fade" id="delete_modal{{recieve.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                      <div class="modal-content">
                                                        <div class="modal-header">
                                                          <h5 class="modal-title" id="exampleModalLongTitle">Haqiqatdanham o'chirmoqchimisiz</h5>
                                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                          </button>
                                                        </div>
                                                        <div class="modal-body">
                                                        </div>
                                                        <div class="modal-footer d-flex justify-content-between">
                                                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                                                          <a class="btn btn-primary" type="button" style="color: #fff;" href="{% url 'delete_recieve'  recieve.id %}">O'chirish</a>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                            {% endfor %}
                                        </ul>
                                       
                                    </div>
                                </div>
                            </div>

                            <div class="invoice-container">
                                <div class="invoice-inbox">

                                    <div class="inv-not-selected">
                                        <p>Qabulni tanlang</p>
                                    </div>

                                    <div class="invoice-header-section">
                                        <h4 class="inv-number"></h4>
                                        <h4></h4>
                                        <div class="invoice-action">
{#                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-printer action-print" data-toggle="tooltip" data-placement="top" data-original-title="Reply"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>#}
                                        </div>
                                    </div>

                                    <div id="ct" class="">
                                        {% for recieve in recieves %}
                                            <div class="invoice-{{ recieve.id }}" id="{% if active_one == recieve %}active_page{% endif %}">
                                                <div class="content-section  animated animatedFadeInUp fadeInUp">

                                                    <div class="row">

                                                        <div class="col-sm-6 col-6">
                                                            <h3 class="in-heading">{{ recieve.name }}</h3>
                                                        </div>
                                                        <div class="col-sm-6 col-6 d-flex justify-content-end text-right">
                                                            <!-- <p class="inv-due-date"><span class="inv-title">Sana : </span> <span class="inv-date">{{ recieve.date }}</span></p> -->
                                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#new_product_add" id="" onclick="">
                                                                Yangi 
                                                            </button>
                                                        </div>
            
            
                                                        
                                                    </div>
                                                    <div class="row">

                                                    </div>
                                                    <!-- <div class="row inv--detail-section">

                                                        <div class="col-sm-7 align-self-center">
                                                        </div>
                                                        <div class="col-sm-5 align-self-center  text-sm-right order-sm-0 order-1">
                                                        </div>

                                                        <div class="col-sm-7 align-self-center">
                                                        </div>
                                                        <div class="col-sm-5 align-self-center  text-sm-right order-2">
                                                        </div>
                                                    </div> -->
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <select onchange="add_modal(this)" class="form-control searchable" name="product" id="" data-recieve="{{recieve.id}}">
                                                                <option value="">Maxsulot tanlash</option>
                                                                
                                                                {% for i in products %}
                                                                    <option value="{{i.id}}&{{i.name}}&{{i.som}}&{{i.sotish_som}}">{{ i.name }}</option>
                                                                {% endfor %}
                                                                    
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div class="row inv--product-table-section">
                                                        <div class="col-12">
                                                            <div class="table-responsive">
                                                                <table class="table">
                                                                    <thead class="">
                                                                        <tr>
                                                                            <th scope="col"></th>
                                                                            <th scope="col"></th>
                                                                            <th scope="col">Mahsulot</th>
                                                                            <th class="text-right" scope="col">So'm</th>
                                                                            <th class="text-right" scope="col">Sotish som</th>
                                                                            <th class="text-right" scope="col">Soni</th>
                                                                            <th class="text-right" scope="col">Jami</th>
                                                                            <th class="text-right" scope="col">Sotish jami</th>
                                                                            <th class="text-right" scope="col"></th>
                                                                            <th class="text-right" scope="col"></th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for item in recieve.receiveitem.all %}
                                                                                <tr>
                                                                                    <td>
                                                                                        <label for="item{{ite.id}}"></label>
                                                                                        <input type="checkbox" id="item{{item.id}}">
                                                                                    </td>
                                                                                    <td>{{ forloop.counter }}</td>
                                                                                    <td>{{ item.product }}</td>
                                                                                    <td class="text-right">{{ item.som|intcomma }}</td>
                                                                                    <td class="text-right">{{ item.sotish_som|intcomma }}</td>
                                                                                    <!-- <td class="text-right">{{ item.kurs|intcomma }}</td> -->
                                                                                    <td class="text-right">{{ item.quantity|floatformat:1|intcomma }}</td>
                                                                                    <td class="text-right">{{ item.total_som|floatformat:1|intcomma }}</td>
                                                                                    <td class="text-right">{{ item.total_sotish_som|floatformat:1|intcomma }}</td>
                                                                                    <td class="text-right"><button  type="button" class="btn" data-toggle="modal" data-target="#recieve_item_add_modal_edit{{item.id}}" style="color: rgb(0, 255, 68); float: right;"><i class="fa fa-edit"></i></button></td>
                                                                                    <td class="text-right"><button  type="button" class="btn" data-toggle="modal" data-target="#delete_item_modal{{item.id}}" style="color: red; float: right;"><i class="fa fa-trash"></i></button></td>
                                                                                </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                    <tfoot class="">
                                                                        <tr>
                                                                            <th></th>
                                                                            <th></th>
                                                                            <th scope="col">Jami</th>
                                                                            <th class="text-right" scope="col">{{ recieve.som|intcomma }}</th>
                                                                            <th class="text-right" scope="col">{{ recieve.sum_sotish_som|intcomma }}</th>
                                                                            <th class="text-right" scope="col">{{ recieve.total_quantity|intcomma }}</th>
                                                                            <th class="text-right" scope="col">{{ recieve.kelish_total|intcomma }}</th>
                                                                            <th class="text-right" scope="col">{{ recieve.sotish_total|intcomma }}</th>
                                                                            <th class="text-right" scope="col"></th>
                                                                            <th class="text-right" scope="col"></th>
                                                                        </tr>
                                                                    </tfoot>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row mt-4">
                                                        <div class="col-sm-5 col-12 order-sm-0 order-1">
                                                            
                                                        </div>
                                                        <!-- <div class="col-sm-7 col-12 order-sm-1 order-0">
                                                            <div class="inv--total-amounts text-sm-right">
                                                                <div class="row">
                                                                    <div class="col-sm-8 col-7">
                                                                        <p class="">Summa: </p>
                                                                    </div>
                                                                    <div class="col-sm-4 col-5">
                                                                        <p class="">{{ recieve.som|intcomma }} so'm</p>
                                                                    </div>
                                                                  
                                                                </div>
                                                            </div>
                                                        </div> -->
                                                    </div>

                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>


                                </div>

                            </div>
                            
                        </div>

                    </div>
                </div>
                </div>



                <button style="width: 100%;display: none;" type="button" class="btn btn-primary" data-toggle="modal" id="recieve_item_add_button" data-target="#recieve_item_add_modal">
                    Yangi 
                </button>


                  <div class="modal fade" id="recieve_item_add_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                      <form class="modal-content" method="post" action="{% url 'add_recieve_item_view' %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="recieve_item_add_product_name">Yangi qoshish</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body" >
                                <div class="form-group" id="recieve_item_add_product_div">
                                  <input type="hidden" name="product" id="recieve_item_add_product_id">
                                  <input type="hidden" name="recieve" id="recieve_item_add_recieve_id">
                                 
                                  <label for="">Miqdori</label>
                                  <input type="number" step="any"  name="quantity" class="form-control">

      
                                  <label for="">Kelish narx</label>
                                  <input id="recieve_item_add_recieve_som" type="number" name="som" class="form-control">
                                  
                                  <label for="">Sotish narxaaa</label>
                                  <input id="recieve_item_add_recieve_sotish_som" type="number" name="sotish_som" class="form-control">
      
                                  <!-- <label for="">Kurs</label>
                                  <input value="12800" type="number" name="kurs" class="form-control"> -->
      
      
                                  
                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                                  <button type="submit" class="btn btn-primary">Saqlash</button>
                                </div>

                        </div>
                      </form>
                    </div>
                  </div>



                  <div class="modal fade" id="new_product_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <form action="{% url 'new_product_add' %}" class="modal-content" method="post">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle1">Yangi qoshish</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                            <label for="">Nomi</label>
                            <input type="text" class="form-control" name="name" required>

                            <!-- <label for="">Ishlab chiqaruvchi</label>
                            <input type="text" class="form-control" name="preparer" required> -->

                            <label for="">Ishlab chiqaruvchi</label>
                            <select class="form-control searchable" required name="deliver" id="">
                                <option value="">- - - - - - - - </option>
                                {% for a in delivers %}
                                    <option value="{{a.id}}">{{ a.name }}</option>
                                {% endfor %}
                            </select>

                            <label for="">Ulchov</label>
                            <select class="form-control searchable" required name="measurement" id="">
                                <option value="">- - - - - - - - </option>
                                {% for a in measurements %}
                                    <option value="{{a.id}}">{{ a.name }}</option>
                                {% endfor %}
                            </select>


                            <label for="">Min miqdor</label>
                            <input type="number" class="form-control" name="min_count" required>


                            <label for="">Guruh</label>
                            <select class="form-control searchable" required name="group" id="">
                                <option value="">- - - - - - - - </option>
                                {% for a in groups %}
                                    <option value="{{a.id}}">{{ a.name }}</option>
                                {% endfor %}
                            </select>

                            <label for="">Shtrix kod</label>
                            <input type="text" class="form-control" name="barcode" value="{{new_barcode}}" required>


                            <!-- <label for="">Tan som</label>
                            <input type="text" class="form-control" name="som" required>


                            <label for="">Sotish som</label>
                            <input type="text" class="form-control" name="sotish_som" required>


                            <label for="">Miqdori</label>
                            <input type="text" class="form-control" name="quantity" required> -->


                            <!-- <label for="">Sotish som</label>
                            <input type="text" class="form-control" name="name" required> -->

                            
                            
                            </div>
                            <div class="modal-footer d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                            <button type="submit" class="btn btn-primary">Saqlash</button>
                            </div>
                        </div>
                        </form>
                    </div>
                </div>


                {% for recieve in recieves %}
                {% for item in recieve.receiveitem.all %}


                    <div class="modal fade" id="delete_item_modal{{item.id}}" tabindex="0" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Haqiqatdanham o'chirmoqchimisiz</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            </div>
                            <div class="modal-body">
                            </div>
                            <div class="modal-footer d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                            <a class="btn btn-primary" type="button" style="color: #fff;" href="{% url 'delete_recieve_item'  item.id %}">O'chirish</a>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="recieve_item_add_modal_edit{{item.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <form class="modal-content" method="post" action="{% url 'edit_recieve_item_view' %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" >Tahrirlash</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" >
                                    <div class="form-group">
                                        <input type="hidden" name="item" value="{{item.id}}">
                                        
                                        <label for="">Miqdori</label>
                                        <input type="number" step="any" value="{{ item.quantity|comma_to_dot }}" name="quantity" class="form-control">
            
                                        <label for="">Kelish narx</label>
                                        <input value="{{item.som}}" type="number" name="som" class="form-control">
                                        
                                        <label for="">Sotish narxbbb</label>
                                        <input  value="{{item.sotish_som}}" type="number" name="sotish_som" class="form-control">
            
                                        <!-- <label for="">Kurs</label>
                                        <input value="12800" type="number" name="kurs" class="form-control"> -->
                                        
                                        {% for pr_type in item.product.price_types.all %}
                                            <label class="pr_type" for="">{{pr_type.type.name}}</label>
                                            <input type="number" name="{{pr_type.id}}" class="form-control" value="{{pr_type.price|floatformat:'0'}}">                                
                                        {% endfor %}
                                            
                                        
                                    </div>
                                    <div class="modal-footer d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                                        <button type="submit" class="btn btn-primary">Saqlash</button>
                                    </div>

                            </div>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
{% endblock content %}
{% block js %}

    <!-- END GLOBAL MANDATORY SCRIPTS -->
    <script src="{% static 'assets/js/apps/invoice.js'%}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
    <script>
        $('select.searchable').selectize({ normalize: true });
    </script>
     <script>
        $('.nav_items').click(function() {
            let item = $(this)
            let id = item.attr('data-id')
            const currentUrl = new URL(window.location.href);

            const paramName = 'active';
            const paramValue = id;

            currentUrl.searchParams.set(paramName, paramValue);

            window.history.replaceState({}, '', currentUrl.toString());

            })
    </script>
    <script>
        let active = $('#active_page')
        if (active.length) {
            $(`#invoice-${"{{active_one.id}}"}`).click()
        }
    </script>
<script>
    function add_modal(item) {
        const itemValue = $(item).val(); // Get the value of the passed item
        const [pr_id, pr_name, pr_som, pr_sotish_som] = itemValue.split('&');


        if (pr_id) {
            $('#recieve_item_add_button').click();
            $('#recieve_item_add_product_id').val(pr_id);

            $('#recieve_item_add_recieve_som').val(pr_som);
            $('#recieve_item_add_recieve_sotish_som').val(pr_sotish_som);
            $('#recieve_item_add_recieve_id').val($(item).data('recieve')); 
            $('#recieve_item_add_product_name').text(pr_name);
            $('#recieve_item_add_product_div .pr_type').remove();
            let price_types = $.get('/api/productpricetype/', { product:  pr_id}, function(data) {
                console.log(data);
                data.forEach(element => {
                    $('#recieve_item_add_product_div').append(
                        `
                        <label class="pr_type" for="">${element.name}</label>
                        <input type="number" name="${element.id}" class="form-control pr_type" value="${element.price}">
                        `
                    )
                });
            });

        }
    }
</script>
<script>
    // function delete_modal() {
    //     console.log('aaaaaa')
    //     console.log($('.modal-backdrop'))
    //     $('.modal-backdrop').remove()
    // }
    function delete_modal() {
    setTimeout(function() {
        console.log($('.modal-backdrop'));
        $('.modal-backdrop').removeClass('modal-backdrop');
    }, 100); // Delay of 100 milliseconds
}
</script>
<script>
    function delete_modal() {
    setTimeout(function() {
        console.log($('.modal-backdrop'));
        $('.modal-backdrop').removeClass('modal-backdrop');
    }, 100);
}
</script>

{% endblock js %}