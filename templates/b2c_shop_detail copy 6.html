{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load mathfilters %}
{% block title %}
    <title>Product</title>
{% endblock title %}
{% block css %}
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link href="{% static 'bootstrap/css/bootstrap.min.css'%}" rel="stylesheet" type="text/css" />
    <link href="{% static 'assets/css/plugins.css'%}" rel="stylesheet" type="text/css" />
        
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/datatables.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/custom_dt_html5.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/dt-global_style.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <style>
        .selectize-input {
            height: 2.7rem !important;
            min-height: 2.7rem !important;
            line-height: 2.7rem !important;
        }

        .btn-check:checked + .btn {
            background-color: #007bff;
            color: white;
        }

        .price_type_input {
            display: none;
        }

        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 30rem;
        }

        .pack-input, .quantity-input {
            width: 80px;
            text-align: center;
        }

        .input-group-text {
            font-size: 12px;
        }
        
        [contenteditable="true"] {
            border-bottom: 1px dashed #007bff;
            padding: 2px;
            min-width: 50px;
        }
        
        [contenteditable="true"]:focus {
            outline: none;
            background-color: #f8f9fa;
        }
        
        .price-input {
            width: 100px;
            text-align: center;
        }
        
    </style>
    <style>
        #productSearchInput {
            font-size: 1.2rem;
        }

        #productListDropdown .dropdown-item {
            line-height: 1.4;
        }
        .hide-important {
            display: none !important;
        }

    </style>
    <style>
        .discount-input-group {
            display: flex;
        }
        .discount-toggle button {
            border: 1px solid #ccc;
            height: 38px;
            background-color: #f2f2f2;
            border-radius: 10px;
            font-weight: bold;
            min-width: 50px;
        }
        .discount-toggle button.active {
            background-color: #007bff;
            color: white;
        }
        .quick-discount button {
            border: 1px solid #ccc;
            border-radius: 20px;
            background-color: #f2f2f2;
            font-weight: bold;
            padding: 6px 20px;
            min-width: 70px;
        }
        .quick-discount button:hover {
            background-color: #e0e0e0;
        }
    </style>
    <style>
        .method-box {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background-color: white !important;
            border-radius: 5px;
            box-shadow: 2px 5px 5px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.129) !important;
        }
        .method-box:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .method-box i {
            color: #007bff !important;
            font-size: 1.2em;
        }
        .method-box p {
            margin: 0;
            flex-grow: 1;
            font-weight: 500;
        }
        .toggle-input {
            color: #007bff !important;
            background-color: white !important;
            border: 1px solid #ffffff !important;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-input i {
            font-size: 1.2em;
        }
        .input-fields {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .remove-field {
            cursor: pointer;
            font-size: 1.8em;
            color: #dc3545;
            background: none;
            border: none;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }
        .payment-table th, .payment-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f8f9fa;
        }
        .card-balance {
            text-align: right;
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .inputkassa {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .input-box {
            display: none;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.401);
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            margin-top: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: border 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .input-box:hover {
            border: 1px solid #007bff !important;
        }
        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        .box-body {
            margin-top: 10px;
        }
        .payment-input {
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.277) !important;
        }
        .receipt-wrapper {
            width: 100%;
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-left: 1.8px solid rgba(192, 192, 192, 0.758);
            border-right: 1.8px solid rgba(192, 192, 192, 0.758);
            overflow: hidden; 
        }
        .zigzag {
            width: calc(100% + 3.6px);
            height: 15px;
            margin-left: -1.8px; 
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 10" xmlns="http://www.w3.org/2000/svg"><polyline points="0,10 5,0 10,10 15,0 20,10 25,0 30,10 35,0 40,10 45,0 50,10 55,0 60,10 65,0 70,10 75,0 80,10 85,0 90,10 95,0 100,10" fill="white" stroke="lightgray" /></svg>') repeat-x;
            background-size: contain;
        }
        .receipt {
            padding: 20px;
            font-size: 13px;
            color: #000 !important;
        }
        .bold {
            font-weight: bold;
        }
        .lines {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        hr {
            border: none;
            border-top: 1px solid #bbb;
            margin: 8px 0;
        }
        .section {
            margin-bottom: 8px;
        }
        .barcode {
            height: 50px;
            width: 100%;
            background: repeating-linear-gradient(
                to right,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px
            );
            margin: 15px 0;
        }
        .center {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        .item-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .subline {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-left: 10px;
        }
        .qarz-row {
            font-weight: bold;
            color: #dc3545;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
            margin: 5px 0;
            background-color: #fff3f3;
        }
        .qarz-row span {
            font-size: 14px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
        }
        .summary-value.total {
            color: green;
        }
        .input-box.has-value {
            border: 1px solid #28a745 !important;
            background-color: #f8fff8;
        }
    </style>
{% endblock css %}

{% block content %}
<p style="display: none;" id="shop_valyuta_name">{{ shop_valyuta_name }}</p>

<div id="content" class="main-content">
    <div class="layout-px-spacing">
        <div class="row layout-top-spacing" id="cancel-row">
            <div id="alert-container"></div>
            <div class="col-xl-8 col-lg-8 col-sm-12 layout-spacing">
                <div class="row">
                    <div class="col-md-2">
                        <select name="valyuta" id="valyuta_input" class="form-control" required disabled oninput="saveValyutaShop(this)">
                            {% for i in valyuta %}
                                <option value="{{i.id}}" {% if shop.valyuta == i %}selected{% endif %} >{{i.name}}</option>
                            {% endfor %}
                        </select>
                    </div>


                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Har bir to'lov usuli uchun event listener qo'shamiz
                                document.querySelectorAll('.toggle-input').forEach(button => {
                                    button.addEventListener('click', function(e) {
                                        // e.stopPropagation();
                                        
                                        const methodBox = this.closest('.method-box');
                                        const inputBox = methodBox.nextElementSibling;
                                        
                                        if (!inputBox || !inputBox.classList.contains('input-box')) return;
                                        
                                        // Boshqa barcha input boxlarni yopamiz
                                        // document.querySelectorAll('.input-box').forEach(b => {
                                        //     if (b !== inputBox) b.style.display = 'none';
                                        // });

                                        document.querySelectorAll('.input-box').forEach(b => {
                                            if (b !== inputBox) {
                                                let input = b.querySelector('input');
                                                if (input && (input.value.trim() === '' || parseFloat(input.value) === 0)) {
                                                    b.classList.add('d-none');   // agar bo‚Äòsh bo‚Äòlsa yashiramiz
                                                } else {
                                                    b.classList.remove('d-none'); // qiymati bo‚Äòlsa ko‚Äòrsatamiz
                                                }
                                            } else {
                                                b.classList.remove('d-none'); // tanlangan (bosilgan) elementni ochiq qoldiramiz
                                            }
                                        });


                                        
                                        // Input boxni ko'rsatamiz
                                        inputBox.style.display = inputBox.style.display === 'block' ? 'none' : 'block';
                                        
                                        // Agar input box ochilgan bo'lsa, unga qolgan summani yozamiz
                                        if (inputBox.style.display === 'block') {
                                            const input = inputBox.querySelector('input');
                                            const toggleButton = methodBox.querySelector('.toggle-input');
                                            const isDollar = toggleButton.getAttribute('data-dollar') === 'true';
                                            const dollarKurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;
                                            
                                            // Jami qolgan summani olish
                                            const remainingAmount = paymentSystem.totalToPay;
                                            
                                            // Agar dollar bo'lsa, kursga bo'lib yozamiz
                                            if (isDollar) {
                                                input.value = (remainingAmount / dollarKurs).toFixed(2);
                                            } else {
                                                input.value = remainingAmount.toFixed(2);
                                            }
                                            
                                            // Input qiymatini yangilaymiz
                                            paymentSystem.updateTolash(input);
                                            input.focus();
                                        }
                                    });
                                });
                                
                                // Qolgan kodlar...
                            });
                        </script>

                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Qarz modalini ochish tugmasi uchun event listener
                            document.getElementById('qarzModalButton').addEventListener('click', function(e) {
                                e.stopPropagation();
                                
                                // Jami qolgan summani olish
                                const remainingAmount = paymentSystem.totalToPay;
                                
                                // Qarz summasini inputga yozish
                                document.getElementById('qarzSumma').value = remainingAmount.toFixed(2);
                                
                                // Bugungi sanani olish va 30 kun qo'shamiz
                                const today = new Date();
                                const dueDate = new Date();
                                dueDate.setDate(today.getDate() + 30);
                                
                                // Sana inputiga formatlab yozish
                                document.getElementById('qarzDueDate').value = dueDate.toISOString().split('T')[0];
                            });
                            
                            // Qarzni tasdiqlash tugmasi
                            document.getElementById('confirmQarzButton').addEventListener('click', function() {
                                const qarzSumma = parseFloat(document.getElementById('qarzSumma').value) || 0;
                                
                                if (qarzSumma > 0) {
                                    if (paymentSystem.addCreditPayment(qarzSumma)) {
                                        // Modalni yopish
                                        const qarzModal = document.getElementById('qarzModal');
                                        $('#qarzclose').click();
                                        // qarzclose.click()
                                        // const modalInstance = bootstrap.Modal.getInstance(qarzModal);
                                        // qarzModal.hide();
                                        
                                        // To'lovlar ro'yxatini yangilash
                                        paymentSystem.updatePaymentDisplay();
                                        paymentSystem.updateTolashText();
                                    }
                                } else {
                                    showAlert("Iltimos, to'g'ri summa kiriting!", "warning");
                                }
                            });
                        });
                        </script>
                    





                   <script>
                        function toggleValyutaDisabled() {
                            const valyutaInput = document.getElementById('valyuta_input');
                            const productNames = document.querySelectorAll('.product_name');

                            let hasProduct = false;
                            productNames.forEach(function (td) {
                                if (td.textContent.trim() !== '') {
                                    hasProduct = true;
                                }
                            });

                            if (hasProduct) {
                                valyutaInput.setAttribute('disabled', 'disabled');
                            } else {
                                valyutaInput.removeAttribute('disabled');
                            }
                        }
                        function saveValyutaShop(val) {
                            const valyuta_id = val.value
                            $.ajax({
                                url: `/shop_change_valyuta/{{shop.id}}`,
                                type: "POST",
                                data:{'valyuta':valyuta_id},
                                success: function(response) {
                                },
                                error: function() {
                                    showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
                                }
                            });
                        }
                        window.addEventListener('DOMContentLoaded', toggleValyutaDisabled);
                    </script>
                    <div class="col-md-7">
                        <div class="input-group">
                            <select class="d-none" id="products" name="product" data-recieve="{{recieve.id}}">
                                <option value="">Mahsulot tanlanmagan</option>
                                {% for i in products %}
                                    <option 
                                        value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}">
                                        {{ i.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="dropdown w-100 position-relative">
                                <input type="text" class="form-control fs-5 py-3" placeholder="Mahsulotni qidiring..." id="productSearchInput" data-bs-toggle="dropdown" aria-expanded="false">
                                <ul class="dropdown-menu w-100 overflow-auto" style="max-height: 300px;" id="productListDropdown">
                                    {% for i in products %}
                                        <li>
                                            <a href="#" class="dropdown-item py-2 fs-5 select-product-item"
                                            data-value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}">
                                                üõí <strong>{{ i.name }}</strong><br>
                                                üì¶ {{ i.quantity|floatformat:'2' }} | üè∑Ô∏è {{ i.get_barcodes }} | üí∞ <span data-prices='{{ i.pricetypevaluta_prices_json|safe }}'>{{ i.price|floatformat:'2' }}</span>
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <br>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger" style="height: 47px;" onclick="clearInputProduct()">X</button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="fullscreenDropdownBtn" style="height: 48px;">
                            Guruh bo‚Äòyicha
                        </button>
                    </div>
                    <script>
                        function clearInputProduct() {
                            const input = document.getElementById('productSearchInput');
                            if (input) {
                                input.value = '';
                                const dropdown = document.getElementById('productListDropdown');
                                if (dropdown) {
                                    dropdown.classList.remove('show');
                                }
                            }
                        }
                    </script>
                    <div id="fullscreenDropdown" class="fullscreen-dropdown">
                        <div class="dropdown-header">
                            <h5>Mahsulot Guruhlari</h5>
                            <button class="btn btn-danger btn-sm" onclick="document.getElementById('fullscreenDropdown').style.display='none'; document.body.style.overflow='';">Yopish</button>
                        </div>

                        <div class="dropdown-content">
                            <div class="row">
                                {% for i in groups %}
                                <div class="col-md-6 mb-3" style="border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                                    <div class="d-flex align-items-center">
                                        <div style="width: 50px; margin-right: 10px;">
                                            {% if i.image %}
                                                <img src="{{ i.image.url }}" alt="{{ i.name }}" width="40" height="40" style="object-fit: contain;">
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="group-name" style="cursor: pointer;" data-group-id="{{ i.id }}">{{ i.name }}</h6>
                                        </div>
                                    </div>
                                    <div class="group-products mt-2" id="group-products-{{ i.id }}" style="display: none;">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <style>
                        .fullscreen-dropdown {
                            position: fixed;
                            top: 0;
                            right: 0;
                            width: 25%;
                            height: 100%;
                            background: white;
                            z-index: 1050;
                            display: none;
                            overflow-y: auto;
                            padding: 20px;
                            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
                        }

                        .dropdown-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #eee;
                            margin-bottom: 15px;
                        }

                        .group-name:hover {
                            background-color: #f0f0f0;
                            padding: 5px;
                            border-radius: 5px;
                        }

                        .product-item {
                            border: 1px solid #ddd;
                            padding: 10px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            border-radius: 4px;
                            background-color: #f9f9f9;
                        }

                        .product-item img {
                            width: 40px;
                            height: 40px;
                            object-fit: contain;
                            margin-right: 10px;
                        }
                    </style>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const dropdownBtn = document.getElementById('fullscreenDropdownBtn');
                            const fullscreenDropdown = document.getElementById('fullscreenDropdown');
                            let isDropdownOpen = false;

                            function toggleDropdown() {
                                isDropdownOpen = !isDropdownOpen;
                                fullscreenDropdown.style.display = isDropdownOpen ? 'block' : 'none';
                                document.body.style.overflow = isDropdownOpen ? 'hidden' : '';
                            }

                            dropdownBtn.addEventListener('click', function (e) {
                                e.stopPropagation();
                                toggleDropdown();
                            });

                            document.addEventListener('click', function (e) {
                                if (isDropdownOpen && !fullscreenDropdown.contains(e.target) && e.target !== dropdownBtn) {
                                    isDropdownOpen = false;
                                    fullscreenDropdown.style.display = 'none';
                                    document.body.style.overflow = '';
                                }
                            });
                            
                            document.querySelectorAll('.group-name').forEach(group => {
                                group.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    const groupId = this.getAttribute('data-group-id');
                                    const productsContainer = document.getElementById(`group-products-${groupId}`);

                                    const valyuta_id = document.getElementById('valyuta_input').value;
                                    const priceType = document.querySelector('.price_type_input:checked');
                                    const priceTypeValue = priceType ? priceType.value : null;

                                    if (productsContainer.style.display === 'block') {
                                        productsContainer.style.display = 'none';
                                        return;
                                    }
                                    $.ajax({
                                        url: `{% url 'ajax_filter_groups' group_id=0 %}`.replace('0', groupId),
                                        type: 'GET',
                                        data:{'valyuta_id':valyuta_id, 'price_type':priceTypeValue},
                                        dataType: 'json',
                                        beforeSend: function () {
                                            productsContainer.innerHTML = '<p>Yuklanmoqda...</p>';
                                            productsContainer.style.display = 'block';
                                        },
                                        success: function (data) {
                                            if (data.data.length > 0) {
                                                let html = '';
                                                data.data.forEach(product => {
                                                    let pr_price = product.price || 0;
                                                    html += `
                                                        <div class="product-item add-to-cart"
                                                            data-id="${product.id}"
                                                            data-name="${product.name}"
                                                            data-pack="${product.pack}"
                                                            data-price="${pr_price}">
                                                            <div>
                                                                <img src="${product.image || '/static/default.png'}" alt="${product.name}">
                                                            </div>
                                                            <div>
                                                                <strong>${product.name}</strong><br>
                                                                <div style="display:flex; gap:10px">
                                                                    <p>Narx: ${pr_price} ${shop_valyuta_name}</p>
                                                                    <p>Pachka: ${product.pack}</p> 
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                });
                                                productsContainer.innerHTML = html;

                                                document.querySelectorAll(`#group-products-${groupId} .add-to-cart`).forEach(item => {
                                                    item.addEventListener('click', function () {
                                                        const productId = this.dataset.id;
                                                        const productName = this.dataset.name;
                                                        const pack = parseFloat(this.dataset.pack) || 1;
                                                        const price = parseFloat(this.dataset.price) || 0;

                                                        const existingRow = $(`#row_${productId}`).first();
                                                        if (existingRow.length > 0) {
                                                            const currentQty = parseFloat(existingRow.find('.quantity-input').val()) || 0;
                                                            const newQty = currentQty + 1;
                                                            existingRow.find('.quantity-input').val(newQty);
                                                            updateCartItem(existingRow, add=true, quantity_add=1);
                                                            updatePackFromQuantity(existingRow.find('.quantity-input'));
                                                        } else {
                                                            addProductToTable(productId, productName, pack, price, 1);
                                                        }
                                                        $('#productSearchInput').val('');
                                                    });
                                                });
                                            } else {
                                                productsContainer.innerHTML = '<p>Mahsulotlar topilmadi</p>';
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            productsContainer.innerHTML = `<p>Xatolik yuz berdi: ${error}</p>`;
                                        }
                                    });
                                });
                            });
                        });
                    </script>

                </div>
                <div class="widget-content widget-content-area br-6">
                    <div class="table-responsive mb-4 mt-4">
                        <table id="product_list" class="table table-hover non-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Maxsulot nomi</th>
                                    <th>Paket soni</th>
                                    <th>Paket</th>
                                    <th>Miqdori (dona)</th>
                                    <th>Narx</th>
                                    <th>Kelishilgan narx</th>
                                    <th style="min-width: 10rem;">Jami</th>
                                    <th>O'chirish</th>
                                </tr>
                            </thead>
                            <tbody> 
                                {% for i in cart %}
                                    <tr data-id="{{i.id}}" id="row_{{i.product.id}}">
                                        <td>{{ forloop.counter }}</td>
                                        <td class="product_name">{{ i.product.name }}</td>
                                        <td>{{ i.product.pack }}</td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" class="form-control pack-input" 
                                                       value="{{ i.total_pack|floatformat }}" min="0" step="0.01"
                                                       data-pack="{{ i.product.pack }}"
                                                       onkeyup="updateQuantityFromPack(this)" style="width: 6rem;">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" class="form-control quantity-input" 
                                                       value="{{ i.quantity|floatformat }}" name="quantity" min="0" step="0.01"
                                                       onkeyup="updatePackFromQuantity(this)" style="width: 6rem;">
                                            </div>
                                        </td>
                                        <td>{{ i.price_without_skidka|intcomma }}</td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" class="form-control price-input price_product_list" 
                                                       value="{{ i.price|floatformat }}" min="0" step="0.01"
                                                       onchange="updatePrice(this)">
                                            </div>
                                        </td>
                                        <td class="total" data-value="{{i.total_price}}">{{ i.total_price|intcomma }}</td>
                                        <td><button type="button" class="btn btn-danger product-delete"><i class="fa-solid fa-trash"></i></button></td>
                                    </tr>
                                {% endfor %}
                                <input type="hidden" class="skidka_input" id="hidden_skidka">

                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Jami</td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-center" id="pack_total">{{ totals.total_pack|floatformat|intcomma }}</td>
                                    <td class="text-center" id="quantity_total">{{ totals.quantity|floatformat|intcomma }}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-4 col-sm-12 layout-spacing">
                <div class="row">
                    <div class="col-md-12 widget-content widget-content-area br-6">
                        <form method="post" action="{% url 'b2c_shop_edit' %}">
                            {% csrf_token %}
                            <!-- <h4 class="text-success" style="font-size: 50px;" id="all_total">{{ totals.total|intcomma }}</h4> -->
                             <h4 class="text-success" style="font-size: 50px;" id="all_total">{{ totals.total|floatformat:2|default:"0.0" }}</h4>
                            <br>
                            <div class="btn-group" role="group" aria-label="Price Types" style="width: 100%;">
                                {% for i in price_types %}
                                    <input type="radio" class="btn-check price_type_input" name="type_price" id="{{i.name}}{{i.id}}" value="{{i.id}}" autocomplete="off" 
                                    {% if shop.debtor.price_type == i %}
                                        checked
                                    {% elif not shop.debtor.price_type and price_types.first == i %}
                                        checked
                                    {% endif %}
                                        >
                                    <label class="btn btn-outline-primary" for="{{i.name}}{{i.id}}">{{i.name}}</label>
                                {% endfor %}
                            </div>
                            <br>
                            <input type="hidden" name="id" id="shop_id" value="{{shop.id}}">
                            <div class="form-group">
                                <label for="recipient-debtor" class="col-form-label">Mijoz</label>
                                <div class="input-group">
                                    <select class="form-control searchable" id="mainSelectDebtor"  name="debtor" required>
                                        <option value=""></option>
                                        {% for i in customers %}
                                            <option value="{{i.id}}" {% if shop.debtor == i %}selected{% endif %}>{{ i.fio }} - {{ i.phone1 }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#debtorModal" style="height: 45px;">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if shop.debtor.fio != "Naqd" %}
                            <!-- <label for="">To'lov sanasi</label>
                            <input type="date" class="form-control" value="{{ shop.debt_return|date:'Y-m-d' }}" name="debt_return" required>

                            <label for="">Call center</label>
                            <select class="form-control searchable" name="call_center" required>
                                <option value=""></option>
                                {% for i in call_center %}
                                    <option value="{{i.id}}" {% if shop.saler == i %}selected{% endif %}>{{ i }}</option>
                                {% endfor %}
                            </select> -->
                            {% endif %}
                         

                            <label for="">Filial</label>
                            <select class="form-control searchable" name="filial" id="selectFilial" required>
                                <option value=""></option>
                                {% for i in filial %}
                                    <option value="{{i.id}}" {% if shop.filial == i or user.filial == i %}selected{% endif %}>{{ i.name }}</option>
                                {% endfor %}
                            </select>
                            <br><hr style="color: black;">

                            <label for="">Jami summa</label>
                            <input type="text" class="form-control" id="all_total_2" name="all_total" value="{{ totals.total }}" disabled>
                            <br>
                            {% if shop.debtor.fio != "Naqd" %}
                            {% endif %}
                             </form>
                            <div class="modal fade" id="debtorModal" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-body">
                                            <form method="post" enctype="multipart/form-data" id="debtorForm">
                                                {% csrf_token %}
                                                <!-- <div class="form-group">
                                                    <label for="recipient-debtor_type" class="col-form-label">Turi</label>
                                                    <div class="input-group">
                                                        <select name="type" id="recipient-debtor_type" class="form-control">
                                                            <option value="">---------</option>
                                                            {% for debtor_type in debtor_type %}
                                                                <option value="{{ debtor_type.id }}">{{ debtor_type.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="input-group-append">
                                                            <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#debtorTypeModal">+</button>
                                                        </div>
                                                    </div>
                                                </div> -->
                                                <!-- <div class="form-group">
                                                    <label for="recipient-teritory" class="col-form-label">Teritoriyasi</label>
                                                    <div class="input-group">
                                                        <select name="teritory" id="recipient-teritory" class="form-control">
                                                            <option value="">---------</option>
                                                            {% for teritory in teritory %}
                                                                <option value="{{ teritory.id }}">{{ teritory.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="input-group-append">
                                                            <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#teritoryModal">+</button>
                                                        </div>
                                                    </div>
                                                </div> -->
                                                <div class="form-group">
                                                    <label class="col-form-label">Narx Turi</label>
                                                    <div class="input-group">
                                                        <select name="price_type" class="form-control" id="recipient-price_type">
                                                            <option value="">---------</option>
                                                            {% for price_type in price_type %}
                                                                <option value="{{ price_type.id }}">{{ price_type.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="input-group-append">
                                                            <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#priceTypeModal">+</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- <div class="form-group">
                                                    <label for="recipient-image" class="col-form-label">Rasm</label>
                                                    <input type="file" class="form-control" id="recipient-image" name="image" >
                                                </div> -->
                                                <div class="form-group">
                                                    <label for="recipient-fio" class="col-form-label">F.I.O</label>
                                                    <input type="text" class="form-control" id="recipient-fio" name="fio" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-form-label">Telegram ID</label>
                                                    <input type="text" class="form-control"  name="tg_id" oninput="filterTgID(this)" placeholder="ID bir xil bo‚Äòlib qolmasin">
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-phone1" class="col-form-label">Telefon</label>
                                                    <input value="998" type="text" class="form-control" id="recipient-phone1" name="phone1" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-phone2" class="col-form-label">Telefon 2</label>
                                                    <input value="998" type="text" class="form-control" id="recipient-phone2"  name="phone2" >
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="debtor_add_close">Yopish</button>
                                                    <button type="submit" class="btn btn-primary">Saqlash</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" id="debtorTypeModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <form id="debtorTypeForm">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Yangi Turi Qo‚Äòshish</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" name="name" class="form-control" placeholder="Turi nomi" required>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">Saqlash</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="modal fade" id="teritoryModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <form id="teritoryForm">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Yangi Teritoriya Qo‚Äòshish</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" name="name" class="form-control mb-2" placeholder="Teritoriya nomi" required>
                                                <div class="input-group">
                                                    <select name="region_id" id="regionSelect" class="form-control" required>
                                                        <option value="">-- Region tanlang --</option>
                                                        {% for region in regions %}
                                                            <option value="{{ region.id }}">{{ region.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <div class="input-group-append">
                                                        <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#regionModal">+</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">Saqlash</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="modal fade" id="regionModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <form id="regionForm">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Yangi Region Qo‚Äòshish</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" name="name" class="form-control mb-2" placeholder="Region nomi" required>
                                                <input type="number" name="number" class="form-control" placeholder="Region raqami" required>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">Saqlash</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="modal fade" id="priceTypeModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <form id="priceTypeForm">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Yangi Narx Turi Qo‚Äòshish</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" name="name" class="form-control" placeholder="Narx turi nomi" required>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">Saqlash</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            

                            <div class="row">
                                <div class="col-md-8 discount-input-group">
                                    <input type="number" id="discountInput"  oninput="changeDiscount()" class="form-control" placeholder="Chegirmani kiriting" style="border-radius: 10px; height: 38px;">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger" onclick="clearPerecent()">X</button>
                                </div>
                                <div class="col-md-2 discount-toggle d-flex justify-content-end">
                                    <button id="uzsBtn">{{shop_valyuta_name}}</button>
                                </div>
                            </div>
                            <br>
                            <div class="row quick-discount  g-2" >
                                <div class="col-auto">
                                    <button id="disc_button" style="display: none;">0%</button>
                                </div>
                            </div>
                         <script>
                            const uzsBtn = document.getElementById('uzsBtn');
                            const discountInput = document.getElementById('discountInput');
                            const all_total = document.getElementById('all_total');
                            const all_total_two = document.getElementById('all_total_2');
                            const disc_button = document.getElementById('disc_button');
                            function safeParse(text) {
                                try {
                                    let cleaned = String(text).replace(/\s/g, '');
                                    cleaned = cleaned.replace(/,/g, '.');
                                    cleaned = cleaned.replace(/[^\d.]/g, '');
                                    return parseFloat(cleaned, 1) || 0;
                                } catch (e) {
                                    return 0;
                                }
                            }
                            function clearPerecent() {
                                document.getElementById('discountInput').value = ''
                                changeDiscount();
                            }
                            function changeDiscount() {
                                const val = parseFloat(discountInput.value) || 0;
                                const hidden_skidka = document.getElementById('hidden_skidka');
                                let originlaTotal = 0;
                                $("tbody tr").each(function() {
                                    const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                                    const price = parseFloat($(this).find('.price-input').val()) || 0;
                                    originlaTotal += quantity * price;
                                });
                                if (0 >= val) {
                                    all_total.textContent = originlaTotal.toLocaleString('ru-RU', {minimumFractionDigits: 1});
                                    all_total_two.value = originlaTotal.toLocaleString('ru-RU', {minimumFractionDigits: 1});
                                    hidden_skidka.value = 0;
                                    disc_button.textContent = '';
                                    disc_button.style.display = 'none';
                                    updateReceiptProducts();
                                    return;
                                }
                                let result;
                                result = originlaTotal - val;
                                hidden_skidka.value = val;
                                let percent = val / originlaTotal * 100
                                disc_button.textContent = `${percent.toFixed(2)}%`
                                disc_button.style.display = 'block';
                                updateReceiptProducts();
                                all_total.textContent = result.toLocaleString('ru-RU', {minimumFractionDigits: 1});
                                all_total_two.value = result.toLocaleString('ru-RU', {minimumFractionDigits: 1});
                            }
                        </script>
                    </div>

                    <div class="col-md-12">
                        <br>
                        <button class="btn btn-secondary" style="width: 100%;" id="fullscreenPaymentBtn">
                            Tolovni amalga oshirish
                        </button>
                    </div>

                    <div id="fullscreenPayment" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1050; overflow-y: auto; padding: 20px;">
                        <div class="container-fluid">
                            <div class="row mb-3">
                                <div class="col-12 d-flex justify-content-between align-items-center">
                                    <h3>To'lovni amalga oshirish</h3>
                                    <button class="btn btn-danger" id="closeFullscreenBtn">
                                        <i class="fas fa-times"></i> 
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="receipt-wrapper" id="check_div">
                                        <div class="zigzag"></div>
                                        <div class="receipt">
                                            <div class="section">
                                                <div class="lines"><span class="bold">Tranzaksiya:</span> <span>#{{ shop.id }}</span></div>
                                                <div class="bold">Store ecomarf-tekstil</div>
                                                <div class="lines"><span class="bold">Sana:</span> <span>{{today|date:'Y-m-d'}}</span></div>
                                                <div class="lines"><span class="bold">Sotuvchi:</span> <span>{{ shop.debtor}}</span></div>
                                                <div class="bold">Maxsulotlar:</div>
                                            </div>
                                            <hr>
                                            <div id="chek_products">
                                            </div>
                                            <hr>
                                            <div class="section">
                                                <div class="lines"><span>Oraliq jami</span><span id="chek_oraliq_jami">0 {{shop_valyuta_name}}</span></div>
                                                <div class="lines"><span>Chegirma</span><span id="chek_chegirma">0 {{shop_valyuta_name}}</span></div>
                                                <div class="lines bold"><span>JAMI</span><span  id="chek_total_jami">0 {{shop_valyuta_name}}</span></div>
                                            </div>
                                            <div class="section" id="check_tolovlar">
                                            </div>
                                            <div class="barcode"></div>
                                            <div class="center">Xaridingiz uchun rahmat</div>
                                        </div>
                                        <div class="zigzag"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 text-center mt-3">
                                            <button class="btn btn-primary" id="saveAsPngBtn">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>

                                        <style>
                                        .zigzag-top, .zigzag-bottom {
                                            height: 15px;
                                            background: 
                                                linear-gradient(135deg, #000 25%, transparent 25%) -10px 0,
                                                linear-gradient(225deg, #000 25%, transparent 25%) -10px 0,
                                                linear-gradient(315deg, #000 25%, transparent 25%),
                                                linear-gradient(45deg, #000 25%, transparent 25%);
                                            background-size: 20px 20px;
                                            margin: 0 -1px;
                                            width: calc(100% + 2px);
                                        }
                                        .zigzag-top {
                                            margin-bottom: 10px;
                                        }
                                        .zigzag-bottom {
                                            margin-top: 10px;
                                        }
                                        .receipt-print {
                                            background: white;
                                            padding: 15px;
                                            border-left: 1px dashed #000;
                                            border-right: 1px dashed #000;
                                            width: 300px;
                                            margin: 0 auto;
                                        }
                                        </style>

                                        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
                                        <script>
                                        document.getElementById('saveAsPngBtn').addEventListener('click', function() {
                                            const printDiv = document.createElement('div');
                                            printDiv.className = 'receipt-print-container';
                                            printDiv.style.position = 'absolute';
                                            printDiv.style.left = '-9999px';
                                            printDiv.style.width = '302px'; 
                                            
                                            const receiptClone = document.querySelector('.receipt-wrapper').cloneNode(true);
                                            
                                            receiptClone.style.width = '300px';
                                            receiptClone.style.margin = '0';
                                            receiptClone.style.boxShadow = 'none';
                                            receiptClone.style.border = 'none';
                                            
                                            printDiv.appendChild(receiptClone);
                                            document.body.appendChild(printDiv);
                                            
                                            html2canvas(printDiv, {
                                                scale: 2,
                                                logging: false,
                                                useCORS: true,
                                                allowTaint: true,
                                                backgroundColor: 'white'
                                            }).then(canvas => {
                                                const link = document.createElement('a');
                                                link.download = 'chek-' + new Date().toISOString().slice(0, 10) + '.png';
                                                link.href = canvas.toDataURL('image/png');
                                                link.click();
                                                document.body.removeChild(printDiv);
                                            });
                                        });
                                        </script>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <div class="summary-title">Jami:</div>
                                                <div class="summary-value" id="total_jami">0 {{shop_valyuta_name}}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <div class="summary-title">To'lash uchun:</div>
                                                <div class="summary-value total" id="tolash_summasi">0 {{shop_valyuta_name}}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <h4>To'lov usullari</h4>
                                            <hr>
                                        </div>
                                        {% for mer in kassa %}
                                        <div class="col-md-3 mb-3 plus_button">
                                            <div class="payment-method" data-kassa-id="{{ mer.kassa.id }}" data-valyuta-id="{{ mer.valyuta.id }}">
                                                <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'">
                                                    <i class="fa-solid fa-money-bill-wave"></i>
                                                    <p>{{ mer.kassa.name }} ({{ mer.valyuta }})</p>
                                                    <button class="toggle-input"
                                                        {% if mer.valyuta.is_dollar %}
                                                            data-dollar="true"
                                                        {% else %}
                                                            data-dollar="false"
                                                        {% endif %}
                                                        >
                                                        <i class="fa-solid fa-plus"></i>
                                                    </button>
                                                </div>
                                                <div class="input-box" style="display: none;">
                                                    <div class="box-header">
                                                        <span>{{ mer.kassa.name }} ({{ mer.valyuta }})</span>
                                                        <p style="display: none;" class="box-header-valyuta-name">{{ mer.valyuta.name }}</p>
                                                        <button class="remove-field">&times;</button>
                                                    </div>
                                                    <div class="box-body">
                                                        <input type="number" step="any" class="form-control payment-input" placeholder="Summani kiriting" oninput="paymentSystem.updatePaymentDisplay(); paymentSystem.updateTolashText();">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        
                                        <div class="col-md-3 mb-3 plus_button">
                                            <div class="payment-method" data-kassa-id="qarz" data-valyuta-id="">
                                                <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'">
                                                    <i class="fa-solid fa-money-bill-transfer"></i>
                                                    <p>Qarzga</p>
                                                    <button class="toggle-input" data-bs-toggle="modal" data-bs-target="#qarzModal" id="qarzModalButton">
                                                        <i class="fa-solid fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-12 d-flex justify-content-end" style="gap: 10px;">
                                            <button type="button" class="btn btn-danger me-2" id="cancelPaymentBtn">
                                                <i class="fas fa-times"></i> Bekor qilish
                                            </button>
                                            <button type="button" class="btn btn-success" id="submit-payment" onclick="Yakunlash()">
                                                <i class="fas fa-check"></i> To'lovni tasdiqlash va Yakunlash
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="qarzModal" tabindex="-1" aria-labelledby="qarzModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content p-4">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="qarzModalLabel">Yangi qarz</h5>
                                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3" id="customer_info">
                                        {% for i in customer_info.valyuta %}
                                        <div class="col-4">
                                            <label>Faol qarz ({{i.name}})</label>
                                            <h6>{{ i.summa|intcomma }}</h6>
                                        </div>
                                        {% endfor %}
                                        <div class="col-3">
                                            <label>Oxirgi to'lov</label>
                                            <h6>{{customer_info.last_pay|date:'Y-m-d'}}</h6>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Mijoz</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fa fa-user"></i></span>
                                            <select class="form-control" id="modalSelectDebtor" name="debtor" required style="border: 1px solid rgba(0, 0, 0, 0.214);font-weight: bold; background-color: #fff; opacity: 1; color: #000;">
                                                <option value=""></option>
                                                {% for i in customers %}
                                                    <option value="{{i.id}}" {% if shop.debtor == i %}selected{% endif %}>{{ i.fio }}</option>
                                                {% endfor %}
                                            </select>
                                            <!-- <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#debtorModal" style="height: 45px;">+</button>
                                            </div> -->
                                        </div>
                                        <small class="text-muted">Balans: 0 {{shop_valyuta_name}}</small>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label>Summa</label>
                                            <input type="number" step="any" class="form-control" id="qarzSumma" 
                                                style="border: 1px solid rgba(0, 0, 0, 0.214);" required>
                                        </div>
                                        <div class="col">
                                            <label>To'lov muddati</label>
                                            <input type="date" class="form-control" id="qarzDueDate" 
                                                style="border: 1px solid rgba(0, 0, 0, 0.214);" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Izoh</label>
                                        <textarea class="form-control" id="qarzComment" rows="3" placeholder="Izoh kiriting"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-danger" id="qarzclose" data-bs-dismiss="modal">Bekor qilish</button>
                                    <button type="button" class="btn btn-primary" id="confirmQarzButton">Qarz berish</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        const shop_valyuta_name = document.getElementById('shop_valyuta_name').textContent

                        const fullscreenPaymentBtn = document.getElementById('fullscreenPaymentBtn');
                        const fullscreenPayment = document.getElementById('fullscreenPayment');
                        const closeFullscreenBtn = document.getElementById('closeFullscreenBtn');
                        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
                            
                        fullscreenPaymentBtn.addEventListener('click', function() {
                                fullscreenPayment.style.display = 'block';
                                document.body.style.overflow = 'hidden'; 
                                paymentSystem.init();
                            });
                            
                        function closeFullscreen() {
                            fullscreenPayment.style.display = 'none';
                            document.body.style.overflow = ''; 
                        }
                            
                        closeFullscreenBtn.addEventListener('click', function() {
                            for (const methodName in paymentSystem.paymentMethods) {
                                paymentSystem.totalToPay += paymentSystem.paymentMethods[methodName];
                                paymentSystem.paymentMethods[methodName] = 0;
                            }
                            
                            document.querySelectorAll('.payment-input').forEach(input => {
                                input.value = '0';
                            });
                            
                            paymentSystem.updatePaymentDisplay();
                            paymentSystem.updateTolashText();
                            closeFullscreen();
                        });
                        cancelPaymentBtn.addEventListener('click', function() {
                            for (const methodName in paymentSystem.paymentMethods) {
                                paymentSystem.totalToPay += paymentSystem.paymentMethods[methodName];
                                paymentSystem.paymentMethods[methodName] = 0;
                            }
                            
                            document.querySelectorAll('.payment-input').forEach(input => {
                                input.value = '0';
                            });
                            
                            paymentSystem.updatePaymentDisplay();
                            paymentSystem.updateTolashText();
                            closeFullscreen();
                        });
                        function formatNumber(num) {
                            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }
                            
                        function updateReceiptProducts() {
                            const productList = document.getElementById('product_list');
                            const receiptContainer = document.getElementById('chek_products');
                            const hidden_skidka = parseFloat(document.getElementById('hidden_skidka').value) || 0;
                            
                            if (!productList || !receiptContainer) return 0;
                            
                            receiptContainer.innerHTML = '';
                            let summaItog = 0;
                            let oraliq_jami = 0;
                            let perecnt = 0;
                            let chegirma = hidden_skidka;
                            const productRows = productList.querySelectorAll('tbody tr');
                            
                            productRows.forEach(row => {
                                const nameCell = row.querySelector('td:nth-child(2)');
                                const productName = nameCell ? nameCell.textContent.trim() : 'Unknown Product';
                                
                                let quantity = 1;
                                const quantityInput = row.querySelector('.quantity-input');
                                if (quantityInput) {
                                    quantity = parseFloat(quantityInput.value) || 1;
                                }
                                
                                let price = 0;
                                const priceInput = row.querySelector('.price-input');
                                if (priceInput) {
                                    price = parseFloat(priceInput.value) || 0;
                                } 
                                
                                const totalWithoutDiscount = price * quantity;
                                summaItog += totalWithoutDiscount;
                                oraliq_jami += totalWithoutDiscount;
                                
                                const formattedPrice = formatNumber(price.toFixed(2));
                                const formattedQuantity = formatNumber(quantity.toFixed(2));
                                const formattedTotalWithoutDiscount = formatNumber(totalWithoutDiscount.toFixed(2));
                                
                                const receiptItem = `
                                    <div class="section">
                                        <div class="item-title">${productName}</div>
                                        <div class="lines">
                                            <span>${formattedQuantity} √ó ${formattedPrice}</span>
                                            <span>${formattedTotalWithoutDiscount} ${shop_valyuta_name}</span>
                                        </div>
                                    </div>
                                `;
                                receiptContainer.insertAdjacentHTML('beforeend', receiptItem);
                            });

                            let discountPercentage = 0;
                            if (chegirma > 0 && oraliq_jami > 0) {
                                discountPercentage = (chegirma / oraliq_jami * 100).toFixed(2);
                                summaItog = oraliq_jami - chegirma;
                            }
                            
                            const formattedSumma = formatNumber(summaItog.toFixed(2));
                            const formattedoraliq_jami = formatNumber(oraliq_jami.toFixed(2));
                            
                            document.getElementById('chek_total_jami').textContent = `${formattedSumma} ${shop_valyuta_name}`;
                            document.getElementById('total_jami').textContent = `${formattedSumma} ${shop_valyuta_name}`;
                            document.getElementById('chek_oraliq_jami').textContent = `${formattedoraliq_jami} ${shop_valyuta_name}`;
                            document.getElementById('chek_chegirma').textContent = `${formatNumber(chegirma)} ${shop_valyuta_name} (${discountPercentage}%)`;
                            
                            return summaItog;
                        }
                            
                            const paymentSystem = {
                                totalJami: 0,
                                totalToPay: 0,
                                paymentMethods: {},
                                modalInstance: null,
                                
                                // init: function() {
                                //     this.totalJami = updateReceiptProducts();
                                //     this.totalToPay = this.totalJami;
                                    
                                //     // Avvalgi to'lov usullarini tozalash
                                //     this.paymentMethods = {};
                                    
                                //     // Barcha to'lov usullarini ishga tushirish
                                //     document.querySelectorAll('.payment-method').forEach(method => {
                                //         const methodName = method.querySelector('p').textContent.trim();
                                //         this.paymentMethods[methodName] = 0;
                                        
                                //         // Agar input box ochiq bo'lsa, unga to'lov summasi yoziladi
                                //         const inputBox = method.querySelector('.input-box');
                                //         if (inputBox) {
                                //             const input = inputBox.querySelector('input');
                                //             input.value = this.totalToPay.toFixed(2);
                                //             this.updateTolash(input);
                                //         }
                                //     });
                                //     console.log(this.totalToPay, 'aaaaaa')
                                //     this.paymentMethods['Qarz'] = 0;
                                //     this.setupEventListeners();
                                //     this.initModal();
                                //     this.updatePaymentDisplay();
                                //     this.updateTolashText();
                                // },


                                init: function() {
                                    this.totalJami = updateReceiptProducts();
                                    this.totalToPay = this.totalJami;
                                    console.log(this.totalJami, 'oooooooo')
                                    // Avvalgi to'lov usullarini tozalash
                                    this.paymentMethods = {};
                                    
                                    // Barcha to'lov usullarini ishga tushirish
                                    document.querySelectorAll('.payment-method').forEach(method => {
                                        const methodName = method.querySelector('p').textContent.trim();
                                        this.paymentMethods[methodName] = 0;
                                        
                                        // Agar input box ochiq bo'lsa, unga to'lov summasi yoziladi
                                        const inputBox = method.querySelector('.input-box');
                                        if (inputBox) {
                                            const input = inputBox.querySelector('input');
                                            const toggleButton = method.querySelector('.toggle-input');
                                            const isDollar = toggleButton.getAttribute('data-dollar') === 'true';
                                            const dollarKurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;
                                            
                                            // if (isDollar) {
                                            //     // Dollar bo'lsa, summani kursga bo'lib yozamiz
                                            //     input.value = (this.totalToPay / dollarKurs).toFixed(2);
                                            // } else {
                                            //     // So'm bo'lsa, to'liq summani yozamiz
                                            //     input.value = this.totalToPay.toFixed(2);
                                            // }
                                            this.updateTolash(input);
                                        }
                                    });
                                    console.log(this.paymentMethods, 'ppppp')
                                    this.paymentMethods['Qarz'] = 0;
                                    this.setupEventListeners();
                                    this.initModal();
                                    this.updatePaymentDisplay();
                                    this.updateTolashText();
                                },

                                
                                // initModal: function() {
                                //     const qarzModal = document.getElementById('qarzModal');
                                //     if (!qarzModal) return;
                                    
                                //     this.modalInstance = new bootstrap.Modal(qarzModal);
                                    
                                //     const summaInput = qarzModal.querySelector('input[type="number"]');
                                //     const qarzButton = qarzModal.querySelector('.btn-primary');
                                //     const cancelButton = qarzModal.querySelector('.btn-danger');
                                    
                                //     // qarzModal.addEventListener('show.bs.modal', () => {
                                //     //     console.log('aaaaaaaaaff')
                                //     //     summaInput.value = this.paymentMethods['Qarz'] || this.totalToPay;
                                //     //     summaInput.select();
                                //     // });

                                //     qarzModal.addEventListener('show.bs.modal', () => {
                                //         // Avval qarz summasi mavjud bo'lsa, uni ko'rsatish
                                //         // Aks holda qolgan summani ko'rsatish
                                //         // console.log(this.paymentMethods['Qarz'], 'iiii')
                                //         const currentQarz = this.paymentMethods['Qarz'] || 0;
                                //         summaInput.value = currentQarz > 0 ? currentQarz : this.totalToPay;
                                //         summaInput.select();
                                //     });

                                //     // $('#qarzModalButton').click(function() {
                                //     //     summaInput.value = this.paymentMethods['Qarz'] || this.totalToPay;
                                //     //     console.log(this.paymentMethods['Qarz'])
                                //     // //     summaInput.select();
                                //     // })
                                    
                                //     qarzButton.addEventListener('click', () => {
                                //         console.log(summaInput.value, 'aaaaaaa')
                                //         const summa = parseFloat(summaInput.value) || 0;
                                //         if (summa > 0) {
                                //             if (this.addCreditPayment(summa)) {
                                //                 this.modalInstance.hide();
                                //                 document.querySelector('[data-bs-dismiss="modal"]').click();
                                //             }
                                //         } else {
                                //             showAlert("Iltimos, to'g'ri summa kiriting!", "success");
                                //             summaInput.focus();
                                //         }
                                //     });
                                    
                                //     cancelButton.addEventListener('click', () => {
                                //         if (this.paymentMethods['Qarz'] > 0) {
                                //             this.totalToPay += this.paymentMethods['Qarz'];
                                //             this.paymentMethods['Qarz'] = 0;
                                //             this.updatePaymentDisplay();
                                //             this.updateTolashText();
                                //         }
                                //         this.modalInstance.hide();
                                //     });
                                // },


                                initModal: function() {
                                    const qarzModal = document.getElementById('qarzModal');
                                    if (!qarzModal) return;
                                    
                                    this.modalInstance = new bootstrap.Modal(qarzModal);
                                    
                                    const summaInput = qarzModal.querySelector('input[type="number"]');
                                    const qarzButton = qarzModal.querySelector('.btn-primary');
                                    const cancelButton = qarzModal.querySelector('.btn-danger');
                                    
                                    qarzModal.addEventListener('show.bs.modal', () => {
                                        const currentQarz = this.paymentMethods['Qarz'] || 0;
                                        // summaInput.value = currentQarz > 0 ? currentQarz : this.totalToPay;
                                        summaInput.select();
                                    });
                                    
                                    qarzButton.addEventListener('click', () => {
                                        const summa = parseFloat(summaInput.value) || 0;
                                        if (summa > 0) {
                                            if (this.addCreditPayment(summa)) {
                                                this.modalInstance.hide();
                                            }
                                        } else {
                                            showAlert("Iltimos, to'g'ri summa kiriting!", "success");
                                            summaInput.focus();
                                        }
                                    });
                                    
                                    cancelButton.addEventListener('click', () => {
                                        if (this.paymentMethods['Qarz'] > 0) {
                                            this.totalToPay += this.paymentMethods['Qarz'];
                                            this.paymentMethods['Qarz'] = 0;
                                            this.updatePaymentDisplay();
                                            this.updateTolashText();
                                        }
                                        this.modalInstance.hide();
                                    });
                                },

                                
                                showInputBox: function(button) {
                                    const methodBox = button.closest('.payment-method');
                                    const inputBox = methodBox.querySelector('.input-box');
                                    if (inputBox) {
                                        inputBox.style.display = 'block';
                                        inputBox.querySelector('input').focus();
                                    }
                                },
                                
                                removeBox: function(button) {
                                    const inputBox = button.closest('.input-box');
                                    if (!inputBox) return;
                                    const input = inputBox.querySelector('input');
                                    const methodName = inputBox.querySelector('.box-header span').textContent.trim();
                                  
                                    const value = parseFloat(input.value) || 0;
                                    if (value > 0) {
                                        input.value = '';
                                        this.totalToPay += this.paymentMethods[methodName];
                                        this.paymentMethods[methodName] = 0;
                                    } else {
                                        // inputBox.style.display = 'none';
                                    }
                                    
                                    this.updatePaymentDisplay();
                                    this.updateTolashText();
                                },
                                
                                // updateTolash: function(input) {
                                //     const inputBox = input.closest('.input-box');
                                //     const methodName = inputBox.querySelector('.box-header span').textContent.trim();
                                //     const methodValyutaName = inputBox.querySelector('.box-header-valyuta-name').textContent.trim();
                                //     const dollar_kurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;
                                //     const value = parseFloat(input.value) || 0;
                                //     const previousValue = this.paymentMethods[methodName] || 0;
                                    
                                //     const isSom = (currency) => ['Som', 'Sum', 'SOM', 'SUM', 'UZS', 'Samon', 'SAMON'].includes(currency);
                                //     const isDollar = (currency) => ['Dollar', 'DOLLAR', 'DOl', '$'].includes(currency);
                                    
                                //     let convertedValue = value;
                                //     let difference = 0;
                                    
                                //     if (isSom(shop_valyuta_name)) {
                                //         if (isSom(methodValyutaName)) {
                                //             difference = value - previousValue;
                                //             convertedValue = value;
                                //         } else if (isDollar(methodValyutaName)) {
                                //             convertedValue = value * dollar_kurs;
                                //             difference = convertedValue - previousValue;
                                //         }
                                //     } else if (isDollar(shop_valyuta_name)) {
                                //         if (isDollar(methodValyutaName)) {
                                //             difference = value - previousValue;
                                //             convertedValue = value;
                                //         } else if (isSom(methodValyutaName)) {
                                //             convertedValue = value / dollar_kurs;
                                //             difference = convertedValue - previousValue;
                                //         }
                                //     } else {
                                //         difference = value - previousValue;
                                //         convertedValue = value;
                                //     }
                                    
                                //     this.paymentMethods[methodName] = convertedValue;
                                //     this.totalToPay -= difference;
                                    
                                //     if (value > 0) {
                                //         inputBox.classList.add('has-value');
                                //     } else {
                                //         inputBox.classList.remove('has-value');
                                //     }
                                    
                                //     this.updatePaymentDisplay();
                                //     this.updateTolashText();
                                // },


                                updateTolash: function(input) {
                                    const inputBox = input.closest('.input-box');
                                    const methodName = inputBox.querySelector('.box-header span').textContent.trim();
                                    const methodValyutaName = inputBox.querySelector('.box-header-valyuta-name').textContent.trim();
                                    const dollar_kurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;
                                    const value = parseFloat(input.value) || 0;
                                    const previousValue = this.paymentMethods[methodName] || 0;
                                    
                                    const isSom = (currency) => ['Som', 'Sum', 'SOM', 'SUM', 'UZS', 'Samon', 'SAMON'].includes(currency);
                                    const isDollar = (currency) => ['Dollar', 'DOLLAR', 'DOl', '$'].includes(currency);
                                    
                                    let convertedValue = value;
                                    let difference = 0;
                                    
                                    // Tugma orqali dollar yoki so'm ekanligini aniqlaymiz
                                    const methodBox = inputBox.closest('.payment-method');
                                    const toggleButton = methodBox.querySelector('.toggle-input');
                                    const isDollarMethod = toggleButton.getAttribute('data-dollar') === 'true';
                                    
                                    if (isSom(shop_valyuta_name)) {
                                        if (!isDollarMethod) {
                                            // So'm to'lov usuli
                                            difference = value - previousValue;
                                            convertedValue = value;
                                        } else {
                                            // Dollar to'lov usuli
                                            convertedValue = value * dollar_kurs;
                                            difference = convertedValue - previousValue;
                                        }
                                    } else if (isDollar(shop_valyuta_name)) {
                                        if (isDollarMethod) {
                                            // Dollar to'lov usuli
                                            difference = value - previousValue;
                                            convertedValue = value;
                                        } else {
                                            // So'm to'lov usuli
                                            convertedValue = value / dollar_kurs;
                                            difference = convertedValue - previousValue;
                                        }
                                    } else {
                                        difference = value - previousValue;
                                        convertedValue = value;
                                    }
                                    
                                    this.paymentMethods[methodName] = convertedValue;
                                    this.totalToPay -= difference;
                                    
                                    if (value > 0) {
                                        inputBox.classList.add('has-value');
                                    } else {
                                        inputBox.classList.remove('has-value');
                                    }
                                    
                                    this.updatePaymentDisplay();
                                    this.updateTolashText();
                                },

                                
                                updateTolashText: function() {
                                    const tolashEl = document.getElementById('tolash_summasi');
                                    const paidAmountEl = document.getElementById('paid_amount');
                                    if (tolashEl) {
                                        tolashEl.textContent = `${formatNumber(this.totalToPay)}  ${shop_valyuta_name}`
                                    }
                                    if (paidAmountEl) {
                                        const paidAmount = this.totalJami - this.totalToPay;
                                        paidAmountEl.textContent = `${formatNumber(paidAmount)} ${shop_valyuta_name}`;
                                    }
                                },
                                
                                updatePaymentDisplay: function() {
                                    const paymentContainer = document.getElementById('check_tolovlar');
                                    paymentContainer.innerHTML = '';
                                    let totalPaid = 0;
                                    
                                    for (const [methodName, amount] of Object.entries(this.paymentMethods)) {
                                        if (amount > 0) {
                                            const paymentLine = document.createElement('div');
                                            paymentLine.className = 'lines';
                                            
                                            if (methodName === 'Qarz') {
                                                paymentLine.classList.add('qarz-row');
                                            }
                                            
                                            paymentLine.innerHTML = `
                                                <span>${methodName}</span>
                                                <span>${formatNumber(amount)} ${shop_valyuta_name}</span>
                                            `;
                                            paymentContainer.appendChild(paymentLine);
                                            totalPaid += amount;
                                        }
                                    }
                                },
                                
                                setupEventListeners: function() {
                                    document.querySelectorAll('.payment-input').forEach(input => {
                                        input.addEventListener('input', (e) => this.updateTolash(e.target));
                                    });
                                    
                                    document.querySelectorAll('.toggle-input').forEach(button => {
                                        button.addEventListener('click', (e) => this.showInputBox(e.target));
                                    });
                                    
                                    document.querySelectorAll('.remove-field').forEach(button => {
                                        button.addEventListener('click', (e) => this.removeBox(e.target));
                                    });
                                },
                                
                                // addCreditPayment: function(amount) {
                                //     if (amount > 0 && amount <= this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                //         if (this.paymentMethods['Qarz'] > 0) {
                                //             this.totalToPay += this.paymentMethods['Qarz'];
                                //         }
                                //         this.paymentMethods['Qarz'] = amount;
                                //         this.totalToPay -= amount;
                                //         this.updatePaymentDisplay();
                                //         this.updateTolashText();
                                //         return true;
                                //     } else if (amount > this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                //         showAlert("Qarz summasi qolgan summadan katta bo\'lishi mumkin emas!", "warning");
                                //         return false;
                                //     }
                                //     return false;
                                // },


                                addCreditPayment: function(amount) {
                                    if (amount > 0 && amount <= this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                        if (this.paymentMethods['Qarz'] > 0) {
                                            this.totalToPay += this.paymentMethods['Qarz'];
                                        }
                                        this.paymentMethods['Qarz'] = amount;
                                        this.totalToPay -= amount;
                                        this.updatePaymentDisplay();
                                        this.updateTolashText();
                                        return true;
                                    } else if (amount > this.totalToPay + (this.paymentMethods['Qarz'] || 0)) {
                                        showAlert("Qarz summasi qolgan summadan katta bo'lishi mumkin emas!", "warning");
                                        return false;
                                    }
                                    return false;
                                },

                                
                                submitPayments: function(shopId) {
                                    const paymentInputs = document.querySelectorAll('.input-box:not([style*="display: none"]) .payment-input');
                                    const qarzPayment = this.paymentMethods['Qarz'] || 0;
                                    const qarzComment = document.querySelector('#qarzModal textarea') ? document.querySelector('#qarzModal textarea').value : '';
                                    const qarzDueDate = document.querySelector('#qarzModal input[type="date"]') ? document.querySelector('#qarzModal input[type="date"]').value : '';
                                    let payments = [];
                                    const hidden_skidka = parseFloat(document.getElementById('hidden_skidka').value) || 0;

                                    if (hidden_skidka > 0){
                                        $.ajax({
                                            url: `/shop_chegirma/${shopId}`,
                                            type: "POST",
                                            data:{'chegirma':hidden_skidka},
                                            success: function(response) {
                                                
                                            },
                                            error: function() {
                                                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
                                            }
                                        });
                                    }

                                    paymentInputs.forEach(input => {
                                        const inputBox = input.closest('.input-box');
                                        const paymentMethod = inputBox.closest('.payment-method');
                                        const kassaId = paymentMethod.dataset.kassaId;
                                        const valyutaId = paymentMethod.dataset.valyutaId;
                                        const methodText = inputBox.querySelector('.box-header span').textContent.trim();
                                        const summa = parseFloat(input.value) || 0;
                                        
                                        if (summa > 0) {
                                            payments.push({
                                                kassa_id: kassaId,
                                                valyuta_id: valyutaId,
                                                summa: summa,
                                                comment: ''
                                            });
                                        }
                                    });




                                    if (qarzPayment > 0) {
                                        if (!qarzDueDate) {
                                            showAlert("Iltimos, qarz uchun to\'lov muddatini kiriting!", "warning");
                                            return false;
                                        }
                                        payments.push({
                                            kassa: 'qarz',
                                            valyuta: '',
                                            summa: qarzPayment,
                                            comment: qarzComment,
                                            payment_date: qarzDueDate
                                        });
                                    }
                                    
                                    // const totalPaid = payments.reduce((sum, payment) => sum + payment.summa, 0);

                                    let totalPaid = 0;

                                    for (const [methodName, amount] of Object.entries(paymentSystem.paymentMethods)) {
                                        const numAmount = parseFloat(amount) || 0;

                                        if (methodName.toLowerCase().includes("dollar")) {
                                            totalPaid += parseFloat(numAmount); // dollarni kursga ko‚Äòpaytirib qo‚Äòshamiz
                                        } else {
                                            totalPaid += parseFloat(numAmount); // so‚Äòmni o‚Äòzini qo‚Äòshamiz
                                        }
                                    }

                                    console.log(this.totalJami- totalPaid, 'kkkkkkk')
                                    if ((this.totalJami - totalPaid) > 1) {
                                        showAlert("To\'lov summasi umumiy summagacha to\'liq emas!", "danger");
                                        return false;
                                    }
                                    
                                    

                                    let successCount = 0;
                                    payments.forEach(payment => {
                                        const formData = new URLSearchParams();
                                        
                                        if (payment.kassa === 'qarz') {
                                            formData.append('kassa_id', 'qarz');
                                            formData.append('summa', payment.summa);
                                            formData.append('comment', payment.comment);
                                            formData.append('payment_date', payment.payment_date);
                                        } else {
                                            formData.append('kassa_id', payment.kassa_id);
                                            formData.append('valyuta_id', payment.valyuta_id);
                                            formData.append('summa', payment.summa);
                                        }
                                        
                                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                                        
                                        fetch(`/payment_shop/${shopId}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/x-www-form-urlencoded',
                                                'X-CSRFToken': '{{ csrf_token }}'
                                            },
                                            body: formData
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                successCount++;
                                                if (successCount === payments.length) {
                                                    //window.location.replace('/b2c_shop');
                                                }
                                            } else {
                                                throw new Error(data.message || 'To\'lovda xatolik yuz berdi');
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Payment error:', error);
                                            alert(error.message);
                                        });
                                    });
                                    
                                    return true;
                                }
                            };
                           document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.method-box').forEach(box => {
                                    box.addEventListener('click', function(e) {
                                        if (e.target.closest('.toggle-input')) return;
                                        
                                        const inputBox = this.nextElementSibling;
                                        
                                        if (!inputBox || !inputBox.classList.contains('input-box')) return;
                                        
                                        // document.querySelectorAll('.input-box').forEach(b => {
                                        //     if (b !== inputBox) b.style.display = 'none';
                                        // });
                                        
                                        // inputBox.style.display = inputBox.style.display === 'block' ? 'none' : 'block';
                                    });
                                });

                                document.querySelectorAll('.toggle-input').forEach(button => {
                                    button.addEventListener('click', function(e) {
                                        e.stopPropagation(); 
                                        
                                        const methodBox = this.closest('.method-box');
                                        const inputBox = methodBox.nextElementSibling;
                                        
                                        if (!inputBox || !inputBox.classList.contains('input-box')) return;
                                        
                                        document.querySelectorAll('.input-box').forEach(b => {
                                            // if (b !== inputBox) b.style.display = 'none';
                                        });
                                        
                                        // inputBox.style.display = inputBox.style.display === 'block' ? 'none' : 'block';
                                        
                                        if (inputBox.style.display === 'block') {
                                            inputBox.querySelector('input').focus();
                                        }
                                    });
                                });

                                // document.addEventListener('click', function(e) {
                                //     if (!e.target.closest('.input-box') && !e.target.closest('.method-box')) {
                                //         document.querySelectorAll('.input-box').forEach(box => {
                                //             box.style.display = 'none';
                                //         });
                                //     }
                                // });
                            });
                            document.getElementById('submit-payment').addEventListener('click', function() {
                                paymentSystem.submitPayments({{ shop.id }});
                            });

                    </script>


                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                    <div class="col-md-6">
                        <br>
                        <button type="button" class="btn btn-success" onclick="fetchReceipt()" style="width: 100%;">CHEK V1</button>
                    </div>
                    <div class="col-md-6">
                        <br>
                        <button type="button" class="btn btn-warning" style="width: 100%;"> 
                            <a href="{% url 'shop_nakladnoy' shop.id %}" target="_blank" rel="noopener noreferrer" style="color: white !important;">CHEK V2</a>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="new_product_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <form id="newProductForm" class="modal-content" method="post">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle1">Yangi qoshish</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
            <label for="">Nomi</label>
            <input type="text" class="form-control" name="name" required>
            <input type="hidden" name="from_ajax" value="True">

            <label for="">Ishlab chiqaruvchi</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="deliver" id="deliverSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in delivers %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#deliverModal">+</button>
                    </div>
                </div>

                <label for="">O‚Äòlchov</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="measurement" id="measurementSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in measurements %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#measurementModal">+</button>
                    </div>
                </div>

                <label for="">Fasl</label>
                <div class="input-group mb-2">
                    <select class="form-control searchable" required name="season" id="seasonSelect">
                        <option value="">- - - - - - - - </option>
                        {% for a in seasons %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div>

            <label for="">Min miqdor</label>
            <input type="text" class="form-control" name="min_count" required>

            <label for="">Paketdagi soni</label>
            <input type="text" class="form-control" name="pack" required>

            <label for="">Guruh</label>
            <div class="input-group mb-2">
                <select class="form-control searchable" required name="group" id="groupSelect">
                    <option value="">- - - - - - - - </option>
                    {% for a in groups %}
                        <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#groupModal">+</button>
                </div>
            </div>

            <label for="">Turi</label>
            <select name="ready" class="form-control" id="" required>
                <option value="">- - - - - - - </option>
                {% for i in ready_types %}
                    <option value="{{i.id}}">{{ i.name }}</option>
                {% endfor %}
            </select>

            <label for="">Shtrix kod</label>
            <input type="text" class="form-control" name="barcode" value="{{new_barcode}}" required>

            <label for="">Soni</label>
            <input type="text" class="form-control" name="quantity" value="1" min="1" required>

            </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
        </form>
    </div>
</div>

<!-- Deliver Modal -->
<div class="modal fade" id="deliverModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="deliverForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi Ishlab chiqaruvchi</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="Nomi" required>
          <input type="text" name="phone1" class="form-control mb-2" placeholder="Telefon 1" required>
          <input type="text" name="phone2" class="form-control mb-2" placeholder="Telefon 2">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Measurement Modal -->
<div class="modal fade" id="measurementModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="measurementForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi O‚Äòlchov</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="O‚Äòlchov nomi" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="groupForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi Guruh</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="Guruh nomi" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </div>
    </form>
  </div>
</div>



<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="successModalLabel">Buyurtma yakunlandi</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Yopish">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <p>Buyurtma muvaffaqiyatli yakunlandi.</p>
        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-primary" onclick="window.location.href='/b2c_shop'">Yangi yaratish</button>
          <button class="btn btn-success" onclick="$('#check_div').print()">Print qilish</button>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="order_id" value="{{shop.id}}">

{% endblock content %}

{% block js %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
    <script>
        $('select.searchable').selectize({ normalize: true });
        // const products_input = $('#products')[0].selectize
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.print/1.6.2/jQuery.print.min.js"></script>



<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('productSearchInput');
    const dropdown = document.getElementById('productListDropdown');
    const select = document.getElementById('products');

    // Qidiruv input ustiga bosilganda dropdown ochish
    searchInput.addEventListener('click', function () {
        dropdown.classList.add('show');
    });

    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });

    // searchInput.addEventListener('input', function () {
    //     const filter = this.value.toLowerCase();
    //     const items = dropdown.querySelectorAll('.select-product-item');
    //     let matchCount = 0;
    //     let firstMatch = null;
        
    //     items.forEach(item => {
    //         const text = item.textContent.toLowerCase();
    //         if (text.includes(filter)) {
    //             item.parentElement.style.display = '';
    //             matchCount++;
    //             if (!firstMatch) firstMatch = item;
    //         } else {
    //             item.parentElement.style.display = 'none';
    //         }
    //     });
        
    //     if (matchCount > 0) {
    //         dropdown.classList.add('show');
    //     } else {
    //         dropdown.classList.remove('show');
    //     }
    // });

    searchInput.addEventListener('input', function () {
    const rawFilter = this.value.toLowerCase();  // foydalanuvchi kiritgani (saqlanadi, o‚Äòzgartirilmaydi)
        
        const items = dropdown.querySelectorAll('.select-product-item');
        let matchCount = 0;
        let firstMatch = null;

        items.forEach(item => {
            // Mahsulot matnidan / va \ belgilarini olib tashlaymiz
            const itemText = item.textContent.toLowerCase().replace(/[\\/]/g, '');
            // Foydalanuvchi kiritgan matndan hech narsa olib tashlamaymiz
            const filter = rawFilter.replace(/[\\/]/g, '');  // faqat taqqoslash uchun soddalashtiramiz

            if (itemText.includes(filter)) {
                item.parentElement.style.display = '';
                matchCount++;
                if (!firstMatch) firstMatch = item;
            } else {
                item.parentElement.style.display = 'none';
            }
        });

        if (matchCount > 0) {
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
        }
    });



    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const filter = this.value.toLowerCase();
            const items = dropdown.querySelectorAll('.select-product-item');
            let exactMatch = null;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    if (!exactMatch) exactMatch = item;
                }
            });
            
            if (exactMatch) {
                exactMatch.click();
            } else {
                showAlert("Mos keladigan mahsulot topilmadi", "warning");
            }
        }
    });

    dropdown.querySelectorAll('.select-product-item').forEach(function (item) {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            const value = this.dataset.value;
            const text = this.innerText.split('\n')[0];

            searchInput.value = text;

            const oldValue = select.value;

            select.value = value;

            $('#products').trigger('change');

            dropdown.classList.remove('show');
            $('#products').val('')
        });
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const priceTypeRadios = document.querySelectorAll('.price_type_input');
    const valyutaSelect = document.getElementById('valyuta_input');

    function updateAllPrices() {
        const selectedValyutaId = valyutaSelect.value;
        const selectedPriceTypeId = document.querySelector('.price_type_input:checked')?.value;


        document.querySelectorAll('#productListDropdown span[data-prices]').forEach(span => {
            const rawPrices = span.getAttribute('data-prices');
            if (!rawPrices) return;

            let pricesData;
            try {
                pricesData = JSON.parse(rawPrices);
            } catch (e) {
                console.error("JSON parse error:", e, rawPrices);
                span.textContent = '0';
                return;
            }

            const foundValyuta = pricesData.find(v => String(v.valyuta_id) === selectedValyutaId);
            if (!foundValyuta) {
                span.textContent = '0';
                return;
            }

            const foundPrice = foundValyuta.summas.find(
                s => String(s.price_type) === selectedPriceTypeId
            );

            if (foundPrice && foundPrice.summa) {
                span.textContent = foundPrice.summa;
            } else {
                span.textContent = '0';
            }
        });
    }

    updateAllPrices();

    priceTypeRadios.forEach(radio => radio.addEventListener('change', updateAllPrices));
    valyutaSelect.addEventListener('change', updateAllPrices);
});
</script>

<script>
    function formatNumber(num) {
        return new Intl.NumberFormat("en-US").format(num);
    }

    const showAlert = (message, type) => {
        const alertElement = $(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);

        $("#alert-container").append(alertElement);

        setTimeout(() => {
            alertElement.fadeOut(500, function() { $(this).remove(); });
        }, 3000); 
    };

    function updateQuantityFromPack(input) {
        const row = $(input).closest('tr');
        const packValue = parseFloat($(input).val()) || 0;
        const packSize = parseFloat($(input).data('pack')) || 1;
        const quantity = packValue * packSize;
        
        row.find('.quantity-input').val(quantity.toFixed(2));
        updateCartItem(row);
        updateReceiptProducts();
    }

    function updatePackFromQuantity(input) {
        const row = $(input).closest('tr');
        const quantity = parseFloat($(input).val()) || 0;
        const packSize = parseFloat(row.find('.pack-input').data('pack')) || 1;
        const totalPack = quantity / packSize;
        
        row.find('.pack-input').val(totalPack.toFixed(2));
        updateCartItem(row);
        updateReceiptProducts();
    }

    function updatePrice(input) {
        const row = $(input).closest('tr');
        const newPrice = parseFloat($(input).val()) || 0;
        const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const total = newPrice * quantity;
        
        row.find('.total').text(formatNumber(total.toFixed(2)));
        row.find('.total').attr('data-value', total.toFixed(2));
        updateCartItem(row);
        updateReceiptProducts();
    }

    function updateCartItem(row) {
        const cart_id = row.data('id');
        let quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const totalPack = parseFloat(row.find('.pack-input').val()) || 0;
        const price = parseFloat(row.find('.price-input').val()) || 0;
        const pr_name = parseFloat(row.find('.product_name').text());
        const total = quantity * price;
        
        $.ajax({
            url: `/b2c_shop_cart_edit/${cart_id}`,
            type: "POST",
            data: { 
                quantity: quantity,
                total_pack: totalPack,
                agreed_price: price
            },
            success: function(response) {
                if (response.success) {
                    row.find('.total').text(formatNumber(total.toFixed(2)));
                    row.find('.total').attr('data-value', total.toFixed(2));
                    updateTotals();
                    changeDiscount();
                    updateReceiptProducts();
                    if (fullscreenPayment.style.display === 'block') {
                        paymentSystem.init();
                    }
                } else {
                    changeDiscount();
                    showAlert(response.message, "danger");
                    const existingRow = $(`#row_${pr_id}`).first();
                    const currentQty = parseFloat(existingRow.find('.quantity-input').val()) || 0;
                    if (response.from_quantity) {
                        existingRow.find('.quantity-input').val(response.max_quantity);
                    }
                }
            },
            error: function(response) {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    }

    function formatNumberCustom(num) {
        if (typeof num === "string") {
            num = num.replace(/[\s,]/g, ""); // Probel va vergullarni olib tashlash
        }
        num = parseFloat(num);
        if (isNaN(num)) return "0.0";
        let parts = num.toFixed(1).split(".");
        let integerPart = parts[0];
        let formattedInt = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return formattedInt + "." + parts[1];
    }

    



    // ishlatish
    // $("#all_total_2").val(formatNumberCustom(totalSum));


    function updateTotals() {
        let totalQuantity = 0;
        let totalPack = 0;
        let totalSum = 0;

        $("tbody tr").each(function() {
            const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
            const pack = parseFloat($(this).find('.pack-input').val()) || 0;
            const price = parseFloat($(this).find('.price-input').val()) || 0;

            totalQuantity += quantity;
            totalPack += pack;
            totalSum += quantity * price;
        });

        $("#quantity_total").text(formatNumber(totalQuantity.toFixed(2)));
        $("#pack_total").text(formatNumber(totalPack.toFixed(2)));
        document.getElementById("all_total").innerHTML = formatNumberCustom(totalSum);
        $("#all_total_2").val(formatNumberCustom(totalSum));
        changeDiscount();
        calculateRemaining();
    }

     function calculateRemaining() {
         const total = parseFloat($("#all_total_2").val().replace(/,/g, "")) || 0;
         const naqd_summa = parseFloat($("#naqd_summa").val()) || 0;
         const remaining = Math.max(total - naqd_summa, 0);
         $("#nasiya_summa").val(formatNumber(remaining.toFixed(2)));
     }
    calculateRemaining()
    // function validatePayments() {
    //     const totalJami = parseFloat(document.getElementById('all_total_2').value) || 0;
    //     // const totalPaid = Object.values(paymentSystem.paymentMethods).reduce((sum, amount) => sum + amount, 0);
    //     const dollarKurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;

    //     const totalPaid = Object.entries(paymentSystem.paymentMethods).reduce((sum, [methodName, amount]) => {
    //         console.log(methodName.toLowerCase(), amount, 'oooooo')
    //         if (methodName.toLowerCase().includes("dollar")) {
    //             return sum + (amount * dollarKurs); // Dollar bo‚Äòlsa kursga ko‚Äòpaytiramiz
    //         }
    //         return sum + amount; // Oddiy so‚Äòm bo‚Äòlsa o‚Äòzini qo‚Äòshamiz
    //     }, 0);
    //     console.log(dollarKurs, 'pppp')
    //     console.log(totalPaid, 'oooooo')

    //     const remaining = totalJami - totalPaid;
    //     const product_name = document.querySelectorAll('.product_name').length
        
    //     if (product_name == 0) {
    //         showAlert(`Maxsulot mavjud emas`, "warning");
    //         return false
    //     }   
    //     console.log(remaining, 'aaa')

    //     if (remaining > 1) { 
    //         return false;
    //     }
    //     return true;
    // }

    function validatePayments() {
        const totalJami = parseFloat(document.getElementById('all_total_2').value) || 0;
        const dollarKurs = parseFloat(document.getElementById('dollar-kurs-base').value) || 1;

        let totalPaid = 0;

        for (const [methodName, amount] of Object.entries(paymentSystem.paymentMethods)) {
            const numAmount = parseFloat(amount) || 0;

            if (methodName.toLowerCase().includes("dollar")) {
                totalPaid += parseFloat(numAmount); // dollarni kursga ko‚Äòpaytirib qo‚Äòshamiz
            } else {
                totalPaid += parseFloat(numAmount); // so‚Äòmni o‚Äòzini qo‚Äòshamiz
            }
        }


        // Floating point xatoni oldini olish uchun yaxlitlab olamiz
        // const fixedTotalPaid = Math.round(totalPaid * 100) / 100; 
        const remaining = Math.round((totalJami - totalPaid));


        const product_name = document.querySelectorAll('.product_name').length;
        if (product_name === 0) {
            showAlert(`Maxsulot mavjud emas`, "warning");
            return false;
        }

        if (remaining > 1) {
            return false;
        }
        return true;
    }



    // function Yakunlash() {
    //     if (!validatePayments()) {
    //         return;
    //     }
        
    //     const orderId = $("#order_id").val();  
    //     $.ajax({
    //         url: `/b2c_shop_finish/${orderId}`,
    //         type: "POST",
    //         success: function(response) {
    //             if (response.success) {
    //                 showAlert(response.message, "success");
    //                 $('#check_div').print()
    //             } else {
    //                 showAlert(response.message, "danger");
    //             }
    //         },

    //         error: function() {
    //             showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
    //         }
    //     });
    // }

    function Yakunlash() {
        // paymentSystem.updateTolash(input);
        if (!validatePayments()) {
            return;
        }

        const orderId = $("#order_id").val();  
        $.ajax({
            url: `/b2c_shop_finish/${orderId}`,
            type: "POST",
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, "success");
                    $("#successModal").modal("show");
                } else {
                    showAlert(response.message, "danger");
                }
            },
            error: function() {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    }


    function productExistsInCart(productId) {
        let exists = false;
        $("tbody tr").each(function() {
            const name = $(this).find('td:eq(1)').text().trim();
            if (name.includes(productId)) {
                exists = true;
                return false; // break loop
            }
        });
        return exists;
    }

    // Add product directly to table when selected
    $('#products').on('change', function() {
        const itemValue = $(this).val();
        if (!itemValue) return;
        
        const [pr_id, pr_name, quantity, barcode, pack, price] = itemValue.split('&');
        const price_type = $('input[name="type_price"]:checked').val();
        const valyuta = $('#valyuta_input').val()
        if (pr_id) {
            // Check if product already exists in cart
            const existingRow = $(`#row_${pr_id}`).first();
            if (existingRow.length > 0) {
                // Product exists - increment quantity
                const currentQty = parseFloat(existingRow.find('.quantity-input').val()) || 0;
                
                const newQty = currentQty + 1;
                existingRow.find('.quantity-input').val(newQty);
                updateCartItem(existingRow, add=true, quantity_add=1);
                updatePackFromQuantity(existingRow.find('.quantity-input'));

                $('#productSearchInput').off('change').off('input');

                // 2. qiymatni o'zgartirish
                $('#productSearchInput').val('');
                $('#productSearchInput').on('change').on('input');


                // const existingRow = $(`tr:contains('${pr_name}')`).first();
            } else {
            $.get("{% url 'check_price' %}", { product: pr_id, type: price_type, valyuta: valyuta }, function(data) {
                const price = parseFloat(data['price']) || 0;
                addProductToTable(pr_id, pr_name, pack, price, 1);

                // updateCartItem(existingRow, add=true, quantity_add=1);
            });
            
            $('#productSearchInput').off('change').off('input');

            // 2. qiymatni o'zgartirish
            $('#productSearchInput').val('');
            $('#productSearchInput').on('change').on('input');

            }
        }
        
      
    });

    function addProductToTable(productId, productName, pack, price, quantity = 1) {
        const orderId = $("#order_id").val();
        const totalPack = quantity / parseFloat(pack);
        
        $.get("{% url 'check_product_quantity' %}", { product_id: productId }, function(qtyData) {
            const availableQty = parseFloat(qtyData.quantity) || 0;
            if (availableQty < quantity) {
                showAlert(`Qolqiq yetarli emas! ${availableQty} ta bor omborda.`, "danger");
                return;
            }

            $.ajax({
                url: `/b2c_shop_cart_add/${orderId}`,
                type: "POST",
                data: {
                    product_id: productId,
                    quantity: quantity,
                    total_pack: totalPack,
                    product_price: price,
                    agreed_price: price,
                },
                success: function(response) {
                    if (response.success) {
                        const newRow = `
                            <tr data-id="${response.cart_id}" id="row_${response.product_id}">
                                <td>${$("tbody tr").length + 1}</td>
                                <td class="product_name">${productName}</td>
                                <td>${pack}</td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control pack-input" 
                                               value="${totalPack.toFixed(2)}" min="0" step="0.01"
                                               data-pack="${parseInt(pack) || 1}"
                                               onkeyup="updateQuantityFromPack(this)" style="width: 6rem;">
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control quantity-input" 
                                               value="${quantity.toFixed(2)}" min="0" step="0.01"
                                               onkeyup="updatePackFromQuantity(this)" style="width: 6rem;">
                                    </div>
                                </td>
                                <td>${formatNumber(price.toFixed(2))}</td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control price-input" 
                                               value="${price.toFixed(2)}" min="0" step="0.01"
                                               onchange="updatePrice(this)">
                                    </div>
                                </td>
                                <td class="total" data-value="${(quantity * price).toFixed(2)}">${formatNumber((quantity * price).toFixed(2))}</td>
                                <td><button type="button" class="btn btn-danger product-delete"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>`;
                        
                        $("tbody").prepend(newRow);
                        updateTotals();
                        updateReceiptProducts();
                        if (fullscreenPayment.style.display === 'block') {
                            updateReceiptProducts()
                            paymentSystem.init();
                        }

                        const addedRow = $("tbody tr").last();
                        const quantityInput = addedRow.find('.quantity-input')[0];
                        updatePackFromQuantity(quantityInput);
                       
                        toggleValyutaDisabled();
                    } else {
                        showAlert(response.message, "danger");
                    }
                },
                error: function() {
                    showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
                }
            });
        });
    }

    $('#newProductForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const quantity = parseFloat(form.find('[name="quantity"]').val()) || 1;
        
        $.ajax({
            url: "{% url 'new_product_add' %}",
            type: "POST",
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#new_product_add').modal('hide');
                    form[0].reset();
                    
                    $.get("{% url 'check_price' %}", { 
                        product: response.product_id, 
                        type: $('input[name="type_price"]:checked').val(),
                        valyuta: $('#valyuta_input').val()
                    }, function(data) {
                        const price = parseFloat(data['price']) || 0;
                        addProductToTable(
                            response.product_id, 
                            response.product_name, 
                            response.pack, 
                            price,
                            quantity
                        );
                    });
                } else {
                    showAlert(response.message, "danger");
                }
            },
            error: function() {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    });

    $(document).on("click", ".product-delete", function() {
        const tr_item = $(this).closest("tr");
        const cart_id = tr_item.data("id");
        
        $.ajax({
            url: `/b2c_shop_cart_del/${cart_id}`,
            type: "POST",
            success: function(response) {
                if (response.success) {
                    tr_item.remove();
                    updateTotals();
                    if (fullscreenPayment.style.display === 'block') {
                        paymentSystem.init();
                    }
                    toggleValyutaDisabled();

                } else {
                    showAlert(response.message, "danger");
                }
            },
            error: function() {
                showAlert("Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.", "danger");
            }
        });
    });

     $("#naqd_summa").on("input change", function() {
         calculateRemaining();
     });

    async function fetchReceipt() {
        try {
            const response = await fetch('/create_check/' + "{{ shop.id }}");
            const data = await response.json();
            generateReceipt(data);
        } catch (error) {
            console.error("Xatolik:", error);
        }
    }

    function generateReceipt(data) {
        const receiptWindow = window.open('', '', 'width=800,height=1000');
        receiptWindow.document.write(`
            <html>
            <head>
                <style>
                    @media print {
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20mm;
                            width: 210mm;
                            height: 297mm;
                        }
                        .receipt {
                            width: 100%;
                            max-width: 190mm;
                            font-size: 14pt;
                            margin: auto;
                        }
                        .header {
                            font-size: 22pt;
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 10mm;
                        }
                        .line {
                            border-top: 2px solid black;
                            margin: 5mm 0;
                        }
                        .item {
                            display: flex;
                            justify-content: space-between;
                            font-size: 14pt;
                        }
                        .bold {
                            font-weight: bold;
                            font-size: 16pt;
                        }
                    }
                    
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 20mm;
                        width: 210mm;
                        height: 297mm;
                    }
                    .receipt {
                        width: 100%;
                        max-width: 190mm;
                        font-size: 14pt;
                        margin: auto;
                    }
                    .header {
                        font-size: 22pt;
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 10mm;
                    }
                    .line {
                        border-top: 2px solid black;
                        margin: 5mm 0;
                    }
                    .item {
                        display: flex;
                        justify-content: space-between;
                        font-size: 14pt;
                    }
                    .bold {
                        font-weight: bold;
                        font-size: 16pt;
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">üõí Eco Maruf jamoasi</div>
                    <div class="bold">Chek: ${data.chek}</div>
                    <div>Sotuvchi: ${data.seller}</div>
                    <div>Sana: ${data.date}</div>
                    <div class="line"></div>
        `);

        let totalAmount = 0;

        data.items.forEach((item, index) => {
            totalAmount += item.total;
            receiptWindow.document.write(`
                <div class="item">
                    <span>${index + 1}. ${item.name}</span>
                    <span>${item.quantity} x ${item.price} = ${item.total.toLocaleString('en-US')}</span>
                </div>
            `);
        });

        receiptWindow.document.write(`
                <div class="line"></div>
                <div class="bold">Jami summa: ${totalAmount.toLocaleString('en-US')} ${data.valyuta} </div>
                <div class="line"></div>
                <div style="font-size: 14pt; text-align: center;">Biz bilan hamkorlik qilayotganingizdan xursandmiz!</div>
                <div style="font-size: 14pt; text-align: center;">üìû +998901254042</div>
                <div style="font-size: 14pt; text-align: center;">üìû +998901252647</div>
                <div style="font-size: 14pt; text-align: center;">üìû +998910197071</div>
                <div class="line"></div>
            </div>
            </body>
            </html>
        `);

        receiptWindow.document.close();
        receiptWindow.print();
    }

    $(document).ready(function() {
            updateReceiptProducts();

        $('#zero-config').DataTable({
            dom: '<"row"<"col-md-12"<"row"<"col-md-6"B><"col-md-6"f> > ><"col-md-12"rt> <"col-md-12"<"row"<"col-md-5"i><"col-md-7"p>>> >',
            buttons: {
                buttons: [
                    { extend: 'copy', className: 'btn' },
                    { extend: 'csv', className: 'btn' },
                    { extend: 'excel', className: 'btn' },
                    { extend: 'print', className: 'btn' }
                ]
            },
            "oLanguage": {
                "oPaginate": { 
                    "sPrevious": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>', 
                    "sNext": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>' 
                },
                "sInfo": " _PAGE_ / _PAGES_",
                "sSearch": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',
                "sSearchPlaceholder": "Izlash",
                "sLengthMenu": "Natijalar:  _MENU_",
            },
            "stripeClasses": [],
            "lengthMenu": [10, 20, 50, 100],
            "pageLength": 15
        });
    });
</script>



    <script>
    
    const qarz_shop_debtor = document.getElementById('modalSelectDebtor')

    $(document).ready(function () {
        function handleFormSubmit(formId, url, selectId, modalId) {
            $(formId).submit(function (e) {
                e.preventDefault();
                const formDatas = $(this).serialize();
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formDatas + '&csrfmiddlewaretoken={{ csrf_token }}',
                    success: function (data) {
                        // $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                        if ($(selectId)[0].selectize) {
                            // Agar Selectize bo'lsa
                            let selectize = $(selectId)[0].selectize;
                            selectize.addOption({ value: data.id, text: data.name });
                            selectize.addItem(data.id, true);
                            $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                        } else {
                            // Oddiy select bo'lsa
                            $(selectId).append(`<option value="${data.id}" selected>${data.name}</option>`);
                        }

                        $(selectId).trigger("change");


                        // $(modalId).modal('hide');
                        if (modalId === "#debtorModal" && document.querySelector("#debtor_add_close")) {
                            document.querySelector("#debtor_add_close").click();
                        } else {
                            $(modalId).modal('hide');
                        }

                        $(formId)[0].reset();
                        if (data.fio) {
                            // qarz_shop_debtor.options[qarz_shop_debtor.selectedIndex].text = data.fio;
                            $('#modalSelectDebtor').append(`<option value="${data.id}" selected>${data.name}</option>`);
                            changeInfo(data.id);

                        }
                    },
                    error: function () {
                        alert("Xatolik yuz berdi!");
                    }
                });
            });
        }

        handleFormSubmit('#deliverForm', '{% url "create_deliver_new" %}', '#deliverSelect', '#deliverModal');
        handleFormSubmit('#measurementForm', '{% url "create_measurement" %}', '#measurementSelect', '#measurementModal');
        handleFormSubmit('#groupForm', '{% url "create_group" %}', '#groupSelect', '#groupModal');
        handleFormSubmit('#debtorTypeForm', '{% url "create_debtor_type" %}', '#recipient-debtor_type', '#debtorTypeModal');
        handleFormSubmit('#teritoryForm', '{% url "create_teritory" %}', '#recipient-teritory', '#teritoryModal');
        handleFormSubmit('#priceTypeForm', '{% url "create_price_type" %}', '#recipient-price_type', '#priceTypeModal');
        handleFormSubmit('#regionForm', '{% url "create_region" %}', '#regionSelect', '#regionModal');
        handleFormSubmit('#debtorForm', '{% url "create_debtor" %}', '#mainSelectDebtor', '#debtorModal');

    });
    $(document).ready(function () {
    $('#mainSelectDebtor, #modalSelectDebtor').on('change', function() {
        const selectedValue = $(this).val();
        const selectedText = $(this).find('option:selected').text();
        
        $('#mainSelectDebtor, #modalSelectDebtor').val(selectedValue);
        
        $.ajax({
            url: "{% url 'edit_shop_ajax' shop.id %}",
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                'debtor': selectedValue
            },
            success: function () {
                changeInfo(selectedValue);
            },
            error: function () {
                console.error("Xatolik yuz berdi");
            }
        });
    });

    // Qolgan funksiyalar...
});
    $('#selectFilial').on('change', function() {
        const select_debtor_value = $('#selectFilial').val();

        $.ajax({
            url: "{% url 'edit_shop_ajax' shop.id %}",
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                'filial': select_debtor_value
            },
            success: function () {
            },
            error: function () {
            }
        });
    });
    function changeInfo(debtor_id) {
        console.log(111133222)
        const customer_info = document.getElementById('customer_info');
        customer_info.innerHTML = ''; 
        $.ajax({
            url: `/ajax_customer_info/${debtor_id}`,
            type: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                const data = response.data;
                let html = '';

                data.valyuta.forEach(i => {
                    html += `
                        <div class="col-4">
                            <label>Faol qarz (${i.name})</label>
                            <h6>${Number(i.summa).toLocaleString()}</h6>
                        </div>
                    `;
                });

                if (data.last_pay) {
                    html += `
                        <div class="col-3">
                            <label>Oxirgi to'lov</label>
                            <h6>${data.last_pay}</h6>
                        </div>
                    `;
                }

                customer_info.innerHTML = html;
            },
            error: function () {
                customer_info.innerHTML = '<div class="col-12">Xatolik yuz berdi</div>';
            }
        });
    }

</script>



<script>
    function filterTgID(input) {
        const tg_id = input.value;
        $.ajax({
            url: "{% url 'tg_id_filter' %}",
            type: "POST",
            data: { 'tg_id': tg_id },
            success: function(response) {
                if (response.data === true) {
                    showAlert("Bu Telegram ID allaqachon mavjud!", "danger");
                    $(input).addClass('is-invalid');
                } else {
                    $(input).removeClass('is-invalid');
                }
            },
            error: function () {
                showAlert("Serverda xatolik yuz berdi", "danger");
            }
        });
    }

    document.querySelectorAll('.plus_button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();

            const toggleInput = this.querySelector('.toggle-input');
            if (toggleInput) {
                toggleInput.dispatchEvent(new Event("click", { bubbles: true }));
            }
        });
    });

</script>


<script>
    let decimalPlaces = parseInt("{{ round_settings.decimal_places }}") || 2;
    let roundingDirection = parseInt("{{ round_settings.rounding_direction }}") || 2;

    // Number prototype ga qo‚Äòshamiz
    Number.prototype.roundNumber = function() {
        const factor = Math.pow(10, decimalPlaces);

        if (roundingDirection === 1) { // Tepaga
            return Math.ceil(this * factor) / factor;
        } else if (roundingDirection === 3) { // Pastga
            return Math.floor(this * factor) / factor;
        } else { // Standart
            return Math.round(this * factor) / factor;
        }
    };

</script>


{% endblock js %}