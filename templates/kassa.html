{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block css %}
<!-- BEGIN PAGE LEVEL STYLES -->
<link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/datatables.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/dt-global_style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'plugins/table/datatable/custom_dt_multiple_tables.css' %}">
<link href="{% static 'assets/css/components/custom-countdown.css' %}" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />

<style>
    .badge-kirim { background-color: #28a745; color: white; }
    .badge-chiqim { background-color: #dc3545; color: white; }
    .transaction-type-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    #chart-container {
        width: 300px;
        margin: auto;
    }
    .kassa-card {
        transition: transform 0.2s;
    }
    .kassa-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    .alert-fixed {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    }
</style>
{% endblock css %}

{% block content %}
<script src="{% static 'multiselect.js' %}"></script>

<div id="content" class="main-content">
    <div class="layout-px-spacing">
        <div class="row layout-top-spacing">

            <!-- Kassa Summary Cards -->
            <div class="col-xl-12 col-lg-12 col-sm-12 layout-spacing">
                <div class="widget-content widget-content-area br-6">
                    <div class="row" id="kassa-cards-container">    
                        <!-- {% for i in data %}
                        <div class="col-xl-3 col-md-3 mb-4 text-center">
                            <div class="card border-left-primary shadow h-100 py-2 kassa-card">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{{ i.name }}</div>
                                            {% for x in i.valyuta %}
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ x.name }} {{x.summa|intcomma}}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-auto">
                                            <img src="{% static 'assets/img/dollar.svg' %}" width="30px" alt="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %} -->
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <form class='col-12' style="margin: 1rem 2rem 1rem 1rem;" id="filterForm">
                <div class="row">
                    <div class="col-md-3">
                        <label>Boshlangich sana</label>
                        <input name="start_date" class="form-control" type="date" value="{{filters.start_date}}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Yakuniy sana</label>
                        <input name="end_date" class="form-control" type="date" value="{{filters.end_date}}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Taminotchi</label>
                        <select multiple multiselect-select-all="true" multiselect-max-items="0" multiselect-search="true" name="deliver" class="form-control">
                            {% for d in delivers %}
                                <option {% if d.id in filters.deliver %}selected{% endif %} value="{{d.id}}">{{d.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Mijoz</label>
                        <select multiple multiselect-select-all="true" multiselect-max-items="0" multiselect-search="true" name="debtor" class="form-control">
                            {% for d in debtors %}
                                <option {% if d.id in filters.debtor %}selected{% endif %} value="{{d.id}}">{{d.fio}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Kategoriya</label>
                        <select multiple multiselect-select-all="true" multiselect-max-items="0" multiselect-search="true" name="category" class="form-control">
                            {% for d in categories %}
                                <option {% if d.id in filters.category %}selected{% endif %} value="{{d.id}}">{{d.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Podkategoriya</label>
                        <select multiple multiselect-select-all="true" multiselect-max-items="0" multiselect-search="true" name="subcategory" class="form-control">
                            {% for d in subcategories %}
                                <option {% if d.id in filters.subcategory %}selected{% endif %} value="{{d.id}}">{{d.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button style="margin-top: 1.8rem;" type="submit" class="btn btn-primary form-control" id="filterButton">Filterlash</button>
                    </div>
                </div>
            </form>

            <!-- Combined Transactions Table -->
            <div class="col-xl-12 col-lg-12 col-sm-12 layout-spacing">
                <div class="widget-content widget-content-area br-6">
                    <div class="row">
                        <div class="col-6">
                            <h4>Pul o'tkazmalari tarixi</h4>
                        </div>
                        <div class="col-6 text-right">
                            <!-- <button class="btn btn-success mr-2" data-toggle="modal" data-target="#KirimModal">Kirim qilish</button> -->
                            <button class="btn btn-danger ml-5" data-toggle="modal" data-target="#ChiqimModal">Chiqim qilish</button>
                            <button class="btn btn-info" onclick="openConvertModal()">
                                <i class="fa fa-exchange"></i> Konvertatsiya
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive mb-4 mt-4">
                        <table class="multi-table table table-nowrap" style="width:100%" id="transactionsTable">
                            <thead id="transactionsTableHead">
                                <tr>
                                    <th style="text-align: left;">#</th>
                                    <th style="text-align: left;">Turi</th>
                                    <th style="text-align: left;">Kassa</th>
                                    <th style="text-align: left;">Valyuta</th>
                                    <th style="text-align: left;">Pul Muomalasi</th>
                                    <th style="text-align: left;">Qaysi oy uchun</th>
                                    {% for v in valutas %}
                                        <th style="text-align: left;">{{ v.name }}</th>
                                    {% endfor %}
                                    <th style="text-align: left;">Hamkor</th>
                                    <th style="text-align: left;">Izox</th>
                                    <th style="text-align: left;">Sana</th>
                                    <th style="text-align: left;">Harakatlar</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                
                            </tbody>
                            <tfoot id="transactionsTableFooter">
                                <!-- <tr>
                                    <th style="text-align: left;" colspan="6">Jami kirim:</th>
                                    {% for q in kirim_totals %}
                                        <th style="text-align: left;" class="text-success">{{ q.summa|default_if_none:'0'|intcomma }}</th>
                                    {% endfor %}
                                    <th style="text-align: left;" colspan="4"></th>
                                </tr>
                                <tr>
                                    <th style="text-align: left;" colspan="6">Jami chiqim:</th>
                                    {% for q in chiqim_totals %}
                                        <th style="text-align: left;" class="text-danger">{{ q.summa|default_if_none:'0'|intcomma }}</th>
                                    {% endfor %}
                                    <th style="text-align: left;" colspan="4"></th>
                                </tr> -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Edit Modal -->
<div class="modal fade" id="EditTransactionModal" tabindex="-1" role="dialog" aria-labelledby="EditTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="editTransactionForm" method="POST">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="EditTransactionModalLabel">Transaksiyani tahrirlash</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="transaction_id" id="editTransactionId">
                    <input type="hidden" name="transaction_type" id="editTransactionType">
                    
                    <div class="form-group">
                        <label for="editSumma">Summa</label>
                        <input class="form-control make_intcomma" type="text" id="editSumma" name="summa" placeholder="Summa" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editKurs">Kurs</label>
                        <input class="form-control make_intcomma" type="text" id="editKurs" name="kurs" placeholder="Kurs" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editIzox">Izox</label>
                        <textarea name="izox" id="editIzox" class="form-control" cols="30" rows="5" placeholder="Izox"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                    <button type="submit" class="btn btn-primary" id="editTransactionSubmit">Saqlash</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Kirim Modal -->
<div class="modal fade" id="KirimModal" tabindex="-1" role="dialog" aria-labelledby="KirimModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="kirimForm" method="POST">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="KirimModalLabel">Kirim qilish</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="kirimValuta">Valyuta</label>
                        <select name="valuta" id="kirimValuta" class="form-control" required>
                            <option value="">- - - - - - - </option>
                            {% for v in valuta %}
                                <option value="{{ v.id }}">{{ v.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="kirimKassa">Kassa</label>
                        <select name="kassa" id="kirimKassa" class="form-control" required>
                            <option value="">- - - - - - - </option>
                            {% for k in cashes %}
                                <option value="{{ k.id }}">{{ k.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="kirimSumma">Summa</label>
                        <input class="form-control make_intcomma" type="text" name="summa" placeholder="Summa" required>
                    </div>

                    <div class="form-group">
                        <label for="kirimKurs">Kurs</label>
                        <input class="form-control make_intcomma" type="text" name="kurs" value="{{dollar_kurs|intcomma}}" placeholder="Kurs" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kirimIzox">Izox</label>
                        <textarea name="izox" class="form-control" rows="3" placeholder="Izox"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                    <button type="submit" class="btn btn-primary" id="kirimSubmit">Saqlash</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Chiqim Modal -->
<div class="modal fade" id="ChiqimModal" tabindex="-1" role="dialog" aria-labelledby="ChiqimModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="chiqimForm" method="POST">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ChiqimModalLabel">Chiqim qilish</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="chiqimValuta">Valyuta</label>
                        <select name="valuta" id="chiqimValuta" class="form-control" required>
                            <option value="">- - - - - - - </option>
                            {% for v in valuta %}
                                <option value="{{ v.id }}">{{ v.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="chiqimKassa">Kassa</label>
                        <select name="kassa" id="chiqimKassa" class="form-control" required>
                            <option value="">- - - - - - - </option>
                            {% for k in cashes %}
                                <option value="{{ k.id }}">{{ k.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="chiqimMoneyCirculation">Pul Muomalasi</label>
                        <select name="money_circulation" id="chiqimMoneyCirculation" class="form-control">
                            <option value="">- - - - - - - </option>
                            {% for k in money_circulation %}
                                <option value="{{ k.id }}">{{ k.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-form-label">Qaysi Oy uchun:</label>
                                <select class="form-control" name="qaysi_oy"> 
                                    <option value="1">Yanvar</option>
                                    <option value="2">Fevral</option>
                                    <option value="3">Mart</option>
                                    <option value="4">Aprel</option>
                                    <option value="5">May</option>
                                    <option value="6">Iyun</option>
                                    <option value="7">Iyul</option>
                                    <option value="8">Avgust</option>
                                    <option value="9">Sentyabr</option>
                                    <option value="10">Oktyabr</option>
                                    <option value="11">Noyabr</option>
                                    <option value="12">Dekabr</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-form-label">Qaysi Yil uchun:</label>
                                <input type="number" name="qaysi_yil" class="form-control" value="{{bugun_year}}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="chiqimSumma">Summa</label>
                        <input class="form-control make_intcomma" type="text" name="summa" placeholder="Summa" required>
                    </div>

                    <div class="form-group">
                        <label for="chiqimKurs">Kurs</label>
                        <input class="form-control make_intcomma" type="text" name="kurs" value="{{dollar_kurs|intcomma}}" placeholder="Kurs" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="chiqimIzox">Izox</label>
                        <textarea name="izox" class="form-control" rows="3" placeholder="Izox"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Yopish</button>
                    <button type="submit" class="btn btn-primary" id="chiqimSubmit">Saqlash</button>
                </div>
            </div>
        </form>
    </div>
</div>



<!-- Konvertatsiya modal oynasi -->
<div class="modal fade" id="convertModal">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #fff;">
            <div class="modal-header">
                <h5 class="modal-title" id="convertModalTitle">Valuta konvertatsiyasi</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="convertForm">
                    <input type="hidden" id="convertId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Qaysi kassadan</label>
                                <select class="form-control selectize" id="fromKassa" required>
                                    <option value="">Tanlang</option>
                                    {% for cash in cashes %}
                                    <option value="{{ cash.id }}">{{ cash.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Qaysi valyutadan</label>
                                <select class="form-control selectize" id="fromValuta" required>
                                    <option value="">Tanlang</option>
                                    {% for valuta in valutas %}
                                    <option value="{{ valuta.id }}" data-sum_or_dollar="{% if valuta.is_som %}1{% elif valuta.is_dollar %}2{% endif %}">{{ valuta.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Qaysi kassaga</label>
                                <select class="form-control selectize" id="toKassa" required>
                                    <option value="">Tanlang</option>
                                    {% for cash in cashes %}
                                    <option value="{{ cash.id }}">{{ cash.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Qaysi valyutaga</label>
                                <select class="form-control selectize" id="toValuta" required>
                                    <option value="">Tanlang</option>
                                    {% for valuta in valutas %}
                                    <option value="{{ valuta.id }}" data-sum_or_dollar="{% if valuta.is_som %}1{% elif valuta.is_dollar %}2{% endif %}">{{ valuta.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Summa</label>
                        <input type="text" class="form-control make_intcomma" id="convertAmount" 
                            onkeyup="formatNumber(this)" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Kurs</label>
                        <input type="text" class="form-control make_intcomma" id="convertRate" 
                            onkeyup="formatNumber(this)" value="{{dollar_kurs|intcomma}}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Konvert qilingan summa</label>
                        <input type="text" class="form-control" id="convertedAmount" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Izoh</label>
                        <textarea class="form-control" id="convertComment" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="submitConvert()" id="submitConvertBtn">Konvertatsiya</button>
            </div>
        </div>
    </div>
</div>


<!-- Success Message Container -->
<div id="messageContainer" class="alert-fixed"></div>

{% endblock content %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js" integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>





<script>
    // Konvertatsiya funksiyalari
    function openConvertModal(convertId = null) {
        editingConvertId = convertId;
        const modal = $('#convertModal');
        
        if (convertId) {
            // Tahrirlash rejimi
            $('#convertModalTitle').text('Konvertatsiyani tahrirlash');
            $('#submitConvertBtn').text('Yangilash');
            loadConvertData(convertId);
        } else {
            // Yangi qo'shish rejimi
            $('#convertModalTitle').text('Valuta konvertatsiyasi');
            $('#submitConvertBtn').text('Konvertatsiya');
            resetConvertForm();
        }
        
        modal.modal('show');
    }

    function resetConvertForm() {
        $('#convertForm')[0].reset();
        $('#convertId').val('');
        editingConvertId = null;
        
        // Selectizelarni tozalash
        $('#fromKassa')[0].selectize.clear();
        $('#toKassa')[0].selectize.clear();
        $('#fromValuta')[0].selectize.clear();
        $('#toValuta')[0].selectize.clear();
    }

    function loadConvertData(convertId) {
        fetch(`/kassa/convert/${convertId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const convert = data.convert;
                    
                    $('#convertId').val(convertId);
                    $('#fromKassa')[0].selectize.setValue(convert.from_cash.cash.id);
                    $('#toKassa')[0].selectize.setValue(convert.to_cash.cash.id);
                    $('#fromValuta')[0].selectize.setValue(convert.from_valyuta_id);
                    $('#toValuta')[0].selectize.setValue(convert.to_valyuta_id);
                    $('#convertAmount').val(formatNumber(parseFloat(convert.som)));
                    $('#convertRate').val(formatNumber(parseFloat(convert.currency)));
                    $('#convertedAmount').val(formatNumber(parseFloat(convert.som2)));
                    $('#convertComment').val(convert.comment || '');
                    
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading conversion data:', error);
                showMessage('Ma\'lumotlarni yuklashda xatolik', 'error');
            });
    }

    function submitConvert() {
        const amount = cleanNumber($('#convertAmount').val());
        const amount2 = cleanNumber($('#convertedAmount').val());
        const rate = cleanNumber($('#convertRate').val());
        
        //if (!amount || parseFloat(amount) <= 0 || !rate || parseFloat(rate) <= 0) {
        //   showMessage('Summa va kurs noto\'g\'ri kiritilgan', 'error');
        //    return;
        //}

        const formData = {
            from_kassa_id: $('#fromKassa').val(),
            to_kassa_id: $('#toKassa').val(),
            from_valyuta_id: $('#fromValuta').val(),
            to_valyuta_id: $('#toValuta').val(),
            amount: amount,
            converted_amount: amount2,
            currency_rate: rate,
            comment: $('#convertComment').val()
        };
        
        // Agar tahrirlash bo'lsa, ID ni qo'shamiz
        if (editingConvertId) {
            formData.convert_id = editingConvertId;
        }
        
        // Majburiy maydonlarni tekshirish
        if (!formData.from_kassa_id || !formData.to_kassa_id || !formData.from_valyuta_id || !formData.to_valyuta_id) {
            showMessage('Barcha maydonlarni to\'ldiring', 'error');
            return;
        }
        
        const url = editingConvertId ? '/kassa/update-convert/' : '/kassa/convert-currency/';
        const method = editingConvertId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                $('#convertModal').modal('hide');
                loadKassaCards()
                reload_table();
                editingConvertId = null;
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Xatolik yuz berdi', 'error');
            console.error('Error:', error);
        });
    }

    // Konvertatsiyani tahrirlash
    function editConversion(convertId) {
        openConvertModal(convertId);
    }

    // Konvertatsiyani o'chirish
    function deleteConversion(convertId) {
        if (confirm('Haqiqatdan ham bu konvertatsiyani o\'chirmoqchimisiz?')) {
            fetch(`/kassa/convert/${convertId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // loadPaymentHistory();
                    // loadKassaStats();
                    loadKassaCards()
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Xatolik yuz berdi', 'error');
                console.error('Error:', error);
            });
        }
    }

    // Konvertatsiya hisoblash
    function calculateConversion() {
        const fromValutaSelect = $('#fromValuta')[0].selectize;
        const toValutaSelect = $('#toValuta')[0].selectize;

        const fromValuta = fromValutaSelect.getValue();
        const toValuta = toValutaSelect.getValue();

        if (!fromValuta || !toValuta) {
            $('#convertedAmount').val('');
            return;
        }

        const fromValutaType = fromValutaSelect.options[fromValuta]?.sum_or_dollar;
        const toValutaType = toValutaSelect.options[toValuta]?.sum_or_dollar;


        const amount = parseFloat(cleanNumber($('#convertAmount').val())) || 0;
        const rate = parseFloat(cleanNumber($('#convertRate').val())) || 0;
        
        let converted = 0;
        
        if (fromValutaType == 1 && toValutaType == 2) {
            converted = amount / rate;
        } else if (fromValutaType == 2 && toValutaType == 1) {
            converted = amount * rate;
        } else {
            converted = amount;
        }
        
        if (!isNaN(converted)) {
            $('#convertedAmount').val(formatNumber(converted));
        }
    }

    // Event listenerlar
    $(document).ready(function() {
        // Selectize instance larini kutish
        setTimeout(function() {
            const fromValutaSelect = $('#fromValuta')[0].selectize;
            const toValutaSelect = $('#toValuta')[0].selectize;
            
            // Selectize o'zgarishlarini kuzatish
            fromValutaSelect.on('change', function() {
                calculateConversion();
            });
            
            toValutaSelect.on('change', function() {
                calculateConversion();
            });
            
            // Input maydonlarida o'zgarish bo'lganda
            $('#convertAmount, #convertRate').on('input', function() {
                calculateConversion();
            });
            
        }, 100);
    });

</script>







<script>
    // // Formatlash funksiyalari
    // function formatNumber(num) {
    //     return new Intl.NumberFormat("ru-RU", {
    //         minimumFractionDigits: 0,
    //         maximumFractionDigits: 2
    //     }).format(num).replace(',', '.');
    // }

    // function cleanNumber(str) {
    //     return str.replace(/\s/g, '');
    // }

    // Xabar ko'rsatish funksiyasi
    function showMessage(message, type = 'success') {
        const messageContainer = document.getElementById('messageContainer');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        
        messageContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        // 5 soniyadan so'ng xabarni yashirish
        setTimeout(() => {
            const alert = messageContainer.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }

    // Loading holatini boshqarish
    function setLoading(element, isLoading) {
        if (isLoading) {
            element.classList.add('loading');
            element.disabled = true;
        } else {
            element.classList.remove('loading');
            element.disabled = false;
        }
    }

    // URL parametrlarini yangilash
    function updateURLParams(formData) {
        const params = new URLSearchParams();
        
        for (const [key, value] of formData.entries()) {
            if (value) {
                if (Array.isArray(value)) {
                    value.forEach(v => params.append(key, v));
                } else {
                    params.append(key, value);
                }
            }
        }
        
        const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.replaceState({}, '', newURL);
    }

    $(document).ready(function() {
        // DataTable ni ishga tushirish
        let dataTable = $('#transactionsTable').DataTable({
            dom: '<"row"<"col-md-12"<"row"<"col-md-6"B><"col-md-6"f> > ><"col-md-12"rt> <"col-md-12"<"row"<"col-md-5"i><"col-md-7"p>>> >',
            buttons: {
                buttons: [
                    { extend: 'copy', className: 'btn' },
                    { extend: 'csv', className: 'btn' },
                    { extend: 'excel', className: 'btn' },
                    { extend: 'print', className: 'btn' }
                ]
            },
            "oLanguage": {
                "oPaginate": { 
                    "sPrevious": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>', 
                    "sNext": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>' 
                },
                "sInfo": " _PAGE_ / _PAGES_",
                "sSearch": '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',
                "sSearchPlaceholder": "Izlash",
                "sLengthMenu": "Natijalar: _MENU_",
            },
            "stripeClasses": [],
            "lengthMenu": [10, 20, 50, 100],
            "paging": false,
            "scrollY": "500px",
            "scrollCollapse": true,
        });

        // Format inputlari
        // document.querySelectorAll('.make_intcomma').forEach(input => {
        //     input.addEventListener('keyup', function() {
        //         setTimeout(() => formatInput(this), 50);
        //     });
            
        //     input.addEventListener('blur', function() {
        //         formatInput(this);
        //     });
        // });
        
        // function formatInput(input) {
        //     let value = cleanNumber(input.value);
        //     if (value) {
        //         input.value = formatNumber(parseFloat(value));
        //     }
        // }

        // Filter form AJAX
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const filterButton = document.getElementById('filterButton');
            
            setLoading(filterButton, true);
            
            // AJAX so'rovi
            $.ajax({
                url: window.location.pathname,
                type: 'GET',
                data: $(this).serialize(),
                success: function(response) {
                    // Jadval ma'lumotlarini yangilash
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(response, 'text/html');
                    dataTable.destroy();
                    $('#transactionsTable').empty()
                    $('#transactionsTable').append(response)
        
                    
                    // DataTable ni yangilash
                    
                    dataTable = $('#transactionsTable').DataTable({
                        paging: false,           // sahifalashni o‘chirish
                        scrollX: true,        // vertikal scroll
                        scrollY: '500px',        // vertikal scroll
                        scrollCollapse: true,    // scroll bo‘sh joyga moslashadi
                        stripeClasses: [],       // striping klasslarni olib tashlash
                        lengthMenu: [10, 20, 50, 100], // page length variantlari
                        dom: 'Bfrtip',           // buttons + filter + table + info + pagination
                        buttons: [               // export tugmalari
                            'copy', 'csv', 'excel', 'print'
                        ],
                        language: {              // oddiy o‘zgartirilgan til
                            searchPlaceholder: "Izlash",
                            search: "",
                            info: "_PAGE_ / _PAGES_"
                        }
                    });

                    // URL ni yangilash
                    updateURLParams(formData);
                    
                    // showMessage('Filter muvaffaqiyatli qo\'llandi', 'success');
                },
                error: function() {
                    showMessage('Filterlashda xatolik yuz berdi', 'error');
                },
                complete: function() {
                    setLoading(filterButton, false);
                }
            });
        });

        // Kirim qo'shish AJAX
        $('#kirimForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);

            formData.set('summa', cleanNumber(formData.get('summa')));
            formData.set('kurs', cleanNumber(formData.get('kurs')));

            const submitButton = document.getElementById('kirimSubmit');
            
            setLoading(submitButton, true);
            
            $.ajax({
                url: "{% url 'kirim_qilish' %}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#KirimModal').modal('hide');
                        $('.modal-backdrop').remove();
                        document.getElementById('kirimForm').reset();
                        
                        // Sahifani yangilash
                        // location.reload();
                        loadKassaCards();
                        reload_table();
                    }
                    else {
                        showMessage('Kirim qilishda xatolik yuz berdi: ' + response.message, 'error');
                    }

                },
                error: function(xhr) {
                    showMessage('Kirim qilishda xatolik yuz berdi: ' + xhr.responseText, 'error');
                },
                complete: function() {
                    setLoading(submitButton, false);
                }
            });
        });

        // Chiqim qo'shish AJAX
        $('#chiqimForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);


            formData.set('summa', cleanNumber(formData.get('summa')));
            formData.set('kurs', cleanNumber(formData.get('kurs')));

            const submitButton = document.getElementById('chiqimSubmit');
            
            setLoading(submitButton, true);
            
            $.ajax({
                url: "{% url 'chiqim_qilsih' %}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#ChiqimModal').modal('hide');
                        $('.modal-backdrop').remove();
                        document.getElementById('chiqimForm').reset();

                        loadKassaCards();
                        reload_table()
                    }
                    else {
                        showMessage('Kirim qilishda xatolik yuz berdi: ' + response.message, 'error');
                    }
                },
                error: function(xhr) {
                    showMessage('Chiqim qilishda xatolik yuz berdi: ' + xhr.responseText, 'error');
                },
                complete: function() {
                    setLoading(submitButton, false);
                }
            });
        });

        // Tahrirlash modalini ochish
        $(document).on('click', '.edit-transaction', function() {
            const transactionId = $(this).data('id');
            const transactionType = $(this).data('type');
            const summa = $(this).data('summa');
            const kurs = $(this).data('kurs');
            const izox = $(this).data('izox');
            
            $('#editTransactionId').val(transactionId);
            $('#editTransactionType').val(transactionType);
            console.log(formatNumber(summa))
            $('#editSumma').val(formatNumber(summa))
            $('#editKurs').val(formatNumber(kurs))
            $('#editIzox').val(izox);
            
            // Form action ni sozlash
            if (transactionType === 'kirim') {
                $('#editTransactionForm').attr('action', "{% url 'kirim_qilish_edit' %}");
            } else {
                $('#editTransactionForm').attr('action', "{% url 'chiqim_qilish_edit' %}");
            }
            
            $('#EditTransactionModal').modal('show');
        });

        // Tahrirlash formasi AJAX
        $('#editTransactionForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);

            formData.set('summa', cleanNumber(formData.get('summa')));
            formData.set('kurs', cleanNumber(formData.get('kurs')));
            
            const submitButton = document.getElementById('editTransactionSubmit');
            
            setLoading(submitButton, true);
            
            // Summa va kurs qiymatlarini tozalash
            const summaInput = document.getElementById('editSumma');
            const kursInput = document.getElementById('editKurs');
            
            if (summaInput) {
                formData.set('summa', cleanNumber(summaInput.value));
            }
            if (kursInput) {
                formData.set('kurs', cleanNumber(kursInput.value));
            }
            
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#EditTransactionModal').modal('hide');
                        $('.modal-backdrop').remove();
                        
                        // Sahifani yangilash
                        // location.reload();

                        loadKassaCards();
                        reload_table();
                    }
                    else {
                        showMessage('Kirim qilishda xatolik yuz berdi: ' + response.message, 'error');
                    }
                },
                error: function(xhr) {
                    showMessage('Tahrirlashda xatolik yuz berdi: ' + xhr.responseText, 'error');
                },
                complete: function() {
                    setLoading(submitButton, false);
                }
            });
        });

        // Modal yopilganda formani tozalash
        $('.modal').on('hidden.bs.modal', function() {
            $(this).find('form').trigger('reset');
        });
    });
</script>



<script>
    // Kassa kartalarini yangilash funksiyasi
    function loadKassaCards() {
        console.log('rrrrr')
        $.ajax({
            url: "{% url 'get_kassas' %}",
            type: 'GET',
            data: {
                'request_type': 'kassas'
            },
            success: function(kassaData) {
                let kassaCardsHTML = '';

                // Faqat data ni olamiz
                kassaData.data.forEach(function(kassa) {

                    let valyutaHTML = '';

                    kassa.valyuta.forEach(function(val) {
                        let formattedSumma = formatNumber(val.summa);
                        valyutaHTML += `<div class="h5 mb-0 font-weight-bold text-gray-800">${val.name} ${formattedSumma}</div>`;
                    });

                    kassaCardsHTML += `
                        <div class="col-xl-4 col-md-6 mb-4 text-center">
                            <div class="card border-left-primary shadow h-100 py-2 kassa-card">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">${kassa.name}</div>
                                            ${valyutaHTML}
                                        </div>
                                        <div class="col-auto">
                                            <img src="/static/assets/img/dollar.svg" width="30px" alt="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                $('#kassa-cards-container').html(kassaCardsHTML);
            },

            error: function(xhr, status, error) {
                console.error('Kassa ma\'lumotlarini yuklashda xatolik:', error);
            }
        });
    }
    
    function reload_table() {
        $('#filterButton').trigger('click');
    }
    $(document).ready(function() {
        setTimeout(function() {
            loadKassaCards();
            reload_table();
        }, 700); // 1000 millisekund = 1 sekund
    });
</script>

<script>
    $('select.selectize').selectize({ normalize: true });
</script>

<script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock js %}