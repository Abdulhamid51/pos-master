{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    <title>Qabul - Yangi</title>
{% endblock %}

{% block css %}
    <style>
        .ajax-loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .quick-add-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .recieve-item {
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 3px solid transparent;
        }
        
        .recieve-item:hover {
            background-color: #f8f9fa;
        }
        
        .recieve-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .price-table th, .price-table td {
            padding: 8px;
            text-align: center;
        }
        
        .edit-form {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .auto-calc {
            background-color: #e8f5e8;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />

{% endblock %}

{% block content %}
<div id="content" class="main-content">
    <div class="layout-px-spacing">
        <div id="alert-container"></div>
        
        <!-- Yuklanish indikatori -->
        <div id="loading" class="ajax-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Yuklanmoqda...</span>
            </div>
        </div>

        <div class="row">
            <!-- Chap panel - Qabullar ro'yxati -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#createRecieveModal">
                            <i class="fas fa-plus"></i> Yangi Qabul
                        </button>
                        <button class="btn btn-info btn-sm ml-2" data-toggle="modal" data-target="#createDeliverModal">
                            <i class="fas fa-truck"></i> Yetkazib beruvchi
                        </button>
                        <button class="btn btn-warning btn-sm ml-2" data-toggle="modal" data-target="#createExpenseTypeModal">
                            <i class="fas fa-tag"></i> Chiqim turi
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="recieve-list">
                            {% for recieve in recieves %}
                            <div class="recieve-item p-3 border-bottom {% if active_one and active_one.id == recieve.id %}active{% endif %}" 
                                 onclick="selectRecieve({{ recieve.id }})" 
                                 data-recieve-id="{{ recieve.id }}"
                                 id="recieve-{{ recieve.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 font-weight-bold">Partiya: {{ recieve.name }}</h6>
                                        <p class="mb-1 text-muted small">Yetkazib beruvchi: {{ recieve.deliver.name }}</p>
                                        <p class="mb-1 text-muted small">Sana: {{ recieve.date|date:'d-m-Y H:i' }}</p>
                                        <p class="mb-0 text-success font-weight-bold">
                                            Jami: {{ recieve.total_bring_price|intcomma }}
                                        </p>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteRecieve({{ recieve.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted p-3">
                                <p>Hozircha qabullar mavjud emas</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- O'ng panel - Tanlangan qabul -->
            <div class="col-md-8">
                <div id="recieve-detail">
                    {% if active_one %}
                        <!-- Tez qo'shish formasi -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Tez qo'shish</h5>
                            </div>
                            <div class="card-body">
                                <form id="quick-add-form" class="quick-add-form">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Mahsulot</label>
                                                <select class="form-control searchable" id="product-select" required>
                                                    <option value="">Tanlang</option>
                                                    {% for product in products %}
                                                    <option value="{{ product.id }}">{{ product.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label>Miqdor</label>
                                                <input type="number" step="0.001" class="form-control" id="quantity-input" required>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <button type="submit" class="btn btn-success btn-block">
                                                    <i class="fas fa-plus"></i> Qo'shish
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Narxlar formasi -->
                                    <div id="price-fields">
                                        <!-- Narxlar JavaScript orqali yuklanadi -->
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Mahsulotlar jadvali -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Mahsulotlar</h5>
                                <span class="badge badge-primary">
                                    Jami: {{ active_one.total_quantity|intcomma }} dona
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Mahsulot</th>
                                                <th>Kelish narxi</th>
                                                <th>Soni</th>
                                                <th>Jami</th>
                                                <th>Dollar narxi</th>
                                                <th>Ulushi</th>
                                                <th>Chiqim</th>
                                                <th>Tan narx</th>
                                                <th>Amallar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-table-body">
                                            {% for item in active_one.receiveitem.all %}
                                            <tr id="item-{{ item.id }}">
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ item.product.name }}</td>
                                                <td>{{ item.bring_price|intcomma }}</td>
                                                <td>{{ item.quantity|intcomma }}</td>
                                                <td>{{ item.total_bring_price|intcomma }}</td>
                                                <td>{{ item.dollar_price_for_count|intcomma }}</td>
                                                <td>{{ item.percent|intcomma }}%</td>
                                                <td>{{ item.expanse|intcomma }}</td>
                                                <td>{{ item.cost|intcomma }}</td>
                                                <td>
                                                    <button class="btn btn-warning btn-sm" onclick="editItem({{ item.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteItem({{ item.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="10" class="text-center text-muted">
                                                    Hozircha mahsulotlar mavjud emas
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="font-weight-bold">
                                            <tr>
                                                <td colspan="3">Jami</td>
                                                <td>{{ active_one.total_quantity|intcomma }}</td>
                                                <td>{{ active_one.total_bring_price|intcomma }}</td>
                                                <td colspan="5"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Chiqimlar qismi -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Qabul chiqimlari</h5>
                                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addExpenseModal">
                                    <i class="fas fa-plus"></i> Chiqim qo'shish
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Turi</th>
                                                <th>Summa</th>
                                                <th>Valyuta</th>
                                                <th>Turli shaxs</th>
                                                <th>Izoh</th>
                                                <th>Amallar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expenses-table-body">
                                            {% for expanse in active_one.expanses.all %}
                                            <tr id="expense-{{ expanse.id }}">
                                                <td>{{ expanse.type.name }}</td>
                                                <td>{{ expanse.summa|intcomma }}</td>
                                                <td>{{ expanse.valyuta.name }}</td>
                                                <td>{{ expanse.externaluser.full_name|default:"-" }}</td>
                                                <td>{{ expanse.comment|default:"-" }}</td>
                                                <td>
                                                    <button class="btn btn-warning btn-sm" onclick="editExpense({{ expanse.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteExpense({{ expanse.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Hozircha chiqimlar mavjud emas
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted p-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Qabulni tanlang</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal oynalar -->

<!-- Yangi qabul modal -->
<div class="modal fade" id="createRecieveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yangi Qabul</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createRecieveForm">
                    <div class="form-group">
                        <label>Partiya nomi</label>
                        <input type="text" class="form-control" name="name" value="{{ last_part }}" required>
                    </div>
                    <div class="form-group">
                        <label>Yetkazib beruvchi</label>
                        <select class="form-control" name="deliver" required>
                            {% for deliver in delivers %}
                            <option value="{{ deliver.id }}">{{ deliver.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filial</label>
                        <select class="form-control" name="filial" required>
                            {% for filial in filial %}
                            <option value="{{ filial.id }}">{{ filial.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valyuta</label>
                        <select class="form-control" name="valyuta" required>
                            {% for valyuta in valyutas %}
                            <option value="{{ valyuta.id }}">{{ valyuta.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kurs</label>
                        <input type="number" step="any" class="form-control" name="kurs" value="{{ dollar_kurs }}" id="dollar-kurs-base" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createRecieve()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Yetkazib beruvchi modal -->
<div class="modal fade" id="createDeliverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yetkazib beruvchi qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createDeliverForm">
                    <div class="form-group">
                        <label>Nomi</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon 1</label>
                        <input type="text" class="form-control" name="phone1" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon 2</label>
                        <input type="text" class="form-control" name="phone2">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createDeliver()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Chiqim turi qo'shish modal -->
<div class="modal fade" id="createExpenseTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chiqim turi qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createExpenseTypeForm">
                    <div class="form-group">
                        <label>Nomi</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="createExpenseType()">Yaratish</button>
            </div>
        </div>
    </div>
</div>

<!-- Chiqim qo'shish modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chiqim qo'shish</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm">
                    <div class="form-group">
                        <label>Chiqim turi</label>
                        <select class="form-control" name="type" required>
                            {% for expanse_type in expanse_types %}
                            <option value="{{ expanse_type.id }}">{{ expanse_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Summa</label>
                        <input type="number" step="0.01" class="form-control" name="summa" required>
                    </div>
                    <div class="form-group">
                        <label>Valyuta</label>
                        <select class="form-control" name="valyuta" required>
                            {% for valyuta in valyutas %}
                            <option value="{{ valyuta.id }}">{{ valyuta.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Turli shaxs</label>
                        <select class="form-control" name="externaluser">
                            <option value="">-</option>
                            {% for user in external_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Izoh</label>
                        <textarea class="form-control" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()">Qo'shish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>



<script>
    
    $(document).ready(function () {
    $('select.searchable').selectize({ normalize: true });
    const debtorSelect = $('#mainSelectDebtor').selectize({
        normalize: true,
        create: false,
        sortField: 'text',
        placeholder: 'Tanlang...',
        render: {
            option: function (item, escape) {
                const parts = escape(item.text).split('—');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="
                        display: flex; 
                        flex-direction: column; 
                        padding: 8px 10px; 
                        line-height: 1.3;
                    ">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span style="font-weight: 500; color:#333;">${name}</span>
                        </div>
                        <div style="
                            display: flex; 
                            align-items: center; 
                            gap: 6px; 
                            margin-top: 4px;
                            line-height: 1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            },
            item: function (item, escape) {
                const parts = escape(item.text).split('—');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="display:flex; flex-direction:column; line-height:1.2;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span>${name}</span>
                        </div>
                        <div style="
                            display:flex; 
                            align-items:center; 
                            gap:6px; 
                            margin-top:2px;
                            line-height:1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            }
        },
        onInitialize: function () {
            const input = this.$control;
            input.css({
                'border-radius': '10px',
                'border': '1px solid #ced4da',
                'padding': '10px 12px',
                'background': '#fff',
                'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
                'transition': 'all 0.2s ease',
            });

            this.$dropdown.css({
                'border-radius': '8px',
                'overflow': 'hidden',
                'box-shadow': '0 4px 8px rgba(0,0,0,0.12)',
            });

            this.$dropdown.on('mouseenter', '.option', function () {
                $(this).css({
                    'background': '#007bff',
                    'color': '#fff',
                    'cursor': 'pointer'
                });
                $(this).find('i').css('color', '#fff');
            }).on('mouseleave', '.option', function () {
                $(this).css({
                    'background': '',
                    'color': ''
                });
                $(this).find('.bi-person-circle').css('color', '#007bff');
                $(this).find('.bi-telephone-fill').css('color', '#28a745');
            });

            input.on('focus', function () {
                $(this).css({
                    'border-color': '#007bff',
                    'box-shadow': '0 0 0 3px rgba(0,123,255,0.15)'
                });
            }).on('blur', function () {
                $(this).css({
                    'border-color': '#ced4da',
                    'box-shadow': 'none'
                });
            });
        }
    });
});
</script>


<script>
    // Asosiy o'zgaruvchilar
    let currentRecieveId = {% if active_one %}{{ active_one.id }}{% else %}null{% endif %};
    let dollarKurs = parseFloat("{{ dollar_kurs }}") || 1;
    
    // Sahifa yuklanganda
    $(document).ready(function() {
        initializeEventListeners();
        // Dollar kursini yangilash
        updateDollarKurs();
    });
    
    // Dollar kursini yangilash
    function updateDollarKurs() {
        const baseKurs = parseFloat($('#dollar-kurs-base').val());
        if (baseKurs && baseKurs > 0) {
            dollarKurs = baseKurs;
        }
    }
    
    // Kurs o'zgarganda avtomatik hisoblash
    function addKurs(input) {
        dollarKurs = parseFloat(input.value) || 1;
        // Barcha narxlarni yangilash
        updateAllPrices();
    }
    
    // Barcha narxlarni yangilash
    function updateAllPrices() {
        console.log('aaaaaaaaa')
        // Kelish narxlarini yangilash
        $('.bring-price-input').each(function() {
            const valyutaId = $(this).data('valyuta');
            if (valyutaId === '1') { // Som
                const somPrice = parseFloat($(this).val()) || 0;
                const dollarPrice = somPrice / dollarKurs;
                console.log(dollarPrice, 'ooo')
                // Dollar narxini yangilash
                $(`.bring-price-input[data-valyuta="2"]`).val(dollarPrice.toFixed(2));
            }
        });
        
        // Sotish narxlarini yangilash
        $('.sell-price-input').each(function() {
            const priceKey = $(this).data('price-key');
            if (priceKey.includes('_1_')) { // Som valyuta
                const somPrice = parseFloat($(this).val()) || 0;
                const dollarPrice = somPrice / dollarKurs;
                // Dollar narxini topish va yangilash
                const parts = priceKey.split('_');
                const dollarPriceKey = `price_${parts[1]}_2`; // Dollar valyuta
                $(`.sell-price-input[data-price-key="${dollarPriceKey}"]`).val(dollarPrice.toFixed(2));
            }
        });
    }
    
    // Hodisa listenerlarini ishga tushirish
    function initializeEventListeners() {
        // Tez qo'shish formasi
        $(document).on('submit', '#quick-add-form', function(e) {
            e.preventDefault();
            addRecieveItemQuick();
        });
        
        // Mahsulot tanlanganda
        $(document).on('change', '#product-select', function() {
            const productId = $(this).val();
            if (productId) {
                loadProductPrices(productId);
            } else {
                $('#price-fields').hide();
            }
        });
        
        // Narx inputlarida o'zgarish
        // $(document).on('input', '.bring-price-input, .sell-price-input', function() {
        //     updateAllPrices();
        // });

        function calculate(this) {
            const $this = $(this);
            const value = parseFloat($this.val()) || 0;
            
            // Agar So'm bo'lsa, Dollarni hisobla
            if ($this.data('is_som')) {
                const dollarValue = value / dollarKurs;
                // Tegishli Dollar inputini topish
                if ($this.hasClass('bring-price-input')) {
                    // Kelish narxi
                    $(`.bring-price-input[data-is_dollar="true"]`).val(dollarValue.toFixed(2));
                } else {
                    // Sotish narxi
                    const priceKey = $this.data('price-key');
                    const parts = priceKey.split('_');
                    const dollarPriceKey = `price_${parts[1]}_${parts[2]}`.replace('_1_', '_2_'); // So'mdan Dollarga
                    $(`.sell-price-input[data-price-key="${dollarPriceKey}"]`).val(dollarValue.toFixed(2));
                }
            }
            // Agar Dollar bo'lsa, So'mni hisobla
            else if ($this.data('is_dollar')) {
                const somValue = value * dollarKurs;
                // Tegishli So'm inputini topish
                if ($this.hasClass('bring-price-input')) {
                    // Kelish narxi
                    $(`.bring-price-input[data-is_som="true"]`).val(somValue.toFixed(0));
                } else {
                    // Sotish narxi
                    const priceKey = $this.data('price-key');
                    const parts = priceKey.split('_');
                    const somPriceKey = `price_${parts[1]}_${parts[2]}`.replace('_2_', '_1_'); // Dollardan So'mga
                    $(`.sell-price-input[data-price-key="${somPriceKey}"]`).val(somValue.toFixed(0));
                }
            }
        }

        function renderPriceFields(data) {
            let html = '<div class="row mt-3"><div class="col-12"><h6>Narxlar</h6></div>';
            
            // Kelish narxlari
            html += '<div class="col-md-6"><h6 class="text-primary">Kelish narxlari</h6>';
            data.bring_prices.forEach(function(price) {
                const isSom = price.is_som;
                const isDollar = price.is_dollar;
                const isAuto = isDollar; // Dollar avtomatik hisoblanadi
                
                html += `
                    <div class="form-group">
                        <label>${price.valyuta} ${isAuto ? '(Avtomatik)' : ''}</label>
                        <input type="number" step="0.01" class="form-control bring-price-input ${isAuto ? 'auto-calc' : ''}" 
                            data-valyuta="${price.valyuta_id}" 
                            data-is_som="${isSom}" 
                            data-is_dollar="${isDollar}" 
                            value="${price.price}" 
                            ${isAuto ? 'readonly' : ''}>
                    </div>
                `;
            });
            html += '</div>';
            
            // Sotish narxlari
            html += '<div class="col-md-6"><h6 class="text-success">Sotish narxlari</h6>';
            data.sell_prices.forEach(function(row, index) {
                html += `<div class="form-group">`;
                row.summas.forEach(function(summa, sumIndex) {
                    const isSom = row.is_som;
                    const isDollar = row.is_dollar;
                    const isAuto = isDollar; // Dollar avtomatik hisoblanadi
                    
                    html += `
                        <label>${summa.name} (${row.valuta})</label>
                        <input type="number" step="0.01" class="form-control sell-price-input mb-2 ${isAuto ? 'auto-calc' : ''}" 
                            data-price-key="price_${summa.id}_${row.valyuta_id}" 
                            data-is_som="${isSom}" 
                            data-is_dollar="${isDollar}"
                            value="${summa.summa}" 
                            ${isAuto ? 'readonly' : ''}>
                    `;
                });
                html += '</div>';
            });
            html += '</div></div>';
            
            $('#price-fields').html(html).show();
        }
        
        // Dollar kursi o'zgarganda
        $(document).on('input', '#dollar-kurs-base', function() {
            addKurs(this);
        });
    }
    
    // Qabul tanlash
    function selectRecieve(recieveId) {
        window.location.href = `{% url 'recieve' %}?active=${recieveId}`;
    }
    
    // Qabul yaratish
    function createRecieve() {
        const formData = {
            name: $('#createRecieveForm input[name="name"]').val(),
            deliver: $('#createRecieveForm select[name="deliver"]').val(),
            filial: $('#createRecieveForm select[name="filial"]').val(),
            valyuta: $('#createRecieveForm select[name="valyuta"]').val(),
            kurs: $('#createRecieveForm input[name="kurs"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'recieve_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createRecieveModal').modal('hide');
                    setTimeout(() => {
                        window.location.href = `{% url 'recieve' %}?active=${response.recieve_id}`;
                    }, 1000);
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Qabulni o'chirish
    function deleteRecieve(recieveId) {
        if (!confirm('Haqiqatan ham bu qabulni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${recieveId}/delete/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'recieve' %}";
                    }, 1000);
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Yetkazib beruvchi yaratish
    function createDeliver() {
        const formData = {
            name: $('#createDeliverForm input[name="name"]').val(),
            phone1: $('#createDeliverForm input[name="phone1"]').val(),
            phone2: $('#createDeliverForm input[name="phone2"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'deliver_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createDeliverModal').modal('hide');
                    $('#createRecieveForm select[name="deliver"]').append(
                        `<option value="${response.deliver.id}">${response.deliver.name}</option>`
                    );
                    $('#createDeliverForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim turi yaratish
    function createExpenseType() {
        const formData = {
            name: $('#createExpenseTypeForm input[name="name"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: "{% url 'recieve_expense_type_create' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#createExpenseTypeModal').modal('hide');
                    // Yangi chiqim turini select ga qo'shish
                    $('#addExpenseForm select[name="type"]').append(
                        `<option value="${response.expense_type.id}">${response.expense_type.name}</option>`
                    );
                    $('#createExpenseTypeForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Tez qo'shish funksiyasi
    function addRecieveItemQuick() {
        if (!currentRecieveId) {
            showAlert('Iltimos, avval qabulni tanlang!', 'warning');
            return;
        }
        
        const formData = {
            product_id: $('#product-select').val(),
            quantity: $('#quantity-input').val(),
            bring_prices: getBringPrices(),
            sell_prices: getSellPrices()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${currentRecieveId}/items/add/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                    $('#quick-add-form')[0].reset();
                    $('#price-fields').hide();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulotni tahrirlash - YANGILANDI (narxlar bilan)
    function editItem(itemId) {
        const row = $(`#item-${itemId}`);
        const currentQuantity = row.find('td').eq(3).text().replace(/,/g, '');
        const currentBringPrice = row.find('td').eq(2).text().replace(/,/g, '');
        
        // Mahsulot ma'lumotlarini olish
        const productName = row.find('td').eq(1).text();
        const productId = getProductIdByName(productName);
        
        // Tahrirlash formasi
        const editForm = `
            <tr id="edit-item-${itemId}" class="edit-form">
                <td colspan="10">
                    <form id="edit-item-form-${itemId}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Yangi miqdor</label>
                                    <input type="number" step="0.001" class="form-control" 
                                           id="edit-quantity-${itemId}" value="${currentQuantity}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Kelish narxi (So'm)</label>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="edit-bring-price-${itemId}" value="${currentBringPrice}" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-success btn-block" 
                                            onclick="saveItemEdit(${itemId})">
                                        <i class="fas fa-save"></i> Saqlash
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary btn-block" 
                                            onclick="cancelItemEdit(${itemId})">
                                        <i class="fas fa-times"></i> Bekor
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">Mahsulot: ${productName}</small>
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
        `;
        
        row.after(editForm);
        row.hide();
    }
    
    // Mahsulot ID sini nomi orqali olish
    function getProductIdByName(productName) {
        let productId = null;
        $('#product-select option').each(function() {
            if ($(this).text() === productName) {
                productId = $(this).val();
                return false;
            }
        });
        return productId;
    }
    
    // Mahsulot tahririni saqlash - YANGILANDI
    function saveItemEdit(itemId) {
        const newQuantity = $(`#edit-quantity-${itemId}`).val();
        const newBringPrice = $(`#edit-bring-price-${itemId}`).val();
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/items/${itemId}/update/`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                quantity: newQuantity,
                bring_price: newBringPrice
            }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                    cancelItemEdit(itemId);
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                cancelItemEdit(itemId);
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulot tahririni bekor qilish
    function cancelItemEdit(itemId) {
        $(`#edit-item-${itemId}`).remove();
        $(`#item-${itemId}`).show();
    }
    
    // Chiqimni tahrirlash
    function editExpense(expenseId) {
        const row = $(`#expense-${expenseId}`);
        const currentSumma = row.find('td').eq(1).text().replace(/,/g, '');
        const currentComment = row.find('td').eq(4).text();
        
        const editForm = `
            <tr id="edit-expense-${expenseId}" class="edit-form">
                <td colspan="6">
                    <form id="edit-expense-form-${expenseId}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Yangi summa</label>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="edit-summa-${expenseId}" value="${currentSumma}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Yangi izoh</label>
                                    <input type="text" class="form-control" 
                                           id="edit-comment-${expenseId}" value="${currentComment}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-success btn-block" 
                                            onclick="saveExpenseEdit(${expenseId})">
                                        <i class="fas fa-save"></i> Saqlash
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary btn-block" 
                                            onclick="cancelExpenseEdit(${expenseId})">
                                        <i class="fas fa-times"></i> Bekor
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
        `;
        
        row.after(editForm);
        row.hide();
    }
    
    // Chiqim tahririni saqlash
    function saveExpenseEdit(expenseId) {
        const newSumma = $(`#edit-summa-${expenseId}`).val();
        const newComment = $(`#edit-comment-${expenseId}`).val();
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/expenses/${expenseId}/update/`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                summa: newSumma,
                comment: newComment
            }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                    cancelExpenseEdit(expenseId);
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                cancelExpenseEdit(expenseId);
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim tahririni bekor qilish
    function cancelExpenseEdit(expenseId) {
        $(`#edit-expense-${expenseId}`).remove();
        $(`#expense-${expenseId}`).show();
    }
    
    // Mahsulotni o'chirish
    function deleteItem(itemId) {
        if (!confirm('Haqiqatan ham bu mahsulotni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/items/${itemId}/remove/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqimni o'chirish
    function deleteExpense(expenseId) {
        if (!confirm('Haqiqatan ham bu chiqimni o\'chirmoqchimisiz?')) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/expenses/${expenseId}/delete/`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    updateRecieveData();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Chiqim qo'shish
    function addExpense() {
        if (!currentRecieveId) {
            showAlert('Iltimos, avval qabulni tanlang!', 'warning');
            return;
        }
        
        const formData = {
            type: $('#addExpenseForm select[name="type"]').val(),
            summa: $('#addExpenseForm input[name="summa"]').val(),
            valyuta: $('#addExpenseForm select[name="valyuta"]').val(),
            externaluser: $('#addExpenseForm select[name="externaluser"]').val(),
            comment: $('#addExpenseForm textarea[name="comment"]').val()
        };
        
        $('#loading').show();
        
        $.ajax({
            url: `/recieve/${currentRecieveId}/expenses/add/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#addExpenseModal').modal('hide');
                    updateRecieveData();
                    $('#addExpenseForm')[0].reset();
                } else {
                    showAlert(response.message, 'error');
                }
                $('#loading').hide();
            },
            error: function() {
                showAlert('Xatolik yuz berdi!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Ma'lumotlarni yangilash
    function updateRecieveData() {
        if (!currentRecieveId) return;
        
        $('#loading').show();
        
        $.ajax({
            url: `{% url 'recieve' %}?active=${currentRecieveId}`,
            type: 'GET',
            success: function(data) {
                const $newContent = $(data).find('#recieve-detail').html();
                $('#recieve-detail').html($newContent);
                $('#loading').hide();
            },
            error: function() {
                showAlert('Ma\'lumotlarni yangilashda xatolik!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Mahsulot narxlarini yuklash
    function loadProductPrices(productId) {
        $('#loading').show();
        
        $.ajax({
            url: `/products/${productId}/prices/`,
            type: 'GET',
            success: function(response) {
                renderPriceFields(response);
                $('#loading').hide();
            },
            error: function() {
                showAlert('Narxlarni yuklashda xatolik!', 'error');
                $('#loading').hide();
            }
        });
    }
    
    // Narx maydonlarini chizish
    function renderPriceFields(data) {
        let html = '<div class="row mt-3"><div class="col-12"><h6>Narxlar</h6></div>';
        
        // Kelish narxlari
        html += '<div class="col-md-6"><h6 class="text-primary">Kelish narxlari</h6>';
        data.bring_prices.forEach(function(price) {
            const isAuto = price.valyuta_id === '2'; // Dollar avtomatik hisoblanadi
            html += `
                <div class="form-group">
                    <label>${price.valyuta} ${isAuto ? '(Avtomatik)' : ''}</label>
                    <input onkeyup="calculate(this)" type="number" step="0.01" class="form-control bring-price-input ${isAuto ? 'auto-calc' : ''}" 
                           data-valyuta="${price.valyuta_id}" data-is_som="${price.is_som}" "${price.is_dollar}" value="${price.price}" 
                           ${isAuto ? 'readonly' : ''}>
                </div>
            `;
        });
        html += '</div>';
        
        // Sotish narxlari
        html += '<div class="col-md-6"><h6 class="text-success">Sotish narxlari</h6>';
        data.sell_prices.forEach(function(row, index) {
            html += `<div class="form-group">`;
            row.summas.forEach(function(summa, sumIndex) {
                const isAuto = row.valyuta_id === '2'; // Dollar avtomatik hisoblanadi
                html += `
                    <label>${summa.name} (${row.valuta})</label>
                    <input onkeyup="calculate(this)" type="number" step="0.01" class="form-control sell-price-input mb-2 ${isAuto ? 'auto-calc' : ''}" 
                           data-price-key="price_${summa.id}_${row.valyuta_id}"  data-is_som="${price.is_som}" "${price.is_dollar}"
                           value="${summa.summa}" placeholder="${data.price_types[sumIndex]}"
                           ${isAuto ? 'readonly' : ''}>
                `;
            });
            html += '</div>';
        });
        html += '</div></div>';
        
        $('#price-fields').html(html).show();
        // Dastlabki narxlarni yangilash
        updateAllPrices();
    }
    
    // Yordamchi funksiyalar
    function getBringPrices() {
        const prices = {};
        $('.bring-price-input').each(function() {
            const valyutaId = $(this).data('valyuta');
            prices[valyutaId] = $(this).val();
        });
        return prices;
    }
    
    function getSellPrices() {
        const prices = {};
        $('.sell-price-input').each(function() {
            const priceKey = $(this).data('price-key');
            prices[priceKey] = $(this).val();
        });
        return prices;
    }
    
    function showAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        
        $('#alert-container').html(alertHtml);
        
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }
</script>
{% endblock %}