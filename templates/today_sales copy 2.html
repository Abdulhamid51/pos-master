{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    <title>Sotuvlar hisoboti</title>
{% endblock title %}

{% block css %}
    <link href="{% static 'assets/css/tables/table-basic.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'plugins/flatpickr/flatpickr.css' %}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">


    <style>
        .method-box {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background-color: white !important;
            border-radius: 5px;
            box-shadow: 2px 5px 5px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.129) !important;
        }
        .method-box:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .method-box i {
            color: #007bff !important;
            font-size: 1.2em;
        }
        .method-box p {
            margin: 0;
            flex-grow: 1;
            font-weight: 500;
        }
        .toggle-input {
            color: #007bff !important;
            background-color: white !important;
            border: 1px solid #ffffff !important;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-input i {
            font-size: 1.2em;
        }
        .input-fields {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .remove-field {
            cursor: pointer;
            font-size: 1.8em;
            color: #dc3545;
            background: none;
            border: none;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }
        .payment-table th, .payment-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f8f9fa;
        }
        .card-balance {
            text-align: right;
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .inputkassa {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .input-box {
            display: none;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.401);
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            margin-top: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: border 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .input-box:hover {
            border: 1px solid #007bff !important;
        }
        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        .box-body {
            margin-top: 10px;
        }
        .payment-input {
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.277) !important;
        }
        .receipt-wrapper {
            width: 100%;
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-left: 1.8px solid rgba(192, 192, 192, 0.758);
            border-right: 1.8px solid rgba(192, 192, 192, 0.758);
            overflow: hidden; 
        }
        .zigzag {
            width: calc(100% + 3.6px);
            height: 15px;
            margin-left: -1.8px; 
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 10" xmlns="http://www.w3.org/2000/svg"><polyline points="0,10 5,0 10,10 15,0 20,10 25,0 30,10 35,0 40,10 45,0 50,10 55,0 60,10 65,0 70,10 75,0 80,10 85,0 90,10 95,0 100,10" fill="white" stroke="lightgray" /></svg>') repeat-x;
            background-size: contain;
        }
        .receipt {
            padding: 20px;
            font-size: 13px;
            color: #000 !important;
        }
        .bold {
            font-weight: bold;
        }
        .lines {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        hr {
            border: none;
            border-top: 1px solid #bbb;
            margin: 8px 0;
        }
        .section {
            margin-bottom: 8px;
        }
        .barcode {
            height: 50px;
            width: 100%;
            background: repeating-linear-gradient(
                to right,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px
            );
            margin: 15px 0;
        }
        .center {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        .item-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .subline {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-left: 10px;
        }
        .qarz-row {
            font-weight: bold;
            color: #dc3545;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
            margin: 5px 0;
            background-color: #fff3f3;
        }
        .qarz-row span {
            font-size: 14px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
        }
        .summary-value.total {
            color: green;
        }
        .input-box.has-value {
            border: 1px solid #28a745 !important;
            background-color: #f8fff8;
        }
    </style>
    
    <style>

        .btn-check:checked + .btn {
            background-color: #007bff;
            color: white;
        }

        .modal-fullscreen-custom {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0;
            padding: 0;
        }
        .modal-fullscreen-custom .modal-content {
            height: 100vh;
            width: 100vw;
            border-radius: 0;
        }
        body.modal-open {
            overflow: hidden; /* Modal ochilganda sahifa skrollanmasin */
        }

        .shop-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .shop-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .shop-header:hover {
            background: #e9ecef;
        }
        
        .shop-main-info {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .shop-details {
            padding: 0;
            background: #f8f9fa;
            display: none;
        }
        
        .shop-details.show {
            display: block;
        }
        
        .carts-section, .payments-section, .returns-section {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .carts-section:last-child, .payments-section:last-child, .returns-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .payment-totals {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .payment-total-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            min-width: 120px;
        }
        
        .payment-total-label {
            font-size: 12px;
            color: #6c757d;
        }
        
        .payment-total-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-1 { background: #e3f2fd; color: #1976d2; }
        .status-2 { background: #e8f5e8; color: #2e7d32; }
        .status-3 { background: #ffebee; color: #c62828; }
        
        .return-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1060;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        .return-modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .return-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1050;
            display: none;
        }
        
        .return-modal-overlay.show {
            display: block;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .debt-payment {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        .table-sm th, .table-sm td {
            padding: 8px 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .payment-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .payment-amount {
            flex: 1;
        }
        
        .remove-payment {
            color: #dc3545;
            cursor: pointer;
        }
        
        .total-return-amount {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .chegirma-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .cart-item-row {
            transition: background-color 0.3s ease;
        }
        
        .cart-item-row:hover {
            background-color: #f8f9fa;
        }
        
        .cart-input {
            width: 80px;
            text-align: center;
        }
        
        .delete-cart-btn {
            padding: 4px 8px;
        }

        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 30rem;
        }

        #products {
            z-index: 1 !important;
            position: relative;
        }

    </style>
{% endblock css %}

{% block content %}
<div id="content" class="main-content">
    <div style="margin:2rem;">
        <div class="row layout-top-spacing">
            <div style="z-index: 1000;" id="alert-container"></div>
            <div class="col-12 layout-spacing">
                <!-- Filter Form -->
                <div class="card">
                    <div class="card-body">
                        <form class="row" method="GET" id="filter-form">
                            <div class="col-md-2 mb-2">
                                <input type="text" name="search" class="form-control" placeholder="Qidiruv..." value="{{ filters.search }}">
                            </div>
                            <div class="col-md-2 mb-2">
                                <input type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
                            </div>
                            <div class="col-md-2 mb-2">
                                <input type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
                            </div>
                            <div class="col-md-2 mb-2">
                                <select name="deliver" class="form-control searchable" multiple id="select-deliver">
                                    <option value="" disabled>Taminotchi</option>
                                    {% for d in deliver %}
                                        <option value="{{ d.id }}" {% if d.id|stringformat:"i" in filters.deliver %}selected{% endif %}>
                                            {{ d.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <select name="client" class="form-control searchable" multiple id="select-client">
                                    <option value="" disabled>Mijoz</option>
                                    {% for c in client %}
                                        <option value="{{ c.id }}" {% if c.id|stringformat:"i" in filters.client %}selected{% endif %}>
                                            {{ c.fio }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="submit" id="filter_submit" class="btn btn-primary w-100">Filterlash</button>
                                <a href="{% url 'today_sales' %}" class="btn btn-secondary w-100 mt-1">Tozalash</a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Totals Card -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <h5>Jami Sotuvlar</h5>
                                <h3 class="text-primary" id="total-shops">{{ totals.total_shops|intcomma }}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Jami Miqdor</h5>
                                <h3 class="text-success" id="total-quantity">{{ totals.total_quantity|intcomma }}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Jami Summa</h5>
                                <h3 class="text-info" id="total-price">{{ totals.total_price|intcomma }}</h3>
                            </div>
                            <div class="col-md-2">
                                <h5>Sahifa</h5>
                                <h3 class="text-warning" id="current-page">1</h3>
                            </div>

                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" id="openPOSModalBtn">POS</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Shops Container -->
                <div id="shops-container" class="mt-3">
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Yuklanmoqda...</span>
                        </div>
                        <p class="mt-2">Ma'lumotlar yuklanmoqda...</p>
                    </div>
                    <!-- Shops will be loaded here via AJAX -->
                </div>
                
                <!-- Pagination -->
                <div id="pagination-container" class="pagination-container">
                    <!-- Pagination will be loaded here via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>



<!-- <div class="modal fade" id="fullscreenPayment" tabindex="-1" aria-hidden="true">
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-between align-items-center">
                <h3><i class="fa fa-payment"></i> To'lov</h3>
                <button class="btn btn-danger" id="closeFullscreenBtn">
                    <i class="fas fa-times"></i> 
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="receipt-wrapper" id="check_div">
                    <div class="zigzag"></div>
                    <div class="receipt">
                        <div class="section">
                            <div class="lines"><span class="bold">Tranzaksiya:</span> <span>#{{ shop.id }}</span></div>
                            <div class="bold">Store ecomarf-tekstil</div>
                            <div class="lines"><span class="bold">Sana:</span> <span>{{today|date:'Y-m-d'}}</span></div>
                            <div class="lines"><span class="bold">Sotuvchi:</span> <span>{{ shop.debtor}}</span></div>
                            <div class="bold">Maxsulotlar:</div>
                        </div>
                        <hr>
                        <div id="chek_products">
                        </div>
                        <hr>
                        <div class="section">
                            <div class="lines"><span>Oraliq jami</span><span id="chek_oraliq_jami">0 {{shop_valyuta_name}}</span></div>
                            <div class="lines"><span>Chegirma</span><span id="chek_chegirma">0 {{shop_valyuta_name}}</span></div>
                            <div class="lines bold"><span>JAMI</span><span  id="chek_total_jami">0 {{shop_valyuta_name}}</span></div>
                        </div>
                        <div class="section" id="check_tolovlar">
                        </div>
                        <div class="barcode"></div>
                        <div class="center">Xaridingiz uchun rahmat</div>
                    </div>
                    <div class="zigzag"></div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-center mt-3">
                        <button class="btn btn-primary" id="saveAsPngBtn">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>

                    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
                    <script>
                    document.getElementById('saveAsPngBtn').addEventListener('click', function() {
                        const printDiv = document.createElement('div');
                        printDiv.className = 'receipt-print-container';
                        printDiv.style.position = 'absolute';
                        printDiv.style.left = '-9999px';
                        printDiv.style.width = '302px'; 
                        
                        const receiptClone = document.querySelector('.receipt-wrapper').cloneNode(true);
                        
                        receiptClone.style.width = '300px';
                        receiptClone.style.margin = '0';
                        receiptClone.style.boxShadow = 'none';
                        receiptClone.style.border = 'none';
                        
                        printDiv.appendChild(receiptClone);
                        document.body.appendChild(printDiv);
                        
                        html2canvas(printDiv, {
                            scale: 2,
                            logging: false,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: 'white'
                        }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = 'chek-' + new Date().toISOString().slice(0, 10) + '.png';
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            document.body.removeChild(printDiv);
                        });
                    });
                    </script>
                </div>
            </div>
            <div class="col-md-9">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="summary-card">
                            <div class="summary-title">Jami:</div>
                            <div class="summary-value" id="total_jami">0 {{shop_valyuta_name}}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card">
                            <div class="summary-title">To'lash uchun:</div>
                            <div class="summary-value total" id="tolash_summasi">0 {{shop_valyuta_name}}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h4>To'lov usullari</h4>
                        <hr>
                    </div>
                    {% for mer in kassalar %}
                    <div class="col-md-3 mb-3 plus_button" onclick="showInputBox(this)">
                        <div class="payment-method" data-kassa-id="{{ mer.kassa.id }}" data-valyuta-id="{{ mer.valyuta.id }}">
                            <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'">
                                <i class="fa-solid fa-money-bill-wave"></i>
                                <p>{{ mer.kassa.name }} ({{ mer.valyuta }})</p>
                                <button class="toggle-input"
                                    {% if mer.valyuta.is_dollar %}
                                        data-dollar="true"
                                    {% else %}
                                        data-dollar="false"
                                    {% endif %}
                                    >
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <div class="input-box" style="display: none;">
                                <div class="box-header">
                                    <span>{{ mer.kassa.name }} ({{ mer.valyuta }})</span>
                                    <p style="display: none;" class="box-header-valyuta-name">{{ mer.valyuta.name }}</p>
                                    <button class="remove-field">&times;</button>
                                </div>
                                <div class="box-body">
                                    <input type="number" step="any" class="form-control payment-input" oninput="">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="col-md-3 mb-3 plus_button">
                        <div class="payment-method" data-kassa-id="qarz" data-valyuta-id="">
                            <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'">
                                <i class="fa-solid fa-money-bill-transfer"></i>
                                <p>Qarzga</p>
                                <button class="toggle-input" data-bs-toggle="modal" data-bs-target="#qarzModal" id="qarzModalButton">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12 d-flex justify-content-end" style="gap: 10px;">
                        <button type="button" class="btn btn-danger me-2" id="cancelPaymentBtn">
                            <i class="fas fa-times"></i> Bekor qilish
                        </button>
                        <button type="button" class="btn btn-success" id="submit-payment" onclick="Yakunlash()">
                            <i class="fas fa-check"></i> To'lovni tasdiqlash va Yakunlash
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->




<!-- Fullscreen Payment Modal -->
<div class="modal fade" id="fullscreenPayment" tabindex="-1" aria-hidden="true" style="z-index:9999">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content">
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <h3><i class="fa fa-payment"></i> To'lovni amalga oshirish</h3>
                        <button class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> 
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="receipt-wrapper" id="check_div">
                            <div class="zigzag"></div>
                            <div class="receipt">
                                <div class="section">
                                    <div class="lines"><span class="bold">Tranzaksiya:</span> <span>#{{ shop.id }}</span></div>
                                    <div class="bold">Store ecomarf-tekstil</div>
                                    <div class="lines"><span class="bold">Sana:</span> <span>{{today|date:'Y-m-d'}}</span></div>
                                    <div class="lines"><span class="bold">Sotuvchi:</span> <span>{{ shop.debtor}}</span></div>
                                    <div class="bold">Maxsulotlar:</div>
                                </div>
                                <hr>
                                <div id="chek_products">
                                </div>
                                <hr>
                                <div class="section">
                                    <div class="lines"><span>Oraliq jami</span><span id="chek_oraliq_jami">0 {{shop_valyuta_name}}</span></div>
                                    <div class="lines"><span>Chegirma</span><span id="chek_chegirma">0 {{shop_valyuta_name}}</span></div>
                                    <div class="lines bold"><span>JAMI</span><span  id="chek_total_jami">0 {{shop_valyuta_name}}</span></div>
                                </div>
                                <div class="section" id="check_tolovlar">
                                </div>
                                <div class="barcode"></div>
                                <div class="center">Xaridingiz uchun rahmat</div>
                            </div>
                            <div class="zigzag"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-center mt-3">
                                <button class="btn btn-primary" id="saveAsPngBtn">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="summary-card">
                                    <div class="summary-title">Jami:</div>
                                    <div class="summary-value" id="total_jami">0 {{shop_valyuta_name}}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card">
                                    <div class="summary-title">To'lash uchun:</div>
                                    <div class="summary-value total" id="tolash_summasi">0 {{shop_valyuta_name}}</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>To'lov usullari</h4>
                                <hr>
                            </div>
                            {% for mer in kassalar %}
                            <div class="col-md-3 mb-3 plus_button">
                                <div class="payment-method" data-kassa-id="{{ mer.kassa.id }}" data-valyuta-id="{{ mer.valyuta.id }}">
                                    <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'" onclick="showInputBox(this)">
                                        <i class="fa-solid fa-money-bill-wave"></i>
                                        <p>{{ mer.kassa.name }} ({{ mer.valyuta }})</p>
                                        <button class="toggle-input"
                                            {% if mer.valyuta.is_dollar %}
                                                data-dollar="true"
                                            {% else %}
                                                data-dollar="false"
                                            {% endif %}
                                            >
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="input-box" style="display: none;">
                                        <div class="box-header">
                                            <span>{{ mer.kassa.name }} ({{ mer.valyuta }})</span>
                                            <p style="display: none;" class="box-header-valyuta-name">{{ mer.valyuta.name }}</p>
                                            <button class="remove-field">&times;</button>
                                        </div>
                                        <div class="box-body">
                                            <input min="0" type="number" step="any" class="form-control payment-input" oninput="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <div class="col-md-3 mb-3 plus_button" id="qarzModalButton">
                                <div class="payment-method" data-kassa-id="qarz" data-valyuta-id="">
                                    <div class="method-box" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='rgba(0,0,0,0.129)'" onclick="showQarzInputBox(this)">
                                        <i class="fa-solid fa-money-bill-transfer"></i>
                                        <p>Qarzga</p>
                                        <button class="toggle-input">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="input-box" style="display: none;" id="qarzInputBox">
                                    <div class="box-header">
                                        <span>Qarz berish</span>
                                        <!-- <button class="remove-field" onclick="hideQarzInputBox()">&times;</button> -->
                                    </div>
                                    <div class="box-body">
                                        <div class="mb-2">
                                            <label class="small">Valyuta</label>
                                            <select class="form-control form-control-sm" id="qarzBoxValyuta">
                                                <option value="">Tanlang</option>
                                                {% for valyuta in valyutalar %}
                                                    <option value="{{ valyuta.id }}" 
                                                            data-name="{{ valyuta.name }}"
                                                            data-is-dollar="{{ valyuta.is_dollar|yesno:'true,false' }}">
                                                        {{ valyuta.name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small">Summa</label>
                                            <input type="number" step="any" class="form-control form-control-sm" id="qarzBoxSumma" placeholder="0.00">
                                        </div>
                                        <div class="mb-2">
                                            <label class="small">To'lov muddati</label>
                                            <input type="date" class="form-control form-control-sm" id="qarzBoxDueDate">
                                        </div>
                                        <div>
                                            <label class="small">Izoh</label>
                                            <textarea class="form-control form-control-sm" id="qarzBoxComment" rows="2" placeholder="Izoh"></textarea>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100 mt-2" onclick="addQarzToPayment()">
                                            <i class="fa-solid fa-plus"></i> Qo'shish
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12 d-flex justify-content-end" style="gap: 10px;">
                                <button type="button" class="btn btn-danger me-2" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Bekor qilish
                                </button>
                                <button type="button" class="btn btn-success" id="submit-payment" onclick="Yakunlash()">
                                    <i class="fas fa-check"></i> To'lovni tasdiqlash va Yakunlash
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Qarz Modal -->
<!-- <div class="modal fade" id="qarzModal" tabindex="-1" aria-labelledby="qarzModalLabel" aria-hidden="true" style="z-index:99999">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-4">
            <div class="modal-header">
                <h5 class="modal-title" id="qarzModalLabel">Yangi qarz</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="customer_info">
                    {% for i in customer_info.valyuta %}
                    <div class="col-4">
                        <label>Faol qarz ({{i.name}})</label>
                        <h6>{{ i.summa|intcomma }}</h6>
                    </div>
                    {% endfor %}
                    <div class="col-3">
                        <label>Oxirgi to'lov</label>
                        <h6>{{customer_info.last_pay|date:'Y-m-d'}}</h6>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Mijoz</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa fa-user"></i></span>
                        <select class="form-control" id="modalSelectDebtor" name="debtor" required style="border: 1px solid rgba(0, 0, 0, 0.214);font-weight: bold; background-color: #fff; opacity: 1; color: #000;">
                            <option value=""></option>
                            {% for i in client %}
                                <option value="{{i.id}}">{{ i.fio }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <small class="text-muted">Balans: 0 {{shop_valyuta_name}}</small>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label>Valyuta</label>
                        <select class="form-control" id="qarzValyuta" required>
                            <option value="">Valyuta tanlang</option>
                            {% for valyuta in valyutalar %}
                                <option value="{{ valyuta.id }}" 
                                        data-is-dollar="{{ valyuta.is_dollar|yesno:'true,false' }}"
                                        data-is-som="{{ valyuta.is_som|yesno:'true,false' }}">
                                    {{ valyuta.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <label>Summa</label>
                        <input type="number" step="any" class="form-control" id="qarzSumma" 
                            style="border: 1px solid rgba(0, 0, 0, 0.214);" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label>To'lov muddati</label>
                        <input type="date" class="form-control" id="qarzDueDate" 
                            style="border: 1px solid rgba(0, 0, 0, 0.214);" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Izoh</label>
                    <textarea class="form-control" id="qarzComment" rows="3" placeholder="Izoh kiriting"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="qarzclose" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" id="confirmQarzButton">Qarz qo'shish</button>
            </div>
        </div>
    </div>
</div> -->


<!-- POS Modal -->
<div class="modal fade" id="posModal" tabindex="-1" aria-labelledby="posModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content bg-light">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" style="color:fff">POS Tizimi</h5>
                <!-- <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Yopish"></button> -->
            </div>
            <div class="modal-body bg-light">
                <div class="row layout-top-spacing" id="cancel-row">
                    <div class="col-xl-9 col-lg-9 col-sm-12 layout-spacing">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        <select name="valyuta" id="valyuta_input" class="searchable form-control" required disabled oninput="saveValyutaShop(this)">
                                            {% for i in valyutalar %}
                                                <option value="{{i.id}}" {% if shop.valyuta == i %}selected{% endif %} >{{i.name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <select class="d-none" id="products" name="product" data-recieve="{{recieve.id}}">
                                                <option value="">Mahsulot tanlanmagan</option>
                                                {% for i in products %}
                                                    <option 
                                                        value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}">
                                                        {{ i.name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <div class="dropdown w-100 position-relative">
                                                <input type="text" class="form-control fs-5 py-3 border-primary" placeholder="Mahsulotni qidiring..." id="productSearchInput" data-bs-toggle="dropdown" aria-expanded="false">
                                                <ul class="dropdown-menu w-100 overflow-auto shadow" style="max-height: 300px;" id="productListDropdown">
                                                    {% for i in products %}
                                                        <li>
                                                            <a onclick="addCart('{{i.id}}')" href="#" class="dropdown-item py-2 fs-5 select-product-item"
                                                            data-value="{{ i.id }}&{{ i.name }}&{{ i.quantity }}&{{ i.get_barcodes }}&{% if i.pack == 0 %}1{% else %}{{ i.pack }}{% endif %}&{{ i.price }}">
                                                                üõí <strong>{{ i.name }}</strong><br>
                                                                üì¶ {{ i.quantity|floatformat:'2' }} | üè∑Ô∏è {{ i.get_barcodes }} | üí∞ <span data-prices='{{ i.pricetypevaluta_prices_json|safe }}' id="productprice{{i.id}}">{{ i.price|floatformat:'2' }}</span>
                                                            </a>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn btn-danger h-100" onclick="clearInputProduct()">X</button>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-primary w-100 h-100" id="fullscreenDropdownBtn">
                                            Guruh bo'yicha
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="product_list" class="table table-hover" style="width:100%">
                                        <thead class="">
                                            <tr>
                                                <th>#</th>
                                                <th>Maxsulot nomi</th>
                                                <th>Paket soni</th>
                                                <th>Paket</th>
                                                <th>Miqdori (dona)</th>
                                                <th>Narx</th>
                                                <th>Kelishilgan narx</th>
                                                <th style="min-width: 10rem;">Jami</th>
                                                <th>O'chirish</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cart-tbody"> 
                                            <!-- Cart elementlari shu yerga qo'shiladi -->
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <td>Jami</td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-center fw-bold" id="pack_total">0</td>
                                                <td class="text-center fw-bold" id="quantity_total">0</td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-center fw-bold" id="total_sum">0</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-3 col-sm-12 layout-spacing">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <form method="post" action="{% url 'b2c_shop_edit' %}">
                                    {% csrf_token %}
                                    <h4 class="text-success text-center mb-4" style="font-size: 50px;" id="all_total">0</h4>
                                    
                                    <div class="btn-group w-100 mb-3" role="group" aria-label="Price Types">
                                        {% for i in price_types %}
                                            <input type="radio" class="btn-check price_type_input" style="display:none" name="type_price" id="{{i.name}}{{i.id}}" value="{{i.id}}" autocomplete="off" 
                                            {% if shop.debtor.price_type == i %}
                                                checked
                                            {% elif not shop.debtor.price_type and price_types.first == i %}
                                                checked
                                            {% endif %}
                                                >
                                            <label class="btn btn-outline-primary" for="{{i.name}}{{i.id}}">{{i.name}}</label>
                                        {% endfor %}
                                    </div>
                                    
                                    <input type="hidden" name="id" id="shop_id" value="">
                                    
                                    <div class="mb-3">
                                        <label for="mainSelectDebtor" class="form-label">Mijoz</label>
                                        <div class="input-group">
                                            <select class="form-control" id="mainSelectDebtor" name="debtor" required>
                                                <option value=""></option>
                                                {% for i in debtors %}
                                                    <option value="{{i.id}}" {% if shop.debtor == i %}selected{% endif %}>{{ i.fio }} - {{ i.phone1|default_if_none:'Kiritilmagan' }}</option>
                                                {% endfor %}
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" data-toggle="modal" data-target="#debtorModal">+</button>
                                        </div>
                                    </div>
                                 
                                    <div class="mb-3">
                                        <label for="selectFilial" class="form-label">Filial</label>
                                        <select class="form-control searchable" name="filial" id="selectFilial" required>
                                            <option value=""></option>
                                            {% for i in filials %}
                                                <option value="{{i.id}}" {% if shop.filial == i or user.filial == i %}selected{% endif %}>{{ i.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="mb-3">
                                        <label for="all_total_2" class="form-label">Jami summa</label>
                                        <input type="text" class="form-control bg-light" id="all_total_2" name="all_total" value="0" disabled>
                                    </div>
                                </form>
                                
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <input type="number" id="discountInput" oninput="changeDiscount();updateTotals()" class="form-control" placeholder="Chegirmani kiriting">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-danger h-100" onclick="clearPerecent()">X</button>
                                    </div>
                                    <div class="col-md-2 d-flex justify-content-end">
                                        <button class="btn btn-outline-secondary" id="uzsBtn">{{shop_valyuta_name}}</button>
                                    </div>
                                </div>
                                
                                <div class="row quick-discount g-2 mb-4">
                                    <div class="col-auto">
                                        <button id="disc_button" style="display: none;" class="btn btn-sm btn-outline-secondary">0%</button>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-lg" id="fullscreenPaymentBtn">
                                        To'lovni amalga oshirish
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="fetchReceipt()">CHEK V1</button>
                                    <button type="button" class="btn btn-warning">
                                        <a href="" target="_blank" rel="noopener noreferrer" class="text-white text-decoration-none">CHEK V2</a>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" onclick="$('#filter_submit').trigger('click')" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>

<!-- Return Modal -->
<div class="return-modal-overlay" id="return-modal-overlay"></div>
<div class="return-modal" id="return-modal">
    <div class="modal-header bg-primary text-white p-3">
        <h5 class="modal-title">Maxsulotlarni Qaytarish</h5>
        <button type="button" class="btn-close btn-close-white" id="close-return-modal"></button>
    </div>
    <div class="modal-body p-3">
        <div id="return-shop-info" class="mb-3 p-3 bg-light rounded"></div>
        
        <!-- Qaytariladigan mahsulotlar -->
        <div class="mb-4">
            <h6>Qaytariladigan Mahsulotlar</h6>
            <div id="return-products-list"></div>
        </div>
        
        <!-- To'lov usuli -->
        <div class="mb-4">
            <h6>To'lov Usuli</h6>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="subtract-from-debt" checked>
                <label class="form-check-label" for="subtract-from-debt">
                    Qarzidan ayirish
                </label>
                <small class="form-text text-muted d-block">
                    Agar belgilansa, qaytarish summasi mijozning qarzidan ayiriladi. 
                    Agar belgilanmasa, kassadan chiqim qilinadi.
                </small>
            </div>
            
            <div id="payment-section" style="display: none;">
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-payment">
                        <i class="fas fa-plus"></i> To'lov qo'shish
                    </button>
                </div>
                <div id="payments-container"></div>
                <div id="total-return-display" class="total-return-amount"></div>
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-success w-100" id="confirm-return">
                <i class="fas fa-check"></i> Qaytarishni Tasdiqlash
            </button>
        </div>
    </div>
</div>





{% endblock content %}

{% block js %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>

<script>
    
    $(document).ready(function () {
    $('select.searchable').selectize({ normalize: true });
    const debtorSelect = $('#mainSelectDebtor').selectize({
        normalize: true,
        create: false,
        sortField: 'text',
        placeholder: 'Mijozni tanlang...',
        render: {
            option: function (item, escape) {
                const parts = escape(item.text).split('‚Äî');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="
                        display: flex; 
                        flex-direction: column; 
                        padding: 8px 10px; 
                        line-height: 1.3;
                    ">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span style="font-weight: 500; color:#333;">${name}</span>
                        </div>
                        <div style="
                            display: flex; 
                            align-items: center; 
                            gap: 6px; 
                            margin-top: 4px;
                            line-height: 1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            },
            item: function (item, escape) {
                const parts = escape(item.text).split('‚Äî');
                const name = parts[0]?.trim() || '';
                const phone = parts[1]?.trim() || '';

                return `
                    <div style="display:flex; flex-direction:column; line-height:1.2;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <i class="bi bi-person-circle" style="color:#007bff; font-size:17px; vertical-align: middle;"></i>
                            <span>${name}</span>
                        </div>
                        <div style="
                            display:flex; 
                            align-items:center; 
                            gap:6px; 
                            margin-top:2px;
                            line-height:1;
                        ">
                            <span style="font-size:13px; color:#666; position: relative; top: -1px;">
                                ${phone}
                            </span>
                        </div>
                    </div>`;
            }
        },
        onInitialize: function () {
            const input = this.$control;
            input.css({
                'border-radius': '10px',
                'border': '1px solid #ced4da',
                'padding': '10px 12px',
                'background': '#fff',
                'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
                'transition': 'all 0.2s ease',
            });

            this.$dropdown.css({
                'border-radius': '8px',
                'overflow': 'hidden',
                'box-shadow': '0 4px 8px rgba(0,0,0,0.12)',
            });

            this.$dropdown.on('mouseenter', '.option', function () {
                $(this).css({
                    'background': '#007bff',
                    'color': '#fff',
                    'cursor': 'pointer'
                });
                $(this).find('i').css('color', '#fff');
            }).on('mouseleave', '.option', function () {
                $(this).css({
                    'background': '',
                    'color': ''
                });
                $(this).find('.bi-person-circle').css('color', '#007bff');
                $(this).find('.bi-telephone-fill').css('color', '#28a745');
            });

            input.on('focus', function () {
                $(this).css({
                    'border-color': '#007bff',
                    'box-shadow': '0 0 0 3px rgba(0,123,255,0.15)'
                });
            }).on('blur', function () {
                $(this).css({
                    'border-color': '#ced4da',
                    'box-shadow': 'none'
                });
            });
        }
    });
});
</script>

<!-- <script>
$(document).on('click', '#qarzModalButton', function () {
    console.log('aaaaaaaaa')
    const qarzModal = new bootstrap.Modal(document.getElementById('qarzModal'));
    qarzModal.show();
});
</script> -->

<script>
// Cart operatsiyalari uchun global o'zgaruvchilar
let currentShopId = null;
let cartItems = [];
let currentKurs = document.querySelector('#dollar-kurs-base').value
let paymentMethods = [
    {% for k in kassalar %}
    {
        id: {{ k.id }},
        kassa: {
            id: {{ k.kassa.id }},
            name: "{{ k.kassa.name|escapejs }}"
        },
        valyuta: {
            id: {{ k.valyuta.id }},
            name: "{{ k.valyuta.name|escapejs }}",
        },
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let currentDatas = null

let existingPayments = [];



// Sahifa yuklanganda shop yaratish yoki olish
document.addEventListener('DOMContentLoaded', function() {
    // initializeShop();
    
    // POS modalini ochish
    document.getElementById('openPOSModalBtn').addEventListener('click', function() {
        initializeShop();
        const modal = new bootstrap.Modal(document.getElementById('posModal'));
        modal.show();
    });
});


function editShopModal(id) {
    initializeShop(id);
    const modal = new bootstrap.Modal(document.getElementById('posModal'));
    modal.show();
}

// Shopni yaratish yoki olish
async function initializeShop(id) {
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${id || ''}`);
    
        const data = await response.json();
        
        if (data.id) {
            currentShopId = data.id;
            currentDatas = data
            filialId = data.filial.id;
            customerId = data.customer_info.id
            document.getElementById('shop_id').value = currentShopId;

            var customerselect = $('#mainSelectDebtor')[0].selectize;
            customerselect.setValue(customerId);

            var filialselect = $('#selectFilial')[0].selectize;
            filialselect.setValue(filialId);

            $('#discountInput').val(data.chegirma)
            $('#all_total').val(data.totals.total)

            loadCartItems();
            await loadExistingPayments();
        }
    } catch (error) {
        console.error('Shop yaratishda xatolik:', error);
        showAlert('Shop yaratishda xatolik yuz berdi', 'danger');
    }
}

// Cart elementlarini yuklash
async function loadCartItems() {
    if (!currentShopId) return;
    
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}`);
        const data = await response.json();
        
        if (data.cart_items) {
            cartItems = data.cart_items;
            renderCartItems();
            updateTotals();
        }
    } catch (error) {
        console.error('Cart elementlarini yuklashda xatolik:', error);
    }
}

// Cart elementlarini ekranga chiqarish
function renderCartItems() {
    const tbody = document.getElementById('cart-tbody');
    tbody.innerHTML = '';
    
    cartItems.forEach((item, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-cart-id', item.id);
        row.setAttribute('data-product-id', item.product_id);
        row.className = 'cart-item-row';
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td class="product_name">${item.product_name}</td>
            <td>${item.pack_size || 1}</td>
            <td>
                <div class="input-group">
                    <input type="number" class="form-control cart-input pack-input" 
                           value="${item.total_pack}" min="0" step="0.01"
                           data-pack="${item.pack_size || 1}"
                           onchange="updateCartItem(${item.id}, 'total_pack', this.value)">
                </div>
            </td>
            <td>
                <div class="input-group">
                    <input type="number" class="form-control cart-input quantity-input" 
                           value="${item.quantity}" min="0" step="0.01"
                           onchange="updateCartItem(${item.id}, 'quantity', this.value)">
                </div>
            </td>
            <td>${formatNumber(item.price_without_skidka)}</td>
            <td>
                <div class="input-group">
                    <input type="number" class="form-control cart-input price-input" 
                           value="${item.price}" min="0" step="0.01"
                           onchange="updateCartItem(${item.id}, 'price', this.value)">
                </div>
            </td>
            <td class="total" data-value="${item.total}">${formatNumber(item.total)}</td>
            <td>
                <button onclick="deleteCartItem(${item.id})" type="button" class="btn btn-danger delete-cart-btn">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Cartga yangi mahsulot qo'shish
async function addCart(productId) {
    if (!currentShopId) {
        showAlert('Iltimos, avval shop yaratiling', 'warning');
        return;
    }
    
    try {
        const productElement = document.querySelector(`[data-value*="${productId}&"]`);
        if (!productElement) {
            showAlert('Mahsulot topilmadi', 'danger');
            return;
        }
        
        const productData = productElement.getAttribute('data-value').split('&');
        const productName = productData[1];
        const quantity = 1;
        const packSize = parseFloat(productData[4]) || 1;
        const totalPack = quantity / packSize;
        const price = parseFloat(document.getElementById(`productprice${productId}`).textContent);
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', quantity);
        formData.append('total_pack', totalPack);
        formData.append('agreed_price', price);
        formData.append('product_price', price);
        
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&request_type=cart_add`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert("Mahsulot savatga qo'shildi", "success");
            
            // Yangi cart elementini qo'shamiz
            const newItem = {
                id: data.cart_id,
                product_id: productId,
                product_name: productName,
                quantity: quantity,
                total_pack: totalPack,
                price: price,
                price_without_skidka: price,
                total: quantity * price,
                pack_size: packSize
            };
            
            cartItems.push(newItem);
            renderCartItems();
            updateTotals();
            
            // Inputni tozalash
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productListDropdown').classList.remove('show');
            
        } else {
            showAlert(data.message || "Xatolik yuz berdi", "danger");
        }
    } catch (error) {
        console.error('Cart qo\'shishda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Cart elementini yangilash
async function updateCartItem(cartId, field, value) {
    try {
        // Avvalgi qiymatni saqlab olamiz
        const itemIndex = cartItems.findIndex(item => item.id === cartId);
        if (itemIndex === -1) return;
        
        const oldItem = {...cartItems[itemIndex]}; // Avvalgi qiymatlarni nusxalaymiz
        const oldValue = cartItems[itemIndex][field];
        
        // Local cart items ni yangilaymiz (vaqtincha)
        cartItems[itemIndex][field] = parseFloat(value);
        
        // Agar quantity yoki price o'zgarsa, totalni qayta hisoblaymiz
        if (field === 'quantity' || field === 'price') {
            const quantity = cartItems[itemIndex].quantity;
            const price = cartItems[itemIndex].price;
            cartItems[itemIndex].total = quantity * price;
            
            // Agar quantity o'zgarsa, total_pack ni ham yangilaymiz
            if (field === 'quantity') {
                const packSize = cartItems[itemIndex].pack_size || 1;
                cartItems[itemIndex].total_pack = quantity / packSize;
            }
        }
        
        // Agar total_pack o'zgarsa, quantity ni yangilaymiz
        if (field === 'total_pack') {
            const packSize = cartItems[itemIndex].pack_size || 1;
            cartItems[itemIndex].quantity = value * packSize;
            cartItems[itemIndex].total = cartItems[itemIndex].quantity * cartItems[itemIndex].price;
        }
        
        // UI ni yangilaymiz (vaqtincha)
        renderCartItems();
        updateTotals();
        
        const formData = new FormData();
        formData.append(field, value);
        
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&cart_id=${cartId}&request_type=cart_edit`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Mahsulot yangilandi', 'success');
        } else {
            // Xatolik bo'lsa, avvalgi qiymatlarga qaytaramiz
            cartItems[itemIndex] = {...oldItem}; // Avvalgi holatiga qaytaramiz
            
            // UI ni qayta yangilaymiz
            renderCartItems();
            updateTotals();
            
            showAlert(data.message || 'Yangilashda xatolik', 'danger');
            
            // Xatolik bo'lsa, cartni qayta yuklaymiz
            loadCartItems();
        }
    } catch (error) {
        console.error('Cart yangilashda xatolik:', error);
        
        // Xatolik bo'lsa, avvalgi qiymatlarga qaytaramiz
        const itemIndex = cartItems.findIndex(item => item.id === cartId);
        if (itemIndex !== -1) {
            // Avvalgi qiymatni qayta o'rnatish
            const inputElement = document.querySelector(`[data-id="${cartId}"] .${field}-input`);
            if (inputElement) {
                inputElement.value = oldValue;
            }
        }
        
        // Cartni qayta yuklaymiz
        loadCartItems();
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Cart elementini o'chirish
async function deleteCartItem(cartId) {
    if (!confirm('Haqiqatan ham ushbu mahsulotni o\'chirmoqchimisiz?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url 'b2c_shop_create' %}?id=${currentShopId}&cart_id=${cartId}&request_type=cart_delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert("Mahsulot o'chirildi", "success");
            
            // Local cart items dan o'chiramiz
            cartItems = cartItems.filter(item => item.id !== cartId);
            renderCartItems();
            updateTotals();
        } else {
            showAlert(data.message || "O'chirishda xatolik", "danger");
        }
    } catch (error) {
        console.error('Cart o\'chirishda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    }
}

// Jami summalarni yangilash
function updateTotals() {
    let totalPack = 0;
    let totalQuantity = 0;
    let totalSum = 0;
    
    cartItems.forEach(item => {
        totalPack += item.total_pack;
        totalQuantity += item.quantity;
        totalSum += item.total;
    });

    chegirma = parseFloat(document.getElementById('discountInput').value) || 0;
    if (chegirma > 0) {
        totalSum = totalSum - chegirma;
    }
    
    document.getElementById('pack_total').textContent = formatNumber(totalPack);
    document.getElementById('quantity_total').textContent = formatNumber(totalQuantity);
    document.getElementById('total_sum').textContent = formatNumber(totalSum);
    document.getElementById('all_total').textContent = formatNumber(totalSum);
    document.getElementById('all_total_2').value = totalSum;
}

// Sonlarni formatlash
function formatNumber(num) {
    return new Intl.NumberFormat("ru-RU", {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(num);
}

// Xabarlarni ko'rsatish
function showAlert(message, type) {
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show`;
    alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('alert-container').appendChild(alertElement);
    
    setTimeout(() => {
        alertElement.remove();
    }, 5000);
}
// Inputni tozalash
function clearInputProduct() {
    document.getElementById('productSearchInput').value = '';
    document.getElementById('productListDropdown').classList.remove('show');
}

// Mahsulot qidiruvini optimallashtirilgan versiyasi
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('productSearchInput');
    const dropdown = document.getElementById('productListDropdown');
    
    // searchInput.addEventListener('input', function() {
    //     const filter = this.value.toLowerCase();
    //     const items = dropdown.querySelectorAll('.select-product-item');
        
    //     let hasVisibleItems = false;
        
    //     items.forEach(item => {
    //         const text = item.textContent.toLowerCase();
    //         if (text.includes(filter)) {
    //             item.style.display = '';
    //             hasVisibleItems = true;
    //         } else {
    //             item.style.display = 'none';
    //         }
    //     });
        
    //     dropdown.classList.toggle('show', hasVisibleItems && filter.length > 0);
    // });



    searchInput.addEventListener('input', function() {
    const searchTerms = this.value.toLowerCase().split(' ').filter(term => term.length > 0);
    const items = dropdown.querySelectorAll('.select-product-item');
    
    let hasVisibleItems = false;
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const dataValue = item.getAttribute('data-value').toLowerCase();
        
        // Barcha qidiruv so'zlarini tekshirish
        const allTermsMatch = searchTerms.every(term => {
            return text.includes(term) || dataValue.includes(term);
        });
        
        if (allTermsMatch) {
            item.style.display = '';
            hasVisibleItems = true;
            
            // Faqat men yozgan textni belgilash
            highlightOnlySearchedText(item, this.value.toLowerCase());
        } else {
            item.style.display = 'none';
            removeHighlight(item);
        }
    });
    
    dropdown.classList.toggle('show', hasVisibleItems && searchTerms.length > 0);
});

// Faqat men yozgan textni belgilash
function highlightOnlySearchedText(element, searchedText) {
    removeHighlight(element);
    
    if (!searchedText) return;
    
    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    let node;
    const nodes = [];
    while (node = walker.nextNode()) {
        nodes.push(node);
    }
    
    nodes.forEach(node => {
        const text = node.textContent;
        const searchRegex = new RegExp(`(${escapeRegex(searchedText)})`, 'gi');
        const newText = text.replace(searchRegex, '<span class="highlight">$1</span>');
        
        if (newText !== text) {
            const span = document.createElement('span');
            span.innerHTML = newText;
            node.parentNode.replaceChild(span, node);
        }
    });
}

// Belgilashni olib tashlash
function removeHighlight(element) {
    const highlights = element.querySelectorAll('.highlight');
    highlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
        parent.normalize();
    });
}

// Regex uchun maxsus belgilarni escape qilish
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
    
    // Enter bosilganda birinchi mos keluvchi mahsulotni tanlash
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const visibleItems = dropdown.querySelectorAll('.select-product-item:not([style*="display: none"])');
            if (visibleItems.length > 0) {
                visibleItems[0].click();
            }
        }
    });
});

// Narx turini o'zgartirganda narxlarni yangilash
document.addEventListener('DOMContentLoaded', function () {
    const priceTypeRadios = document.querySelectorAll('.price_type_input');
    const valyutaSelect = document.getElementById('valyuta_input');

    function updateAllPrices() {
        const selectedValyutaId = valyutaSelect.value;
        const selectedPriceTypeId = document.querySelector('.price_type_input:checked')?.value;

        document.querySelectorAll('#productListDropdown span[data-prices]').forEach(span => {
            const rawPrices = span.getAttribute('data-prices');
            if (!rawPrices) return;

            let pricesData;
            try {
                pricesData = JSON.parse(rawPrices);
            } catch (e) {
                console.error("JSON parse error:", e, rawPrices);
                span.textContent = '0';
                return;
            }

            const foundValyuta = pricesData.find(v => String(v.valyuta_id) === selectedValyutaId);
            if (!foundValyuta) {
                span.textContent = '0';
                return;
            }

            const foundPrice = foundValyuta.summas.find(
                s => String(s.price_type) === selectedPriceTypeId
            );

            if (foundPrice && foundPrice.summa) {
                span.textContent = foundPrice.summa;
            } else {
                span.textContent = '0';
            }
        });
    }

    updateAllPrices();

    priceTypeRadios.forEach(radio => radio.addEventListener('change', updateAllPrices));
    valyutaSelect.addEventListener('change', updateAllPrices);
});


</script>



<script>

function showInputBox(item) {
    const mainBox = $(item).closest('.plus_button');
    const isDollar = mainBox.find('.toggle-input').data('dollar') === true;
    const inputBox = mainBox.find('.input-box');

    if (inputBox.length) {
        inputBox.show();

        const input = inputBox.find('input');
        let inputValue = 0
        if (isDollar) {
            inputValue = (parseFloat(input.val()) || 0) * currentKurs;
        } else {
            inputValue = parseFloat(input.val()) || 0;
        }
        console.log(input.val(), 'wwwwww')

        input.trigger('focus');

        // Tolash summasini olish va bo‚Äòsh joylarni olib tashlash
        let tolashSummasi = parseFloat(calculatePaymentTotal().replace(/\s+/g, '')) + inputValue;
        console.log(calculatePaymentTotal().replace(/\s+/g, ''), inputValue)
        // console.log(tolashSummasi)
        // let tolashSummasi = parseFloat($('#tolash_summasi').text().replace(/\s+/g, '')) || 0;

        // Agar dollar bo‚Äòlsa, kursga ko‚Äòra hisoblash
        if (isDollar) {
            input.val((tolashSummasi / currentKurs).toFixed(2));
        } else {
            input.val(tolashSummasi);
        }

        // Umumiy hisobni yangilash
        if (typeof updatePaymentTotal === 'function') {
            updatePaymentTotal();
        }
    }
}




$(document).on('click', '.remove-field', function () {
    const parentBox = $(this).closest('.input-box');
    const input = parentBox.find('.payment-input');

    // Inputni tozalaymiz
    input.val('');

    updatePaymentTotal()
});

function calculatePaymentTotal() {
    $('#total_jami').text(formatNumber(currentDatas.total_price))
    let total = 0;

    $('.plus_button').each(function() {
        const inputBox = $(this).find('.input-box');
        
        // faqat display:none bo‚Äòlmaganlarini olish
        if (inputBox.is(':visible')) {
            const inputVal = parseFloat($(this).find('.payment-input').val()) || 0;
            const isDollar = $(this).find('.toggle-input').data('dollar') === true;

            if (isDollar) {
                total += inputVal * currentKurs;
            } else {
                total += inputVal;
            }
        }
    });

    // $('#tolash_summasi').text(formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total)))
    // console.log(formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total)))
    return formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total));
}

function updatePaymentTotal() {
    let total = calculatePaymentTotal()
    console.log(total)
    $('#tolash_summasi').text(total)
}

// Masalan, har input o‚Äòzgarganda hisoblash uchun:
$(document).on('input', '.payment-input', function() {
    updatePaymentTotal();
});

</script>



<script>
    

async function loadExistingPayments() {
    if (!currentShopId) return;
    
    try {
        const response = await fetch(`{% url 'get_shop_payments' %}?shop_id=${currentShopId}`);
        const data = await response.json();
        
        if (data.success) {
            existingPayments = data.payments;
            // Kursni yangilash
            if (data.kurs) {
                currentKurs = data.kurs;
                document.getElementById('current-kurs').textContent = formatNumber(currentKurs);
            }
        }
    } catch (error) {
        console.error('To\'lovlarni yuklashda xatolik:', error);
    }
}



$(document).ready(function() {
    // DOM elementni olish (jQuery elementning [0]-chi elementi)
    var fullscreenPaymentEl = $('#fullscreenPayment')[0]; 

    // Bootstrap modal obyekti yaratish
    var fullscreenPaymentModal = new bootstrap.Modal(fullscreenPaymentEl);

    // Modalni ochish
    $('#fullscreenPaymentBtn').on('click', function() {
        fullscreenPaymentModal.show();
        calculatePaymentTotal()
    });

    // Modalni yopish va inputlarni tozalash
    function closeFullscreen() {
        fullscreenPaymentModal.hide();
        $('#fullscreenPayment').find('.payment-input').val('0');
    }

    // Tugmalarni bog‚Äòlash
    $('#closeFullscreenBtn, #cancelPaymentBtn').on('click', closeFullscreen);

    // ESC yoki backdrop bosilganda inputlarni tozalash
    $('#fullscreenPayment').on('hidden.bs.modal', function() {
        $(this).find('.payment-input').val('0');
    });
});


// </script>


<script>
    // Sotuvlar ro'yxatini boshqarish
document.addEventListener('DOMContentLoaded', function() {
    const shopsContainer = document.getElementById('shops-container');
    const paginationContainer = document.getElementById('pagination-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const filterForm = document.getElementById('filter-form');
    const returnModal = document.getElementById('return-modal');
    const returnOverlay = document.getElementById('return-modal-overlay');
    const closeReturnModal = document.getElementById('close-return-modal');
    const returnShopInfo = document.getElementById('return-shop-info');
    const subtractFromDebtCheckbox = document.getElementById('subtract-from-debt');
    const paymentSection = document.getElementById('payment-section');
    const addPaymentBtn = document.getElementById('add-payment');
    const paymentsContainer = document.getElementById('payments-container');
    const totalReturnDisplay = document.getElementById('total-return-display');
    const confirmReturnBtn = document.getElementById('confirm-return');
    
    let currentPage = 1;
    let currentShops = [];
    let currentShop = null;
    let totalReturnAmount = 0;
    let payments = [];
    
    // Sahifani yuklash
    function loadShops(page = 1) {
        currentPage = page;
        loadingSpinner.style.display = 'block';
        shopsContainer.style.opacity = '0.5';
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        // Form ma'lumotlarini qo'shamiz
        for (let [key, value] of formData.entries()) {
            if (key === 'deliver' || key === 'client') {
                const values = formData.getAll(key);
                values.forEach(val => params.append(key, val));
            } else if (value) {
                params.append(key, value);
            }
        }
        
        params.append('page', page);
        
        fetch(`?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            currentShops = data.shops;
            renderShops(data.shops);
            renderPagination(data);
            updateTotals(data);
            loadingSpinner.style.display = 'none';
            shopsContainer.style.opacity = '1';
        })
        .catch(error => {
            console.error('Xatolik:', error);
            loadingSpinner.style.display = 'none';
            shopsContainer.style.opacity = '1';
            shopsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Xatolik yuz berdi: ${error.message}
                </div>
            `;
        });
    }
    
    // Sotuvlarni render qilish
    function renderShops(shops) {
        if (shops.length === 0) {
            shopsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h5>Hech qanday sotuv topilmadi</h5>
                        <p class="text-muted">Filterlarni o'zgartirib ko'ring</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        shops.forEach((shop, index) => {
            // To'lov jami larini formatlash
            let paymentTotalsHtml = '';
            for (const [valyuta, summa] of Object.entries(shop.payment_totals)) {
                paymentTotalsHtml += `
                    <div class="payment-total-item">
                        <div class="payment-total-label">${valyuta}</div>
                        <div class="payment-total-value">${parseFloat(summa).toLocaleString()}</div>
                    </div>
                `;
            }
            
            if (!paymentTotalsHtml) {
                paymentTotalsHtml = '<div class="text-muted">To\'lovlar mavjud emas</div>';
            }

            let chiqimTotalsHtml = '';
            for (const [valyuta, summa] of Object.entries(shop.chiqim_totals)) {
                chiqimTotalsHtml += `
                    <div class="payment-total-item">
                        <div class="payment-total-label">${valyuta}</div>
                        <div class="payment-total-value">${parseFloat(summa).toLocaleString()}</div>
                    </div>
                `;
            }
            
            if (!chiqimTotalsHtml) {
                chiqimTotalsHtml = '<div class="text-muted">To\'lovlar mavjud emas</div>';
            }
            
            // Chegirma ko'rsatish
            let chegirmaHtml = '';
            if (shop.chegirma > 0) {
                chegirmaHtml = `<span class="chegirma-badge">Chegirma: ${parseFloat(shop.chegirma).toLocaleString()}</span>`;
            }
            
            html += `
                <div class="shop-table">
                    <div class="shop-header" onclick="toggleShopDetails(${shop.id})">
                        <div class="shop-main-info">
                            <div>
                                <strong>${shop.debtor_name}</strong>
                                <br>
                                <small class="text-muted">${shop.date}</small>
                                ${chegirmaHtml}
                            </div>
                            <div>
                                <div class="text-success"><strong>${parseFloat(shop.total_price).toLocaleString()} ${shop.valyuta_name}</strong></div>
                                <small class="text-muted">Jami summa</small>
                            </div>

                            <div>
                                <div class="text-success"><strong>${parseFloat(shop.total_returned_sum).toLocaleString()} ${shop.valyuta_name}</strong></div>
                                <small class="text-muted">Qaytarilgan summa</small>
                            </div>

                            <div>
                                <div><strong>${shop.total_quantity}</strong></div>
                                <small class="text-muted">Mahsulotlar</small>
                            </div>
                            <div>
                                ${paymentTotalsHtml ? Object.keys(shop.payment_totals).length + ' hil to\'lov' : 'To\'lov yo\'q'}
                            </div>

                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editShopModal(${shop.id})">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); openReturnModal(${shop.id})">
                                    <i class="fas fa-undo"></i> Qaytarish
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="shop-details" id="details-${shop.id}">
                        <!-- Mahsulotlar qismi -->
                        <div class="carts-section">
                            <div class="section-title">
                                <span>Sotilgan Mahsulotlar</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Mahsulot</th>
                                            <th>Narx</th>
                                            <th>Soni</th>
                                            <th>Summa</th>
                                            <th>Qaytarilgan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${shop.carts.map(cart => `
                                            <tr>
                                                <td>${cart.product_name}</td>
                                                <td>${parseFloat(cart.price).toLocaleString()}</td>
                                                <td>${parseFloat(cart.quantity).toLocaleString()}</td>
                                                <td>${parseFloat(cart.total).toLocaleString()}</td>
                                                <td>${parseFloat(cart.total_returned).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- To'lovlar qismi -->
                        <div class="payments-section">
                            <div class="section-title">
                                <span>To'lovlar</span>
                            </div>
                            <div class="payment-totals">
                                ${paymentTotalsHtml}
                            </div>
                            ${shop.payment_details.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Summa</th>
                                                <th>Valyuta</th>
                                                <th>Kassa</th>
                                                <th>Sana</th>
                                                <th>Turi</th>
                                                <th>Holat</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${shop.payment_details.map(payment => `
                                            <tr class="${payment.is_debt ? 'debt-payment' : ''}">
                                                <td>${parseFloat(payment.summa).toLocaleString()}</td>
                                                <td>${payment.valyuta}</td>
                                                <td>${payment.kassa}</td>
                                                <td>${payment.date}</td>
                                                <td class="${payment.type_pay == 1 ? 'text-primary' : 'text-danger'}">
                                                    ${payment.type_pay == 1 ? 'Kirim' : 'Chiqim'}
                                                </td>
                                                <td>
                                                    ${payment.is_debt 
                                                        ? '<span class="badge bg-warning">Qarz</span>' 
                                                        : '<span class="badge bg-success">To\'lov</span>'
                                                    }
                                                </td>
                                            </tr>
                                        `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-muted">To\'lovlar mavjud emas</p>'}
                        </div>

                        <!-- Qaytarilgan summalar qismi -->
                        <div class="payments-section">
                            <div class="section-title">
                                <span>Qaytarilgan summalar</span>
                            </div>
                            <div class="payment-totals">
                                ${chiqimTotalsHtml}
                            </div>
                            ${shop.chiqim_details.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Summa</th>
                                                <th>Valyuta</th>
                                                <th>Kassa</th>
                                                <th>Sana</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${shop.chiqim_details.map(chiqim => `
                                            <tr class="">
                                                <td>${parseFloat(chiqim.summa).toLocaleString()}</td>
                                                <td>${chiqim.valyuta}</td>
                                                <td>${chiqim.kassa}</td>
                                                <td>${chiqim.date}</td>
                                            </tr>
                                        `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-muted">To\'lovlar mavjud emas</p>'}
                        </div>
                        
                        <!-- Qaytarilgan mahsulotlar qismi -->
                        ${shop.return_details.length > 0 ? `
                            <div class="returns-section">
                                <div class="section-title">
                                    <span>Qaytarilgan Mahsulotlar</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Mahsulot</th>
                                                <th>Qaytarilgan miqdor</th>
                                                <th>Sana</th>
                                                <th>Kim tomonidan</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${shop.return_details.map(return_item => `
                                                <tr>
                                                    <td>${return_item.product_name}</td>
                                                    <td>${parseFloat(return_item.return_quantity).toLocaleString()}</td>
                                                    <td>${return_item.date}</td>
                                                    <td>${return_item.returned_by}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        shopsContainer.innerHTML = html;
    }
    
    // Pagination render qilish
    function renderPagination(data) {
        let html = '';
        
        if (data.total_pages > 1) {
            html = '<nav><ul class="pagination justify-content-center">';
            
            if (data.has_previous) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadShops(${data.current_page - 1})">‚Üê Oldingi</a>
                </li>`;
            }
            
            // Birinchi sahifalar
            for (let i = 1; i <= Math.min(3, data.total_pages); i++) {
                html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                </li>`;
            }
            
            // O'rtada nuqtalar
            if (data.current_page > 4) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            
            // Joriy sahifa atrofi
            for (let i = Math.max(4, data.current_page - 1); i <= Math.min(data.total_pages - 1, data.current_page + 1); i++) {
                if (i > 3 && i < data.total_pages) {
                    html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                    </li>`;
                }
            }
            
            // Oxirgi nuqtalar
            if (data.current_page < data.total_pages - 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            
            // Oxirgi sahifalar
            if (data.total_pages > 3) {
                for (let i = Math.max(data.total_pages - 2, data.current_page + 2); i <= data.total_pages; i++) {
                    html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                    </li>`;
                }
            }
            
            if (data.has_next) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadShops(${data.current_page + 1})">Keyingi ‚Üí</a>
                </li>`;
            }
            
            html += '</ul></nav>';
        }
        
        paginationContainer.innerHTML = html;
    }
    
    // Jami qiymatlarni yangilash
    function updateTotals(data) {
        document.getElementById('current-page').textContent = data.current_page;
        document.getElementById('total-price').textContent = parseFloat(data.total_price).toLocaleString();
        document.getElementById('total-quantity').textContent = parseFloat(data.total_quantity).toLocaleString();
        document.getElementById('total-shops').textContent = parseInt(data.total_shops).toLocaleString();
    }
    
    // Shop tafsilotlarini ochish/yopish
    window.toggleShopDetails = function(shopId) {
        const details = document.getElementById(`details-${shopId}`);
        details.classList.toggle('show');
    }
    
    // Qaytarish modalini ochish
    window.openReturnModal = function(shopId) {
        currentShop = currentShops.find(s => s.id === shopId);
        if (!currentShop) return;
        
        // Shop ma'lumotlarini ko'rsatish
        returnShopInfo.innerHTML = `
            <strong>${currentShop.debtor_name}</strong><br>
            <small>Sana: ${currentShop.date}</small><br>
            <small>Jami summa: ${parseFloat(currentShop.total_price).toLocaleString()} ${currentShop.valyuta_name}</small>
            ${currentShop.chegirma > 0 ? `<br><small>Chegirma: ${parseFloat(currentShop.chegirma).toLocaleString()}</small>` : ''}
        `;
        
        // Qaytariladigan mahsulotlar ro'yxati
        let productsHtml = '';
        totalReturnAmount = 0;
        
        currentShop.carts.forEach(cart => {
            const maxReturnable = cart.quantity - cart.total_returned;
            if (maxReturnable > 0) {
                productsHtml += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${cart.product_name}</h6>
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <small class="text-muted">Qaytarish mumkin: ${maxReturnable}</small>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Narx: ${parseFloat(cart.price).toLocaleString()}</small>
                                </div>
                                <div class="col-4">
                                    <input type="number" 
                                           class="form-control form-control-sm return-quantity" 
                                           data-cart-id="${cart.id}"
                                           data-price="${cart.price}"
                                           min="0" 
                                           max="${maxReturnable}" 
                                           step="0.01"
                                           placeholder="Miqdor"
                                           value="0"
                                           onchange="updateReturnTotal()">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        if (!productsHtml) {
            productsHtml = '<div class="alert alert-info">Qaytarish mumkin bo\'lgan mahsulotlar yo\'q</div>';
        }
        
        document.getElementById('return-products-list').innerHTML = productsHtml;
        
        // To'lovlarni tozalash
        payments = [];
        paymentsContainer.innerHTML = '';
        updatePaymentSection();
        
        returnModal.classList.add('show');
        returnOverlay.classList.add('show');
    }
    
    // Qaytarish jami summasini yangilash
    window.updateReturnTotal = function() {
        totalReturnAmount = 0;
        const inputs = document.querySelectorAll('.return-quantity');
        
        inputs.forEach(input => {
            const quantity = parseFloat(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            totalReturnAmount += quantity * price;
        });
        
        totalReturnDisplay.innerHTML = `
            Jami qaytarish summasi: <strong>${totalReturnAmount.toLocaleString()} ${currentShop.valyuta_name}</strong>
        `;
        
        updatePaymentSection();
    }
    
    // To'lov bo'limini yangilash
    function updatePaymentSection() {
        const isNaqdMijoz = currentShop.debtor_name.toLowerCase().includes('naqd');
        const shouldShowPayment = !subtractFromDebtCheckbox.checked || isNaqdMijoz;
        
        paymentSection.style.display = shouldShowPayment ? 'block' : 'none';
        
        if (shouldShowPayment) {
            totalReturnDisplay.style.display = totalReturnAmount > 0 ? 'block' : 'none';
        }
    }
    
    // To'lov qo'shish
    addPaymentBtn.addEventListener('click', function() {
        console.log('aaaaaaaaa')
        const paymentId = Date.now();
        const paymentHtml = `
            <div class="payment-row" id="payment-${paymentId}">
                <div class="payment-amount">
                    <label>Summa</label>
                    <input type="number" class="form-control payment-amount-input" 
                           step="0.01" min="0" placeholder="Summa"
                           onchange="updatePayments()">
                </div>
                <div class="payment-amount">
                    <label>Valyuta</label>
                    <select class="form-control valyuta-select" onchange="onValyutaChange(${paymentId})">
                        <option value="">Valyuta tanlang</option>
                        {% for valyuta in valyutalar %}
                            <option value="{{ valyuta.id }}" 
                                    data-is-dollar="{{ valyuta.is_dollar|yesno:'true,false' }}"
                                    data-is-som="{{ valyuta.is_som|yesno:'true,false' }}">
                                {{ valyuta.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="payment-amount">
                    <label>Kassa</label>
                    <select class="form-control kassa-select" id="kassa-${paymentId}" onchange="updatePayments()">
                        <option value="">Kassa tanlang</option>
                    </select>
                </div>
                <div class="remove-payment" onclick="removePayment(${paymentId})">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        `;
        
        paymentsContainer.insertAdjacentHTML('beforeend', paymentHtml);
        payments.push({
            id: paymentId,
            amount: 0,
            valyuta_id: null,
            kassa_id: null
        });
    });

    
    
    // Valyuta o'zgarganda kassalarni yuklash
    window.onValyutaChange = function(paymentId) {
        const valyutaSelect = document.querySelector(`#payment-${paymentId} .valyuta-select`);
        const kassaSelect = document.querySelector(`#kassa-${paymentId}`);
        const valyutaId = valyutaSelect.value;
        
        if (valyutaId) {
            fetch(`/get-kassalar-by-valyuta/?valyuta_id=${valyutaId}`)
                .then(response => response.json())
                .then(data => {
                    kassaSelect.innerHTML = '<option value="">Kassa tanlang</option>';
                    data.kassalar.forEach(kassa => {
                        kassaSelect.innerHTML += `<option value="${kassa.id}" data-balance="${kassa.balance}">${kassa.name}</option>`;
                    });
                    updatePayments();
                });
        } else {
            kassaSelect.innerHTML = '<option value="">Kassa tanlang</option>';
            updatePayments();
        }
    }
    
    // To'lovni o'chirish
    window.removePayment = function(paymentId) {
        const paymentElement = document.getElementById(`payment-${paymentId}`);
        if (paymentElement) {
            paymentElement.remove();
        }
        payments = payments.filter(p => p.id !== paymentId);
        updatePayments();
    }
    
    // To'lovlarni yangilash
    window.updatePayments = function() {
        let totalPaid = 0;
        
        payments.forEach(payment => {
            const paymentElement = document.getElementById(`payment-${payment.id}`);
            if (paymentElement) {
                const amountInput = paymentElement.querySelector('.payment-amount-input');
                const valyutaSelect = paymentElement.querySelector('.valyuta-select');
                const kassaSelect = paymentElement.querySelector('.kassa-select');
                
                payment.amount = parseFloat(amountInput.value) || 0;
                payment.valyuta_id = valyutaSelect.value;
                payment.kassa_id = kassaSelect.value;
                
                // Valyuta konvertatsiyasi
                if (payment.amount > 0 && payment.valyuta_id) {
                    const valyutaOption = valyutaSelect.options[valyutaSelect.selectedIndex];
                    const isDollar = valyutaOption.dataset.isDollar === 'true';
                    const isSom = valyutaOption.dataset.isSom === 'true';
                    
                    if (currentShop.valyuta_is_dollar && isSom) {
                        // Dollar -> So'm
                        totalPaid += payment.amount / currentShop.kurs;
                    } else if (!currentShop.valyuta_is_dollar && isDollar) {
                        // So'm -> Dollar
                        totalPaid += payment.amount * currentShop.kurs;
                    } else {
                        totalPaid += payment.amount;
                    }
                }
            }
        });
        
        // Jami to'langan summani ko'rsatish
        if (totalReturnAmount > 0) {
            totalReturnDisplay.innerHTML = `
                Jami qaytarish summasi: <strong>${totalReturnAmount.toLocaleString()} ${currentShop.valyuta_name}</strong><br>
                Jami to'langan: <strong>${totalPaid.toLocaleString()} ${currentShop.valyuta_name}</strong><br>
                Farq: <strong>${(totalReturnAmount - totalPaid).toLocaleString()} ${currentShop.valyuta_name}</strong>
            `;
        }
    }
    
    // Qarzdan ayirish checkbox'ini tinglash
    subtractFromDebtCheckbox.addEventListener('change', function() {
        updatePaymentSection();
    });
    
    // Qaytarishni tasdiqlash
    confirmReturnBtn.addEventListener('click', function() {
        const returnItems = [];
        const returnInputs = document.querySelectorAll('.return-quantity');
        
        returnInputs.forEach(input => {
            const quantity = parseFloat(input.value);
            if (quantity > 0) {
                returnItems.push({
                    cart_id: input.dataset.cartId,
                    return_quantity: quantity
                });
            }
        });
        
        if (returnItems.length === 0) {
            alert('Hech qanday miqdor kiritilmagan');
            return;
        }
        
        // To'lovlarni tekshirish
        const subtractFromDebt = subtractFromDebtCheckbox.checked;
        const isNaqdMijoz = currentShop.debtor_name.toLowerCase().includes('naqd');
        
        if ((!subtractFromDebt || isNaqdMijoz) && payments.length === 0) {
            alert('To\'lov usulini tanlang yoki to\'lov qo\'shing');
            return;
        }
        
        // To'lovlarni tekshirish
        let totalPaid = 0;
        const validPayments = [];
        
        payments.forEach(payment => {
            if (payment.amount > 0 && payment.valyuta_id && payment.kassa_id) {
                totalPaid += payment.amount;
                validPayments.push(payment);
            }
        });
        
        if ((!subtractFromDebt || isNaqdMijoz) && validPayments.length === 0) {
            alert('To\'g\'ri to\'lov ma\'lumotlarini kiriting');
            return;
        }
        
        confirmReturnBtn.disabled = true;
        confirmReturnBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Amalga oshirilmoqda...';
        
        fetch("{% url 'return_products' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                shop_id: currentShop.id,
                return_items: returnItems,
                payments: validPayments,
                subtract_from_debt: subtractFromDebt
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                returnModal.classList.remove('show');
                returnOverlay.classList.remove('show');
                loadShops(currentPage); // Sahifani yangilash
            } else {
                alert('Xatolik: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Xatolik:', error);
            alert('Server xatosi yuz berdi');
        })
        .finally(() => {
            confirmReturnBtn.disabled = false;
            confirmReturnBtn.innerHTML = '<i class="fas fa-check"></i> Qaytarishni Tasdiqlash';
        });
    });
    
    // Qaytarish modalini yopish
    closeReturnModal.addEventListener('click', function() {
        returnModal.classList.remove('show');
        returnOverlay.classList.remove('show');
    });
    
    returnOverlay.addEventListener('click', function() {
        returnModal.classList.remove('show');
        returnOverlay.classList.remove('show');
    });
    
    // Filter formasi
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadShops(1);
    });
    
    // Sahifani boshlang'ich yuklash
    loadShops(1);
});
</script>



<script>
// QarzModal-ni boshqarish
$(document).on('click', '#qarzModalButton .method-box', function (e) {
    e.stopPropagation();
    
    const customerSelect = $('#mainSelectDebtor')[0].selectize;
    const selectedCustomerId = customerSelect.getValue();
    
    if (!selectedCustomerId) {
        showAlert('Iltimos, avval mijozni tanlang', 'warning');
        return;
    }
    
    // Qarz input boxini ko'rsatish
    showQarzInputBox(this);
});

// Qarz input boxini ko'rsatish
function showQarzInputBox(element) {
    const qarzInputBox = document.getElementById('qarzInputBox');
    const mainBox = $(element).closest('.plus_button');
    
    // Boshqa input boxlarni yopish
    $('.input-box').hide();
    
    // Qarz input boxini ko'rsatish
    qarzInputBox.style.display = 'block';
    
    // Formani tozalash
    document.getElementById('qarzBoxValyuta').value = '';
    document.getElementById('qarzBoxSumma').value = '';
    document.getElementById('qarzBoxDueDate').value = '';
    document.getElementById('qarzBoxComment').value = '';
    
    // Kursni yangilash
    updatePaymentTotal();
}

// Qarz input boxini yopish
function hideQarzInputBox() {
    const qarzInputBox = document.getElementById('qarzInputBox');
    qarzInputBox.style.display = 'none';
    updatePaymentTotal();
}

// Qarzni to'lovlar ro'yxatiga qo'shish
function addQarzToPayment() {
    const valyutaId = document.getElementById('qarzBoxValyuta').value;
    const summa = parseFloat(document.getElementById('qarzBoxSumma').value);
    const dueDate = document.getElementById('qarzBoxDueDate').value;
    const comment = document.getElementById('qarzBoxComment').value;
    
    if (!valyutaId || !summa || summa <= 0 || !dueDate) {
        showAlert('Iltimos, valyuta, summani va sanani to\'g\'ri kiriting', 'warning');
        return;
    }
    
    const valyutaSelect = document.getElementById('qarzBoxValyuta');
    const selectedOption = valyutaSelect.options[valyutaSelect.selectedIndex];
    const valyutaName = selectedOption.getAttribute('data-name');
    const isDollar = selectedOption.getAttribute('data-is-dollar') === 'true';
    
    // Qarz ma'lumotlarini global o'zgaruvchiga saqlash (sessionStorage o'rniga)
    window.currentQarzData = {
        type: 'qarz',
        valyuta_id: valyutaId,
        valyuta_name: valyutaName,
        summa: summa,
        due_date: dueDate,
        comment: comment,
        is_dollar: isDollar
    };
    
    // Input boxni yopish
    hideQarzInputBox();
    
    // Chekda ko'rsatish
    updateQarzInCheck();
    
    // To'lov jamiini yangilash
    updatePaymentTotal();
    
    showAlert('Qarz ma\'lumotlari qo\'shildi', 'success');
}

// Qarzni to'lovlar ro'yxatiga qo'shish
function addQarzToPayment() {
    const valyutaId = document.getElementById('qarzBoxValyuta').value;
    const summa = parseFloat(document.getElementById('qarzBoxSumma').value);
    const dueDate = document.getElementById('qarzBoxDueDate').value;
    const comment = document.getElementById('qarzBoxComment').value;
    
    if (!valyutaId || !summa || summa <= 0 || !dueDate) {
        showAlert('Iltimos, valyuta, summani va sanani to\'g\'ri kiriting', 'warning');
        return;
    }
    
    const valyutaSelect = document.getElementById('qarzBoxValyuta');
    const selectedOption = valyutaSelect.options[valyutaSelect.selectedIndex];
    const valyutaName = selectedOption.getAttribute('data-name');
    const isDollar = selectedOption.getAttribute('data-is-dollar') === 'true';
    
    // Input boxni yopish
    hideQarzInputBox();
    
    // Chekda ko'rsatish
    updateQarzInCheck(valyutaId, summa, valyutaName, dueDate, comment, isDollar);
    
    // To'lov jamiini yangilash
    updatePaymentTotal();
    
    showAlert('Qarz ma\'lumotlari qo\'shildi', 'success');
}

// Chekda qarzni ko'rsatish
function updateQarzInCheck(valyutaId, summa, valyutaName, dueDate, comment, isDollar) {
    const checkTolovlar = document.getElementById('check_tolovlar');
    
    let dueDateInfo = '';
    if (dueDate) {
        dueDateInfo = `<br><small>To'lov muddati: ${dueDate}</small>`;
    }
    
    let commentInfo = '';
    if (comment) {
        commentInfo = `<br><small>Izoh: ${comment}</small>`;
    }
    
    checkTolovlar.innerHTML = `
        <div class="section">
            <div class="lines"><span class="bold">Qarz</span><span>${formatNumber(summa)} ${valyutaName}</span></div>
            ${dueDateInfo}
            ${commentInfo}
        </div>
    `;
}

// To'lov ma'lumotlarini yig'ish
function collectPaymentData() {
    const payments = [];
    let totalPaid = 0;

    // Kassalar bo'yicha to'lovlar
    $('.plus_button').each(function() {
        if (!$(this).is('#qarzModalButton')) {
            const inputBox = $(this).find('.input-box');
            if (inputBox.is(':visible')) {
                const inputVal = parseFloat($(this).find('.payment-input').val()) || 0;
                const kassaId = $(this).find('.payment-method').data('kassa-id');
                const valyutaId = $(this).find('.payment-method').data('valyuta-id');
                const isDollar = $(this).find('.toggle-input').data('dollar') === true;
                
                if (inputVal > 0) {
                    // Valyuta konvertatsiyasi
                    let convertedAmount = inputVal;
                    if (isDollar && !currentDatas.valyuta_is_dollar) {
                        convertedAmount = inputVal * currentKurs;
                    } else if (!isDollar && currentDatas.valyuta_is_dollar) {
                        convertedAmount = inputVal / currentKurs;
                    }
                    
                    totalPaid += convertedAmount;
                    
                    payments.push({
                        kassa_id: kassaId,
                        valyuta_id: valyutaId,
                        summa: inputVal,
                        converted_summa: convertedAmount,
                        type: 'payment',
                        is_dollar: isDollar
                    });
                }
            }
        }
    });

    // Qarzni hisobga olish (faqat inputlardan olish)
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(document.getElementById('qarzBoxSumma').value) || 0;
    const qarzDueDate = document.getElementById('qarzBoxDueDate').value;
    const qarzComment = document.getElementById('qarzBoxComment').value;
    
    if (qarzValyutaId && qarzSumma > 0) {
        const qarzValyutaSelect = document.getElementById('qarzBoxValyuta');
        const qarzSelectedOption = qarzValyutaSelect.options[qarzValyutaSelect.selectedIndex];
        const qarzIsDollar = qarzSelectedOption.getAttribute('data-is-dollar') === 'true';
        
        let convertedQarzAmount = qarzSumma;
        
        if (qarzIsDollar && !currentDatas.valyuta_is_dollar) {
            convertedQarzAmount = qarzSumma * currentKurs;
        } else if (!qarzIsDollar && currentDatas.valyuta_is_dollar) {
            convertedQarzAmount = qarzSumma / currentKurs;
        }
        
        totalPaid += convertedQarzAmount;
        
        payments.push({
            type: 'qarz',
            valyuta_id: qarzValyutaId,
            summa: qarzSumma,
            converted_summa: convertedQarzAmount,
            due_date: qarzDueDate,
            comment: qarzComment,
            is_dollar: qarzIsDollar
        });
    }

    return {
        payments: payments,
        total_paid: totalPaid
    };
}

// To'lovni tekshirish va yakunlash
async function Yakunlash() {
    try {
        const totalRequired = parseFloat(currentDatas.total_price);
        const paymentResult = collectPaymentData();
        const totalPaid = paymentResult.total_paid;
        
        // To'lov miqdorini tekshirish
        if (totalPaid < totalRequired) {
            const difference = totalRequired - totalPaid;
            showAlert(`To'lov yetarli emas! Yetishmayotgan summa: ${formatNumber(difference)} ${currentDatas.valyuta_name}`, 'danger');
            return;
        }
        
        // Agar ortiqcha to'langan bo'lsa, ogohlantirish
        if (totalPaid > totalRequired) {
            const difference = totalPaid - totalRequired;
            const confirmContinue = confirm(`To'lov keragidan ${formatNumber(difference)} ${currentDatas.valyuta_name} ko'p. Davom ettirilsinmi?`);
            if (!confirmContinue) {
                return;
            }
        }

        // To'lov ma'lumotlarini tayyorlash
        const paymentData = {
            shop_id: currentShopId,
            payments: paymentResult.payments,
            total_required: totalRequired,
            total_paid: totalPaid,
            chegirma: parseFloat($('#discountInput').val()) || 0
        };

        console.log(paymentData, 'ooooooo')
        
        // Yuklash indikatorini ko'rsatish
        const submitBtn = document.getElementById('submit-payment');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Amalga oshirilmoqda...';
        
        // Serverga yuborish
        const response = await fetch("{% url 'complete_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(paymentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('To\'lov muvaffaqiyatli yakunlandi!', 'success');
            
            // Modalni yopish
            const paymentModal = bootstrap.Modal.getInstance(document.getElementById('fullscreenPayment'));
            paymentModal.hide();
            
            // POS modalini ham yopish
            const posModal = bootstrap.Modal.getInstance(document.getElementById('posModal'));
            if (posModal) {
                posModal.hide();
            }
            
            // Ma'lumotlarni tozalash
            $('.payment-input').val('');
            $('.input-box').hide();
            document.getElementById('qarzBoxValyuta').value = '';
            document.getElementById('qarzBoxSumma').value = '';
            document.getElementById('qarzBoxDueDate').value = '';
            document.getElementById('qarzBoxComment').value = '';
            document.getElementById('check_tolovlar').innerHTML = '';
            
            // Sahifani yangilash
            setTimeout(() => {
                // window.location.reload();
            }, 1500);
            
        } else {
            showAlert(result.message || 'To\'lovda xatolik yuz berdi', 'danger');
        }
    } catch (error) {
        console.error('Yakunlashda xatolik:', error);
        showAlert('Server bilan bog\'lanishda xatolik', 'danger');
    } finally {
        // Tugmani qayta faollashtirish
        const submitBtn = document.getElementById('submit-payment');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> To\'lovni tasdiqlash va Yakunlash';
        }
    }
}

// Real vaqtda to'lov miqdorini tekshirish va ko'rsatish
function updatePaymentTotal() {
    const totalRequired = parseFloat(currentDatas.total_price);
    const paymentResult = collectPaymentData();
    const totalPaid = paymentResult.total_paid;
    
    const remaining = totalRequired - totalPaid;
    $('#tolash_summasi').text(formatNumber(remaining > 0 ? remaining : 0));
    
    // To'lov holatini rang bilan ko'rsatish
    const tolashElement = $('#tolash_summasi');
    tolashElement.removeClass('text-success text-warning text-danger');
    
    if (remaining <= 0) {
        tolashElement.addClass('text-success');
    } else if (remaining <= totalRequired * 0.1) { // 10% dan kam qolgan
        tolashElement.addClass('text-warning');
    } else {
        tolashElement.addClass('text-danger');
    }
    
    // Submit tugmasini holatini yangilash
    const submitBtn = document.getElementById('submit-payment');
    if (submitBtn) {
        if (totalPaid >= totalRequired) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    return formatNumber(remaining > 0 ? remaining : 0);
}

// DOM yuklanganda submit tugmasini sozlash
document.addEventListener('DOMContentLoaded', function() {
    // Har bir input o'zgarganda to'lovni yangilash
    $(document).on('input', '.payment-input, #qarzBoxSumma, #qarzBoxValyuta, #qarzBoxDueDate, #qarzBoxComment', function() {
        updatePaymentTotal();
    });
    
    // Fullscreen payment modal ochilganda to'lovni yangilash
    $('#fullscreenPayment').on('shown.bs.modal', function() {
        updatePaymentTotal();
    });
    
    // Modal yopilganda inputlarni tozalash
    $('#fullscreenPayment').on('hidden.bs.modal', function() {
        // Qarz inputlarini tozalash
        document.getElementById('qarzBoxValyuta').value = '';
        document.getElementById('qarzBoxSumma').value = '';
        document.getElementById('qarzBoxDueDate').value = '';
        document.getElementById('qarzBoxComment').value = '';
        document.getElementById('check_tolovlar').innerHTML = '';
        
        // Boshqa input boxlarni yopish
        $('.input-box').hide();
    });
});

// To'lov jamiini yangilash (qarzni hisobga olgan holda)
function calculatePaymentTotal() {
    $('#total_jami').text(formatNumber(currentDatas.total_price));
    let total = 0;

    // Kassalar bo'yicha to'lovlar
    $('.plus_button').each(function() {
        const inputBox = $(this).find('.input-box');
        
        if (inputBox.is(':visible') && !$(this).is('#qarzModalButton')) {
            const inputVal = parseFloat($(this).find('.payment-input').val()) || 0;
            const isDollar = $(this).find('.toggle-input').data('dollar') === true;

            if (isDollar) {
                total += inputVal * currentKurs;
            } else {
                total += inputVal;
            }
        }
    });

    // Qarzni hisobga olish (faqat inputlardan)
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(document.getElementById('qarzBoxSumma').value) || 0;
    
    if (qarzValyutaId && qarzSumma > 0) {
        const qarzValyutaSelect = document.getElementById('qarzBoxValyuta');
        const qarzSelectedOption = qarzValyutaSelect.options[qarzValyutaSelect.selectedIndex];
        const qarzIsDollar = qarzSelectedOption.getAttribute('data-is-dollar') === 'true';
        
        if (qarzIsDollar && !currentDatas.valyuta_is_dollar) {
            // Dollar qarz, asosiy valyuta so'm
            total += qarzSumma * currentKurs;
        } else if (!qarzIsDollar && currentDatas.valyuta_is_dollar) {
            // So'm qarz, asosiy valyuta dollar
            total += qarzSumma / currentKurs;
        } else {
            // Bir xil valyuta
            total += qarzSumma;
        }
    }

    const remaining = parseFloat(currentDatas.total_price) - parseFloat(total);
    $('#tolash_summasi').text(formatNumber(remaining > 0 ? remaining : 0));
    return formatNumber(parseFloat(currentDatas.total_price) - parseFloat(total));
}

// Qarz input boxini yopish
function hideQarzInputBox() {
    const qarzInputBox = document.getElementById('qarzInputBox');
    qarzInputBox.style.display = 'none';
    
    // Agar qarz ma'lumotlari to'liq kiritilmagan bo'lsa, chekni tozalash
    const qarzValyutaId = document.getElementById('qarzBoxValyuta').value;
    const qarzSumma = parseFloat(document.getElementById('qarzBoxSumma').value) || 0;
    
    if (!qarzValyutaId || qarzSumma <= 0) {
        document.getElementById('check_tolovlar').innerHTML = '';
    }
    
    updatePaymentTotal();
}

// Modal yopilganda inputlarni tozalash
$('#fullscreenPayment').on('hidden.bs.modal', function() {
    // Qarz inputlarini tozalash
    document.getElementById('qarzBoxValyuta').value = '';
    document.getElementById('qarzBoxSumma').value = '';
    document.getElementById('qarzBoxDueDate').value = '';
    document.getElementById('qarzBoxComment').value = '';
    document.getElementById('check_tolovlar').innerHTML = '';
});
</script>

{% endblock js %}